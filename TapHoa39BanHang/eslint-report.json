[{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\app.component.html","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\app.component.ts","messages":[{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":20,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":20,"endColumn":27}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, OnInit } from '@angular/core';\r\nimport { Router, RouterModule } from '@angular/router';\r\n// import { ProductService } from './services/product.service';\r\n// import { CustomerService } from './services/customer.service';\r\n// import { InvoiceService } from './services/invoice.service';\r\n// import { KiotvietService } from './services/kiotviet.service';\r\n@Component({\r\n  selector: 'app-root',\r\n  standalone: true,\r\n  imports: [\r\n    RouterModule,\r\n  ],\r\n  templateUrl: './app.component.html',\r\n  styleUrls: ['./app.component.css'],\r\n\r\n})\r\nexport class AppComponent implements OnInit {\r\n\r\n  constructor(\r\n    private router: Router,\r\n    // private productService: ProductService,\r\n    // private customerService: CustomerService,\r\n    // private invoiceService: InvoiceService,\r\n    // private kiotvietService: KiotvietService,\r\n  ) {\r\n  }\r\n\r\n  ngOnInit(): void {\r\n    // Kiểm tra đăng nhập KiotViet\r\n    const token = localStorage.getItem('kv_access_token');\r\n    const retailer = localStorage.getItem('kv_retailer');\r\n    const branchId = localStorage.getItem('kv_branch_id');\r\n    \r\n    if (!token || !retailer || !branchId) {\r\n      if (this.router.url !== '/login') {\r\n        this.router.navigate(['/login']);\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Kiểm tra token có expired không\r\n    if (this.isTokenExpired(token)) {\r\n      console.log('Token đã hết hạn, chuyển hướng về trang đăng nhập');\r\n      this.clearStoredCredentials();\r\n      if (this.router.url !== '/login') {\r\n        this.router.navigate(['/login']);\r\n      }\r\n      return;\r\n    }\r\n  }\r\n\r\n  private isTokenExpired(token: string): boolean {\r\n    try {\r\n      // JWT token có 3 phần, phần thứ 2 là payload\r\n      const payload = token.split('.')[1];\r\n      const decodedPayload = JSON.parse(atob(payload));\r\n      \r\n      // Kiểm tra thời gian hết hạn (exp)\r\n      if (decodedPayload.exp) {\r\n        const currentTime = Math.floor(Date.now() / 1000);\r\n        return currentTime >= decodedPayload.exp;\r\n      }\r\n      \r\n      // Nếu không có exp, kiểm tra thời gian tạo token (iat) + thời gian sống ước tính\r\n      if (decodedPayload.iat) {\r\n        const currentTime = Math.floor(Date.now() / 1000);\r\n        const estimatedExpiry = decodedPayload.iat + (24 * 60 * 60); // Ước tính 24 giờ\r\n        return currentTime >= estimatedExpiry;\r\n      }\r\n      \r\n      // Nếu không có thông tin thời gian, coi như không expired\r\n      return false;\r\n    } catch (error) {\r\n      console.error('Lỗi khi kiểm tra token expired:', error);\r\n      // Nếu không parse được token, coi như expired để đảm bảo an toàn\r\n      return true;\r\n    }\r\n  }\r\n\r\n  private clearStoredCredentials(): void {\r\n    localStorage.removeItem('kv_access_token');\r\n    localStorage.removeItem('kv_retailer');\r\n    localStorage.removeItem('kv_branch_id');\r\n  }\r\n  // async fromKiotViet() {\r\n  //   console.log('Starting sync from KiotViet to IndexedDB...');\r\n  //   await this.productService.loadItemsFromKiotVietToIndexedDB();\r\n  //   await this.customerService.loadCustomersFromKiotvietToIndexedDB();\r\n  //   await this.kiotvietService.syncProductFromKiotvietToFirebase('');\r\n  //   await this.kiotvietService.syncCustomerFromKiotvietToFirebase('');\r\n  //   console.log('Sync from KiotViet to IndexedDB finished.');\r\n  // }\r\n  // async fromIndexedDB() {\r\n  //   console.log('Starting sync from IndexedDB to Firebase...');\r\n  //   await this.invoiceService.syncAllInvoicesFromIndexedDBToFirebase();\r\n  //   await this.productService.syncAllProductsFromIndexedDBToFirebase();\r\n  //   await this.customerService.syncAllCustomersFromIndexedDBToFirebase();\r\n  //   console.log('Sync from IndexedDB to Firebase finished.');\r\n  // }\r\n  // async fromFirebase() {\r\n  //   console.log('Starting sync from Firebase to IndexedDB...');\r\n  //   await this.productService.syncProductsFromFirebaseToIndexedDB();\r\n  //   await this.customerService.syncCustomersFromFirebaseToIndexedDB();\r\n  //   await this.invoiceService.syncInvoicesFromFirestoreToIndexedDB();\r\n  //   console.log('Sync from Firebase to IndexedDB finished.');\r\n  // }\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\app.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\app.module.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'environment' is defined but never used.","line":9,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":21}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NgModule } from '@angular/core';\r\nimport { BrowserModule } from '@angular/platform-browser';\r\nimport { AppComponent } from './app.component';\r\nimport { MatTableModule } from '@angular/material/table';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatToolbarModule } from '@angular/material/toolbar';\r\nimport { FormsModule } from '@angular/forms';\r\n\r\nimport { environment } from '../environments/environment';\r\nimport { ProductService } from './services/product.service';\r\nimport { AngularFontAwesomeModule } from 'angular-font-awesome';\r\nimport { InvoiceDetailComponent } from './components/invoice-detail/invoice-detail.component';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { BrowserAnimationsModule } from '@angular/platform-browser/animations';\r\nimport { ConfirmPopupComponent } from './components/confirm-popup/confirm-popup.component';\r\nimport { InvoicesPageComponent } from './components/invoices-page/invoices-page.component';\r\nimport { MatDatepickerModule } from '@angular/material/datepicker';\r\nimport { MatNativeDateModule } from '@angular/material/core';\r\nimport { MAT_DIALOG_DATA } from '@angular/material/dialog';\r\nimport { provideRouter } from '@angular/router';\r\nimport { routes } from './app.routes';\r\nimport { NgChartsModule } from 'ng2-charts';\r\n\r\n@NgModule({\r\n  providers: [\r\n    CommonModule,\r\n    AngularFontAwesomeModule,\r\n    ProductService,\r\n    MatDialogModule,\r\n    MatDatepickerModule,\r\n    MatNativeDateModule,\r\n    { provide: MAT_DIALOG_DATA, useValue: {} },\r\n    provideRouter(routes),\r\n    BrowserModule,\r\n    BrowserAnimationsModule,\r\n    MatCardModule,\r\n    MatToolbarModule,\r\n    MatButtonModule,\r\n    AppComponent,\r\n    MatDialogModule,\r\n    FormsModule,\r\n    MatTableModule,\r\n    NgChartsModule\r\n  ],\r\n  imports: [\r\n    InvoicesPageComponent,\r\n    ConfirmPopupComponent,\r\n    InvoiceDetailComponent,\r\n    BrowserAnimationsModule,\r\n    MatButtonModule,\r\n    BrowserModule,\r\n    BrowserAnimationsModule,\r\n    MatCardModule,\r\n    MatToolbarModule,\r\n    MatButtonModule,\r\n    AppComponent,\r\n    MatDialogModule,\r\n    FormsModule,\r\n    MatTableModule,\r\n  ],\r\n  bootstrap: []\r\n})\r\nexport class AppModule { }\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\app.routes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\add-customer\\add-customer.component.html","messages":[{"ruleId":"@angular-eslint/template/label-has-associated-control","severity":2,"message":"A label component must be associated with a form element","line":61,"column":9,"nodeType":null,"messageId":"labelHasAssociatedControl","endLine":61,"endColumn":52}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"<div class=\"dialog-container\" >\r\n  <div class=\"header\">\r\n    <h1 mat-dialog-title>Thêm khách hàng</h1>\r\n  </div>\r\n  <div mat-dialog-content [formGroup]=\"customerForm\">\r\n    <div class=\"form-content\">\r\n      <div class=\"left-column\">\r\n        <div class=\"avatar-section\">\r\n          <div class=\"avatar-placeholder\"></div>\r\n          <button mat-stroked-button color=\"primary\" class=\"choose-image-btn\">\r\n            Chọn ảnh\r\n          </button>\r\n        </div>\r\n        <mat-form-field appearance=\"outline\">\r\n          <mat-label>Mã khách hàng</mat-label>\r\n          <input matInput formControlName=\"code\">\r\n        </mat-form-field>\r\n\r\n        <mat-form-field appearance=\"outline\">\r\n          <mat-label>Tên khách hàng</mat-label>\r\n          <input matInput formControlName=\"name\" required>\r\n        </mat-form-field>\r\n\r\n        <mat-form-field appearance=\"outline\">\r\n          <mat-label>Điện thoại</mat-label>\r\n          <input matInput formControlName=\"phone\" required>\r\n        </mat-form-field>\r\n\r\n        <div class=\"dob-gender-row\">\r\n          <mat-form-field appearance=\"outline\" class=\"dob-field\">\r\n            <mat-label>Ngày sinh</mat-label>\r\n            <input matInput [matDatepicker]=\"picker\" formControlName=\"dob\">\r\n            <mat-datepicker-toggle matSuffix [for]=\"picker\"></mat-datepicker-toggle>\r\n            <mat-datepicker #picker></mat-datepicker>\r\n          </mat-form-field>\r\n          <mat-radio-group formControlName=\"gender\" class=\"gender-radio-group\">\r\n            <mat-radio-button value=\"Nam\">Nam</mat-radio-button>\r\n            <mat-radio-button value=\"Nữ\">Nữ</mat-radio-button>\r\n          </mat-radio-group>\r\n        </div>\r\n\r\n        <mat-form-field appearance=\"outline\">\r\n          <mat-label>Địa chỉ</mat-label>\r\n          <input matInput formControlName=\"address\">\r\n        </mat-form-field>\r\n\r\n        <mat-form-field appearance=\"outline\">\r\n          <mat-label>Khu vực</mat-label>\r\n          <input matInput formControlName=\"area\" placeholder=\"Chọn Tỉnh/TP - Quận/Huyện\">\r\n          <mat-icon matSuffix>search</mat-icon>\r\n        </mat-form-field>\r\n\r\n        <mat-form-field appearance=\"outline\">\r\n          <mat-label>Phường xã</mat-label>\r\n          <input matInput formControlName=\"ward\" placeholder=\"Chọn Phường/Xã\">\r\n          <mat-icon matSuffix>search</mat-icon>\r\n        </mat-form-field>\r\n      </div>\r\n\r\n      <div class=\"right-column\">\r\n        <label class=\"mat-label\">Loại khách</label>\r\n        <mat-radio-group formControlName=\"type\" class=\"type-radio-group\">\r\n          <mat-radio-button value=\"personal\">Cá nhân</mat-radio-button>\r\n          <mat-radio-button value=\"company\">Công ty</mat-radio-button>\r\n        </mat-radio-group>\r\n\r\n        <mat-form-field appearance=\"outline\">\r\n          <mat-label>Mã số thuế</mat-label>\r\n          <input matInput formControlName=\"taxCode\">\r\n        </mat-form-field>\r\n\r\n        <mat-form-field appearance=\"outline\">\r\n          <mat-label>Số CMND/CCCD</mat-label>\r\n          <input matInput formControlName=\"idCard\">\r\n        </mat-form-field>\r\n\r\n        <mat-form-field appearance=\"outline\">\r\n          <mat-label>Email</mat-label>\r\n          <input matInput formControlName=\"email\">\r\n        </mat-form-field>\r\n\r\n        <mat-form-field appearance=\"outline\">\r\n          <mat-label>Facebook</mat-label>\r\n          <input matInput formControlName=\"facebook\">\r\n        </mat-form-field>\r\n\r\n        <mat-form-field appearance=\"outline\">\r\n          <mat-label>Nhóm</mat-label>\r\n          <input matInput formControlName=\"group\">\r\n        </mat-form-field>\r\n\r\n        <mat-form-field appearance=\"outline\">\r\n          <mat-label>Ghi chú</mat-label>\r\n          <textarea matInput formControlName=\"notes\"></textarea>\r\n          <mat-icon matSuffix class=\"edit-icon\">edit</mat-icon>\r\n        </mat-form-field>\r\n      </div>\r\n    </div>\r\n  </div>\r\n  <div mat-dialog-actions align=\"end\">\r\n    <button mat-stroked-button (click)=\"onCancel()\">Bỏ qua</button>\r\n    <button mat-flat-button color=\"primary\" (click)=\"onSave()\" [disabled]=\"isSaving\">\r\n      <mat-icon>save</mat-icon> Lưu\r\n    </button>\r\n  </div>\r\n</div>\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\add-customer\\add-customer.component.ts","messages":[{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":39,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":39,"endColumn":28},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":40,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":40,"endColumn":57},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":41,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":41,"endColumn":46},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1607,1610],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1607,1610],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":42,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":42,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":43,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":43,"endColumn":34},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":44,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":44,"endColumn":45}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, Inject } from '@angular/core';\r\nimport { FormBuilder, FormGroup, Validators, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatDialogRef, MAT_DIALOG_DATA, MatDialogModule } from '@angular/material/dialog';\r\nimport { KiotvietService } from '../../services/kiotviet.service';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatDatepickerModule } from '@angular/material/datepicker';\r\nimport { MatNativeDateModule } from '@angular/material/core';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatSnackBar, MatSnackBarModule } from '@angular/material/snack-bar';\r\nimport { CustomerService } from '../../services/customer.service';\r\n@Component({\r\n  selector: 'app-add-customer',\r\n  standalone: true,\r\n  imports: [\r\n    CommonModule,\r\n    ReactiveFormsModule,\r\n    MatDialogModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatButtonModule,\r\n    MatRadioModule,\r\n    MatDatepickerModule,\r\n    MatNativeDateModule,\r\n    MatIconModule,\r\n    MatSnackBarModule,\r\n  ],\r\n  templateUrl: './add-customer.component.html',\r\n  styleUrl: './add-customer.component.css'\r\n})\r\nexport class AddCustomerComponent {\r\n  customerForm: FormGroup;\r\n  isSaving = false;\r\n\r\n  constructor(\r\n    private fb: FormBuilder,\r\n    public dialogRef: MatDialogRef<AddCustomerComponent>,\r\n    @Inject(MAT_DIALOG_DATA) public data: any,\r\n    private kiotvietService: KiotvietService,\r\n    private snackBar: MatSnackBar,\r\n    private customerService: CustomerService\r\n  ) {\r\n    this.customerForm = this.fb.group({\r\n      code: [{ value: 'Mã mặc định', disabled: true }],\r\n      name: ['', Validators.required],\r\n      phone: ['', Validators.required],\r\n      dob: [null],\r\n      gender: [null],\r\n      address: [''],\r\n      area: [''],\r\n      ward: [''],\r\n      type: ['personal', Validators.required],\r\n      taxCode: [''],\r\n      idCard: [''],\r\n      email: ['', Validators.email],\r\n      facebook: [''],\r\n      group: [''],\r\n      notes: ['']\r\n    });\r\n  }\r\n\r\n  onSave(): void {\r\n    if (this.customerForm.invalid) {\r\n      this.snackBar.open('Vui lòng điền đầy đủ thông tin bắt buộc: Tên, SDT', 'Đóng', { duration: 3000 });\r\n      return;\r\n    }\r\n\r\n    this.isSaving = true;\r\n    const formValue = this.customerForm.getRawValue();\r\n\r\n    const payload = {\r\n      name: formValue.name,\r\n      phone: formValue.phone,\r\n      birthDate: formValue.dob,\r\n      address: formValue.address,\r\n      email: formValue.email,\r\n      type: formValue.type === 'personal' ? 0 : 1,\r\n      gender: formValue.gender,\r\n      taxCode: formValue.taxCode,\r\n      notes: formValue.notes,\r\n      organization: formValue.type === 'company' ? formValue.name : ''\r\n    };\r\n\r\n    this.kiotvietService.addCustomer(payload)\r\n      .then(response => {\r\n        this.isSaving = false;\r\n        this.snackBar.open('Thêm khách hàng đến kiotviet thành công!', 'Đóng', { duration: 3000 });\r\n        this.dialogRef.close(response);\r\n      })\r\n      .catch(error => {\r\n        this.isSaving = false;\r\n        this.snackBar.open('Có lỗi xảy ra, không thể thêm khách hàng.', 'Đóng', { duration: 3000 });\r\n        console.error('Error adding customer', error);\r\n      });\r\n\r\n    this.customerService.addCustomerTofireBase(payload).then(response => {\r\n      this.isSaving = false;\r\n      this.snackBar.open('Thêm khách hàng đến firebase thành công!', 'Đóng', { duration: 3000 });\r\n      this.dialogRef.close(response);\r\n    })\r\n      .catch(error => {\r\n        this.isSaving = false;\r\n        this.snackBar.open('Có lỗi xảy ra, không thể thêm khách hàng.', 'Đóng', { duration: 3000 });\r\n        console.error('Error adding customer', error);\r\n      });\r\n  }\r\n\r\n  onCancel(): void {\r\n    this.dialogRef.close();\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\confirm-popup\\confirm-popup.component.html","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\confirm-popup\\confirm-popup.component.ts","messages":[{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":12,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":12,"endColumn":58},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":13,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":13,"endColumn":62}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, Inject } from '@angular/core';\r\nimport { MAT_DIALOG_DATA, MatDialogRef } from '@angular/material/dialog';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\n@Component({\r\n  selector: 'app-confirm-popup',\r\n  templateUrl: './confirm-popup.component.html',\r\n  styleUrls: ['./confirm-popup.component.css'],\r\n  imports:[MatDialogModule]\r\n})\r\nexport class ConfirmPopupComponent {\r\n  constructor(\r\n    public dialogRef: MatDialogRef<ConfirmPopupComponent>,\r\n    @Inject(MAT_DIALOG_DATA) public data: { message: string }\r\n  ) {}\r\n\r\n  onConfirm(): void {\r\n    this.dialogRef.close(true); // User confirmed\r\n  }\r\n\r\n  onCancel(): void {\r\n    this.dialogRef.close(false); // User canceled\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\customers-page\\customers-page.component.html","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\customers-page\\customers-page.component.ts","messages":[{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":51,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":51,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":52,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":52,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":102,"column":5,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":104,"endColumn":71}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, OnInit, ViewChild, AfterViewInit } from '@angular/core';\r\nimport { MatTableDataSource, MatTableModule } from '@angular/material/table';\r\nimport { MatPaginator, MatPaginatorModule } from '@angular/material/paginator';\r\nimport { MatSort, MatSortModule } from '@angular/material/sort';\r\nimport { MatDialog, MatDialogModule } from '@angular/material/dialog';\r\nimport { SelectionModel } from '@angular/cdk/collections';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatProgressSpinnerModule } from '@angular/material/progress-spinner';\r\n\r\nimport { Customer } from '../../models/customer.model';\r\nimport { CustomerService } from '../../services/customer.service';\r\nimport { AddCustomerComponent } from '../add-customer/add-customer.component';\r\n\r\n@Component({\r\n  selector: 'app-customers-page',\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    MatTableModule,\r\n    MatPaginatorModule,\r\n    MatSortModule,\r\n    MatDialogModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatCheckboxModule,\r\n    MatProgressSpinnerModule\r\n  ],\r\n  templateUrl: './customers-page.component.html',\r\n  styleUrl: './customers-page.component.css'\r\n})\r\nexport class CustomersPageComponent implements OnInit, AfterViewInit {\r\n  displayedColumns: string[] = ['select', 'code', 'name', 'phone', 'debt', 'totalSpend'];\r\n  dataSource: MatTableDataSource<Customer> = new MatTableDataSource<Customer>();\r\n  selection = new SelectionModel<Customer>(true, []);\r\n  isLoading = true;\r\n  totalDebt = 0;\r\n  totalSpend = 0;\r\n\r\n  @ViewChild(MatPaginator) paginator!: MatPaginator;\r\n  @ViewChild(MatSort) sort!: MatSort;\r\n\r\n  constructor(\r\n    private customerService: CustomerService,\r\n    private dialog: MatDialog\r\n  ) { }\r\n\r\n  ngOnInit(): void {\r\n    this.loadCustomers();\r\n  }\r\n\r\n  ngAfterViewInit(): void {\r\n    this.dataSource.paginator = this.paginator;\r\n    this.dataSource.sort = this.sort;\r\n  }\r\n\r\n  async loadCustomers(): Promise<void> {\r\n    this.isLoading = true;\r\n    try {\r\n      // await this.customerService.loadCustomersFromKiotvietToIndexedDB();\r\n      const customers = await this.customerService.getAllCustomersFromIndexedDB();\r\n       // Sort customers by ID descending to show newest first\r\n      customers.sort((a, b) => (b.Id ?? 0) - (a.Id ?? 0));\r\n      this.dataSource.data = customers;\r\n      this.calculateTotals(customers);\r\n    } catch (error) {\r\n      console.error('Error loading customers:', error);\r\n    } finally {\r\n      this.isLoading = false;\r\n    }\r\n  }\r\n  \r\n  calculateTotals(customers: Customer[]): void {\r\n    this.totalDebt = customers.reduce((sum, customer) => sum + (customer.Debt ?? 0), 0);\r\n    this.totalSpend = customers.reduce((sum, customer) => sum + (customer.TotalRevenue ?? 0), 0);\r\n  }\r\n\r\n  applyFilter(event: Event): void {\r\n    const filterValue = (event.target as HTMLInputElement).value;\r\n    this.dataSource.filter = filterValue.trim().toLowerCase();\r\n\r\n    if (this.dataSource.paginator) {\r\n      this.dataSource.paginator.firstPage();\r\n    }\r\n    this.calculateTotals(this.dataSource.filteredData);\r\n  }\r\n\r\n  isAllSelected(): boolean {\r\n    const numSelected = this.selection.selected.length;\r\n    const numRows = this.dataSource.data.length;\r\n    return numSelected === numRows;\r\n  }\r\n\r\n  masterToggle(): void {\r\n    this.isAllSelected() ?\r\n      this.selection.clear() :\r\n      this.dataSource.data.forEach(row => this.selection.select(row));\r\n  }\r\n\r\n  checkboxLabel(row?: Customer): string {\r\n    if (!row) {\r\n      return `${this.isAllSelected() ? 'select' : 'deselect'} all`;\r\n    }\r\n    return `${this.selection.isSelected(row) ? 'deselect' : 'select'} row ${row.Id}`;\r\n  }\r\n\r\n  openAddCustomerDialog(): void {\r\n    const dialogRef = this.dialog.open(AddCustomerComponent, {\r\n      width: '900px',\r\n      maxHeight: '95vh',\r\n      disableClose: true,\r\n    });\r\n\r\n    dialogRef.afterClosed().subscribe(result => {\r\n      if (result) {\r\n        this.loadCustomers();\r\n      }\r\n    });\r\n  }\r\n\r\n  getSelectedCount(): number {\r\n    return this.selection.selected.length;\r\n  }\r\n\r\n  async deleteSelectedCustomers(): Promise<void> {\r\n    const selectedCustomers = this.selection.selected;\r\n    \r\n    if (selectedCustomers.length === 0) {\r\n      alert('Vui lòng chọn khách hàng cần xóa');\r\n      return;\r\n    }\r\n\r\n    const confirmed = confirm(`Bạn có chắc chắn muốn xóa ${selectedCustomers.length} khách hàng đã chọn?`);\r\n    if (!confirmed) {\r\n      return;\r\n    }\r\n\r\n    this.isLoading = true;\r\n    try {\r\n      for (const customer of selectedCustomers) {\r\n        await this.customerService.deleteCustomerFromIndexedDB(customer.Id);\r\n        // Nếu có API để xóa khỏi KiotViet, gọi ở đây\r\n        // await this.customerService.deleteCustomerFromKiotviet(customer.Id);\r\n      }\r\n      \r\n      // Reload data sau khi xóa\r\n      await this.loadCustomers();\r\n      this.selection.clear();\r\n      \r\n      alert(`Đã xóa thành công ${selectedCustomers.length} khách hàng`);\r\n    } catch (error) {\r\n      console.error('Lỗi khi xóa khách hàng:', error);\r\n      alert('Có lỗi xảy ra khi xóa khách hàng');\r\n    } finally {\r\n      this.isLoading = false;\r\n    }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\DataFunction\\app.load-data.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":7,"column":9,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":12,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[234,237],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[234,237],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":8,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[274,277],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[274,277],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1477,1480],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1477,1480],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":42,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1512,1515],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1512,1515],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":43,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1553,1556],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1553,1556],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":114,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":114,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4311,4314],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4311,4314],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { catchError, map, of } from \"rxjs\";\r\nimport { sortByGroup } from \"../utility-functions/app.sort\";\r\nimport { environment } from '../../../../environments/environment';\r\n\r\nexport function loadData(\r\n  category: string,\r\n  http: any,\r\n  setFilteredProducts: (products: any[]) => void, // Callback để cập nhật filteredProducts\r\n  setLoading: (isLoading: boolean) => void, // Callback để cập nhật trạng thái loading\r\n  setShowLowStockWarning: (show: boolean) => void // Callback để cập nhật cảnh báo tồn kho thấp\r\n) {\r\n  const cachedProducts = localStorage.getItem(`products_${category}`);\r\n  setLoading(true); // Bắt đầu loading\r\n\r\n  // Nếu có dữ liệu trong Local Storage, sử dụng dữ liệu đó\r\n  if (cachedProducts) {\r\n    const products = JSON.parse(cachedProducts);\r\n    const sortedProducts = sortByGroup(products);\r\n    setFilteredProducts(sortedProducts); // Cập nhật filteredProducts\r\n    setShowLowStockWarning(\r\n      sortedProducts.some(\r\n        (product) => product.OnHand < 3 && !/thùng/i.test(product.Unit) && !/lốc/i.test(product.Unit)\r\n      )\r\n    );\r\n    setLoading(false); // Kết thúc loading\r\n    return;\r\n  }\r\n\r\n  const apiUrl = `${environment.domainUrl}/api/items/${category}`;\r\n\r\n  if (category === 'all') {\r\n    setFilteredProducts([]); // Xóa danh sách nếu chọn \"TẤT CẢ\"\r\n    setLoading(false);\r\n    setShowLowStockWarning(false); // Không có cảnh báo cho danh mục \"TẤT CẢ\"\r\n    return;\r\n  }\r\n\r\n  http\r\n    .get(apiUrl)\r\n    .pipe(\r\n      map((data: any) => {\r\n        const products: any[] = [];\r\n        data.forEach((item: any) => {\r\n          if (item.UnitList && item.UnitList.length > 0) {\r\n            // item.UnitList.forEach((unit: any) => {\r\n            products.push({\r\n              Image: item.Image || '',\r\n              Code: item.Code || '',\r\n              FullName: item.FullName || '',\r\n              AverageCheckPoint: item.AverageCheckPoint || false,\r\n              BasePrice: item.BasePrice || 0,\r\n              FinalBasePrice: item.FinalBasePrice || 0,\r\n              OnHand: item.OnHand || 0,\r\n              Cost: item.LatestPurchasePrice || 0,\r\n              PackCost: item.PackCost || 0,\r\n              OriginalBoxPrice: item.OriginalBoxPrice || 0,\r\n              Description: item.Description\r\n                ? item.Description.replace(/<\\/?[^>]+(>|$)/g, '')\r\n                : '',\r\n              Unit: item.UnitName || '',\r\n              PackingSpec: item.PackingSpec || 0,\r\n              UnitSpec: item.UnitSpec || 0,\r\n              Retail: item.Retail || 0,\r\n              Box: item.Box || 0,\r\n              Discount: item.Discount || 0,\r\n              Discoun2: item.Discount2 || 0,\r\n              ConversionValue: item.ConversionValue || 0,\r\n              TotalPrice: item.TotalPrice || 0,\r\n              GroupName: item.Name,\r\n              Edited: false,\r\n              Master: false,\r\n              Id: item.Id\r\n\r\n            });\r\n            // });\r\n          } else {\r\n            products.push({\r\n              Image: item.Image,\r\n              Code: item.Code,\r\n              FullName: item.FullName,\r\n              AverageCheckPoint: item.AverageCheckPoint || false,\r\n              BasePrice: item.BasePrice || 0,\r\n              FinalBasePrice: item.FinalBasePrice || 0,\r\n              OnHand: item.OnHand || 0,\r\n              Cost: item.Cost || 0,\r\n              PackCost: item.PackCost || 0,\r\n              OriginalBoxPrice: item.OriginalBoxPrice || 0,\r\n              Description: item.Description\r\n                ? item.Description.replace(/<\\/?[^>]+(>|$)/g, '')\r\n                : '',\r\n              Unit: item.Unit || '',\r\n              PackingSpec: item.PackingSpec || 0,\r\n              UnitSpec: item.UnitSpec || 0,\r\n              Retail: item.Retail || 0,\r\n              Box: item.Box || 0,\r\n              Discount: item.Discount || 0,\r\n              Discount2: item.Discount2 || 0,\r\n              ConversionValue: item.ConversionValue || 0,\r\n              TotalPrice: item.TotalPrice || '0',\r\n              GroupName: item.Name,\r\n              Master: false,\r\n              Id: item.Id\r\n            });\r\n          }\r\n        });\r\n        return products;\r\n      }),\r\n      catchError((err) => {\r\n        console.error('❌ Lỗi API:', err);\r\n        setLoading(false);\r\n        return of([]);\r\n      })\r\n    )\r\n    .subscribe((products: any[]) => {\r\n      const sortedProducts = sortByGroup(products);\r\n      setFilteredProducts(sortedProducts); // Cập nhật filteredProducts\r\n      localStorage.setItem(`products_${category}`, JSON.stringify(products)); // Lưu sản phẩm vào Local Storage\r\n      setShowLowStockWarning(\r\n        sortedProducts.some(\r\n          (product) => product.OnHand < 3 && !/thùng/i.test(product.Unit) && !/lốc/i.test(product.Unit)\r\n        )\r\n      );\r\n      setLoading(false); // Kết thúc loading\r\n    });\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\DataFunction\\app.save.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_' is defined but never used.","line":7,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":13},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":9,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[333,336],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[333,336],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":15,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[509,512],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[509,512],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":25,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[812,815],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[812,815],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":43,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1382,1385],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1382,1385],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":55,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1634,1637],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1634,1637],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { showNotification } from \"../utility-functions/app.notification\";\r\n\r\nexport function onSave(searchTerm: string) {\r\n\r\n  const editedProducts = Object.entries(localStorage)\r\n    .filter(([key]) => key.startsWith(\"editing_childProduct_\"))\r\n    .map(([_, value]) => JSON.parse(value));\r\n\r\n  const groupedProducts: Record<string, any[]> = {};\r\n\r\n  editedProducts.forEach((product) => {\r\n\r\n    if (product.ListProduct && product.ListProduct.length > 0) {\r\n\r\n      product.ListProduct.forEach((childProduct: any) => {\r\n        if (!groupedProducts[product.Code]) {\r\n          groupedProducts[product.Code] = [];\r\n        }\r\n        groupedProducts[product.Code].push(\r\n          editedProducts.find((p) => p.Code === childProduct.Code) || childProduct\r\n        );\r\n      });\r\n    }\r\n  });\r\n  const masterItems: any[] = [];\r\n\r\n  Object.entries(groupedProducts).forEach((key) => {\r\n    const masterItem = key[1].find((a) => a.Master === true);\r\n    if (masterItem && !masterItems.some((item) => item.Code === masterItem.Code)) {\r\n      masterItems.push(masterItem);\r\n    }\r\n    if (!masterItems.some((item) => item.Code === key[0])) {\r\n      delete groupedProducts[key[0]];\r\n    }\r\n  })\r\n  allEditedProducts.push(groupedProducts);\r\n  saveToLocalStorage(searchTerm, allEditedProducts);\r\n  cleanLocalStorage();\r\n\r\n\r\n  showNotification('Đã lưu thành công !')\r\n}\r\nlet allEditedProducts: any[] = [];\r\n\r\nfunction cleanLocalStorage(): void {\r\n  Object.keys(localStorage).forEach((k) => {\r\n    if (k && k.startsWith('editing_')) {\r\n\r\n      localStorage.removeItem(k);\r\n    }\r\n  })\r\n\r\n}\r\n\r\nfunction saveToLocalStorage(searchTerm: string, data: any): void {\r\n  localStorage.setItem(`edited_products_${searchTerm}`, JSON.stringify(data));\r\n\r\n}\r\n\r\nexport function clearCache(): void {\r\n  try {\r\n    // Get all keys that start with our prefixes\r\n    const keysToRemove: string[] = [];\r\n    for (let i = 0; i < localStorage.length; i++) {\r\n      const key = localStorage.key(i);\r\n      if (key && (\r\n        key.startsWith('grouped_') ||\r\n        key.startsWith('search_') ||\r\n        key.startsWith('edited_products_') ||\r\n        key.startsWith('editing_childProduct_')\r\n      )) {\r\n        keysToRemove.push(key);\r\n      }\r\n    }\r\n\r\n    // Remove all identified keys\r\n    keysToRemove.forEach(key => localStorage.removeItem(key));\r\n  } catch (error) {\r\n    console.error('Error clearing all localStorage data:', error);\r\n  }\r\n  allEditedProducts = []\r\n  showNotification('Đã xóa cache thành công !')\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\DataFunction\\app.search.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":82,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2425,2428],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2425,2428],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":93,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":93,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2722,2725],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2722,2725],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":104,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":104,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3098,3101],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3098,3101],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":112,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":112,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3496,3499],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3496,3499],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":140,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":140,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4653,4656],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4653,4656],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":183,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":183,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5889,5892],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5889,5892],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { catchError, forkJoin, map, Observable, of, switchMap } from \"rxjs\";\r\nimport { assignColorsToProductList } from \"../utility-functions/app.color\";\r\nimport { sortByGroup } from \"../utility-functions/app.sort\";\r\nimport { groupProducts } from \"../utility-functions/app.group-item\";\r\nimport { environment } from '../../../../environments/environment';\r\nimport { HttpClient } from \"@angular/common/http\";\r\n\r\ninterface Product {\r\n    Image: string;\r\n    Code: string;\r\n    FullName: string;\r\n    Name: string;\r\n    AverageCheckPoint: false,\r\n    BasePrice: number;\r\n    FinalBasePrice: number,\r\n    OnHand: number;\r\n    Cost: number;\r\n    PackCost: number;\r\n    OriginalBoxPrice: number;\r\n    Description: string;\r\n    Unit: string;\r\n    PackingSpec: number;\r\n    UnitSpec: number;\r\n    Retail: number;\r\n    Box: number;\r\n    Discount: number;\r\n    Discount2: number;\r\n    TotalPrice: number;\r\n    ListProduct: [];\r\n    ConversionValue: number;\r\n    GroupName: string;\r\n    Edited: boolean;\r\n    Master: boolean;\r\n    Id: number\r\n}\r\n\r\nconst item_search_url=\"/api/kiotviet/item/\"\r\n\r\nexport function onSearch(\r\n    http: HttpClient,\r\n    productColors: Record<string, string>,\r\n    filteredProducts: Product[],\r\n    setLoading: (loading: boolean) => void,\r\n    searchTerm: string,\r\n    loadData: (data: Product[]) => void\r\n) {\r\n    if (!searchTerm) {\r\n        filteredProducts = [];\r\n        loadData(filteredProducts);\r\n        return;\r\n    }\r\n\r\n    // Try to get data from localStorage first\r\n    const cachedData = getCachedData(searchTerm);\r\n    if (cachedData) {\r\n        handleCachedData(cachedData, filteredProducts, productColors, setLoading, loadData,);\r\n        return;\r\n    }\r\n\r\n    // If no cached data, fetch from API\r\n    fetchFromAPI(http, searchTerm, productColors, filteredProducts, setLoading, loadData);\r\n}\r\n\r\nfunction getCachedData(searchTerm: string): Product[] | null {\r\n    const st = searchTerm.replace(/ /g, '_');\r\n    const groupedKey = `grouped_${st}`;\r\n    const groupedData = localStorage.getItem(groupedKey);\r\n\r\n    if (groupedData) {\r\n        return JSON.parse(groupedData);\r\n    }\r\n    return null;\r\n}\r\n\r\nfunction handleCachedData(\r\n    cachedData: Product[],\r\n    filteredProducts: Product[],\r\n    productColors: Record<string, string>,\r\n    setLoading: (loading: boolean) => void,\r\n    loadData: (data: Product[]) => void,\r\n) {\r\n    filteredProducts = Object.keys(cachedData).reduce((acc, k: any) => {\r\n        return acc.concat(cachedData[k]);\r\n    }, [] as Product[]);\r\n\r\n    assignColorsToProductList(filteredProducts, productColors);\r\n    filteredProducts = sortByGroup(filteredProducts);\r\n    setLoading(false)\r\n    loadData(filteredProducts);\r\n}\r\n\r\nfunction fetchFromAPI(\r\n    http: any,\r\n    searchTerm: string,\r\n    productColors: Record<string, string>,\r\n    filteredProducts: Product[],\r\n    setLoading: (loading: boolean) => void,\r\n    loadData: (data: Product[]) => void\r\n) {\r\n    setLoading(true);\r\n    const st = searchTerm.replace(/ /g, '_');\r\n\r\n    http.get(`${environment.domainUrl}${item_search_url}${searchTerm}`).pipe(\r\n        switchMap((data: any[]) => {\r\n            const products = transformApiData(data);\r\n            const requests: Observable<Product[]>[] = [];\r\n\r\n            const fetchedCodes = new Set<string>(); // Để lưu những item.Code đã gọi API\r\n\r\n            products.forEach((product) => {\r\n                if (product.ListProduct && product.ListProduct.length > 0) {\r\n                    product.ListProduct.forEach((item: any) => {\r\n                        const exists = products.some(p => p.Code === item.Code);\r\n                        const alreadyFetched = fetchedCodes.has(item.Code);\r\n\r\n                        if (!exists && !alreadyFetched) {\r\n                            console.log(`Không tìm thấy item ${item.Code} từ KiotViet API`);\r\n\r\n                            fetchedCodes.add(item.Code); // Đánh dấu đã fetch\r\n\r\n                            // Push observable request vào mảng\r\n                            requests.push(\r\n                                http.get(`${environment.domainUrl}${item_search_url}${item.Code}`).pipe(\r\n                                    map((res: Product[]) => res[0])\r\n                                )\r\n                            );\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n\r\n\r\n            // Nếu không có request nào => trả về nguyên products\r\n            if (requests.length === 0) {\r\n                return of(products);\r\n            }\r\n\r\n            // Đợi tất cả request hoàn tất rồi merge vào products\r\n            return forkJoin(requests).pipe(\r\n                map((results: any[][]) => {\r\n                    const c = transformApiData(results);\r\n\r\n                    c.forEach((childArray) => {\r\n                        if (childArray) {\r\n                            products.push(childArray);\r\n                        }\r\n                    });\r\n\r\n                    return products;\r\n                })\r\n            );\r\n        }),\r\n        map((products: Product[]) => {\r\n            const groupedProducts = groupProducts(products);\r\n\r\n            localStorage.setItem(`grouped_${st}`, JSON.stringify(groupedProducts));\r\n\r\n\r\n            return products;\r\n        }),\r\n        catchError((err) => {\r\n            console.error('❌ Lỗi khi tìm kiếm:', err);\r\n            setLoading(false);\r\n            return of([]);\r\n        })\r\n    ).subscribe((products: Product[]) => {\r\n\r\n        const newProducts = processProducts(products, searchTerm);\r\n        filteredProducts = newProducts;\r\n\r\n        assignColorsToProductList(filteredProducts, productColors);\r\n        filteredProducts = sortByGroup(filteredProducts);\r\n\r\n        localStorage.setItem(`search_${st}`, JSON.stringify(products));\r\n\r\n        setLoading(false);\r\n        loadData(filteredProducts);\r\n    });\r\n\r\n\r\n}\r\n\r\nfunction transformApiData(data: any[]): Product[] {\r\n    return data.map(item => ({\r\n        Image: item.Image,\r\n        Name: item.Name,\r\n        Code: item.Code,\r\n        FullName: item.Name,\r\n        AverageCheckPoint: item.AverageCheckPoint || false,\r\n        BasePrice: item.BasePrice || 0,\r\n        FinalBasePrice: item.FinalBasePrice || 0,\r\n        OnHand: item.OnHand || 0,\r\n        Cost: item.Cost || 0,\r\n        PackCost: item.PackCost || 0,\r\n        OriginalBoxPrice: item.OriginalBoxPrice || 0,\r\n        Description: item.Description ? item.Description.replace(/<\\/?[^>]+(>|$)/g, '') : '',\r\n        Unit: item.Unit || '',\r\n        PackingSpec: item.PackingSpec || 0,\r\n        UnitSpec: item.UnitSpec || 0,\r\n        Retail: item.Retail || 0,\r\n        Box: item.Box || 0,\r\n        Discount: item.Discount || 0,\r\n        Discount2: item.Discoun2 || 0,\r\n        TotalPrice: item.TotalPrice || 0,\r\n        ListProduct: item.ListProductUnit || 0,\r\n        ConversionValue: item.ConversionValue || 0,\r\n        GroupName: item.Name,\r\n        Edited: false,\r\n        Master: false,\r\n        Id: item.Id\r\n    }));\r\n}\r\n\r\nfunction processProducts(products: Product[], searchTerm: string): Product[] {\r\n    const newProducts: Product[] = [];\r\n\r\n    const groupedProductsResult = JSON.parse(localStorage.getItem(`grouped_${searchTerm.replace(/ /g, '_')}`) || '{}');\r\n\r\n    products.forEach((product) => {\r\n        if (groupedProductsResult[product.Code]) {\r\n            groupedProductsResult[product.Code].forEach((p: Product) => {\r\n                newProducts.push(p);\r\n            });\r\n        }\r\n    });\r\n\r\n    // Apply edited data if exists\r\n    const cachedEditedProducts = localStorage.getItem(`edited_${searchTerm}`);\r\n    if (cachedEditedProducts) {\r\n        const editedProducts = JSON.parse(cachedEditedProducts);\r\n        newProducts.forEach((product) => {\r\n            const editedProduct = editedProducts.find((p: Product) => p.Code === product.Code);\r\n            if (editedProduct) {\r\n                Object.assign(product, editedProduct);\r\n            }\r\n        });\r\n    }\r\n\r\n    return newProducts;\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\DataFunction\\app.send-data-to-kiotviet.ts","messages":[{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":7,"column":18,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":7,"endColumn":58},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":9,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[311,314],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[311,314],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":9,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[338,341],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[338,341],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":9,"column":85,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":88,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[354,357],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[354,357],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1031,1034],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1031,1034],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from \"@angular/core\";\r\nimport { KiotvietService } from \"../../../services/kiotviet.service\";\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class SendDataToKiotVietService {\r\n    constructor( private kiotvietService: KiotvietService) { } \r\n    \r\n    async sendProductData(editedProduct: any, remainEditedProducts: any[]): Promise<any> {\r\n\r\n        const formDataGetFromKiotViet = await this.kiotvietService.getRequestBody(editedProduct.Id)\r\n\r\n\r\n        formDataGetFromKiotViet.Product.Code = editedProduct.Code;\r\n        formDataGetFromKiotViet.Product.FullName = editedProduct.FullName;\r\n        formDataGetFromKiotViet.Product.BasePrice = editedProduct.BasePrice;\r\n        formDataGetFromKiotViet.Product.Cost = editedProduct.Cost;\r\n        formDataGetFromKiotViet.Product.Description = editedProduct.Description;\r\n        formDataGetFromKiotViet.Product.OnHand = editedProduct.OnHand\r\n        remainEditedProducts.forEach((ep) => {\r\n\r\n            formDataGetFromKiotViet.Product.ProductUnits.forEach((p: any) => {\r\n                if (ep.Code === p.Code) {\r\n                    p.BasePrice = ep.BasePrice\r\n                }\r\n            })\r\n\r\n        })\r\n        await this.kiotvietService.updateProductToKiotviet(formDataGetFromKiotViet);\r\n    }\r\n\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\edit-product-page.component.html","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\edit-product-page.component.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Inject' is defined but never used.","line":1,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":35},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'of' is defined but never used.","line":3,"column":22,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'MatDialogRef' is defined but never used.","line":11,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'MAT_DIALOG_DATA' is defined but never used.","line":11,"column":52,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":67},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Routes' is defined but never used.","line":12,"column":24,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'IndexedDBService' is defined but never used.","line":28,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":28,"endColumn":26},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":32,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1811,1814],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1811,1814],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@angular-eslint/component-selector","severity":2,"message":"The selector should start with one of these prefixes: \"app\" (https://angular.dev/style-guide#style-02-07)","line":35,"column":13,"nodeType":"Literal","messageId":"prefixFailure","endLine":35,"endColumn":32},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":68,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2751,2754],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2751,2754],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":70,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2805,2808],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2805,2808],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":72,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2864,2867],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2864,2867],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":97,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":97,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3360,3363],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3360,3363],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":98,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":98,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3380,3383],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3380,3383],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":100,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":100,"endColumn":29},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":101,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":101,"endColumn":29},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":102,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":102,"endColumn":37},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":103,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":103,"endColumn":27},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":113,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":113,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3868,3871],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3868,3871],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":120,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4071,4074],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4071,4074],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":147,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":147,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4918,4921],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4918,4921],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":154,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":154,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5263,5266],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5263,5266],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":201,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":201,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6856,6859],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6856,6859],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":226,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":226,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7644,7647],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7644,7647],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":239,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":239,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8010,8013],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8010,8013],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":244,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":244,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8156,8159],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8156,8159],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":244,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":244,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8170,8173],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8170,8173],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":250,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":250,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8357,8360],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8357,8360],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":250,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":250,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8371,8374],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8371,8374],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":256,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":256,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8560,8563],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8560,8563],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":256,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":256,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8574,8577],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8574,8577],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":263,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":263,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8769,8772],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8769,8772],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":263,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":263,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8783,8786],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8783,8786],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":269,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":269,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8976,8979],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8976,8979],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":269,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":269,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8990,8993],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8990,8993],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":291,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":291,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9762,9765],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9762,9765],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":292,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":292,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9817,9820],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9817,9820],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":293,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":293,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9859,9862],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9859,9862],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":298,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":298,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9976,9979],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9976,9979],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":302,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":302,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10106,10109],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10106,10109],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":306,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":306,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10202,10205],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10202,10205],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":307,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":307,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10266,10269],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10266,10269],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":308,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":308,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10308,10311],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10308,10311],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":313,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":313,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10517,10520],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10517,10520],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":338,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":338,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11088,11091],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11088,11091],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_' is defined but never used.","line":364,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":364,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":377,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":377,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13334,13337],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13334,13337],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":46,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, OnInit, Inject, NgZone } from '@angular/core';\nimport { HttpClient } from '@angular/common/http';\nimport { Observable, of } from 'rxjs';\nimport { map, startWith } from 'rxjs/operators';\nimport { CommonModule } from '@angular/common';\nimport { MatTableModule } from '@angular/material/table';\nimport { MatCardModule } from '@angular/material/card';\nimport { MatToolbarModule } from '@angular/material/toolbar';\nimport { MatButtonModule } from '@angular/material/button';\nimport { MatTooltipModule } from '@angular/material/tooltip';\nimport { MatDialog, MatDialogModule, MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\nimport { RouterModule, Routes } from '@angular/router';\nimport { FormsModule, FormControl, ReactiveFormsModule } from '@angular/forms';\nimport { MatIconModule } from '@angular/material/icon';\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\nimport { MatFormFieldModule } from '@angular/material/form-field';\nimport { MatInputModule } from '@angular/material/input';\nimport { assignColorsToProductList } from './utility-functions/app.color';\nimport { validateNumber } from './utility-functions/app.validate-number';\nimport { onSearch } from './DataFunction/app.search';\nimport { onSave, clearCache } from './DataFunction/app.save';\nimport { showEditedProducts } from './utility-functions/app.show';\nimport { loadData } from './DataFunction/app.load-data';\nimport { CostService } from './services/cost.service';\nimport { InputDialog } from './input-dialog.component';\nimport { LowStockDialog } from './low-stock-dialog.component';\nimport { EditedItemDialog } from './edited-products-dialog.component';\nimport { IndexedDBService } from '../../services/indexed-db.service';\n\n\ninterface IWindow extends Window {\n  webkitSpeechRecognition: any;\n}\n@Component({\n  selector: 'edit-product-page',\n  standalone: true,\n  imports: [\n    CommonModule,\n    MatCardModule,\n    MatToolbarModule,\n    MatButtonModule,\n    MatTableModule,\n    MatTooltipModule,\n    MatDialogModule,\n    RouterModule,\n    FormsModule,\n    MatAutocompleteModule,\n    MatFormFieldModule,\n    MatInputModule,\n    ReactiveFormsModule,\n    MatIconModule\n  ],\n  templateUrl: './edit-product-page.component.html',\n  styleUrls: [\n    './edit-product-page.component.css',\n    './button.component.css',\n    './category.component.css'\n  ],\n})\n\nexport class EditProductPageComponent implements OnInit {\n\n  searchControl = new FormControl('');\n  filteredOptions!: Observable<{ value: string; FullName: string; Image: string; }[]>;\n  options: { FullName: string; Image: string }[] = []; // Replace with your data source\n\n  productColors: Record<string, string> = {}; // Lưu màu sắc cho từng nhóm ProductList\n  displayedRows: any[] = [];\n  isLoading = false;\n  data$!: Observable<any[]>;\n  error: string | null = null;\n  filteredProducts: any[] = [];\n  categories: { id?: number; name: string; path: string; }[] = [];\n  activeCategory: string | null = null;\n  displayedColumns: string[] = [\n    'Image',\n    'Code',\n    'FullName',\n    'AverageCheckPoint',\n    'FinalBasePrice',\n    'BasePrice',\n    'Cost',\n    'OnHand',\n    'Unit',\n    // 'PackCost',\n    // 'OriginalBoxPrice',\n    // 'Description',\n    // 'PackingSpec',\n    'UnitSpec',\n    'Box',\n    'Retail',\n    'Discount',\n    'Discount2',\n    'TotalPrice'\n\n  ];\n  dataSource: any;\n  recognition: any;\n  constructor(\n    private http: HttpClient,\n    public dialog: MatDialog,\n    private costService: CostService,\n    private ngZone: NgZone,\n\n\n  ) {\n    const { webkitSpeechRecognition }: IWindow = (window as unknown) as IWindow;\n    this.recognition = new webkitSpeechRecognition();\n    this.recognition.lang = 'vi-VN'; // hoặc 'en-US' nếu muốn tiếng Anh\n    this.recognition.continuous = false;\n    this.recognition.interimResults = false;\n\n    this.recognition.onresult = (event: any) => {\n      const transcript = event.results[0][0].transcript;\n      this.ngZone.run(() => {\n        this.searchControl.setValue(transcript);\n      });\n    };\n\n    this.recognition.onerror = (event: any) => {\n      console.error('Lỗi khi nhận giọng nói:', event.error);\n    };\n\n  }\n  startVoiceInput() {\n    this.recognition.start();\n  }\n  activeButton = '';\n  userChangedFinalBasePrice = false;\n  changedFinalBasePrice = '';\n  ngOnInit() {\n    // const groupedProducts = groupProducts(this.filteredProducts);\n    assignColorsToProductList(this.filteredProducts, this.productColors);\n    this.filteredOptions = this.searchControl.valueChanges.pipe(\n      startWith(''),\n      map(value => this._filter(value || ''))\n    );\n\n    this.searchControl.valueChanges.subscribe(value => {\n      const selectedOption = this.options.find(option => option.FullName === value);\n      if (selectedOption) {\n        this.searchTerm = selectedOption.FullName; // Update searchTerm with the selected option\n      }\n    });\n  }\n\n  private _filter(value: string): any[] {\n    const filterValue = value.toLowerCase();\n    const searchKeys = Object.keys(localStorage).filter((key) => key.startsWith(\"search_\"));\n\n    const allGroupedProducts = searchKeys.map((key) => JSON.parse(localStorage.getItem(key) || \"[]\"));\n\n    this.options = allGroupedProducts.flatMap(product =>\n      product.map((item: { FullName: any; Image: string; }) => ({\n        FullName: item.FullName,\n        Image: item.Image\n      }))\n    );\n    return this.options.filter(option => option.FullName.toLowerCase().includes(filterValue));\n  }\n\n  loadData(category: string) {\n    loadData(\n      category,\n      this.http,\n      (products) => (this.filteredProducts = products), // Cập nhật filteredProducts\n      (isLoading) => (this.isLoading = isLoading), // Cập nhật trạng thái loading\n      (showWarning) => (this.showLowStockWarning = showWarning) // Cập nhật cảnh báo tồn kho thấp\n    );\n  }\n  // Hàm xử lý sự kiện khi người dùng nhấp vào danh mục\n\n  onCategoryClick(category: string) {\n    this.activeCategory = category; // Cập nhật danh mục đang hoạt động\n    loadData(\n      category,\n      this.http,\n      (products) => (this.filteredProducts = products), // Cập nhật filteredProducts\n      (isLoading) => (this.isLoading = isLoading), // Cập nhật trạng thái loading\n      (showWarning) => (this.showLowStockWarning = showWarning) // Cập nhật cảnh báo tồn kho thấp\n    );\n  }\n\n\n  getProductColor(productCode: string): string {\n    return this.productColors[productCode] || '#ffffff'; // Mặc định là màu trắng\n  }\n\n  searchTerm = '';\n  onSearch(event: Event) {\n\n    this.searchTerm = (event.target as HTMLInputElement).value.trim().toLowerCase();\n    // Sử dụng search từ IndexedDB thay vì onSearch cũ\n    onSearch(this.http,\n      this.productColors,\n      this.filteredProducts,\n      (isLoading) => (this.isLoading = isLoading),\n      this.searchTerm, (data) => this.filteredProducts = data);\n  }\n\n  lowStockProducts: any[] = []; // Biến để lưu danh sách sản phẩm tồn kho thấp\n  showLowStockWarning = false; // Biến để kiểm soát hiển thị dấu chấm than\n\n  checkRemains() {\n    // Lọc các sản phẩm có OnHand < 3\n    this.lowStockProducts = this.filteredProducts.filter(product => product.OnHand < 3 && !/thùng/i.test(product.Unit) && !/lốc/i.test(product.Unit));\n    this.showLowStockWarning = this.lowStockProducts.length > 0;\n\n    // Mở popup hiển thị danh sách sản phẩm tồn kho thấp\n    this.dialog.open(LowStockDialog, {\n      width: '600px',\n      data: { products: this.lowStockProducts }\n    });\n  }\n\n  onSave() {\n    onSave(this.searchTerm);\n  }\n  clearCache() {\n    clearCache()\n  }\n  showEditedProducts() {\n    showEditedProducts(this.searchTerm, this.filteredProducts);\n  }\n\n  updateCost(element: any) {\n    if (element.Master) {\n      this.costService.updateCostMaster(element);\n      this.costService.updateCostChildItems(this.filteredProducts);\n    } else {\n      this.costService.updateFinalBasePrice(this.changedFinalBasePrice, this.filteredProducts);\n    }\n  }\n\n  validateNumber(event: KeyboardEvent) {\n    validateNumber(event);\n  }\n\n  formatNumber(value: any): string {\n    const num = Number(value);\n    if (isNaN(num)) return '';\n    return num.toLocaleString('en-US');\n  }\n  onInputDiscount(event: any, element: any) {\n    const input = event.target.value.replace(/,/g, ''); // Bỏ dấu phẩy\n    if (!isNaN(Number(input))) {\n      element.Discount = Number(input);\n    }\n  }\n  onInputDiscount2(event: any, element: any) {\n    const input = event.target.value.replace(/,/g, ''); // Bỏ dấu phẩy\n    if (!isNaN(Number(input))) {\n      element.Discount2 = Number(input);\n    }\n  }\n  onInputTotalPrice(event: any, element: any) {\n    const input = event.target.value.replace(/,/g, ''); // Bỏ dấu phẩy\n    if (!isNaN(Number(input))) {\n      element.TotalPrice = Number(input);\n    }\n  }\n\n  onInputFinalBasePrice(event: any, element: any) {\n    const input = event.target.value.replace(/,/g, ''); // Bỏ dấu phẩy\n    if (!isNaN(Number(input))) {\n      element.FinalBasePrice = Number(input);\n    }\n  }\n  onInputBasePrice(event: any, element: any) {\n    const input = event.target.value.replace(/,/g, ''); // Bỏ dấu phẩy\n    if (!isNaN(Number(input))) {\n      element.BasePrice = Number(input);\n    }\n  }\n\n  onInputFocus(event: FocusEvent) {\n    const input = event.target as HTMLInputElement;\n\n    input.classList.add('tabbed');\n    setTimeout(() => input.classList.remove('tabbed'), 300); // gỡ class sau hiệu ứng\n  }\n\n  onUpdate() {\n    const editedProducts = Object.keys(localStorage)\n      .filter((key) => key.startsWith(\"edited_products_\"))\n      .map((key) => JSON.parse(localStorage.getItem(key) || \"[]\"));\n    const oldProducts = Object.keys(localStorage)\n      .filter((key) => key.startsWith(\"grouped_\"))\n      .map((key) => JSON.parse(localStorage.getItem(key) || \"[]\"));\n\n    const editedProductKeys: any[] = [];\n    editedProducts.forEach((editedProduct: any) => {\n      editedProduct.forEach((i: any) => {\n        editedProductKeys.push(Object.keys(i))\n      })\n    })\n\n    editedProducts.forEach((editedProduct: any) => {\n\n      editedProductKeys.forEach((keys) => {\n        oldProducts.forEach((oldProduct) => {\n          keys.forEach((key: any) => {\n            if (oldProduct[key]) {\n\n\n              editedProduct.forEach((editedItem: any) => {\n                Object.values(editedItem).forEach((e: any) => {\n                  e.forEach((p: any) => {\n                    if (p.FinalBasePrice > 0) {\n                      p.BasePrice = p.FinalBasePrice\n                    }\n\n                    const matchingOldItem = oldProduct[key].find((oldItem: any) => oldItem.Code === p.Code);\n\n                    if (matchingOldItem) {\n                      p['OldCost'] = matchingOldItem.Cost;\n                      p['OldBasePrice'] = matchingOldItem.BasePrice;\n                    }\n                  })\n\n                })\n\n              });\n            }\n          })\n\n        });\n      });\n    });\n\n    this.dialog.open(EditedItemDialog, {\n      width: '70vw',   // hoặc '1000px'\n      height: 'auto',  // hoặc 'auto'\n      maxWidth: '100vw',\n      data: { products: editedProducts }\n    });\n  }\n  openInputDialog(element: any) {\n    const dialogRef = this.dialog.open(InputDialog, {\n      width: '80vw',   // hoặc '1000px'\n      height: 'auto',  // hoặc 'auto'\n      maxWidth: '100vw'\n    });\n    const currentCost = element.Cost;\n    dialogRef.afterClosed().subscribe(result => {\n      if (result !== undefined) {\n        element.Box = result.box\n        element.Retail = result.retail\n        element.Discount = result.discount\n        element.Discount2 = result.discount2\n        element.TotalPrice = result.totalPrice\n\n        element.Cost = (parseInt(element.TotalPrice) / (parseInt(element.Box) * parseInt(element.ConversionValue) + parseInt(element.Retail))) * parseInt(element.ConversionValue) || 0;\n\n        if (element.Discount2 > 0) {\n          element.Cost = (parseInt(element.TotalPrice) - parseInt(element.Discount2)) / (parseInt(element.Box) * parseInt(element.ConversionValue) + parseInt(element.Retail)) * parseInt(element.ConversionValue) || 0;\n        }\n        element.OnHand = ((parseFloat(element.OnHand) * parseInt(element.ConversionValue) + parseInt(element.Retail) + parseInt(element.Box) * parseInt(element.ConversionValue)) / parseInt(element.ConversionValue)) || 0\n        element.BasePrice = Math.round((parseInt(element.BasePrice) + (parseInt(element.Cost) - parseInt(currentCost))) / 100) * 100;\n\n        localStorage.setItem(`editing_childProduct_${element.Code}`, JSON.stringify(element));\n        const oldProducts = Object.entries(localStorage)\n          .filter(([key]) => key.startsWith(\"grouped_\"))\n          .map(([_, value]) => JSON.parse(value || \"[]\"));\n\n        this.costService.masterCode = element.Code;\n        this.costService.masterOnHand = element.OnHand;\n        this.costService.masterConversionValue = element.ConversionValue;\n        this.costService.masterDiscount = element.Discount;\n        this.costService.masterFinalBasePrice = element.FinalBasePrice;\n        this.costService.masterCost = element.Cost;\n        this.filteredProducts.forEach((currentItem) => {\n          oldProducts.forEach((oP) => {\n            const productGroup = oP[this.costService.masterCode];\n            if (productGroup) {\n              // Tìm sản phẩm trong nhóm sản phẩm\n              const matchingProduct = productGroup.find((o: any) => o.Code === currentItem.Code);\n              if (matchingProduct) {\n\n                if (currentItem.Master) {\n                  currentItem.Cost = Math.round(currentItem.Cost) || 0;\n                  currentItem.BasePrice = Math.round(currentItem.BasePrice * 100) / 100 || 0;\n                } else {\n                  currentItem.OnHand = (parseFloat(this.costService.masterOnHand) * parseFloat(this.costService.masterConversionValue)) / parseFloat(currentItem.ConversionValue) || 0;\n                  currentItem.Cost = Math.round((parseInt(this.costService.masterCost) / parseInt(this.costService.masterConversionValue) * parseInt(currentItem.ConversionValue)) || 0);\n                  if (parseInt(this.costService.masterDiscount) > 0) {\n                    currentItem.Cost = (currentItem.Cost - (parseInt(this.costService.masterDiscount) * parseInt(currentItem.ConversionValue))) || 0;\n                  }\n                  currentItem.BasePrice = Math.round((matchingProduct.BasePrice + (currentItem.Cost - matchingProduct.Cost)) / 100) * 100 || 0;\n                  if (parseInt(this.costService.masterFinalBasePrice) > 0) {\n                    currentItem.FinalBasePrice = Math.round((parseInt(this.costService.masterFinalBasePrice) / parseInt(this.costService.masterConversionValue) * parseInt(currentItem.ConversionValue)) || 0);\n\n                  }\n                }\n\n                currentItem.Edited = true;\n                if (!currentItem.Master) {\n                  localStorage.setItem(`editing_childProduct_${currentItem.Code}`, JSON.stringify(currentItem));\n                }\n              }\n            }\n          });\n        });\n      }\n    });\n  }\n}","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\edited-products-dialog.component.html","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\edited-products-dialog.component.ts","messages":[{"ruleId":"@angular-eslint/component-selector","severity":2,"message":"The selector should start with one of these prefixes: \"app\" (https://angular.dev/style-guide#style-02-07)","line":16,"column":13,"nodeType":"Literal","messageId":"prefixFailure","endLine":16,"endColumn":37},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":31,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1411,1414],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1411,1414],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":34,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":34,"endColumn":53},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":35,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":35,"endColumn":46},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":35,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1617,1620],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1617,1620],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":36,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":36,"endColumn":65},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":37,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":37,"endColumn":47},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":38,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":38,"endColumn":43},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":42,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1854,1857],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1854,1857],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":43,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1907,1910],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1907,1910],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":44,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1949,1952],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1949,1952],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":44,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1968,1971],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1968,1971],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":45,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1997,2000],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1997,2000],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":45,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2016,2019],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2016,2019],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":66,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2707,2710],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2707,2710],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":77,"column":81,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":84,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3102,3105],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3102,3105],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":87,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":87,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3386,3389],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3386,3389],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'key' is assigned a value but never used.","line":89,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":89,"endColumn":20},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":91,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":91,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3581,3584],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3581,3584],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":91,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":91,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3592,3595],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3592,3595],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":94,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":94,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3768,3771],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3768,3771],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":21,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, Inject } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatTableModule } from '@angular/material/table';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatDialogModule, MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { assignColorsToProductList } from './utility-functions/app.color';\r\nimport { SendDataToKiotVietService } from './DataFunction/app.send-data-to-kiotviet';\r\nimport { groupProducts } from './utility-functions/app.group-item';\r\nimport { showNotification } from './utility-functions/app.notification';\r\nimport { clearCache } from './DataFunction/app.save';\r\nimport { IndexedDBService } from '../../services/indexed-db.service';\r\nimport { ProductService } from '../../services/product.service';\r\n\r\n@Component({\r\n  selector: 'edited-products-dialog', standalone: true,\r\n  imports: [\r\n    CommonModule,\r\n    MatDialogModule, // Đảm bảo MatDialogModule được import\r\n    MatTableModule,\r\n    MatButtonModule,\r\n    MatIconModule\r\n\r\n  ],\r\n  templateUrl: './edited-products-dialog.component.html',\r\n  styleUrls: ['./dialog.component.css', './button.component.css']\r\n})\r\n\r\nexport class EditedItemDialog {\r\n  displayedColumns: string[] = ['Image', 'Code', 'FullName', 'BasePrice', 'OldBasePrice', 'Cost', 'OldCost', 'OnHand'];\r\n  filteredProducts: any[] = []; // Lưu danh sách sản phẩm đã lọc\r\n  productColors: Record<string, string> = {};\r\n  constructor(\r\n    public dialogRef: MatDialogRef<EditedItemDialog>,\r\n    @Inject(MAT_DIALOG_DATA) public data: any,\r\n    private sendDataToKiotVietService: SendDataToKiotVietService,\r\n    private indexedDBService: IndexedDBService,\r\n    private productService: ProductService\r\n  ) {\r\n    const seen = new Set();\r\n\r\n    data.products.forEach((item: any) => {\r\n      Object.values(item).forEach((group: any) => {\r\n        Object.values(group as any).forEach((arr: any) => {\r\n          (arr as any[]).forEach((y: any) => {\r\n            const key = JSON.stringify(y);\r\n            if (!seen.has(key)) {\r\n              seen.add(key);\r\n              this.filteredProducts.push(y);\r\n            }\r\n          });\r\n        });\r\n      });\r\n    });\r\n    assignColorsToProductList(this.filteredProducts, this.productColors)\r\n  }\r\n  getProductColor(productCode: string): string {\r\n    return this.productColors[productCode] || '#ffffff'; // Mặc định là màu trắng\r\n  }\r\n\r\n  getCostClass(cost: number, oldCost: number): string {\r\n    if (cost > oldCost) return 'text-red';\r\n    if (cost < oldCost) return 'text-green';\r\n    return '';\r\n  }\r\n  getCostClassHighlight(cost: number, oldCost: number, isMaster: boolean): any {\r\n    return {\r\n      [this.getCostClass(cost, oldCost)]: true,\r\n      'highlight': isMaster\r\n    };\r\n  }\r\n  getBasePriceClass(basePrice: number, oldbasePrice: number): string {\r\n    if (basePrice < oldbasePrice) return 'text-red';\r\n    if (basePrice > oldbasePrice) return 'text-green';\r\n    return '';\r\n  }\r\n  getBasePriceClassHighlight(cost: number, oldCost: number, isMaster: boolean): any {\r\n    return {\r\n      [this.getBasePriceClass(cost, oldCost)]: true,\r\n      'highlight': isMaster\r\n    };\r\n  }\r\n  async sendDataClick(): Promise<void> {\r\n    const groupedProduct = groupProducts(this.filteredProducts);\r\n    console.log(groupedProduct);\r\n\r\n    const allToUpdate: any[] = [];\r\n\r\n    for (const [key, products] of Object.entries(groupedProduct)) {\r\n      // products là array các sản phẩm trong group\r\n      const lowestConversionItem = products.reduce((prev: any, curr: any) => {\r\n        return parseFloat(curr.ConversionValue) < parseFloat(prev.ConversionValue) ? curr : prev;\r\n      }, products[0]);\r\n      const rest = products.filter((item: any) => item !== lowestConversionItem);\r\n\r\n      await this.sendDataToKiotVietService.sendProductData(lowestConversionItem, rest);\r\n\r\n      allToUpdate.push(...[lowestConversionItem, ...rest]);\r\n    }\r\n\r\n    // --- Cập nhật lại dữ liệu vào IndexedDB ---\r\n    for (const prod of allToUpdate) {\r\n      // Tìm sản phẩm mới nhất trong filteredProducts (đã chỉnh sửa trên UI)\r\n      const updated = this.filteredProducts.find(p => p.Id === prod.Id);\r\n      const dbProduct = await this.productService.getProductByIdFromIndexedDB(prod.Id);\r\n      if (dbProduct && updated) {\r\n        dbProduct.FullName = updated.FullName;\r\n        dbProduct.Code = updated.Code;\r\n        dbProduct.BasePrice = updated.BasePrice;\r\n        dbProduct.Cost = updated.Cost;\r\n        dbProduct.OnHand = updated.OnHand;\r\n        await this.productService.updateProductFromIndexedDB(dbProduct);\r\n      }\r\n    }\r\n\r\n    // --- Đồng bộ lên Firestore ---\r\n    await this.productService.updateProductsBatchToFirebase(groupedProduct);\r\n    clearCache();\r\n    showNotification('Đã gửi dữ liệu thành công!');\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\input-dialog.component.html","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\input-dialog.component.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'OnInit' is defined but never used.","line":1,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":27},{"ruleId":"@angular-eslint/component-selector","severity":2,"message":"The selector should start with one of these prefixes: \"app\" (https://angular.dev/style-guide#style-02-07)","line":12,"column":15,"nodeType":"Literal","messageId":"prefixFailure","endLine":12,"endColumn":29},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":27,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[905,908],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[905,908],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":28,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[928,931],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[928,931],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":29,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[953,956],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[953,956],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":30,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[979,982],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[979,982],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":31,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1006,1009],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1006,1009],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":34,"column":9,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":34,"endColumn":52},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":35,"column":9,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":35,"endColumn":50},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":35,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1158,1161],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1158,1161],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":36,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1205,1208],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1205,1208],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":11,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, OnInit, Inject } from '@angular/core';\r\n\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatTableModule } from '@angular/material/table';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatDialogModule, MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\nimport { FormsModule } from '@angular/forms';\r\n\r\n@Component({\r\n    selector: 'input-dialog', standalone: true,\r\n    imports: [\r\n        CommonModule,\r\n        MatDialogModule,\r\n        MatButtonModule,\r\n        MatTableModule,\r\n        MatTooltipModule,\r\n        FormsModule // \r\n    ],\r\n    templateUrl: './input-dialog.component.html',\r\n    styleUrls: ['./dialog.component.css']\r\n})\r\n\r\nexport class InputDialog {\r\n    displayedColumns: string[] = ['Box', 'Retail', 'Discount', 'Discount2', 'TotalPrice'];\r\n    box: any = '';\r\n    retail: any = '';\r\n    discount: any = '';\r\n    discount2: any = '';\r\n    totalPrice: any = '';\r\n    inputRows = [{}];\r\n    constructor(\r\n        public dialogRef: MatDialogRef<InputDialog>,\r\n        @Inject(MAT_DIALOG_DATA) public data: any) { }\r\n    private evaluateExpression(expr: any): string {\r\n        if (!expr) return '';\r\n        try {\r\n            const result = Function(`\"use strict\"; return (${expr})`)();\r\n            return result.toString();\r\n        } catch {\r\n            return 'Lỗi';\r\n        }\r\n    }\r\n    onOkClick(): void {\r\n        this.box = this.evaluateExpression(this.box) || 0;\r\n        this.retail = this.evaluateExpression(this.retail) || 0;\r\n        this.discount = this.evaluateExpression(this.discount) || 0;\r\n        this.discount2 = this.evaluateExpression(this.discount2) || 0;\r\n        this.totalPrice = this.evaluateExpression(this.totalPrice) || 0;\r\n        this.inputRows.push(this.box, this.retail, this.discount, this.discount2, this.totalPrice)\r\n\r\n        this.dialogRef.close({\r\n            box: this.box,\r\n            retail: this.retail,\r\n            discount: this.discount,\r\n            discount2: this.discount2,\r\n            totalPrice: this.totalPrice\r\n        });\r\n    }\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\low-stock-dialog.component.html","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\low-stock-dialog.component.ts","messages":[{"ruleId":"@angular-eslint/component-selector","severity":2,"message":"The selector should start with one of these prefixes: \"app\" (https://angular.dev/style-guide#style-02-07)","line":10,"column":13,"nodeType":"Literal","messageId":"prefixFailure","endLine":10,"endColumn":31},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":23,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[742,745],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[742,745],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":26,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":26,"endColumn":51},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":27,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":27,"endColumn":46},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":27,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[901,904],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[901,904],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":30,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1021,1024],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1021,1024],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, Inject } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatTableModule } from '@angular/material/table';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\n\r\nimport {  MatDialogModule, MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\n\r\n@Component({\r\n  selector: 'low-stock-dialog', standalone: true,\r\n  imports: [\r\n    CommonModule,\r\n    MatDialogModule, // Đảm bảo MatDialogModule được import\r\n    MatTableModule,\r\n    MatButtonModule\r\n  ],\r\n  templateUrl: './low-stock-dialog.component.html',\r\n  styleUrls: ['./dialog.component.css']\r\n})\r\n\r\nexport class LowStockDialog {\r\n  displayedColumns: string[] = ['Code', 'FullName', 'OnHand'];\r\n  filteredProducts: any[] = []; // Lưu danh sách sản phẩm đã lọc\r\n\r\n  constructor(\r\n    public dialogRef: MatDialogRef<LowStockDialog>,\r\n    @Inject(MAT_DIALOG_DATA) public data: any\r\n  ) {\r\n    // Lọc bỏ các sản phẩm có đơn vị là \"thùng\"\r\n    this.filteredProducts = data.products.filter((product: any) => {\r\n      return !/thùng/i.test(product.Unit) && !/lốc/i.test(product.Unit);\r\n    });\r\n  }\r\n\r\n  onNoClick(): void {\r\n    this.dialogRef.close(false);\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\services\\cost.service.ts","messages":[{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty constructor.","line":8,"column":17,"nodeType":"FunctionExpression","messageId":"unexpected","endLine":8,"endColumn":20,"suggestions":[{"messageId":"suggestComment","data":{"name":"constructor"},"fix":{"range":[135,136],"text":" /* empty */ "},"desc":"Add comment inside empty constructor."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":17,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[327,330],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[327,330],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":24,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[633,636],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[633,636],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":30,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[799,802],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[799,802],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":31,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[833,836],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[833,836],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":32,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[860,863],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[860,863],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":33,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[889,892],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[889,892],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"prefer-const","severity":2,"message":"'currentBaseprice' is never reassigned. Use 'const' instead.","line":35,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":35,"endColumn":21},{"ruleId":"prefer-const","severity":2,"message":"'currentOnHand' is never reassigned. Use 'const' instead.","line":36,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":36,"endColumn":18},{"ruleId":"prefer-const","severity":2,"message":"'currentCost' is never reassigned. Use 'const' instead.","line":37,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":37,"endColumn":16},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":49,"column":80,"nodeType":"BlockStatement","messageId":"unexpected","endLine":50,"endColumn":6,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[1523,1529],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":78,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":78,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3099,3102],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3099,3102],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_' is defined but never used.","line":82,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":82,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":88,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":88,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3499,3502],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3499,3502],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":116,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":116,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5039,5042],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5039,5042],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":116,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":116,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5062,5065],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5062,5065],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":16,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@angular/core';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class CostService {\r\n\r\n  constructor() { }\r\n\r\n  masterCode = '';\r\n  masterOnHand = '';\r\n  masterConversionValue = '';\r\n  masterCost = '';\r\n  masterDiscount = '';\r\n  masterFinalBasePrice = '';\r\n\r\n  private getOldProductsMaster(code: any) {\r\n    const oldProduct = Object.entries(localStorage)\r\n      .filter(([key]) => key.startsWith(\"grouped_\"))\r\n      .map(([key, value]) => ({ key: key.replace('grouped_', ''), value: JSON.parse(value) }));\r\n\r\n\r\n    const oldItem = oldProduct.map((k) => {\r\n      return k.value[code]?.find((c: { Code: any }) => c.Code == code);\r\n    }).find(item => item !== undefined); // Find the first non-undefined result\r\n\r\n    return oldItem\r\n  }\r\n\r\n  updateCostMaster(element: any) {\r\n    let currentBaseprice: any;\r\n    let currentCost: any;\r\n    let currentOnHand: any;\r\n    const oldProduct = this.getOldProductsMaster(element.Code) || 0\r\n    currentBaseprice = oldProduct.BasePrice || 0;\r\n    currentOnHand = oldProduct.OnHand || 0\r\n    currentCost = oldProduct.Cost || 0\r\n\r\n    this.masterCode = element.Code\r\n\r\n    let newCost = 0;\r\n    let retail = element.Retail\r\n    let box = element.Box\r\n    if (element.Retail > element.ConversionValue) {\r\n      retail = element.Retail % element.ConversionValue;\r\n      box = (element.Retail - (element.Retail % element.ConversionValue)) / element.ConversionValue;\r\n    }\r\n\r\n    if (element.Box === 0 && element.Retail === 0 && element.TotalPrice === 0) {\r\n    } else if ((element.Box > 0 || element.Retail > 0) && element.TotalPrice === 0) {\r\n      element.Cost = currentCost\r\n    } else {\r\n      if (element.AverageCheckPoint === true) {\r\n\r\n        newCost = element.TotalPrice;\r\n        element.Cost = ((newCost * element.Box * element.ConversionValue) + (currentCost * currentOnHand * element.ConversionValue)) / ((element.OnHand ) * element.ConversionValue)\r\n      } else {\r\n        element.Cost = (parseInt(element.TotalPrice) / (parseInt(box) * parseInt(element.ConversionValue) + parseInt(retail))) * parseInt(element.ConversionValue) || 0;\r\n        if (element.Discount2 > 0) {\r\n          element.Cost = (parseInt(element.TotalPrice) - parseInt(element.Discount2)) / (parseInt(box) * parseInt(element.ConversionValue) + parseInt(retail)) * parseInt(element.ConversionValue) || 0;\r\n        }\r\n\r\n      }\r\n    }\r\n    element.OnHand = ((parseFloat(currentOnHand) * parseInt(element.ConversionValue) + parseInt(retail) + parseInt(box) * parseInt(element.ConversionValue)) / parseInt(element.ConversionValue)) || 0\r\n\r\n    element.BasePrice = Math.round((parseInt(currentBaseprice) + (parseInt(element.Cost) - parseInt(currentCost))) / 1000) * 1000;\r\n    this.masterOnHand = element.OnHand\r\n    this.masterConversionValue = element.ConversionValue\r\n    this.masterCost = element.Cost\r\n    this.masterDiscount = element.Discount\r\n    this.masterFinalBasePrice = element.FinalBasePrice\r\n    localStorage.setItem(`editing_childProduct_${element.Code}`, JSON.stringify(element));\r\n  }\r\n\r\n\r\n\r\n  updateCostChildItems(filteredProducts: any[]) {\r\n\r\n    const oldProducts = Object.entries(localStorage)\r\n      .filter(([key]) => key.startsWith(\"grouped_\"))\r\n      .map(([_, value]) => JSON.parse(value || \"[]\"));\r\n\r\n    filteredProducts.forEach((currentItem) => {\r\n      oldProducts.forEach((oP) => {\r\n        const productGroup = oP[this.masterCode];\r\n        if (productGroup) {\r\n          const matchingProduct = productGroup.find((o: any) => o.Code === currentItem.Code);\r\n          if (matchingProduct) {\r\n            if (currentItem.Master) {\r\n              currentItem.Cost = Math.round(currentItem.Cost) || 0;\r\n              currentItem.BasePrice = Math.round(currentItem.BasePrice * 100) / 100 || 0;\r\n            } else {\r\n\r\n              currentItem.OnHand = (parseFloat(this.masterOnHand) * parseFloat(this.masterConversionValue)) / parseFloat(currentItem.ConversionValue) || 0;\r\n              currentItem.Cost = Math.round((parseInt(this.masterCost) / parseInt(this.masterConversionValue) * parseInt(currentItem.ConversionValue)) || 0);\r\n              if (parseInt(this.masterDiscount) > 0) {\r\n                currentItem.Cost = (currentItem.Cost - (parseInt(this.masterDiscount) * parseInt(currentItem.ConversionValue))) || 0;\r\n              }\r\n              currentItem.BasePrice = Math.round((matchingProduct.BasePrice + (currentItem.Cost - matchingProduct.Cost)) / 500) * 500 || 0;\r\n\r\n              if (parseInt(this.masterFinalBasePrice) > 0) {\r\n                currentItem.FinalBasePrice = Math.round((parseInt(this.masterFinalBasePrice) / parseInt(this.masterConversionValue) * parseInt(currentItem.ConversionValue)) || 0);\r\n              }\r\n            }\r\n\r\n            currentItem.Edited = true;\r\n            if (!currentItem.Master) {\r\n              localStorage.setItem(`editing_childProduct_${currentItem.Code}`, JSON.stringify(currentItem));\r\n            }\r\n          }\r\n        }\r\n      });\r\n    });\r\n  }\r\n  updateFinalBasePrice(changedFinalBasePrice: any, filteredProducts: any[]) {\r\n\r\n    filteredProducts.forEach((currentItem) => {\r\n      localStorage.setItem(`editing_childProduct_${currentItem.Code}`, JSON.stringify(currentItem));\r\n    });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\utility-functions\\app.color.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[113,116],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[113,116],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { groupProducts } from \"./app.group-item\";\r\n\r\nexport function assignColorsToProductList(filteredProducts: any[], productColors: Record<string, string>) {\r\n    // Group products based on the ListProduct field of the first product\r\n    const groupedProducts = groupProducts(filteredProducts);\r\n    const colors = [\r\n        '#aabcee',\r\n        '#aed581', // Màu xanh lá sáng nhạt\r\n        '#ffcc80', // Màu cam nhạt\r\n        '#ffab91', // Màu đỏ nhạt\r\n        '#80deea', // Màu xanh nhạt\r\n        '#e6ee9c', // Màu vàng nhạt\r\n        '#bcaaa4', // Màu nâu nhạt\r\n        '#ce93d8', // Màu tím nhạt\r\n        '#b0bec5', // Màu xám nhạt\r\n        '#f48fb1', // Màu hồng nhạt\r\n        '#ffd54f', // Màu vàng cam nhạt\r\n        '#81d4fa', // Màu xanh dương nhạt\r\n        '#c5e1a5', // Màu xanh lá cây nhạt\r\n        '#ff8a65', // Màu cam đỏ nhạt\r\n        '#d4e157', // Màu xanh chanh nhạt\r\n        '#9575cd', // Màu tím đậm nhạt\r\n        '#4fc3f7', // Màu xanh biển nhạt\r\n        '#ffb74d', // Màu cam sáng nhạt\r\n        \r\n        '#e57373', // Màu đỏ sáng nhạt\r\n    ];\r\n\r\n    Object.keys(groupedProducts).forEach((parentCode, index) => {\r\n\r\n        const groupColor = colors[index % colors.length];\r\n        const darkerColor = darkenColor(groupColor); // Function to darken the color\r\n        productColors[parentCode] = groupColor;\r\n        groupedProducts[parentCode].forEach((childProduct) => {\r\n            if (childProduct.Master) {\r\n                productColors[childProduct.Code] = darkerColor;\r\n            } else {\r\n                productColors[childProduct.Code] = groupColor;\r\n            }\r\n        });\r\n\r\n        function darkenColor(color: string): string {\r\n            // Simple function to darken a hex color\r\n            const colorValue = parseInt(color.slice(1), 16);\r\n            const r = Math.max((colorValue >> 16) - 30, 0);\r\n            const g = Math.max(((colorValue >> 8) & 0x00ff) - 30, 0);\r\n            const b = Math.max((colorValue & 0x0000ff) - 30, 0);\r\n            return `#${(r << 16 | g << 8 | b).toString(16).padStart(6, '0')}`;\r\n        }\r\n    });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\utility-functions\\app.group-item.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[40,43],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[40,43],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[64,67],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[64,67],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[116,119],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[116,119],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":9,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[383,386],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[383,386],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":23,"column":83,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":86,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[954,957],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[954,957],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":23,"column":97,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":100,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[968,971],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[968,971],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":29,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1186,1189],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1186,1189],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export function groupProducts(products: any[],): Record<string, any[]> {\r\n    const groupedProducts: Record<string, any[]> = {};\r\n\r\n    if (products.length > 1 && products.some(p => p.Master !== true)) {\r\n        products.forEach((product) => {\r\n\r\n            if (product.ListProduct && product.ListProduct.length > 0) {\r\n\r\n                product.ListProduct.forEach((childProduct: any) => {\r\n                    if (!groupedProducts[product.Code]) {\r\n                        groupedProducts[product.Code] = [];\r\n                    }\r\n                    if (products.includes(products.find((p) => p.Code === childProduct.Code))) {\r\n\r\n                        groupedProducts[product.Code].push(\r\n                            products.find((p) => p.Code === childProduct.Code) || childProduct\r\n                        );\r\n\r\n                    }\r\n\r\n                });\r\n\r\n                const maxCostProduct = groupedProducts[product.Code].reduce((min: any, current: any) =>\r\n                    current.Cost > min.Cost ? current : min, groupedProducts[product.Code][0]);\r\n                maxCostProduct.Master = true;\r\n            }\r\n        });\r\n        \r\n        const masterItems: any[] = [];\r\n        Object.entries(groupedProducts).forEach((key) => {\r\n            const masterItem = key[1].find((a) => a.Master === true);\r\n            if (masterItem && !masterItems.some((item) => item.Code === masterItem.Code)) {\r\n                masterItems.push(masterItem);\r\n            }\r\n            if (!masterItems.some((item) => item.Code === key[0])) {\r\n                delete groupedProducts[key[0]];\r\n            }\r\n        })\r\n\r\n    } else {\r\n        products.forEach((product) => {\r\n            groupedProducts[product.Code] = [product];\r\n            product.Master = true;\r\n        })\r\n\r\n    }\r\n\r\n\r\n    return groupedProducts;\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\utility-functions\\app.notification.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\utility-functions\\app.show.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[73,76],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[73,76],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export function showEditedProducts(searchTerm: string, filteredProducts: any[]) {\r\n    const cachedEditedProducts = localStorage.getItem(`edited_${searchTerm}`);\r\n    if (cachedEditedProducts) {\r\n        filteredProducts = JSON.parse(cachedEditedProducts);\r\n        console.log('Hiển thị các sản phẩm đã chỉnh sửa:', filteredProducts);\r\n    } else {\r\n        console.log('Không có sản phẩm nào đã chỉnh sửa.');\r\n        filteredProducts = [];\r\n    }\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\utility-functions\\app.sort.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[40,43],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[40,43],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[48,51],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[48,51],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nexport function sortByGroup(products: any[]): any[] {\r\n\r\n  return products.sort((a, b) => {\r\n    const nameA = a.FullName.toLowerCase(); // Chuyển tên về chữ thường để so sánh\r\n    const nameB = b.FullName.toLowerCase();\r\n\r\n    if (nameA < nameB) return -1; // Sắp xếp tăng dần\r\n    if (nameA > nameB) return 1;\r\n    return 0; // Nếu bằng nhau, giữ nguyên thứ tự\r\n  });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\edit-product-page\\utility-functions\\app.validate-number.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\invoice-detail\\invoice-detail.component.html","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\invoice-detail\\invoice-detail.component.ts","messages":[{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":16,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":16,"endColumn":92},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":17,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":17,"endColumn":85},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":18,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":18,"endColumn":45}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, ElementRef, Inject, Input, ViewChild, OnInit, Optional } from '@angular/core';\r\nimport { InvoiceTab } from '../../models/invoice.model';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MAT_DIALOG_DATA, MatDialogRef } from '@angular/material/dialog';\r\nimport { TimeZoneService } from '../../services/time-zone.service';\r\n\r\n@Component({\r\n  selector: 'app-invoice-detail',\r\n  templateUrl: './invoice-detail.component.html',\r\n  styleUrls: ['./invoice-detail.component.css'],\r\n  imports: [CommonModule]\r\n})\r\nexport class InvoiceDetailComponent implements OnInit {\r\n  @Input() invoice!: InvoiceTab;\r\n  constructor(\r\n    @Optional() @Inject(MAT_DIALOG_DATA) public data: { invoice: InvoiceTab } | null = null,\r\n    @Optional() public dialogRef: MatDialogRef<InvoiceDetailComponent> | null = null,\r\n    private timeZoneService: TimeZoneService,\r\n  ) { }\r\n\r\n  ngOnInit() {\r\n    // Nếu được mở như dialog, sử dụng data từ dialog\r\n    if (this.data && this.data.invoice) {\r\n      this.invoice = this.data.invoice;\r\n    }\r\n  }\r\n  @ViewChild('printSection', { static: false }) printSection!: ElementRef;\r\n  getHtmlContent(): string {\r\n    return this.printSection?.nativeElement?.innerHTML || '';\r\n  }\r\n\r\n  formatVietnameseDate(): string {\r\n    const now = new Date();\r\n    const vnNow = this.timeZoneService.formatVietnamISOString(now);\r\n    const d = new Date(vnNow);\r\n    const day = d.getDate().toString().padStart(2, '0');\r\n    const month = (d.getMonth() + 1).toString().padStart(2, '0');\r\n    const year = d.getFullYear();\r\n\r\n    return `Ngày ${day} tháng ${month} năm ${year}`;\r\n  }\r\n  getTotalDiscount(): number {\r\n    if (!this.invoice || !this.invoice.cartItems) return 0;\r\n    return this.invoice.cartItems\r\n      .filter(item => item.unitPriceSaleOff > 0)\r\n      .reduce((sum, item) => sum + item.unitPriceSaleOff * item.quantity, 0);\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\invoices-page\\invoices-page.component.html","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\invoices-page\\invoices-page.component.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'MAT_DATE_FORMATS' is defined but never used.","line":8,"column":44,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":60},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'MAT_DATE_LOCALE' is defined but never used.","line":8,"column":62,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":77},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":66,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2916,2919],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2916,2919],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":73,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":73,"endColumn":59},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":74,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":74,"endColumn":30},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":75,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":75,"endColumn":39},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":76,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":76,"endColumn":43},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":77,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":77,"endColumn":34},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":78,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":78,"endColumn":43},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":79,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":79,"endColumn":45},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'date' is assigned a value but never used.","line":223,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":223,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":408,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":408,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15184,15187],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15184,15187],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":536,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":536,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19118,19121],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19118,19121],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":690,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":690,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24294,24297],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24294,24297],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":14,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, ViewEncapsulation, OnInit, ViewChild, OnDestroy } from '@angular/core';\r\nimport { MatDialogRef, MatDialogModule, MatDialog } from '@angular/material/dialog';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatDatepickerModule } from '@angular/material/datepicker';\r\nimport { MatNativeDateModule, DateAdapter, MAT_DATE_FORMATS, MAT_DATE_LOCALE } from '@angular/material/core';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatTableModule } from '@angular/material/table';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { InvoiceTab } from '../../models/invoice.model';\r\nimport { ViewSwlectedInvoiceDialogComponent } from './view-selected-invoice.component';\r\nimport { InvoiceDetailComponent } from '../invoice-detail/invoice-detail.component';\r\nimport { PrintService } from '../../services/print.service';\r\nimport { VietnameseService } from '../../services/vietnamese.service';\r\nimport { InvoiceService } from '../../services/invoice.service';\r\nimport { TimeZoneService } from '../../services/time-zone.service';\r\nimport { ConfirmPopupComponent } from '../confirm-popup/confirm-popup.component';\r\nimport { firstValueFrom, Subscription } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'app-invoices-page',\r\n  standalone: true,\r\n  imports: [\r\n    CommonModule,\r\n    MatDialogModule,\r\n    FormsModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatDatepickerModule,\r\n    MatNativeDateModule,\r\n    MatSelectModule,\r\n    MatTableModule,\r\n    MatIconModule,\r\n    MatButtonModule\r\n  ],\r\n  templateUrl: './invoices-page.component.html',\r\n  styleUrls: ['./invoices-page.component.css'],\r\n  encapsulation: ViewEncapsulation.None\r\n})\r\nexport class InvoicesPageComponent implements OnInit, OnDestroy {\r\n  allInvoices: InvoiceTab[] = [];\r\n  filteredInvoices: InvoiceTab[] = [];\r\n  searchTerm = '';\r\n  searchTermProduct = ''\r\n  selectedDate: Date | null = null;\r\n  selectedTime: string | null = null; // kept for compatibility with existing filters\r\n  selectedHour: string | null = '';\r\n  selectedMinute: string | null = '';\r\n  hours: string[] = Array.from({ length: 24 }, (_, i) => (i < 10 ? '0' + i : '' + i));\r\n  minutes: string[] = [ '15', '30', '45', '59'];\r\n  selectedCustomer = '';\r\n  customers: string[] = [];\r\n  pageSize = 10;\r\n  currentPage = 1;\r\n  displayedColumns: string[] = ['id', 'customer', 'date', 'totalPrice', 'actions'];\r\n  isLoading = false;\r\n  isWebSocketConnected = false;\r\n  lastSyncTime: Date | null = null;\r\n\r\n  // Real-time subscriptions\r\n  private subscriptions: Subscription[] = [];\r\n  private isSyncing = false; // Flag to prevent multiple simultaneous syncs\r\n  private syncDebounceTimer: any = null; // Debounce timer for sync operations\r\n\r\n  // Total price filter\r\n  selectedMinTotal: number | null = null;\r\n  selectedMaxTotal: number | null = null;\r\n\r\n  constructor(\r\n    private dialogRef: MatDialogRef<InvoicesPageComponent>,\r\n    private dialog: MatDialog,\r\n    private printService: PrintService,\r\n    private dateAdapter: DateAdapter<Date>,\r\n    private vi: VietnameseService,\r\n    private invoiceService: InvoiceService,\r\n    private timeZoneService: TimeZoneService\r\n  ) {\r\n    this.dateAdapter.setLocale('vi-VN');\r\n  }\r\n\r\n  async ngOnInit() {\r\n    // 1. Xác định ngày hôm nay\r\n    const now = new Date();\r\n    this.selectedDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);\r\n\r\n\r\n\r\n\r\n    // 4. Đọc lại hóa đơn của ngày hôm nay từ IndexedDB để hiển thị\r\n    this.allInvoices = await this.invoiceService.getInvoicesByDateFromDB(this.selectedDate) || [];\r\n    this.filteredInvoices = [...this.allInvoices];\r\n    this.applyFilters();\r\n\r\n    // 5. Các bước khởi tạo khác\r\n    this.initializeWebSocket();\r\n    this.setupRealTimeSubscriptions();\r\n    this.loadLastSyncTime();\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    // Cleanup WebSocket connection when component is destroyed\r\n    this.invoiceService.disconnectSocket();\r\n\r\n    // Unsubscribe from all real-time events\r\n    this.subscriptions.forEach(sub => sub.unsubscribe());\r\n    this.subscriptions = [];\r\n\r\n    // Clear any pending sync timers\r\n    if (this.syncDebounceTimer) {\r\n      clearTimeout(this.syncDebounceTimer);\r\n    }\r\n\r\n    console.log('🔌 WebSocket connection closed for invoices page');\r\n  }\r\n\r\n  private async loadLastSyncTime(): Promise<void> {\r\n    try {\r\n      this.lastSyncTime = await this.invoiceService.getLastSyncTime();\r\n      console.log('📅 Last sync time loaded:', this.lastSyncTime);\r\n    } catch (error) {\r\n      console.error('❌ Error loading last sync time:', error);\r\n    }\r\n  }\r\n\r\n  private async initializeWebSocket(): Promise<void> {\r\n    try {\r\n      console.log('🔌 Initializing WebSocket for invoices page...');\r\n\r\n      // Initialize WebSocket connection\r\n      await this.invoiceService.initializeWebSocket();\r\n      this.isWebSocketConnected = this.invoiceService.isWebSocketConnected();\r\n      console.log('🔌 WebSocket initialized for real-time invoice updates');\r\n\r\n      // If WebSocket is connected, check if we need to sync\r\n      if (this.isWebSocketConnected) {\r\n        const needsSync = await this.invoiceService.needsSync();\r\n        if (needsSync) {\r\n          console.log('🔄 WebSocket connected and sync needed, triggering sync...');\r\n          // Delay sync to ensure everything is ready\r\n          setTimeout(() => {\r\n            this.triggerSyncIfNeeded();\r\n          }, 1000);\r\n        } else {\r\n          console.log('✅ WebSocket connected and data is up to date');\r\n          // Update last sync time display\r\n          await this.loadLastSyncTime();\r\n        }\r\n      } else {\r\n        console.log('⚠️ WebSocket not connected, will sync when connection is established');\r\n        // Thử kết nối lại sau 5 giây\r\n        setTimeout(() => {\r\n          this.retryWebSocketConnection();\r\n        }, 5000);\r\n      }\r\n    } catch (error) {\r\n      console.error('❌ Failed to initialize WebSocket:', error);\r\n      this.isWebSocketConnected = false;\r\n    }\r\n  }\r\n\r\n  // Method để thử kết nối lại WebSocket\r\n  private async retryWebSocketConnection(): Promise<void> {\r\n    try {\r\n      console.log('🔄 Retrying WebSocket connection...');\r\n      await this.invoiceService.initializeWebSocket();\r\n      this.isWebSocketConnected = this.invoiceService.isWebSocketConnected();\r\n\r\n      if (this.isWebSocketConnected) {\r\n        console.log('✅ WebSocket reconnection successful');\r\n      } else {\r\n        console.log('❌ WebSocket reconnection failed');\r\n      }\r\n    } catch (error) {\r\n      console.error('❌ WebSocket reconnection error:', error);\r\n    }\r\n  }\r\n\r\n  private setupRealTimeSubscriptions(): void {\r\n    // Subscribe to invoice created events\r\n    const createdSub = this.invoiceService.invoiceCreated$.subscribe(invoice => {\r\n      console.log(`🆕 Real-time: Invoice created - ${invoice.id}`);\r\n      this.handleInvoiceCreated(invoice);\r\n    });\r\n\r\n    // Subscribe to invoice updated events\r\n    const updatedSub = this.invoiceService.invoiceUpdated$.subscribe(invoice => {\r\n      console.log(`🔄 Real-time: Invoice updated - ${invoice.id}`);\r\n      this.handleInvoiceUpdated(invoice);\r\n    });\r\n\r\n    // Subscribe to invoice deleted events\r\n    const deletedSub = this.invoiceService.invoiceDeleted$.subscribe(invoiceId => {\r\n      console.log(`🗑️ Real-time: Processing invoice deleted - ${invoiceId}`);\r\n      this.handleInvoiceDeleted(invoiceId);\r\n    });\r\n\r\n    // Subscribe to sync completed events - update last sync time\r\n    const syncSub = this.invoiceService.syncCompleted$.subscribe(async () => {\r\n      console.log('🔄 Real-time: Sync completed, updating last sync time...');\r\n      this.isSyncing = false;\r\n      await this.loadLastSyncTime();\r\n    });\r\n\r\n    // Add all subscriptions to the array for cleanup\r\n    this.subscriptions.push(createdSub, updatedSub, deletedSub, syncSub);\r\n  }\r\n\r\n  // Enhanced fetch method WITHOUT automatic sync to prevent infinite loops\r\n  async fetchInvoicesByDate() {\r\n    this.isLoading = true;\r\n    if (!this.selectedDate) {\r\n      this.allInvoices = [];\r\n      this.filteredInvoices = [];\r\n      this.isLoading = false;\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Format ngày theo Vietnam timezone để lấy từ indexedDB\r\n      const date = this.timeZoneService.formatDateToVietnamString(this.selectedDate);\r\n\r\n      // Lấy hóa đơn từ indexedDB theo ngày\r\n      const invoices: InvoiceTab[] = await this.invoiceService.getInvoicesByDateFromDB(this.selectedDate);\r\n      this.allInvoices = invoices || [];\r\n\r\n      // Sort invoices to show the newest first\r\n      this.allInvoices.sort((a, b) => {\r\n        if (!a.createdDate) return 1;\r\n        if (!b.createdDate) return -1;\r\n        return new Date(b.createdDate).getTime() - new Date(a.createdDate).getTime()\r\n      });\r\n\r\n      this.filteredInvoices = [...this.allInvoices];\r\n      this.customers = [...new Set(this.allInvoices.map(invoice =>\r\n        typeof invoice.customer === 'string' ? invoice.customer : invoice.customer?.Name ?? ''\r\n      ))];\r\n      this.applyFilters();\r\n\r\n    } catch (err) {\r\n      console.error('Error fetching invoices from indexedDB:', err);\r\n      this.allInvoices = [];\r\n      this.filteredInvoices = [];\r\n    } finally {\r\n      this.isLoading = false;\r\n    }\r\n  }\r\n\r\n  // Debounced sync method to prevent multiple rapid calls\r\n  private async debouncedSync(): Promise<void> {\r\n    if (this.syncDebounceTimer) {\r\n      clearTimeout(this.syncDebounceTimer);\r\n    }\r\n\r\n    this.syncDebounceTimer = setTimeout(async () => {\r\n      if (!this.isSyncing) {\r\n        await this.performSync();\r\n      }\r\n    }, 1000); // 1 second debounce\r\n  }\r\n\r\n  // Actual sync method with proper locking\r\n  private async performSync(): Promise<void> {\r\n    if (this.isSyncing) {\r\n      console.log('⚠️ Sync already in progress, skipping...');\r\n      return;\r\n    }\r\n\r\n    this.isSyncing = true;\r\n    try {\r\n      console.log('🔄 Starting sync with server...');\r\n      if (!this.selectedDate) {\r\n        this.isSyncing = false;\r\n        return;\r\n      }\r\n      // Lấy ngày dạng string cho API\r\n      const dateStr = this.timeZoneService.formatDateToVietnamString(this.selectedDate);\r\n      // 1. Lấy hóa đơn từ API (Firestore) theo ngày\r\n      const apiInvoices = await firstValueFrom(this.invoiceService.getInvoicesByDateFromFirestore(dateStr)) as InvoiceTab[];\r\n\r\n      // 2. Lưu từng hóa đơn vào IndexedDB (Invoices/invoice)\r\n      if (Array.isArray(apiInvoices)) {\r\n        for (const invoice of apiInvoices) {\r\n          await this.invoiceService.addInvoiceToDB(invoice);\r\n        }\r\n      }\r\n\r\n      // 3. Refresh data sau khi sync\r\n      await this.fetchInvoicesByDate();\r\n\r\n      // 4. Update last sync time\r\n      await this.loadLastSyncTime();\r\n\r\n      console.log('✅ Sync completed successfully');\r\n    } catch (error) {\r\n      console.error('❌ Error during sync:', error);\r\n    } finally {\r\n      this.isSyncing = false;\r\n    }\r\n  }\r\n\r\n  private async syncInvoicesWithServer(): Promise<void> {\r\n    await this.performSync();\r\n  }\r\n\r\n  // Real-time update methods\r\n  async handleInvoiceCreated(invoice: InvoiceTab): Promise<void> {\r\n    console.log(`🆕 Real-time: Processing invoice created - ${invoice.id}`);\r\n\r\n    // Check if the invoice belongs to the current date\r\n    if (this.selectedDate && this.isInvoiceInSelectedDate(invoice)) {\r\n      // Add to local list if not already present\r\n      const existingIndex = this.allInvoices.findIndex(inv => inv.id === invoice.id);\r\n      if (existingIndex === -1) {\r\n        this.allInvoices.unshift(invoice); // Add to beginning\r\n        this.updateFilteredInvoices();\r\n        console.log(`✅ Invoice ${invoice.id} added to current view`);\r\n      } else {\r\n        console.log(`ℹ️ Invoice ${invoice.id} already exists in current view`);\r\n      }\r\n    } else {\r\n      console.log(`ℹ️ Invoice ${invoice.id} does not belong to current date, skipping UI update`);\r\n    }\r\n  }\r\n\r\n  async handleInvoiceUpdated(invoice: InvoiceTab): Promise<void> {\r\n    console.log(`🔄 Real-time: Processing invoice updated - ${invoice.id}`);\r\n\r\n    // Update in local list\r\n    const existingIndex = this.allInvoices.findIndex(inv => inv.id === invoice.id);\r\n    if (existingIndex !== -1) {\r\n      this.allInvoices[existingIndex] = invoice;\r\n      this.updateFilteredInvoices();\r\n      console.log(`✅ Invoice ${invoice.id} updated in current view`);\r\n    } else {\r\n      console.log(`ℹ️ Invoice ${invoice.id} not found in current view, may need to refresh`);\r\n      // Nếu không tìm thấy, có thể cần refresh data\r\n      await this.fetchInvoicesByDate();\r\n    }\r\n  }\r\n\r\n  async handleInvoiceDeleted(invoiceId: string): Promise<void> {\r\n    console.log(`🗑️ Real-time: Processing invoice deleted - ${invoiceId}`);\r\n\r\n    // Remove from local list\r\n    const initialLength = this.allInvoices.length;\r\n    this.allInvoices = this.allInvoices.filter(inv => inv.id !== invoiceId);\r\n\r\n    if (this.allInvoices.length < initialLength) {\r\n      this.updateFilteredInvoices();\r\n      console.log(`✅ Invoice ${invoiceId} removed from current view`);\r\n    } else {\r\n      console.log(`ℹ️ Invoice ${invoiceId} not found in current view`);\r\n    }\r\n  }\r\n\r\n  private isInvoiceInSelectedDate(invoice: InvoiceTab): boolean {\r\n    if (!this.selectedDate || !invoice.createdDate) return false;\r\n\r\n    const invoiceDate = new Date(invoice.createdDate);\r\n    const selectedDateOnly = new Date(\r\n      this.selectedDate.getFullYear(),\r\n      this.selectedDate.getMonth(),\r\n      this.selectedDate.getDate()\r\n    );\r\n\r\n    return invoiceDate >= selectedDateOnly &&\r\n      invoiceDate < new Date(selectedDateOnly.getTime() + 24 * 60 * 60 * 1000);\r\n  }\r\n\r\n  private updateFilteredInvoices(): void {\r\n    this.filteredInvoices = [...this.allInvoices];\r\n    this.applyFilters();\r\n  }\r\n\r\n  // Enhanced delete method with WebSocket notification\r\n  async deleteInvoicesByFilter() {\r\n    const dialogRef = this.dialog.open(ConfirmPopupComponent, {\r\n      width: '300px',\r\n      data: { message: 'Bạn có chắc chắn muốn xóa tất cả hóa đơn đang hiển thị?' }\r\n    });\r\n\r\n    dialogRef.afterClosed().subscribe(async (result) => {\r\n      if (result === true) {\r\n        this.isLoading = true;\r\n        let successCount = 0;\r\n        let errorCount = 0;\r\n\r\n        // Xóa từng invoice trong filteredInvoices\r\n        for (const invoice of this.filteredInvoices) {\r\n          try {\r\n            // Xóa ở IndexedDB\r\n            await this.invoiceService.deleteInvoiceFromDB(invoice.id);\r\n            console.log('Hóa đơn đã được xóa thành công từ IndexedDB');\r\n\r\n            // Xóa ở Firestore\r\n            await firstValueFrom(this.invoiceService.deleteInvoiceToFirestore(invoice.id));\r\n            console.info(`Đã xóa thành công từ Firestore: ${invoice.id}`);\r\n\r\n            // Notify other clients via WebSocket\r\n            if (this.isWebSocketReady()) {\r\n              await this.invoiceService.notifyInvoiceDeleted(invoice.id);\r\n            }\r\n\r\n            successCount++;\r\n          } catch (error: any) {\r\n            console.error('Lỗi khi xóa hóa đơn:', error);\r\n            errorCount++;\r\n          }\r\n        }\r\n\r\n        // Show summary\r\n        if (successCount > 0) {\r\n          console.log(`✅ Successfully deleted ${successCount} invoices`);\r\n        }\r\n        if (errorCount > 0) {\r\n          console.error(`❌ Failed to delete ${errorCount} invoices`);\r\n        }\r\n\r\n        // Cập nhật lại danh sách\r\n        this.fetchInvoicesByDate();\r\n      }\r\n    });\r\n  }\r\n\r\n  // Manual sync method with proper locking\r\n  async manualSync(): Promise<void> {\r\n    if (this.isSyncing) {\r\n      console.log('⚠️ Sync already in progress, please wait...');\r\n      return;\r\n    }\r\n\r\n    if (this.isLoading) {\r\n      console.log('⚠️ Component is loading, please wait...');\r\n      return;\r\n    }\r\n\r\n    console.log('🔄 Manual sync requested...');\r\n    this.isLoading = true;\r\n    try {\r\n      await this.performSync();\r\n      console.log('✅ Manual sync completed successfully');\r\n    } catch (error) {\r\n      console.error('❌ Manual sync failed:', error);\r\n      // Có thể hiển thị thông báo lỗi cho user ở đây\r\n    } finally {\r\n      this.isLoading = false;\r\n    }\r\n  }\r\n\r\n  // Get connection status with more detailed information\r\n  getConnectionStatus(): string {\r\n    const status = this.invoiceService.getWebSocketStatus();\r\n    if (status.connected) {\r\n      return '🟢 Connected';\r\n    } else if (status.initialized && status.socketExists) {\r\n      return '🟡 Connecting...';\r\n    } else {\r\n      return '🔴 Disconnected';\r\n    }\r\n  }\r\n\r\n  // Method to trigger sync when needed (e.g., when WebSocket connects)\r\n  async triggerSyncIfNeeded(): Promise<void> {\r\n    // Only sync if WebSocket is ready and not already syncing\r\n    if (this.isWebSocketReady() && !this.isSyncing && !this.isLoading) {\r\n      console.log('🔄 Triggering sync due to WebSocket connection...');\r\n      await this.debouncedSync();\r\n    }\r\n  }\r\n\r\n  // Optional: Periodic sync check (can be called by parent components)\r\n  async checkAndSyncIfNeeded(): Promise<void> {\r\n    // Only sync if:\r\n    // 1. WebSocket is connected\r\n    // 2. Not currently syncing\r\n    // 3. Not loading\r\n    // 4. Last sync was more than 5 minutes ago\r\n    const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);\r\n    const shouldSync = this.isWebSocketReady() &&\r\n      !this.isSyncing &&\r\n      !this.isLoading &&\r\n      (!this.lastSyncTime || this.lastSyncTime < fiveMinutesAgo);\r\n\r\n    if (shouldSync) {\r\n      console.log('🔄 Periodic sync check triggered...');\r\n      await this.debouncedSync();\r\n    } else {\r\n      console.log('ℹ️ Periodic sync check skipped (conditions not met)');\r\n    }\r\n  }\r\n\r\n  // Public method to check sync status for template\r\n  isCurrentlySyncing(): boolean {\r\n    return this.isSyncing;\r\n  }\r\n\r\n  // Enhanced method to check if WebSocket is ready for real-time updates\r\n  isWebSocketReady(): boolean {\r\n    const isConnected = this.invoiceService.isWebSocketConnected();\r\n    return isConnected;\r\n  }\r\n\r\n  // Get last sync time\r\n  getLastSyncTime(): string {\r\n    if (this.lastSyncTime) {\r\n      const now = new Date();\r\n      const diffMs = now.getTime() - this.lastSyncTime.getTime();\r\n      const diffMins = Math.floor(diffMs / 60000);\r\n      const diffHours = Math.floor(diffMs / 3600000);\r\n      const diffDays = Math.floor(diffMs / 86400000);\r\n\r\n      if (diffMins < 1) {\r\n        return 'Vừa xong';\r\n      } else if (diffMins < 60) {\r\n        return `${diffMins} phút trước`;\r\n      } else if (diffHours < 24) {\r\n        return `${diffHours} giờ trước`;\r\n      } else if (diffDays < 7) {\r\n        return `${diffDays} ngày trước`;\r\n      } else {\r\n        return this.lastSyncTime.toLocaleDateString('vi-VN', {\r\n          year: 'numeric',\r\n          month: '2-digit',\r\n          day: '2-digit',\r\n          hour: '2-digit',\r\n          minute: '2-digit'\r\n        });\r\n      }\r\n    }\r\n    return 'Chưa đồng bộ';\r\n  }\r\n\r\n  onDateChange(event: any) {\r\n    if (event.value) {\r\n      // Keep selectedDate as the day (00:00). Filtering will use createdDate range [00:00,24:00)\r\n      this.selectedDate = new Date(event.value.getFullYear(), event.value.getMonth(), event.value.getDate(), 0, 0, 0, 0);\r\n    } else {\r\n      this.selectedDate = null;\r\n    }\r\n    if (this.selectedDate) {\r\n      this.fetchInvoicesByDate();\r\n    }\r\n  }\r\n\r\n  onTimePartsChange() {\r\n    if (this.selectedHour) {\r\n      const mm = this.selectedMinute ? this.selectedMinute : '00';\r\n      this.selectedTime = `${this.selectedHour}:${mm}`;\r\n    } else {\r\n      this.selectedTime = null;\r\n    }\r\n    this.applyFilters();\r\n  }\r\n\r\n  clearTime(event?: MouseEvent) {\r\n    if (event) event.stopPropagation();\r\n    this.selectedHour = '';\r\n    this.selectedMinute = '';\r\n    this.selectedTime = null;\r\n    this.applyFilters();\r\n  }\r\n  clearFilters() {\r\n    this.selectedDate = null;\r\n    this.searchTerm = '';\r\n    this.searchTermProduct = '';\r\n    this.selectedCustomer = '';\r\n    this.selectedHour = '';\r\n    this.selectedMinute = '';\r\n    this.selectedTime = null;\r\n    this.selectedMinTotal = null;\r\n    this.selectedMaxTotal = null;\r\n    this.fetchInvoicesByDate();\r\n  }\r\n\r\n  applyFilters() {\r\n    this.filteredInvoices = this.allInvoices.filter(invoice => {\r\n      const matchesSearch = this.searchTerm\r\n        ? String(invoice.id).toLowerCase().includes(this.searchTerm.toLowerCase()) ||\r\n        invoice.customer?.Name?.toLowerCase().includes(this.searchTerm.toLowerCase())\r\n        : true;\r\n      const matchesProduct = this.checkProductFilter(invoice, this.searchTermProduct);\r\n      const matchesCustomer = this.checkCustomerFilter(invoice);\r\n      const matchesDate = this.checkDateFilter(invoice);\r\n      const matchesTotal = this.checkTotalFilter(invoice);\r\n      this.currentPage = 1;\r\n      return matchesSearch && matchesCustomer && matchesProduct && matchesDate && matchesTotal;\r\n    });\r\n  }\r\n\r\n  private checkTotalFilter(invoice: InvoiceTab): boolean {\r\n    // Nếu không nhập giá trị, không lọc theo tổng\r\n    if (this.selectedMinTotal === null || this.selectedMinTotal === undefined) {\r\n      return true;\r\n    }\r\n\r\n    const total = typeof invoice.totalPrice === 'number' ? invoice.totalPrice : Number(invoice.totalPrice || 0);\r\n    if (isNaN(total)) return false;\r\n\r\n    // Lọc chính xác bằng số nhập vào (không phải khoảng)\r\n    const target = Number(this.selectedMinTotal);\r\n    return total === target;\r\n  }\r\n  \r\n  private checkDateFilter(invoice: InvoiceTab): boolean {\r\n    // No date selected -> match all\r\n    if (!this.selectedDate) return true;\r\n    if (!invoice.createdDate) return false;\r\n    const invoiceDate = new Date(invoice.createdDate);\r\n    if (isNaN(invoiceDate.getTime())) return false;\r\n\r\n    // Start of selected day (00:00:00.000)\r\n    const startOfDay = new Date(this.selectedDate.getFullYear(), this.selectedDate.getMonth(), this.selectedDate.getDate(), 0, 0, 0, 0);\r\n    // End is exclusive: startOfNextDay (00:00 of next day)\r\n    const startOfNextDay = new Date(startOfDay.getTime() + 24 * 60 * 60 * 1000);\r\n\r\n    // Invoice must be within [startOfDay, startOfNextDay)\r\n    if (!(invoiceDate >= startOfDay && invoiceDate < startOfNextDay)) {\r\n      return false;\r\n    }\r\n\r\n    // If no hour selected, accept\r\n    if (!this.selectedHour) return true;\r\n\r\n    const hh = parseInt(this.selectedHour as string, 10);\r\n    if (isNaN(hh)) return true;\r\n\r\n    const invHour = invoiceDate.getHours();\r\n    const invMin = invoiceDate.getMinutes();\r\n\r\n    // If minute not selected -> treat as \"all minutes in that hour\"\r\n    if (!this.selectedMinute) {\r\n      return invHour === hh;\r\n    }\r\n\r\n    // Map selectedMinute to ranges:\r\n    // '15' => 01..15\r\n    // '30' => 16..30\r\n    // '45' => 31..45\r\n    // '00' => 46..00 (i.e., 46..59 of hh OR minute 0 of next hour)\r\n    const selMin = this.selectedMinute;\r\n\r\n    if (selMin === '15') {\r\n      return invHour === hh && invMin >= 1 && invMin <= 15;\r\n    }\r\n\r\n    if (selMin === '30') {\r\n      return invHour === hh && invMin >= 16 && invMin <= 30;\r\n    }\r\n\r\n    if (selMin === '45') {\r\n      return invHour === hh && invMin >= 31 && invMin <= 45;\r\n    }\r\n    if (selMin === '59') {\r\n      // Two parts: minutes 46-59 of selected hour OR minute 0 of next hour\r\n      if (invHour === hh && invMin >= 46 && invMin <= 59) return true;\r\n    }\r\n\r\n\r\n    // Fallback: if minute is numeric but not one of buckets, try exact match\r\n    const mm = parseInt(selMin as string, 10);\r\n    if (!isNaN(mm)) {\r\n      return invHour === hh && invMin === mm;\r\n    }\r\n\r\n    return true;\r\n  }\r\n  \r\n  private checkCustomerFilter(invoice: InvoiceTab): boolean {\r\n    if (!this.selectedCustomer) {\r\n      return true;\r\n    }\r\n\r\n    return typeof invoice.customer === 'string'\r\n      ? invoice.customer === this.selectedCustomer\r\n      : invoice.customer?.Name === this.selectedCustomer;\r\n  }\r\n\r\n  viewInvoice(invoice: InvoiceTab) {\r\n    const dialogRef = this.dialog.open(ViewSwlectedInvoiceDialogComponent, {\r\n      width: '600px',\r\n      data: {\r\n        invoices: invoice,\r\n        cartItems: invoice.cartItems || [],\r\n      }\r\n    });\r\n\r\n    dialogRef.afterClosed().subscribe((result: any) => {\r\n      // result could be: { edit: true, invoice, cartItems, isInvoiceEdit }\r\n      if (result === true || result?.deleted) {\r\n        this.allInvoices = this.allInvoices.filter(i => i.id !== invoice.id);\r\n        this.applyFilters();\r\n      } else if (result?.edit) {\r\n        // Forward edit payload to the opener (main-page) including isInvoiceEdit flag\r\n        try {\r\n          this.dialogRef.close({\r\n            edit: true,\r\n            invoice: result.invoice,\r\n            cartItems: result.cartItems || [],\r\n            isInvoiceEdit: !!result.isInvoiceEdit\r\n          });\r\n        } catch (err) {\r\n          console.error('❌ Error while forwarding edit request to opener:', err);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  @ViewChild(InvoiceDetailComponent, { static: false })\r\n  invoiceDetailComponent!: InvoiceDetailComponent;\r\n\r\n  printInvoice(invoice: InvoiceTab) {\r\n    const dialogRef = this.dialog.open(InvoiceDetailComponent, {\r\n      data: { invoice },\r\n      width: '0px',\r\n      height: '0px',\r\n      panelClass: 'hidden-dialog',\r\n      disableClose: true\r\n    });\r\n\r\n    dialogRef.afterOpened().subscribe(() => {\r\n      const componentInstance = dialogRef.componentInstance;\r\n      if (componentInstance) {\r\n        const html = componentInstance.getHtmlContent();\r\n        if (!html) {\r\n          console.error('Không lấy được nội dung HTML hóa đơn!');\r\n          dialogRef.close();\r\n          return;\r\n        }\r\n        this.printService.printHtml(html);\r\n        dialogRef.close();\r\n      } else {\r\n        console.error('Không thể lấy componentInstance của InvoiceDetailComponent!');\r\n        dialogRef.close();\r\n      }\r\n    });\r\n  }\r\n\r\n  close() {\r\n    this.dialogRef.close();\r\n  }\r\n\r\n  lastScrollTop = 0;\r\n  hideFilters = false;\r\n\r\n  onScroll(event: Event) {\r\n    const target = event.target as HTMLElement;\r\n    const scrollTop = target.scrollTop;\r\n\r\n    if (scrollTop > this.lastScrollTop + 10) {\r\n      this.hideFilters = true;\r\n    } else if (scrollTop < this.lastScrollTop - 10 || scrollTop === 0) {\r\n      this.hideFilters = false;\r\n    }\r\n\r\n    this.lastScrollTop = scrollTop;\r\n  }\r\n\r\n  formatDate(date: Date | string): string {\r\n    if (!date) return '';\r\n    const d = new Date(date);\r\n    return d.toLocaleDateString('vi-VN', {\r\n      year: 'numeric',\r\n      month: '2-digit',\r\n      day: '2-digit',\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    });\r\n  }\r\n  get totalPages(): number {\r\n    return Math.ceil(this.filteredInvoices.length / this.pageSize);\r\n  }\r\n\r\n  get pagedInvoices(): InvoiceTab[] {\r\n    const start = (this.currentPage - 1) * this.pageSize;\r\n    return this.filteredInvoices.slice(start, start + this.pageSize);\r\n  }\r\n  goToPage(page: number) {\r\n    if (page < 1 || page > this.totalPages) return;\r\n    this.currentPage = page;\r\n  }\r\n\r\n  nextPage() {\r\n    if (this.currentPage < this.totalPages) {\r\n      this.currentPage++;\r\n    }\r\n  }\r\n\r\n  prevPage() {\r\n    if (this.currentPage > 1) {\r\n      this.currentPage--;\r\n    }\r\n  }\r\n\r\n  private searchInvoicesByProduct(searchTerm: string): boolean {\r\n    if (!searchTerm || searchTerm.trim() === '') {\r\n      return true; // Không có điều kiện tìm kiếm thì trả về true\r\n    }\r\n\r\n    const queryTokens = this.vi.normalizeAndTokenize(searchTerm);\r\n    const queryStr = queryTokens.join(' ').toLowerCase();\r\n    const rawQuery = searchTerm.toLowerCase();\r\n\r\n    return this.filteredInvoices.some(invoice => {\r\n      if (!invoice.cartItems || invoice.cartItems.length === 0) {\r\n        return false;\r\n      }\r\n\r\n      // Tìm kiếm trong tất cả sản phẩm của hóa đơn\r\n      return invoice.cartItems.some(item => {\r\n        if (!item.product || !item.product.Name) {\r\n          return false;\r\n        }\r\n\r\n        const productName = item.product.Name;\r\n        const productCode = item.product.Code || '';\r\n\r\n        // Chuẩn hóa tên sản phẩm\r\n        const normalizedProductName = this.vi.normalizeAndTokenize(productName).join(' ').toLowerCase();\r\n\r\n        // 1. Kiểm tra tên sản phẩm bắt đầu bằng từ khóa tìm kiếm\r\n        if (normalizedProductName.startsWith(queryStr)) {\r\n          return true;\r\n        }\r\n\r\n        // 2. Kiểm tra tên sản phẩm chứa từ khóa tìm kiếm\r\n        if (normalizedProductName.includes(queryStr) || productName.toLowerCase().includes(rawQuery)) {\r\n          return true;\r\n        }\r\n\r\n        // 3. Kiểm tra mã sản phẩm\r\n        const productCodeLower = productCode.toLowerCase();\r\n\r\n        // Kiểm tra nếu query có dạng \"XXXXXXX-X\" (có chứa dấu gạch ngang)\r\n        if (rawQuery.includes('-')) {\r\n          const baseQuery = rawQuery.split('-')[0];\r\n          return productCodeLower === baseQuery;\r\n        }\r\n\r\n        return productCodeLower.includes(rawQuery);\r\n      });\r\n    });\r\n  }\r\n  private checkProductFilter(invoice: InvoiceTab, searchTerm: string): boolean {\r\n    if (!searchTerm || searchTerm.trim() === '') {\r\n      return true;\r\n    }\r\n\r\n    if (!invoice.cartItems || invoice.cartItems.length === 0) {\r\n      return false;\r\n    }\r\n\r\n    const queryTokens = this.vi.normalizeAndTokenize(searchTerm);\r\n    const queryStr = queryTokens.join(' ').toLowerCase();\r\n    const rawQuery = searchTerm.toLowerCase();\r\n\r\n    return invoice.cartItems.some(item => {\r\n      if (!item.product || !item.product.Name) {\r\n        return false;\r\n      }\r\n\r\n      const productName = item.product.Name;\r\n      const productCode = item.product.Code || '';\r\n\r\n      // Chuẩn hóa tên sản phẩm\r\n      const normalizedProductName = this.vi.normalizeAndTokenize(productName).join(' ').toLowerCase();\r\n\r\n      // 1. Kiểm tra tên sản phẩm bắt đầu bằng từ khóa tìm kiếm (độ ưu tiên cao nhất)\r\n      if (normalizedProductName.startsWith(queryStr)) {\r\n        return true;\r\n      }\r\n\r\n      // 2. Kiểm tra tên sản phẩm chứa từ khóa tìm kiếm\r\n      if (normalizedProductName.includes(queryStr) || productName.toLowerCase().includes(rawQuery)) {\r\n        return true;\r\n      }\r\n\r\n      // 3. Kiểm tra mã sản phẩm\r\n      const productCodeLower = productCode.toLowerCase();\r\n\r\n      // Kiểm tra nếu query có dạng \"XXXXXXX-X\" (có chứa dấu gạch ngang)\r\n      if (rawQuery.includes('-')) {\r\n        const baseQuery = rawQuery.split('-')[0];\r\n        return productCodeLower === baseQuery;\r\n      }\r\n\r\n      return productCodeLower.includes(rawQuery);\r\n    });\r\n  }\r\n  searchInvoicesByProductName(productSearchTerm: string): InvoiceTab[] {\r\n    if (!productSearchTerm || productSearchTerm.trim() === '') {\r\n      return this.allInvoices;\r\n    }\r\n\r\n    const queryTokens = this.vi.normalizeAndTokenize(productSearchTerm);\r\n    const queryStr = queryTokens.join(' ').toLowerCase();\r\n    const rawQuery = productSearchTerm.toLowerCase();\r\n\r\n    // 1. Hóa đơn chứa sản phẩm có tên bắt đầu bằng từ khóa\r\n    const startsWithMatches = this.allInvoices.filter(invoice =>\r\n      invoice.cartItems?.some(item => {\r\n        if (!item.product?.Name) return false;\r\n        const normalizedName = this.vi.normalizeAndTokenize(item.product.Name).join(' ').toLowerCase();\r\n        return normalizedName.startsWith(queryStr);\r\n      })\r\n    );\r\n\r\n    // 2. Hóa đơn chứa sản phẩm có tên chứa từ khóa (nhưng không bắt đầu)\r\n    const containsNameMatches = this.allInvoices.filter(invoice => {\r\n      if (startsWithMatches.includes(invoice)) return false;\r\n\r\n      return invoice.cartItems?.some(item => {\r\n        if (!item.product?.Name) return false;\r\n        const normalizedName = this.vi.normalizeAndTokenize(item.product.Name).join(' ').toLowerCase();\r\n        return normalizedName.includes(queryStr) || item.product.Name.toLowerCase().includes(rawQuery);\r\n      });\r\n    });\r\n\r\n    // 3. Hóa đơn chứa sản phẩm có mã chứa từ khóa\r\n    const codeMatches = this.allInvoices.filter(invoice => {\r\n      if (startsWithMatches.includes(invoice) || containsNameMatches.includes(invoice)) {\r\n        return false;\r\n      }\r\n\r\n      return invoice.cartItems?.some(item => {\r\n        if (!item.product?.Code) return false;\r\n        const productCode = item.product.Code.toLowerCase();\r\n\r\n        if (rawQuery.includes('-')) {\r\n          const baseQuery = rawQuery.split('-')[0];\r\n          return productCode === baseQuery;\r\n        }\r\n\r\n        return productCode.includes(rawQuery);\r\n      });\r\n    });\r\n\r\n    // Trả về theo độ ưu tiên\r\n    return [\r\n      ...startsWithMatches,\r\n      ...containsNameMatches,\r\n      ...codeMatches\r\n    ];\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\invoices-page\\view-selected-invoice.component.html","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\invoices-page\\view-selected-invoice.component.ts","messages":[{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":32,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":32,"endColumn":71},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":33,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":33,"endColumn":90},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":34,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":34,"endColumn":43},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":35,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":35,"endColumn":30},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":133,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":133,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4879,4882],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4879,4882],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, Inject, OnInit, OnDestroy } from '@angular/core';\r\nimport { MAT_DIALOG_DATA, MatDialogRef, MatDialogModule, MatDialog } from '@angular/material/dialog';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { CartItem } from '../../models/cart-item.model';\r\nimport { InvoiceTab } from '../../models/invoice.model';\r\nimport { InvoiceService } from '../../services/invoice.service';\r\nimport { ConfirmPopupComponent } from '../confirm-popup/confirm-popup.component';\r\nimport { firstValueFrom, Subscription } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'app-invoice-detail-dialog',\r\n  templateUrl: './view-selected-invoice.component.html',\r\n  styleUrls: ['./view-selected-invoice.component.css'],\r\n  imports: [\r\n    CommonModule,\r\n    MatDialogModule,\r\n    MatIconModule,\r\n    MatButtonModule\r\n  ]\r\n})\r\nexport class ViewSwlectedInvoiceDialogComponent implements OnInit, OnDestroy {\r\n  isDeleting = false;\r\n  isWebSocketConnected = false;\r\n  lastUpdateTime: Date | null = null;\r\n\r\n  // Real-time subscriptions\r\n  private subscriptions: Subscription[] = [];\r\n\r\n  constructor(\r\n    public dialogRef: MatDialogRef<ViewSwlectedInvoiceDialogComponent>,\r\n    @Inject(MAT_DIALOG_DATA) public data: { invoices: InvoiceTab, cartItems: CartItem[] },\r\n    private invoiceService: InvoiceService,\r\n    private dialog: MatDialog,\r\n  ) { }\r\n\r\n  ngOnInit() {\r\n    this.initializeWebSocket();\r\n    this.setupRealTimeSubscriptions();\r\n    this.lastUpdateTime = new Date();\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    // Unsubscribe from all real-time events\r\n    this.subscriptions.forEach(sub => sub.unsubscribe());\r\n    this.subscriptions = [];\r\n    console.log('🔌 View invoice dialog destroyed');\r\n  }\r\n\r\n  private async initializeWebSocket(): Promise<void> {\r\n    try {\r\n      // Initialize WebSocket connection if not already connected\r\n      await this.invoiceService.initializeWebSocket();\r\n      this.isWebSocketConnected = this.invoiceService.isWebSocketConnected();\r\n      console.log('🔌 WebSocket initialized for invoice detail view');\r\n    } catch (error) {\r\n      console.error('❌ Failed to initialize WebSocket for invoice detail:', error);\r\n      this.isWebSocketConnected = false;\r\n    }\r\n  }\r\n\r\n  private setupRealTimeSubscriptions(): void {\r\n    // Subscribe to invoice updated events for this specific invoice\r\n    const updatedSub = this.invoiceService.invoiceUpdated$.subscribe(invoice => {\r\n      if (invoice.id === this.data.invoices.id) {\r\n        console.log(`🔄 Real-time: Invoice ${invoice.id} updated in detail view`);\r\n        this.handleInvoiceUpdate(invoice);\r\n      }\r\n    });\r\n\r\n    // Subscribe to invoice deleted events for this specific invoice\r\n    const deletedSub = this.invoiceService.invoiceDeleted$.subscribe(invoiceId => {\r\n      if (invoiceId === this.data.invoices.id) {\r\n        console.log(`🗑️ Real-time: Invoice ${invoiceId} deleted in detail view`);\r\n        this.handleInvoiceDeleted(invoiceId);\r\n      }\r\n    });\r\n\r\n    // Add subscriptions to the array for cleanup\r\n    this.subscriptions.push(updatedSub, deletedSub);\r\n  }\r\n\r\n  close() {\r\n    this.dialogRef.close();\r\n  }\r\n\r\n  getTotalPrice(): number {\r\n    return this.data.invoices.totalPrice\r\n  }\r\n\r\n  getTotalQuantity(): number {\r\n    return this.data.invoices.totalQuantity\r\n  }\r\n\r\n  formatVnd(amount: number): string {\r\n    return amount.toLocaleString('vi-VN') + ' ₫';\r\n  }\r\n\r\n  // Enhanced delete method with WebSocket notification\r\n  async deleteInvoice() {\r\n    // Hiển thị popup xác nhận trước khi xóa\r\n    const confirmData = {\r\n      message: 'Bạn có chắc chắn muốn xóa hóa đơn này? Hành động này không thể hoàn tác.'\r\n    };\r\n    \r\n    const dialogRef = this.dialog.open(ConfirmPopupComponent, {\r\n      width: '400px',\r\n      data: confirmData\r\n    });\r\n    \r\n    dialogRef.afterClosed().subscribe(async (confirmed: boolean) => {\r\n      if (confirmed) {\r\n        this.isDeleting = true;\r\n        \r\n        try {\r\n          // Xóa từ Firestore trước\r\n          await firstValueFrom(this.invoiceService.deleteInvoiceToFirestore(this.data.invoices.id));\r\n          console.log('✅ Hóa đơn đã được xóa thành công từ Firestore');\r\n          \r\n          // Xóa từ IndexedDB\r\n          await this.invoiceService.deleteInvoiceFromDB(this.data.invoices.id);\r\n          console.log('✅ Hóa đơn đã được xóa thành công từ IndexedDB');\r\n          \r\n          // Notify other clients via WebSocket\r\n          if (this.invoiceService.isWebSocketConnected()) {\r\n            await this.invoiceService.notifyInvoiceDeleted(this.data.invoices.id);\r\n            console.log('📡 WebSocket notification sent for invoice deletion');\r\n          }\r\n          \r\n          this.dialogRef.close(true); // Trả về true để thông báo đã xóa thành công\r\n          \r\n        } catch (error: any) {\r\n          console.error('❌ Lỗi khi xóa hóa đơn:', error);\r\n          \r\n          // Show more detailed error message\r\n          let errorMessage = 'Lỗi khi xóa hóa đơn. Vui lòng thử lại sau.';\r\n          \r\n          if (error.status === 404) {\r\n            errorMessage = 'Hóa đơn không tồn tại hoặc đã bị xóa.';\r\n          } else if (error.status === 403) {\r\n            errorMessage = 'Bạn không có quyền xóa hóa đơn này.';\r\n          } else if (error.status === 0) {\r\n            errorMessage = 'Không thể kết nối đến máy chủ. Vui lòng kiểm tra kết nối mạng.';\r\n          } else if (error.message) {\r\n            errorMessage += ` Chi tiết: ${error.message}`;\r\n          }\r\n          \r\n          alert(errorMessage);\r\n        } finally {\r\n          this.isDeleting = false;\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  // Method to refresh invoice data\r\n  async refreshInvoiceData(): Promise<void> {\r\n    try {\r\n      console.log('🔄 Refreshing invoice data...');\r\n      \r\n      // Get latest data from IndexedDB\r\n      const updatedInvoice = await this.invoiceService.getInvoiceFromDBById(this.data.invoices.id);\r\n      \r\n      if (updatedInvoice) {\r\n        this.data.invoices = updatedInvoice;\r\n        this.lastUpdateTime = new Date();\r\n        console.log('✅ Invoice data refreshed successfully');\r\n      } else {\r\n        console.warn('⚠️ Invoice not found in local database');\r\n      }\r\n    } catch (error) {\r\n      console.error('❌ Error refreshing invoice data:', error);\r\n    }\r\n  }\r\n\r\n  // Get connection status with more detailed information\r\n  getConnectionStatus(): string {\r\n    const status = this.invoiceService.getWebSocketStatus();\r\n    if (status.connected) {\r\n      return '🟢 Connected';\r\n    } else if (status.initialized && status.socketExists) {\r\n      return '🟡 Connecting...';\r\n    } else {\r\n      return '🔴 Disconnected';\r\n    }\r\n  }\r\n\r\n  // Public method to check WebSocket status for template\r\n  isWebSocketReady(): boolean {\r\n    return this.invoiceService.isWebSocketConnected();\r\n  }\r\n\r\n  // Get last update time\r\n  getLastUpdateTime(): string {\r\n    if (this.lastUpdateTime) {\r\n      return this.lastUpdateTime.toLocaleTimeString('vi-VN');\r\n    }\r\n    return 'Never';\r\n  }\r\n\r\n  // Check if invoice is recent (within last 5 minutes)\r\n  isRecentInvoice(): boolean {\r\n    if (!this.data.invoices.createdDate) return false;\r\n    \r\n    const createdTime = new Date(this.data.invoices.createdDate).getTime();\r\n    const currentTime = new Date().getTime();\r\n    const fiveMinutes = 5 * 60 * 1000; // 5 minutes in milliseconds\r\n    \r\n    return (currentTime - createdTime) < fiveMinutes;\r\n  }\r\n\r\n  // Get invoice age in human readable format\r\n  getInvoiceAge(): string {\r\n    if (!this.data.invoices.createdDate) return 'Unknown';\r\n    \r\n    const createdTime = new Date(this.data.invoices.createdDate).getTime();\r\n    const currentTime = new Date().getTime();\r\n    const diffInMinutes = Math.floor((currentTime - createdTime) / (1000 * 60));\r\n    \r\n    if (diffInMinutes < 1) {\r\n      return 'Just now';\r\n    } else if (diffInMinutes < 60) {\r\n      return `${diffInMinutes} minutes ago`;\r\n    } else if (diffInMinutes < 1440) { // Less than 24 hours\r\n      const hours = Math.floor(diffInMinutes / 60);\r\n      return `${hours} hours ago`;\r\n    } else {\r\n      const days = Math.floor(diffInMinutes / 1440);\r\n      return `${days} days ago`;\r\n    }\r\n  }\r\n\r\n  // Check if invoice can be edited (recent invoices only)\r\n  canEditInvoice(): boolean {\r\n    return this.isRecentInvoice();\r\n  }\r\n\r\n  /**\r\n   * Request to edit this invoice: close dialog and return payload to caller.\r\n   * Caller (InvoicesPageComponent) will handle bubbling this up to MainPage.\r\n   */\r\n  editInvoice() {\r\n    try {\r\n      const payload = {\r\n        edit: true,\r\n        invoice: this.data.invoices,\r\n        cartItems: this.data.cartItems || [],\r\n        isInvoiceEdit: true // <-- mark this as invoice edit\r\n      };\r\n      this.dialogRef.close(payload);\r\n    } catch (err) {\r\n      console.error('❌ Error while requesting invoice edit:', err);\r\n      this.dialogRef.close();\r\n    }\r\n  }\r\n\r\n  // Method to handle invoice updates from WebSocket\r\n  handleInvoiceUpdate(updatedInvoice: InvoiceTab): void {\r\n    this.data.invoices = updatedInvoice;\r\n    this.lastUpdateTime = new Date();\r\n    console.log('🔄 Invoice updated via WebSocket');\r\n  }\r\n\r\n  // Method to handle invoice deletion from WebSocket\r\n  handleInvoiceDeleted(invoiceId: string): void {\r\n    console.log(`🗑️ Invoice ${invoiceId} was deleted by another user`);\r\n    // Close the dialog since the invoice no longer exists\r\n    this.dialogRef.close();\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\login-page\\login-page.component.html","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\login-page\\login-page.component.ts","messages":[{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":27,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":27,"endColumn":27},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":28,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":28,"endColumn":43},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":29,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":29,"endColumn":43},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":30,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":30,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":31,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":31,"endColumn":39},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":32,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":32,"endColumn":45},{"ruleId":"@angular-eslint/no-empty-lifecycle-method","severity":2,"message":"Lifecycle methods should not be empty","line":35,"column":3,"nodeType":"MethodDefinition","messageId":"noEmptyLifecycleMethod","endLine":36,"endColumn":4,"suggestions":[{"messageId":"suggestRemoveLifecycleMethod","fix":{"range":[18,1277],"text":" } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { environment } from \"../../../environments/environment\";\r\nimport { Router } from '@angular/router';\r\nimport { InvoiceService } from '../../services/invoice.service';\r\nimport { ProductService } from '../../services/product.service';\r\nimport { CustomerService } from '../../services/customer.service';\r\nimport { Product } from '../../models/product.model';\r\nimport { OrderService } from '../../services/order.service';\r\nimport { KiotvietService } from '../../services/kiotviet.service';\r\n\r\n@Component({\r\n  selector: 'app-login-page',\r\n  standalone: true,\r\n  imports: [CommonModule, FormsModule],\r\n  templateUrl: './login-page.component.html',\r\n  styleUrl: './login-page.component.css'\r\n})\r\nexport class LoginPageComponent  {\r\n  username = '';\r\n  password = '';\r\n  isLoading = false;\r\n  error = '';\r\n\r\n  constructor(\r\n    private router: Router,\r\n    private invoiceService: InvoiceService,\r\n    private productService: ProductService,\r\n    private customerService: CustomerService,\r\n    private orderService: OrderService,\r\n    private kiotvietService: KiotvietService\r\n  ) { }\r\n\r\n  "},"desc":"Remove lifecycle method"}]},{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty async method 'ngOnInit'.","line":35,"column":20,"nodeType":"FunctionExpression","messageId":"unexpected","endLine":36,"endColumn":4,"suggestions":[{"messageId":"suggestComment","data":{"name":"async method 'ngOnInit'"},"fix":{"range":[1272,1276],"text":" /* empty */ "},"desc":"Add comment inside empty async method 'ngOnInit'."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":116,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":116,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4149,4152],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4149,4152],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":140,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":140,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":213,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":213,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8331,8334],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8331,8334],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":214,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":214,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8364,8367],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8364,8367],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'syncError' is defined but never used.","line":260,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":260,"endColumn":25}],"suppressedMessages":[],"errorCount":13,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, OnInit } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { environment } from \"../../../environments/environment\";\r\nimport { Router } from '@angular/router';\r\nimport { InvoiceService } from '../../services/invoice.service';\r\nimport { ProductService } from '../../services/product.service';\r\nimport { CustomerService } from '../../services/customer.service';\r\nimport { Product } from '../../models/product.model';\r\nimport { OrderService } from '../../services/order.service';\r\nimport { KiotvietService } from '../../services/kiotviet.service';\r\n\r\n@Component({\r\n  selector: 'app-login-page',\r\n  standalone: true,\r\n  imports: [CommonModule, FormsModule],\r\n  templateUrl: './login-page.component.html',\r\n  styleUrl: './login-page.component.css'\r\n})\r\nexport class LoginPageComponent implements OnInit {\r\n  username = '';\r\n  password = '';\r\n  isLoading = false;\r\n  error = '';\r\n\r\n  constructor(\r\n    private router: Router,\r\n    private invoiceService: InvoiceService,\r\n    private productService: ProductService,\r\n    private customerService: CustomerService,\r\n    private orderService: OrderService,\r\n    private kiotvietService: KiotvietService\r\n  ) { }\r\n\r\n  async ngOnInit() {\r\n  }\r\n\r\n  private async initializeAllIndexedDB(): Promise<void> {\r\n    try {\r\n\r\n      // Khởi tạo tuần tự để tránh conflict\r\n\r\n      console.log('🔄 Khởi tạo tất cả IndexedDB...');\r\n      // initialize sequentially to avoid upgrade/connection conflicts\r\n      console.log('🔄 Khởi tạo invoiceService...');\r\n      await this.invoiceService.initDB();\r\n\r\n      console.log('🔄 Khởi tạo customerService...');\r\n      await this.customerService.initDB();\r\n\r\n      console.log('🔄 Khởi tạo productService...');\r\n      await this.productService.initDB();\r\n\r\n      console.log('🔄 Khởi tạo orderService...');\r\n      await this.orderService.initDB();\r\n\r\n      // Debug trạng thái database\r\n      await this.productService.debugDatabaseStatus();\r\n\r\n      // Delay cuối cùng để đảm bảo tất cả đã sẵn sàng\r\n      await new Promise(resolve => setTimeout(resolve, 300));\r\n\r\n      console.log('✅ Tất cả IndexedDB đã sẵn sàng');\r\n\r\n    } catch (error) {\r\n      console.error('❌ Lỗi khi khởi tạo IndexedDB:', error);\r\n      throw error; // Re-throw để component có thể xử lý\r\n    }\r\n  }\r\n\r\n  async login() {\r\n    this.error = '';\r\n    this.isLoading = true;\r\n    try {\r\n      const response = await fetch(`${environment.domainUrl}/api/kiotviet/authentication`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({\r\n          username: this.username,\r\n          password: this.password\r\n        })\r\n      });\r\n      if (!response.ok) {\r\n        throw new Error('Sai tài khoản hoặc mật khẩu!');\r\n      }\r\n      const data = await response.json();\r\n      // Lưu thông tin vào localStorage\r\n      localStorage.setItem('kv_access_token', data.access_token);\r\n      localStorage.setItem('kv_retailer', data.retailer);\r\n      localStorage.setItem('kv_branch_id', data.LatestBranchId);\r\n\r\n      // Đảm bảo IndexedDB đã được khởi tạo\r\n      await this.initializeAllIndexedDB();\r\n\r\n      // Thực hiện đồng bộ dữ liệu từ Firestore nếu IndexedDB rỗng\r\n      await this.performInitialSync();\r\n\r\n      // Đồng bộ out-of-stock từ Firestore về IndexedDB\r\n      try {\r\n        const outOfStock = await this.kiotvietService.getOutOfStockItems();\r\n        if (outOfStock && Array.isArray(outOfStock.data)) {\r\n          await this.productService['indexedDBService'].clear('SalesDB', 1, 'outofstock');\r\n          await this.productService['indexedDBService'].putMany('SalesDB', 1, 'outofstock', outOfStock.data);\r\n          console.log(`✅ Đã đồng bộ ${outOfStock.data.length} out-of-stock từ Firestore vào IndexedDB`);\r\n        } else {\r\n          console.log('ℹ️ Không có out-of-stock nào từ Firestore');\r\n        }\r\n      } catch (error) {\r\n        console.error('❌ Lỗi khi đồng bộ out-of-stock từ Firestore:', error);\r\n      }\r\n\r\n      // Chuyển hướng sang trang chính\r\n      this.router.navigate(['/home']);\r\n    } catch (err: any) {\r\n      this.error = err.message || 'Đăng nhập thất bại!';\r\n    } finally {\r\n      this.isLoading = false;\r\n    }\r\n  }\r\n\r\n  private async performInitialSync(): Promise<void> {\r\n    try {\r\n      console.log('🔄 Bắt đầu kiểm tra và đồng bộ dữ liệu từ Firestore...');\r\n\r\n      // Kiểm tra xem IndexedDB có rỗng không\r\n      const isIndexedDBEmpty = await this.checkIfIndexedDBEmpty();\r\n\r\n      if (isIndexedDBEmpty) {\r\n        console.log('📦 IndexedDB rỗng, bắt đầu load dữ liệu từ Firestore...');\r\n\r\n        // Preload Firebase cache trước\r\n        await this.productService.preloadFirebaseCache();\r\n\r\n        // Hiển thị thông tin sync status trước khi load\r\n        try {\r\n          const productSyncStatus = await this.productService.getSyncStatusWithCache();\r\n          console.log(`📊 Trạng thái Products - Firebase: ${productSyncStatus.totalInFirebase}, IndexedDB: ${productSyncStatus.totalInIndexedDB}, Used Cache: ${productSyncStatus.usedCache}`);\r\n        } catch (error) {\r\n          console.warn('⚠️ Không thể kiểm tra sync status, có thể cần reset database');\r\n          // Thử reset database nếu có lỗi\r\n          try {\r\n            await this.productService.resetDatabase();\r\n          } catch (resetError) {\r\n            console.error('❌ Không thể reset database:', resetError);\r\n          }\r\n        }\r\n        await Promise.all([\r\n          console.log('🔄 Bắt đầu load products...'),\r\n          await this.loadProductsFromFirestore(),\r\n\r\n          console.log('🔄 Bắt đầu load customers...'),\r\n          await this.loadCustomersFromFirestore(),\r\n\r\n          console.log('🔄 Bắt đầu load invoices...'),\r\n          await this.loadInvoicesFromFirestore(),\r\n\r\n          console.log('🔄 Bắt đầu load orders...'),\r\n          await this.loadOrdersFromFirestore(),\r\n          \r\n          console.log('✅ Hoàn thành load dữ liệu từ Firestore'),\r\n        ]);\r\n\r\n        // Load tuần tự để tránh race condition\r\n\r\n\r\n        // Kiểm tra lại sau khi load\r\n        try {\r\n          const finalProductStatus = await this.productService.getSyncStatusWithCache();\r\n          console.log(`📊 Trạng thái Products sau sync - Firebase: ${finalProductStatus.totalInFirebase}, IndexedDB: ${finalProductStatus.totalInIndexedDB}, Used Cache: ${finalProductStatus.usedCache}`);\r\n          // If IndexedDB still empty after sync, attempt a force sync\r\n          if ((finalProductStatus.totalInIndexedDB || 0) === 0 && (finalProductStatus.totalInFirebase || 0) > 0) {\r\n            console.warn('⚠️ SalesDB appears empty after sync; attempting force sync from Firebase');\r\n            try {\r\n              await this.productService.forceSyncAllProductsFromFirebase();\r\n              await this.productService.syncProductsFromFirebaseToIndexedDB();\r\n              console.log('✅ Force sync completed and products loaded into IndexedDB');\r\n            } catch (forceErr) {\r\n              console.error('❌ Force sync failed:', forceErr);\r\n            }\r\n          }\r\n        } catch (error) {\r\n          console.warn('⚠️ Không thể kiểm tra trạng thái cuối cùng:', error);\r\n        }\r\n\r\n      } else {\r\n        console.log('ℹ️ IndexedDB đã có dữ liệu, bỏ qua load từ Firestore');\r\n\r\n        // Vẫn kiểm tra xem có cần sync không\r\n        try {\r\n          const productSyncStatus = await this.productService.getSyncStatusWithCache();\r\n          console.log(`📊 Trạng thái Products - Firebase: ${productSyncStatus.totalInFirebase}, IndexedDB: ${productSyncStatus.totalInIndexedDB}, Used Cache: ${productSyncStatus.usedCache}`);\r\n          if (productSyncStatus.needsSync) {\r\n            console.log('🔄 Phát hiện dữ liệu Firebase mới hơn, thực hiện sync...');\r\n            await this.loadProductsFromFirestore();\r\n          }\r\n        } catch (error) {\r\n          console.warn('⚠️ Không thể kiểm tra sync status:', error);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('❌ Lỗi khi đồng bộ dữ liệu từ Firestore:', error);\r\n    }\r\n  }\r\n\r\n  private async checkIfIndexedDBEmpty(): Promise<boolean> {\r\n    try {\r\n      console.log('🔍 Kiểm tra trạng thái IndexedDB...');\r\n\r\n      // Kiểm tra tuần tự để tránh race condition\r\n      let products: Product[] = [];\r\n      let customers: any[] = [];\r\n      let invoices: any[] = [];\r\n\r\n      try {\r\n        products = await this.productService.getAllProductsFromIndexedDB();\r\n        console.log(`📦 Products trong IndexedDB: ${products.length}`);\r\n      } catch (error) {\r\n        console.warn('⚠️ Không thể đọc products từ IndexedDB:', error);\r\n        products = [];\r\n      }\r\n\r\n      try {\r\n        customers = await this.customerService.getAllCustomersFromIndexedDB();\r\n        console.log(`👥 Customers trong IndexedDB: ${customers.length}`);\r\n      } catch (error) {\r\n        console.warn('⚠️ Không thể đọc customers từ IndexedDB:', error);\r\n        customers = [];\r\n      }\r\n\r\n      try {\r\n        invoices = await this.invoiceService.getAllInvoicesFromDB();\r\n        console.log(`📄 Invoices trong IndexedDB: ${invoices.length}`);\r\n      } catch (error) {\r\n        console.warn('⚠️ Không thể đọc invoices từ IndexedDB:', error);\r\n        invoices = [];\r\n      }\r\n\r\n      // Nếu tất cả đều rỗng thì coi như IndexedDB rỗng\r\n      const isEmpty = products.length === 0 && customers.length === 0 && invoices.length === 0;\r\n      console.log(`📊 IndexedDB ${isEmpty ? 'rỗng' : 'có dữ liệu'}`);\r\n\r\n      return isEmpty;\r\n    } catch (error) {\r\n      console.error('❌ Lỗi khi kiểm tra IndexedDB:', error);\r\n      // Nếu có lỗi, coi như rỗng để load lại dữ liệu\r\n      return true;\r\n    }\r\n  }\r\n\r\n  private async loadProductsFromFirestore(): Promise<void> {\r\n    try {\r\n      console.log('🔄 Đang load products từ Firestore...');\r\n\r\n      // Thử sync bình thường trước\r\n      try {\r\n        await this.productService.syncProductsFromFirebaseToIndexedDB();\r\n        console.log('✅ Hoàn thành load products từ Firestore');\r\n      } catch (syncError) {\r\n        console.warn('⚠️ Lỗi khi sync products, thử force sync...');\r\n\r\n        // Nếu sync thất bại, thử force sync\r\n        try {\r\n          await this.productService.forceSyncAllProductsFromFirebase();\r\n          console.log('✅ Hoàn thành force sync products từ Firestore');\r\n        } catch (forceSyncError) {\r\n          console.error('❌ Cả sync và force sync đều thất bại:', forceSyncError);\r\n          throw forceSyncError;\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('❌ Lỗi khi load products từ Firestore:', error);\r\n      // Không throw error để không ảnh hưởng đến việc load customers và invoices\r\n    }\r\n  }\r\n\r\n  private async loadCustomersFromFirestore(): Promise<void> {\r\n    try {\r\n      console.log('🔄 Đang load customers từ Firestore...');\r\n      await this.customerService.syncCustomersFromFirebaseToIndexedDB();\r\n      console.log('✅ Hoàn thành load customers');\r\n    } catch (error) {\r\n      console.error('❌ Lỗi khi load customers từ Firestore:', error);\r\n    }\r\n  }\r\n\r\n  private async loadInvoicesFromFirestore(): Promise<void> {\r\n    try {\r\n      console.log('🔄 Đang load invoices từ Firestore...');\r\n      await this.invoiceService.syncInvoicesBetweenFirestoreAndIndexedDB(true); // Force full sync\r\n      console.log('✅ Hoàn thành load invoices');\r\n    } catch (error) {\r\n      console.error('❌ Lỗi khi load invoices từ Firestore:', error);\r\n    }\r\n  }\r\n  private async loadOrdersFromFirestore(): Promise<void> {\r\n    try {\r\n      console.log('🔄 Đang load invoices từ Firestore...');\r\n      await this.orderService.syncOrdersBetweenFirestoreAndIndexedDB(true); // Force full sync\r\n      console.log('✅ Hoàn thành load invoices');\r\n    } catch (error) {\r\n      console.error('❌ Lỗi khi load invoices từ Firestore:', error);\r\n    }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\main-page\\main-page.component.html","messages":[{"ruleId":"@angular-eslint/template/interactive-supports-focus","severity":2,"message":"Elements with interaction handlers must be focusable.","line":4,"column":5,"nodeType":null,"messageId":"interactiveSupportsFocus","endLine":29,"endColumn":11},{"ruleId":"@angular-eslint/template/click-events-have-key-events","severity":2,"message":"click must be accompanied by either keyup, keydown or keypress event for accessibility.","line":12,"column":9,"nodeType":null,"messageId":"clickEventsHaveKeyEvents","endLine":24,"endColumn":15},{"ruleId":"@angular-eslint/template/interactive-supports-focus","severity":2,"message":"Elements with interaction handlers must be focusable.","line":12,"column":9,"nodeType":null,"messageId":"interactiveSupportsFocus","endLine":24,"endColumn":15},{"ruleId":"@angular-eslint/template/alt-text","severity":2,"message":"<img/> element must have a text alternative.","line":17,"column":15,"nodeType":null,"messageId":"altText","endLine":17,"endColumn":62},{"ruleId":"@angular-eslint/template/click-events-have-key-events","severity":2,"message":"click must be accompanied by either keyup, keydown or keypress event for accessibility.","line":25,"column":9,"nodeType":null,"messageId":"clickEventsHaveKeyEvents","endLine":27,"endColumn":15},{"ruleId":"@angular-eslint/template/interactive-supports-focus","severity":2,"message":"Elements with interaction handlers must be focusable.","line":25,"column":9,"nodeType":null,"messageId":"interactiveSupportsFocus","endLine":27,"endColumn":15},{"ruleId":"@angular-eslint/template/click-events-have-key-events","severity":2,"message":"click must be accompanied by either keyup, keydown or keypress event for accessibility.","line":34,"column":9,"nodeType":null,"messageId":"clickEventsHaveKeyEvents","endLine":38,"endColumn":15},{"ruleId":"@angular-eslint/template/interactive-supports-focus","severity":2,"message":"Elements with interaction handlers must be focusable.","line":34,"column":9,"nodeType":null,"messageId":"interactiveSupportsFocus","endLine":38,"endColumn":15},{"ruleId":"@angular-eslint/template/click-events-have-key-events","severity":2,"message":"click must be accompanied by either keyup, keydown or keypress event for accessibility.","line":37,"column":11,"nodeType":null,"messageId":"clickEventsHaveKeyEvents","endLine":37,"endColumn":120},{"ruleId":"@angular-eslint/template/interactive-supports-focus","severity":2,"message":"Elements with interaction handlers must be focusable.","line":37,"column":11,"nodeType":null,"messageId":"interactiveSupportsFocus","endLine":37,"endColumn":120},{"ruleId":"@angular-eslint/template/click-events-have-key-events","severity":2,"message":"click must be accompanied by either keyup, keydown or keypress event for accessibility.","line":39,"column":9,"nodeType":null,"messageId":"clickEventsHaveKeyEvents","endLine":39,"endColumn":83},{"ruleId":"@angular-eslint/template/interactive-supports-focus","severity":2,"message":"Elements with interaction handlers must be focusable.","line":39,"column":9,"nodeType":null,"messageId":"interactiveSupportsFocus","endLine":39,"endColumn":83},{"ruleId":"@angular-eslint/template/click-events-have-key-events","severity":2,"message":"click must be accompanied by either keyup, keydown or keypress event for accessibility.","line":43,"column":9,"nodeType":null,"messageId":"clickEventsHaveKeyEvents","endLine":47,"endColumn":15},{"ruleId":"@angular-eslint/template/interactive-supports-focus","severity":2,"message":"Elements with interaction handlers must be focusable.","line":43,"column":9,"nodeType":null,"messageId":"interactiveSupportsFocus","endLine":47,"endColumn":15},{"ruleId":"@angular-eslint/template/click-events-have-key-events","severity":2,"message":"click must be accompanied by either keyup, keydown or keypress event for accessibility.","line":46,"column":11,"nodeType":null,"messageId":"clickEventsHaveKeyEvents","endLine":46,"endColumn":118},{"ruleId":"@angular-eslint/template/interactive-supports-focus","severity":2,"message":"Elements with interaction handlers must be focusable.","line":46,"column":11,"nodeType":null,"messageId":"interactiveSupportsFocus","endLine":46,"endColumn":118},{"ruleId":"@angular-eslint/template/click-events-have-key-events","severity":2,"message":"click must be accompanied by either keyup, keydown or keypress event for accessibility.","line":48,"column":9,"nodeType":null,"messageId":"clickEventsHaveKeyEvents","endLine":48,"endColumn":81},{"ruleId":"@angular-eslint/template/interactive-supports-focus","severity":2,"message":"Elements with interaction handlers must be focusable.","line":48,"column":9,"nodeType":null,"messageId":"interactiveSupportsFocus","endLine":48,"endColumn":81},{"ruleId":"@angular-eslint/template/click-events-have-key-events","severity":2,"message":"click must be accompanied by either keyup, keydown or keypress event for accessibility.","line":53,"column":7,"nodeType":null,"messageId":"clickEventsHaveKeyEvents","endLine":55,"endColumn":88},{"ruleId":"@angular-eslint/template/interactive-supports-focus","severity":2,"message":"Elements with interaction handlers must be focusable.","line":53,"column":7,"nodeType":null,"messageId":"interactiveSupportsFocus","endLine":55,"endColumn":88},{"ruleId":"@angular-eslint/template/click-events-have-key-events","severity":2,"message":"click must be accompanied by either keyup, keydown or keypress event for accessibility.","line":56,"column":7,"nodeType":null,"messageId":"clickEventsHaveKeyEvents","endLine":57,"endColumn":69},{"ruleId":"@angular-eslint/template/interactive-supports-focus","severity":2,"message":"Elements with interaction handlers must be focusable.","line":56,"column":7,"nodeType":null,"messageId":"interactiveSupportsFocus","endLine":57,"endColumn":69},{"ruleId":"@angular-eslint/template/click-events-have-key-events","severity":2,"message":"click must be accompanied by either keyup, keydown or keypress event for accessibility.","line":58,"column":7,"nodeType":null,"messageId":"clickEventsHaveKeyEvents","endLine":59,"endColumn":50},{"ruleId":"@angular-eslint/template/interactive-supports-focus","severity":2,"message":"Elements with interaction handlers must be focusable.","line":58,"column":7,"nodeType":null,"messageId":"interactiveSupportsFocus","endLine":59,"endColumn":50},{"ruleId":"@angular-eslint/template/click-events-have-key-events","severity":2,"message":"click must be accompanied by either keyup, keydown or keypress event for accessibility.","line":60,"column":7,"nodeType":null,"messageId":"clickEventsHaveKeyEvents","endLine":61,"endColumn":49},{"ruleId":"@angular-eslint/template/interactive-supports-focus","severity":2,"message":"Elements with interaction handlers must be focusable.","line":60,"column":7,"nodeType":null,"messageId":"interactiveSupportsFocus","endLine":61,"endColumn":49},{"ruleId":"@angular-eslint/template/click-events-have-key-events","severity":2,"message":"click must be accompanied by either keyup, keydown or keypress event for accessibility.","line":62,"column":7,"nodeType":null,"messageId":"clickEventsHaveKeyEvents","endLine":63,"endColumn":53},{"ruleId":"@angular-eslint/template/interactive-supports-focus","severity":2,"message":"Elements with interaction handlers must be focusable.","line":62,"column":7,"nodeType":null,"messageId":"interactiveSupportsFocus","endLine":63,"endColumn":53},{"ruleId":"@angular-eslint/template/alt-text","severity":2,"message":"<img/> element must have a text alternative.","line":112,"column":11,"nodeType":null,"messageId":"altText","endLine":112,"endColumn":63},{"ruleId":"@angular-eslint/template/click-events-have-key-events","severity":2,"message":"click must be accompanied by either keyup, keydown or keypress event for accessibility.","line":172,"column":9,"nodeType":null,"messageId":"clickEventsHaveKeyEvents","endLine":175,"endColumn":16},{"ruleId":"@angular-eslint/template/interactive-supports-focus","severity":2,"message":"Elements with interaction handlers must be focusable.","line":172,"column":9,"nodeType":null,"messageId":"interactiveSupportsFocus","endLine":175,"endColumn":16}],"suppressedMessages":[],"errorCount":31,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"<div class=\"container\">\n  <!-- Header -->\n  <div class=\"header\">\n    <div class=\"search-section\" (document:keydown.escape)=\"showDropdown = false\" (focusout)=\"showDropdown = false\">\n\n      <input #searchInput matInput (focus)=\"searchInput.select()\" type=\"text\" [(ngModel)]=\"searchTerm\"\n        (input)=\"onSearchInput()\" (keydown)=\"onKeyDown($event)\" (keydown.enter)=\"onSearchInput()\"\n        placeholder=\"Tìm hàng hóa (F3)\" class=\"search-input\" tabindex=\"1\" />\n      <i class=\"fa-solid fa-magnifying-glass search-icon\"></i>\n      <div class=\"dropdown\" *ngIf=\"showDropdown && filteredProducts.length > 0\" (mousedown)=\"$event.preventDefault()\"\n        #dropdownContainer>\n        <div class=\"dropdown-item\" *ngFor=\"let product of filteredProducts; let i = index\"\n          (click)=\"selectProduct(product)\" [class.active]=\"i === activeIndex\" #itemRefs>\n          <div class=\"product-info\">\n            <div class=\"product-name\">{{ product.FullName||product.Name }}</div>\n            <div class=\"product-details\">\n              <img class=\"thumbnail\" [src]=\"product.Image\" />\n              <span>{{ product.Code }}</span>\n              <span>Tồn: {{ product.OnHand }}</span>\n\n            </div>\n          </div>\n          <div class=\"product-price\">{{ formatPrice(product.BasePrice) }}</div>\n        </div>\n        <div class=\"add-new-item\" (click)=\"addNewProduct()\">\n          + Thêm mới hàng hóa\n        </div>\n      </div>\n    </div>\n\n    <div class=\"content-tab\">\n      <!-- Invoice Tabs -->\n      <ng-container *ngIf=\"!isOrderMode\">\n        <div class=\"invoice-tab\" *ngFor=\"let invoice of invoices; let idx = index\"\n          [class.active]=\"idx === activeTabIndex\" (click)=\"setActiveTab(idx)\">\n          <span>{{ invoice.name }}</span>\n          <i class=\"fa-solid fa-xmark close-invoice-tab\" (click)=\"removeInvoiceTab(idx); $event.stopPropagation()\"></i>\n        </div>\n        <i class=\"fa-solid fa-circle-plus add-bill\" (click)=\"addInvoiceTab()\"></i>\n      </ng-container>\n      <!-- Order Tabs -->\n      <ng-container *ngIf=\"isOrderMode\">\n        <div class=\"invoice-tab\" *ngFor=\"let order of orders; let idx = index\"\n          [class.active]=\"idx === activeOrderTabIndex\" (click)=\"setActiveOrderTab(idx)\">\n          <span>{{ order.name }}</span>\n          <i class=\"fa-solid fa-xmark close-invoice-tab\" (click)=\"removeOrderTab(idx); $event.stopPropagation()\"></i>\n        </div>\n        <i class=\"fa-solid fa-circle-plus add-bill\" (click)=\"addOrderTab()\"></i>\n      </ng-container>\n    </div>\n\n    <div class=\"menu-bar\">\n      <i class=\"fa-solid fa-wifi bar\" *ngIf=\"hasOfflineInvoices\" style=\"color: #ff6b6b;\"\n        title=\"Có hóa đơn offline chưa đồng bộ\" (click)=\"openOfflineInvoicesDialog()\"\n        matTooltip=\"Những hóa đơn bán ra khi offline và chưa đồng bộ với hệ thống\"></i>\n      <i class=\"fa-solid fa-repeat bar\" [ngClass]=\"{'spinning': isReloading}\" (click)=\"reload()\"\n        matTooltip=\"Đồng bộ sản phẩm giữa kiotviet và hệ thống\"></i>\n      <i class=\"fa-solid fa-cart-plus  toogle-print\" (click)=\"enableOrderMode()\" [class.disabled]=\"!isOrderMode\"\n        matTooltip=\"Bật tắt chế độ đặt hàng\"></i>\n      <i class=\"fa-solid fa-print toogle-print\" [class.disabled]=\"!isPrintEnabled\" (click)=\"togglePrint()\"\n        matTooltip=\"Bật tắt máy in hóa đơn\"></i>\n      <i class=\"fa-solid fa-cubes-stacked\" style=\"color: #ff6b6b;\" (click)=\"openOutOfStockDialog()\"\n        matTooltip=\"Danh sách hết hàng tồn kho\"></i>\n      <i class=\"admin\" (mouseleave)=\"showMenuDropdown = false\">admin</i>\n      <i class=\"fa-solid fa-bars bar\" (mouseenter)=\"showMenuDropdown = true\"></i>\n      <div class=\"menu-dropdown\" *ngIf=\"showMenuDropdown\" (mouseleave)=\"showMenuDropdown = false\">\n        <i class=\"fa-solid fa-boxes-stacked menu-btn\">\n          <button class=\"menu-btn\" (click)=\"onMenuClick('hanghoa')\">\n            Hàng Hóa\n          </button>\n        </i>\n        <i class=\"fa-solid fa-receipt  menu-btn\">\n          <button class=\"menu-btn\" (click)=\"onMenuClick('hoadon')\">\n            Hóa đơn\n          </button>\n        </i>\n        <i class=\"fa-solid fa-user menu-btn\">\n          <button class=\"menu-btn\" (click)=\"onMenuClick('khachhang')\">\n            Khách hàng\n          </button>\n        </i>\n        <i class=\"fa-solid fa-chart-pie menu-btn\">\n          <button class=\"menu-btn\" (click)=\"onMenuClick('baocao')\">\n            Báo cáo\n          </button>\n        </i>\n        <i class=\"fa-solid fa-cart-shopping menu-btn\">\n          <button class=\"menu-btn\" (click)=\"onMenuClick('dathang')\">\n            Đặt hàng\n          </button>\n        </i>\n        <i class=\"fa-solid fa-right-from-bracket menu-btn\"> <button class=\"menu-btn\" (click)=\"onMenuClick('dangxuat')\">\n            Đăng xuất\n          </button>\n        </i>\n      </div>\n    </div>\n  </div>\n  <router-outlet></router-outlet>\n  <div class=\"row\">\n    <!-- Cart Items -->\n    <div class=\"cart-section column\" *ngIf=\"cartItems.length > 0\">\n      <div class=\"cart-item\" *ngFor=\"let item of cartItems; let i = index\">\n        <div class=\"item-number\">{{ i + 1 }}</div>\n\n        <button class=\"delete-btn\" (click)=\"removeItem(i)\" tabindex=\"1\">\n          <!-- <mat-icon (click)=\"removeItem(i)\">delete_forever</mat-icon> -->\n          <i class=\"fas fa-trash-alt\"></i>\n        </button>\n\n        <div class=\"img-tooltip-wrapper\">\n          <img class=\"thumbnail\" [src]=\"item.product.Image\" />\n          <div class=\"tooltip-img\">\n            <img [src]=\"item.product.Image\" alt=\"preview\" />\n          </div>\n        </div>\n        <div class=\"item-code\">{{ item.product.Code||'' }}<br>\n          <span class=\"on-hand\">Tồn kho: {{ item.product.OnHand|number:'1.0-2'}}</span>\n        </div>\n\n        <div class=\"item-name\">{{ item.product.Name }}<br>\n\n        </div>\n\n        <div class=\"item-status\">{{ getItemStatus(item.product) }}</div>\n\n        <!-- Unit Dropdown -->\n        <div class=\"unit-dropdown\">\n          <select [(ngModel)]=\"item.product.Unit\" (change)=\"updateItemUnit(i, item.product.Unit)\" class=\"unit-select\"\n            tabindex=\"1\">\n            <option class=\"unit-select-option\" *ngFor=\"let unit of getAvailableUnits(item.product,item.product)\"\n              [value]=\"unit\" [selected]=\"item.product.Unit === unit\">\n              {{unit}}\n            </option>\n          </select>\n        </div>\n\n        <input type=\"number\" class=\"quantity-input\" [(ngModel)]=\"item.quantity\" (ngModelChange)=\"onQuantityChange(item)\"\n          min=\"1\" tabindex=\"1\" [ngClass]=\"{'not-enough': item.quantity > item.product.OnHand}\"\n          (keydown.enter)=\"increaseQuantity(item)\">\n\n        <div class=\"price-diff\">\n          <input type=\"text\" class=\"price-input\" [value]=\"formatPrice(item.unitPrice)\"\n            (input)=\"onUnitPriceInput($event, item)\" tabindex=\"1\" (keydown)=\"validateNumber($event)\">\n\n          <!-- Hiển thị chênh lệch nếu có -->\n          <span *ngIf=\"item.unitPriceSaleOff > 0\" style=\"color: #ED232F;\">\n            - {{ formatPrice(item.unitPriceSaleOff) }}\n          </span>\n          <span *ngIf=\"item.unitPriceSaleOff < 0\" style=\"color: #00b63e;\">\n            + {{ formatPrice(item.unitPriceSaleOff) }}\n          </span>\n        </div>\n\n        <div class=\"item-total\">{{ formatPrice(item.totalPrice) }}</div>\n\n        <button class=\"more-btn\" tabindex=\"1\" (click)=\"openEditOnHandPopup(i)\">⋮</button>\n        <!-- Popup chỉnh sửa OnHand -->\n\n        <div class=\"edit-onhand-popup\" *ngIf=\"showEditOnHandIndex === i\">\n          <span style=\"position: relative;color: white;text-align: center;font-size: 11px;\">Tồn kho: </span>\n          <input type=\"number\" [(ngModel)]=\"editOnHandValue\" min=\"0\" />\n\n          <button\n            style=\"margin-left: 5px;font-size: 11px;background-color:#00b63e;border: none;cursor: pointer;color: white; border-radius: 15px;\"\n            (click)=\"confirmEditOnHand(i)\">OK</button>\n          <button\n            style=\"margin-left: 5px;font-size: 11px;background-color:#00b63e;border: none;cursor: pointer;color: white;border-radius: 15px\"\n            (click)=\"closeEditOnHandPopup()\">Hủy</button>\n\n        </div>\n        <span class=\"note-format\" (click)=\"showNoteForProduct(i)\"\n          *ngIf=\"item.product.OrderTemplate && item.product.OrderTemplate.length > 0 && showNoteInputIndex !== i\">\n          {{ item.product.OrderTemplate}}\n        </span>\n        <input #noteInput (focusout)=\"showNoteInputIndex = null\" *ngIf=\"showNoteInputIndex === i\" class=\"note-input\"\n          [(ngModel)]=\"item.product.OrderTemplate\" tabindex=\"0\" placeholder=\"Ghi chú...\"\n          (document:keydown.escape)=\"showNoteInputIndex = null\">\n      </div>\n\n    </div>\n    <div>\n      <!-- Summary -->\n      <div class=\"main-content\">\n        <div class=\"customer-search\" style=\"position:relative;\">\n          <input #searchCustomer type=\"text\" placeholder=\"Tìm khách hàng (F4)\" class=\"customer-input\"\n            (focusout)=\"showCustomerDropdown = false\" (input)=\"onCustomerSearchInput($event)\"\n            (keydown)=\"onCustomerKeyDown($event)\" [(ngModel)]=\"customerSearchTerm\" autocomplete=\"off\"\n            (keydown.delete)=\"onCustomerDelete($event)\" (keydown.backspace)=\"onCustomerDelete($event)\" />\n\n          <mat-icon class=\"add-customer\" (click)=\"openAddCustomerDialog()\">add</mat-icon>\n\n          <div *ngIf=\"showCustomerDropdown && customerSuggestions.length > 0\"\n            class=\"dropdown-customer customer-autocomplete\">\n            <div class=\"customer-suggestion\" *ngFor=\"let customer of customerSuggestions; let i = index\"\n              (mousedown)=\"selectCustomer(customer); $event.preventDefault()\"\n              [class.active]=\"i === activeCustomerIndex\">\n              {{ customer.Name }} - {{ customer.ContactNumber || '' }}\n              <br>\n              <span style=\"color: #9b9999;height: 50%;\">Nợ: {{ customer.Debt|number:'1.0-0' }}</span>\n              &nbsp;\n              <span style=\"color: #9b9999;height: 50%;\">Điểm thưởng: {{ customer.RewardPoint||0|number:'1.0-0' }}</span>\n            </div>\n          </div>\n        </div>\n        <span *ngIf=\"selectedCustomer  && selectedCustomer.Debt > 0\"\n          style=\"margin-left: 15px;padding: 0 2px 0 2px;background-color:#faecec;color:#ED232F;border-radius: 5px;\">\n          Nợ: {{ selectedCustomer.Debt | number:'1.0-0' }}</span>\n        <span *ngIf=\"selectedCustomer && selectedCustomer.RewardPoint > 0\"\n          style=\"margin-left: 15px;padding: 0 2px 0 2px;background-color:#d9eedf;color:#12a04d;border-radius: 5px\">\n          Điểm thưởng: {{ selectedCustomer.RewardPoint||0 | number:'1.0-0' }}</span>\n        <div class=\"summary-section\">\n          <div class=\"summary-row\">\n            <span>Tổng tiền hàng:</span>\n            <span>{{ getTotalQuantity() }}</span>\n            <span>{{ formatPrice(getTotalAmount()) }}</span>\n          </div>\n          <div class=\"summary-row\">\n            <span>Giảm giá:</span>\n            <input class=\"customer-payment\" type=\"number\" [(ngModel)]=\"discountAmount\"\n              (keydown)=\"validateNumber($event)\" (ngModelChange)=\"onDiscountChange()\">\n          </div>\n          <div class=\"summary-row total\">\n            <span>Khách cần trả:</span>\n            <span class=\"total-amount\">{{ formatPrice(getTotalAmount() - (discountAmount || 0)) }}</span>\n          </div>\n\n          <div class=\"summary-row\">\n            <span>Khách thanh toán:</span>\n            <ng-container *ngIf=\"!isOrderMode\">\n              <input class=\"customer-payment\" type=\"text\"\n                [value]=\"formatPrice(invoices[activeTabIndex].customerPaid || 0)\" (input)=\"onCustomerPaidChange($event)\"\n                (click)=\"selectIfNotSelected($event)\" (keydown)=\"validateNumber($event)\" />\n            </ng-container>\n            <ng-container *ngIf=\"isOrderMode\">\n              <input class=\"customer-payment\" type=\"text\"\n                [value]=\"formatPrice(orders[activeOrderTabIndex].customerPaid || 0)\"\n                (input)=\"onCustomerPaidChange($event)\" (click)=\"selectIfNotSelected($event)\"\n                (keydown)=\"validateNumber($event)\" />\n            </ng-container>\n          </div>\n\n          <div class=\"summary-row change-amount\">\n            <span *ngIf=\"getChangeAmount() >= 0\" style=\"color: rgb(25, 139, 15);\">Số tiền thừa:</span>\n\n            <span *ngIf=\"getChangeAmount() >= 0\" style=\"color: rgb(25, 139, 15);\">\n              {{ formatPrice(getChangeAmount())}}\n              <span *ngIf=\"getChangeAmount() < 0\"\n                style=\"font-size: 12px;color: red; font-weight: bold; margin-left: 2px;\">Nợ</span>\n            </span>\n            <span *ngIf=\"getChangeAmount() < 0\" style=\"color: red;\">Số tiền thừa:</span>\n            <span *ngIf=\"getChangeAmount() < 0\" style=\"color: red;\">\n              {{ formatPrice(getChangeAmount()) }}\n              <span *ngIf=\"getChangeAmount() < 0\"\n                style=\"font-size: 12px;color: red; font-weight: bold; margin-left: 2px;\">Nợ</span>\n            </span>\n          </div>\n          <div>\n            <label>\n              <input type=\"radio\" name=\"paymentMode\" [(ngModel)]=\"paymentMode\" value=\"normal\" /> Tính thường\n            </label>\n            <label>\n              <input type=\"radio\" name=\"paymentMode\" [(ngModel)]=\"paymentMode\" value=\"debt\" /> Tính vào công nợ\n            </label>\n          </div>\n        </div>\n\n        <!-- Payment Options -->\n        <div class=\"payment-section\">\n\n          <!-- Quick Amount Buttons -->\n          <span>Chọn nhanh số tiền khách trả:</span>\n          <div class=\"quick-amounts\">\n            <button *ngFor=\"let amount of quickAmounts\" class=\"amount-btn\" (click)=\"selectQuickAmount(amount)\">\n              {{ formatPrice(amount) }}\n            </button>\n          </div>\n        </div>\n        <div class=\"phimtat-list\">\n          <span>\n            - <span style=\"font-weight: bold;\"> F1:</span> Tạo hóa đơn mới\n          </span>\n          <span>\n            - <span style=\"font-weight: bold;\"> F2:</span> Bật tắt in hóa đơn giấy\n          </span>\n\n          <span>\n            - <span style=\"font-weight: bold;\"> F3:</span> Thay con chuột trỏ vào ô tìm kiếm hàng hóa\n          </span>\n          <span>\n            - <span style=\"font-weight: bold;\"> F4:</span> Thay con chuột trỏ vào ô tìm kiếm khác hàng\n          </span>\n          <span>\n            - <span style=\"font-weight: bold;\"> TAB:</span>Thay con chuột trỏ các nút bấm có tô đen\n          </span>\n          <span>\n            - &#8593; &#8595;: Tăng giảm trong ô nhập số lượng sản phẩm\n          </span>\n          <span>\n            - <span style=\"font-weight: bold;\"> F9:</span> Thanh toán\n          </span>\n        </div>\n        <!-- Checkout Button -->\n        <div class=\"checkout-section\">\n          <button class=\"checkout-btn\" *ngIf=\"!isOrderMode && !isEditMode\" (click)=\"checkout()\">\n            THANH TOÁN (F9)\n          </button>\n          <button class=\"checkout-btn\" *ngIf=\"!isOrderMode && isEditMode\" (click)=\"isEditModeInvoice ? saveEditedInvoice() : checkout()\" style=\"background-color: #ffd600; color: #333;\">\n            {{ isEditModeInvoice ? 'LƯU HÓA ĐƠN ĐÃ SỬA (F9)' : 'LƯU CHỈNH SỬA (F9)' }}\n          </button>\n          <button class=\"checkout-btn\" *ngIf=\"isOrderMode\" (click)=\"order()\">\n            ĐẶT HÀNG (F9)\n          </button>\n        </div>\n\n        <!-- Order Notes -->\n      </div>\n\n\n    </div>\n    <div class=\"notes-section\">\n      <input type=\"text\" placeholder=\"Ghi chú đơn hàng\" class=\"notes-input\" [(ngModel)]=\"invoiceNote\">\n    </div>\n\n  </div>\n  <app-invoice-detail *ngIf=\"selectedInvoice\" [invoice]=\"selectedInvoice\" #invoiceDetailComp style=\"display:none\">\n  </app-invoice-detail>","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\main-page\\main-page.component.ts","messages":[{"ruleId":"@angular-eslint/component-selector","severity":2,"message":"The selector should start with one of these prefixes: \"app\" (https://angular.dev/style-guide#style-02-07)","line":59,"column":13,"nodeType":"Literal","messageId":"prefixFailure","endLine":59,"endColumn":24},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":89,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":89,"endColumn":43},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":90,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":90,"endColumn":39},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":91,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":91,"endColumn":43},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":92,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":92,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":93,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":93,"endColumn":39},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":94,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":94,"endColumn":30},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":95,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":95,"endColumn":27},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":96,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":96,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":97,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":97,"endColumn":53},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":98,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":98,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":99,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":99,"endColumn":43},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":100,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":100,"endColumn":39},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":101,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":101,"endColumn":57},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":103,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":103,"endColumn":47},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":119,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5063,5066],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5063,5066],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":212,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":212,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8427,8430],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8427,8430],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":327,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":327,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12709,12712],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12709,12712],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":747,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":747,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29018,29021],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29018,29021],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":773,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":773,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[30002,30005],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[30002,30005],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":846,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":846,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32319,32322],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32319,32322],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":854,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":854,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32633,32636],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32633,32636],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":928,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":928,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35091,35094],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35091,35094],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":943,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":943,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35352,35355],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35352,35355],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":966,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":966,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36085,36088],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36085,36088],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":992,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":992,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36897,36900],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36897,36900],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'index' is defined but never used.","line":1034,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":1034,"endColumn":24},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1136,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1136,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[41603,41606],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[41603,41606],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1231,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1231,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[44724,44727],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[44724,44727],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1239,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1239,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[45120,45123],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[45120,45123],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1363,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1363,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[49899,49902],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[49899,49902],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1390,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1390,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[50795,50798],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[50795,50798],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1525,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1525,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[55492,55495],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[55492,55495],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1534,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1534,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[55883,55886],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[55883,55886],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1648,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1648,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[59849,59852],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[59849,59852],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1650,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1650,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[59912,59915],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[59912,59915],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1651,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1651,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[60016,60019],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[60016,60019],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1653,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1653,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[60213,60216],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[60213,60216],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1653,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1653,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[60250,60253],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[60250,60253],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1655,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1655,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[60453,60456],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[60453,60456],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1656,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1656,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[60553,60556],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[60553,60556],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1661,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1661,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[60840,60843],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[60840,60843],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1662,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1662,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[60920,60923],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[60920,60923],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1691,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1691,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[62137,62140],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[62137,62140],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1691,"column":83,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1691,"endColumn":86,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[62174,62177],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[62174,62177],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1693,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1693,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[62297,62300],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[62297,62300],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1795,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1795,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[65646,65649],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[65646,65649],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1863,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1863,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[68494,68497],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[68494,68497],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2029,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2029,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[74696,74699],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[74696,74699],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2033,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2033,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[74796,74799],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[74796,74799],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2038,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2038,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[74950,74953],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[74950,74953],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2073,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2073,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[76483,76486],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[76483,76486],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2076,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2076,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[76568,76571],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[76568,76571],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2078,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2078,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[76655,76658],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[76655,76658],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2079,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2079,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[76705,76708],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[76705,76708],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2087,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2087,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[77029,77032],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[77029,77032],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2100,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2100,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[77524,77527],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[77524,77527],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2102,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2102,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[77630,77633],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[77630,77633],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2103,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2103,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[77699,77702],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[77699,77702],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2109,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2109,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[77999,78002],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[77999,78002],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2110,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2110,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[78086,78089],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[78086,78089],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2141,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2141,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[79381,79384],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[79381,79384],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'err' is defined but never used.","line":2192,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":2192,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2335,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2335,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[86123,86126],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[86123,86126],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2337,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2337,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[86221,86224],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[86221,86224],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":2338,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":2338,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2389,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2389,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88021,88024],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88021,88024],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2390,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2390,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88122,88125],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88122,88125],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2391,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2391,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88230,88233],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88230,88233],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2391,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2391,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88267,88270],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88267,88270],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2392,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2392,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88348,88351],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88348,88351],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2393,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2393,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88435,88438],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88435,88438],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2397,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2397,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88574,88577],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88574,88577],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2398,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2398,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88653,88656],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88653,88656],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2399,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2399,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88741,88744],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88741,88744],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2400,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2400,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88817,88820],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88817,88820],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2429,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2429,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[89710,89713],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[89710,89713],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2431,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2431,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[89808,89811],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[89808,89811],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":2432,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":2432,"endColumn":19}],"suppressedMessages":[],"errorCount":79,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, OnInit, ViewChild, ElementRef, HostListener, ViewChildren, QueryList, OnDestroy, DoCheck } from '@angular/core';\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\nimport { CommonModule } from '@angular/common';\nimport { MatIconModule, } from '@angular/material/icon';\nimport { MatTabsModule } from '@angular/material/tabs';\nimport { MatTooltipModule } from '@angular/material/tooltip';\nimport { MatDialogModule } from '@angular/material/dialog';\nimport { MatInputModule } from '@angular/material/input';\nimport { MatSelectModule } from '@angular/material/select';\nimport { MatDatepickerModule } from '@angular/material/datepicker';\nimport { MatNativeDateModule } from '@angular/material/core';\nimport { MatButtonModule } from '@angular/material/button';\nimport { MatSnackBarModule } from '@angular/material/snack-bar';\nimport { MatTableModule } from '@angular/material/table';\nimport { MatPaginatorModule } from '@angular/material/paginator';\nimport { MatSortModule } from '@angular/material/sort';\nimport { MatRadioModule } from '@angular/material/radio';\nimport { debounceTime } from 'rxjs/operators';\nimport { Subscription } from 'rxjs';\nimport { MatDialog } from '@angular/material/dialog';\nimport { Router } from '@angular/router';\nimport { RouterModule } from '@angular/router';\nimport { MatFormFieldModule } from '@angular/material/form-field';\n//libs\nimport { IndexedDBService } from '../../services/indexed-db.service';\nimport { firstValueFrom, Subject } from 'rxjs';\n//component\nimport { InvoiceDetailComponent } from \"../../components/invoice-detail/invoice-detail.component\";\nimport { ConfirmPopupComponent } from '../../components/confirm-popup/confirm-popup.component';\nimport { InvoicesPageComponent } from '../../components/invoices-page/invoices-page.component';\nimport { OutOfStockDialogComponent } from '../../components/out-of-stock-dialog/out-of-stock-dialog.component';\nimport { OrderPageComponent } from '../../components/order-page/order-page.component';\n\n//model\nimport { Product } from '../../models/product.model';\nimport { CartItem } from '../../models/cart-item.model';\nimport { InvoiceTab } from '../../models/invoice.model';\nimport { Customer } from '../../models/customer.model';\n//services\nimport { CustomerService } from '../../services/customer.service';\nimport { PrintService } from '../../services/print.service';\nimport { ProductService } from '../../services/product.service';\nimport { GroupService } from '../../services/group.service';\nimport { InvoiceService } from '../../services/invoice.service';\nimport { OrderService } from '../../services/order.service';\nimport { OrderToInvoiceService } from '../../services/order-to-invoice.service';\nimport { KiotvietService } from '../../services/kiotviet.service';\nimport { LocalStorageService } from '../../services/local-storage.service';\nimport { ReportPageComponent } from '../report-page/report-page.component';\nimport { AddCustomerComponent } from '../add-customer/add-customer.component';\nimport { CustomersPageComponent } from '../customers-page/customers-page.component';\nimport { TimeZoneService } from '../../services/time-zone.service';\nimport { OfflineInvoicesListComponent } from '../offline-invoices-list/offline-invoices-list.component';\nimport { UtilityService } from '../../services/utility.service';\n\nimport { environment } from '../../../environments/environment';\n\n@Component({\n  selector: 'main-page',\n  standalone: true,\n  imports: [CommonModule,\n    FormsModule,\n    ReactiveFormsModule,\n    MatIconModule,\n    MatTabsModule,\n    InvoiceDetailComponent,\n    MatTooltipModule,\n    RouterModule,\n    MatFormFieldModule,\n    MatDialogModule,\n    MatInputModule,\n    MatSelectModule,\n    MatDatepickerModule,\n    MatNativeDateModule,\n    MatButtonModule,\n    MatSnackBarModule,\n    MatTableModule,\n    MatPaginatorModule,\n    MatSortModule,\n    MatRadioModule\n  ],\n  templateUrl: './main-page.component.html',\n  styleUrls: ['./main-page.component.css'],\n\n})\nexport class MainPageComponent implements OnInit, OnDestroy, DoCheck {\n\n  constructor(\n    private productService: ProductService,\n    private groupService: GroupService,\n    private invoiceService: InvoiceService,\n    private customerService: CustomerService,\n    private printService: PrintService,\n    private dialog: MatDialog,\n    private router: Router,\n    private kiotvietService: KiotvietService,\n    private localStorageService: LocalStorageService,\n    private timeZoneService: TimeZoneService,\n    private utilityService: UtilityService,\n    private orderService: OrderService,\n    private orderToInvoiceService: OrderToInvoiceService\n    ,\n    private indexedDBService: IndexedDBService\n  ) {\n    // this.addInvoiceTab();\n  }\n\n  searchTerm = '';\n  showDropdown = false;\n  showCustomerDropdown = false;\n  filteredProducts: Product[] = [];\n\n  showNoteInput = false;\n  selectedItem: CartItem | null = null;\n  // removed unused variable `swtichedItem`\n  discountAmount = 0;\n  discountType = 'VND';\n  deliveryTime = '';\n  groupedProducts: Record<number, any[]> = {}\n  paymentMode: 'normal' | 'debt' = 'normal';\n  cartItems: CartItem[] = [];\n  invoices: InvoiceTab[] = [];\n  tabCounter = 1;\n  activeIndex = 0;\n  activeTabIndex = 0;\n\n  @ViewChild(InvoiceDetailComponent, { static: false })\n  invoiceDetailComponent!: InvoiceDetailComponent;\n\n\n  get selectedInvoice(): InvoiceTab | null {\n    return this.invoices[this.activeTabIndex] || null;\n  }\n  searchChanged: Subject<string> = new Subject<string>();\n\n  @ViewChild('printSection', { static: false }) printSection!: ElementRef;\n  @ViewChildren('itemRefs') itemRefs!: QueryList<ElementRef>;\n  @ViewChild('dropdownContainer') dropdownContainer!: ElementRef;\n  @ViewChild('searchInput') searchInput!: ElementRef;\n  @ViewChild('searchCustomer') searchCustomer!: ElementRef;\n  @ViewChildren('noteInput') noteInputs!: QueryList<ElementRef>;\n\n\n  validateNumber(event: KeyboardEvent) {\n    this.utilityService.validateNumber(event)\n  }\n\n  // Load data from localStorage on component initialization\n  private loadDataFromLocalStorage(): void {\n    if (!this.localStorageService.isStorageAvailable()) {\n      console.warn('localStorage is not available');\n      return;\n    }\n\n    // Load invoice tabs\n    const savedInvoices = this.localStorageService.getInvoiceTabs();\n    if (savedInvoices.length > 0) {\n      this.invoices = savedInvoices;\n      this.tabCounter = savedInvoices.length + 1;\n    }\n\n    // Load active tab index\n    this.activeTabIndex = this.localStorageService.getActiveTabIndex();\n\n    // Ensure activeTabIndex is within bounds\n    if (this.activeTabIndex >= this.invoices.length) {\n      this.activeTabIndex = 0;\n    }\n\n    // Load cart items for the active tab\n    if (this.invoices.length > 0) {\n      const savedCartItems = this.localStorageService.getCartItems(this.activeTabIndex);\n      this.cartItems = savedCartItems;\n\n      // Sync cart items with the active invoice\n      if (this.invoices[this.activeTabIndex]) {\n        this.invoices[this.activeTabIndex].cartItems = [...this.cartItems];\n      }\n\n      // Load other tab-specific data\n      this.discountAmount = this.localStorageService.getDiscountAmount(this.activeTabIndex);\n      this.selectedCustomer = this.localStorageService.getSelectedCustomer(this.activeTabIndex);\n      this.invoiceNote = this.localStorageService.getInvoiceNote(this.activeTabIndex);\n\n      // Update customer search term if customer exists\n      if (this.selectedCustomer) {\n        this.customerSearchTerm = this.selectedCustomer.Name + ' - ' + (this.selectedCustomer.ContactNumber || '');\n      }\n    }\n  }\n\n  // Save data to localStorage\n  private saveDataToLocalStorage(): void {\n    if (!this.localStorageService.isStorageAvailable()) {\n      return;\n    }\n\n    // Save cart items for current tab\n    this.localStorageService.saveCartItems(this.cartItems, this.activeTabIndex);\n\n    // Save invoice tabs\n    this.localStorageService.saveInvoiceTabs(this.invoices);\n\n    // Save active tab index\n    this.localStorageService.saveActiveTabIndex(this.activeTabIndex);\n\n    // Save other tab-specific data\n    this.localStorageService.saveDiscountAmount(this.discountAmount, this.activeTabIndex);\n    this.localStorageService.saveSelectedCustomer(this.selectedCustomer, this.activeTabIndex);\n    this.localStorageService.saveInvoiceNote(this.invoiceNote, this.activeTabIndex);\n  }\n  private onHandReloadInterval: any = null;\n  private subscriptions: Subscription[] = [];\n  async ngOnInit() {\n\n    // this.productService.loadItemsFromKiotVietToIndexedDB().then(() => {\n    //   console.log('Tất cả sản phẩm đã được tải và lưu vào IndexedDB.');\n    // }).catch((err) => {\n    //   console.error('Lỗi khi tải tất cả sản phẩm:', err);\n    // });\n\n    this.loadDataFromLocalStorage();\n    if (this.invoices.length === 0) {\n      this.addInvoiceTab();\n    }\n    await this.syncCartItemsWithIndexedDB();\n    setTimeout(() => {\n      this.searchInput?.nativeElement.focus();\n    }, 0);\n\n    await this.groupProduct();\n    const searchSub = this.searchChanged.pipe(\n      debounceTime(400) // 300ms sau khi dừng nhập mới search\n    ).subscribe(query => {\n      this.onSearchInputInternal(query);\n    });\n    this.subscriptions.push(searchSub);\n    //download product tu kiotviet den indexedDB\n\n    // Initialize WebSocket for real-time notifications\n    await this.initializeWebSocket();\n\n    // Kiểm tra có invoice offline không\n    this.checkOfflineInvoices();\n\n    this.setquickAmounts();\n\n    // Định kỳ reload lại OnHand cho cartItems mỗi 10s\n    this.onHandReloadInterval = setInterval(() => {\n      this.reloadCartItemsOnHand();\n    }, 10000);\n\n    // Nếu đang ở Order Mode mà chưa có order tab thì tạo mới\n    if (this.isOrderMode && this.orders.length === 0) {\n      this.addOrderTab();\n    }\n\n    // Subscribe to invoice created events to handle orders converted to invoices\n    const invoiceCreatedSub = this.invoiceService.invoiceCreated$.subscribe(invoice => {\n      console.log(`🆕 Main page: Invoice created from order - ${invoice.id}`);\n      // If the invoice name contains \"từ đơn hàng\", it was converted from an order\n      if (invoice.name && invoice.name.includes('từ đơn hàng')) {\n        console.log(`✅ Invoice ${invoice.id} was converted from an order and is now available in the invoice system`);\n      }\n    });\n    this.subscriptions.push(invoiceCreatedSub);\n\n    // Subscribe to order processed events\n    const orderProcessedSub = this.orderToInvoiceService.orderProcessed$.subscribe(data => {\n      console.log(`🔄 Main page: Received order processed data - ${data.orderId}`);\n      this.handleProcessedOrder(data.order, data.orderId);\n    });\n    this.subscriptions.push(orderProcessedSub);\n    \n    // Subscribe to real-time product OnHand updates\n    const onHandSub = this.productService.productOnHandUpdated$.subscribe(({ productId, onHand }) => {\n      try {\n        console.log('🟢 MainPageComponent: received productOnHandUpdated', { productId, onHand });\n        \n        // Update in-memory filteredProducts / groupedProducts if present\n        let updated = false;\n        for (const p of this.filteredProducts) {\n          if (p?.Id === productId) {\n            p.OnHand = onHand;\n            updated = true;\n          }\n        }\n        \n        // Update cartItems if they reference the product\n        for (const item of this.cartItems) {\n          if (item.product?.Id === productId) {\n            item.product.OnHand = onHand;\n            updated = true;\n          }\n        }\n        \n        if (updated) {\n          // Refresh groupedProducts to reflect updated OnHand where necessary\n          this.groupProduct().catch(err => console.error('Error refreshing groupedProducts after OnHand update', err));\n        }\n      } catch (err) {\n        console.error('Error handling productOnHandUpdated in MainPageComponent', err);\n      }\n    });\n    this.subscriptions.push(onHandSub);\n  }\n\n  private async initializeWebSocket(): Promise<void> {\n    try {\n      // Initialize WebSocket connection for real-time notifications\n      await this.invoiceService.initializeWebSocket();\n      console.log('🔌 WebSocket initialized for main page real-time notifications');\n    } catch (error) {\n      console.error('❌ Failed to initialize WebSocket for main page:', error);\n    }\n  }\n\n  async reload() {\n    this.isReloading = true;\n    try {\n      console.log('🔄 Bắt đầu reload dữ liệu...');\n\n      // ✅ Gọi API lấy toàn bộ sản phẩm từ KiotViet chỉ 1 lần\n      const apiUrl = environment.domainUrl + this.kiotvietService.kiotviet_items_api;\n      let apiProducts = await this.productService['http'].get<Product[]>(apiUrl)\n        .toPromise()\n        .catch((err: any) => {\n          console.error('❌ Lỗi khi tải tất cả sản phẩm từ KiotViet:', err);\n          return [] as Product[];\n        });\n      if (!apiProducts) apiProducts = [];\n\n      // ✅ Bước 1: Cleanup orphaned products (xóa products trong IndexedDB mà không có trong API)\n      console.log('🧹 Bước 1: Cleanup orphaned products...');\n      const cleanupResult = await this.productService.cleanupOrphanedProductsFromAPI(apiProducts).catch((err) => {\n        console.error('❌ Lỗi khi cleanup orphaned products:', err);\n        return { deletedCount: 0, totalChecked: 0 };\n      });\n\n      console.log(`✅ Cleanup hoàn thành: đã xóa ${cleanupResult.deletedCount}/${cleanupResult.totalChecked} orphaned products`);\n\n      // ✅ Bước 2: Load và sync products từ KiotViet\n      console.log('📦 Bước 2: Load và sync products từ KiotViet...');\n      await this.productService.loadItemsFromKiotVietToIndexedDB(apiProducts).then(() => {\n        console.log('✅ Tất cả sản phẩm đã được tải và lưu vào IndexedDB.');\n      }).catch((err) => {\n        console.error('❌ Lỗi khi tải tất cả sản phẩm:', err);\n      });\n\n      // ✅ Bước 3: Sync customers (nếu cần)\n      console.log('👥 Bước 3: Sync customers từ KiotViet...');\n      await this.customerService.loadCustomersFromKiotvietToIndexedDB().then(() => {\n        console.log('✅ Tất cả customer đã được tải và lưu vào IndexedDB.');\n      }).catch((err) => {\n        console.error('❌ Lỗi khi tải tất cả customer:', err);\n      });\n\n      // ✅ Bước 4: Sync invoices (nếu cần)\n      console.log('📄 Bước 4: Sync invoices...');\n      await this.invoiceService.syncInvoicesBetweenFirestoreAndIndexedDB().then(() => {\n        console.info('✅ Tất cả invoices đã được tải và lưu vào IndexedDB thành công!');\n      }).catch(err => {\n        console.error(`❌ Lỗi khi tải và lưu invoices vào IndexedDB: ${err}`);\n      });\n\n      console.log('✅ Tất cả dữ liệu đã được reload thành công!');\n      console.log(`📊 Tóm tắt: Đã xóa ${cleanupResult.deletedCount} orphaned products, sync products, customers và invoices`);\n\n    } catch (err) {\n      console.error('❌ Lỗi khi reload dữ liệu:', err);\n    } finally {\n      this.isReloading = false;\n    }\n  }\n\n\n  async checkout() {\n    // Check if in edit mode\n    if (this.isEditMode) {\n      await this.saveEditedOrder();\n      return;\n    }\n\n    // ✅ Kiểm tra OnHand từ IndexedDB thay vì từ cartItems\n    const notEnough = await this.checkOnHandFromIndexedDB();\n    if (notEnough) {\n      alert('Không đủ số lượng');\n      return;\n    }\n\n    if (this.cartItems.length === 0) {\n      alert('Giỏ hàng trống!');\n      return;\n    }\n    // Kiểm tra nếu số tiền thừa (change) khác 0 mà chưa nhập khách hàng\n    if (this.getChangeAmount() < 0 && !this.selectedCustomer) {\n      alert('CẦN NHẬP KHÁCH HÀNG ĐỂ QUẢN LÝ CÔNG NỢ');\n      return;\n    }\n\n    // ✅ 1. Lưu thông tin invoice hiện tại TRƯỚC KHI thay đổi activeTab\n    const now = new Date();\n    const vnNow = this.timeZoneService.formatVietnamISOString(now);\n    const currentInvoiceIndex = this.activeTabIndex;\n    this.invoices[currentInvoiceIndex].debt = this.getChangeAmount();\n    this.invoices[currentInvoiceIndex].note = this.invoiceNote;\n    this.createdDate = vnNow\n\n    const invoice: InvoiceTab = {\n      ...this.invoices[currentInvoiceIndex],\n      createdDate: this.createdDate,\n      totalPrice: this.invoices[currentInvoiceIndex].totalPrice - this.invoices[currentInvoiceIndex].discountAmount,\n      customer: this.invoices[currentInvoiceIndex].customer ? { ...this.invoices[currentInvoiceIndex].customer } : null,\n      debt: this.invoices[currentInvoiceIndex].debt >= 0 ? 0 : this.invoices[currentInvoiceIndex].debt,\n      discountAmount: this.invoices[currentInvoiceIndex].discountAmount,\n      note: this.invoices[currentInvoiceIndex].note\n    };\n\n    // Trước khi reset selectedCustomer hoặc sau khi tạo invoice:\n    if (this.paymentMode === 'debt' && invoice.customer?.Id) {\n      const changeAmount = this.getChangeAmount();\n      if (changeAmount < 0) {\n        invoice.customer.Debt += Math.abs(changeAmount);\n      } else {\n        invoice.customer.Debt -= changeAmount;\n        if (invoice.customer.Debt < 0) invoice.customer.Debt = 0;\n      }\n      // Nếu cần update customer vào DB:\n      console.log('Bắt đầu update customer debt:', invoice.customer.Id, invoice.customer.Debt);\n      try {\n        await this.customerService.updateCustomerDebt(invoice.customer.Id, invoice.customer.Debt);\n        console.log('Đã gọi updateCustomerDebt');\n        const updatedCustomer = await this.customerService.getCustomerByIdFromIndexedDB(invoice.customer.Id);\n        console.log('✅ Customer sau khi update Debt:', updatedCustomer);\n      } catch (err) {\n        console.error('❌ Lỗi khi update customer debt:', err);\n      }\n    }\n    // ✅ 3. Print TRƯỚC KHI xóa invoice (nếu cần)\n    if (this.isPrintEnabled) {\n      // Gán invoice vừa tạo vào component để in đúng createdDate\n      if (this.invoiceDetailComponent) {\n        this.invoiceDetailComponent.invoice = invoice;\n      }\n      const html = this.invoiceDetailComponent?.getHtmlContent();\n      if (html) {\n        this.printService.printHtml(html);\n      }\n    }\n    // ✅ Clear localStorage data for the current tab before removing it\n    this.localStorageService.clearTabData(currentInvoiceIndex);\n    // ✅ 4. Xóa invoice đã checkout\n    this.invoices.splice(currentInvoiceIndex, 1);\n\n    // ✅ 5. Xử lý chuyển tab\n    if (this.invoices.length === 0) {\n      // Tạo tab mới nếu không còn invoice nào\n      this.addInvoiceTab();\n    } else {\n      // Chuyển sang tab còn lại\n      const newIndex = Math.min(currentInvoiceIndex, this.invoices.length - 1);\n      this.setActiveTab(newIndex);\n    }\n\n    // ✅ 2. Gửi lên Firestore với xử lý offline\n    this.invoiceService.addInvoiceToFirestore(invoice).subscribe({\n      next: async res => {\n        // 🔌 Real-time: Thông báo tạo hóa đơn mới qua Socket.IO\n        try {\n          await this.invoiceService.notifyInvoiceCreated(invoice);\n\n          // Check if this invoice was created from an order and update order status\n          if (invoice.name && invoice.name.includes('từ đơn hàng')) {\n            const orderIdMatch = invoice.name.match(/từ đơn hàng (DH\\d+)/);\n            if (orderIdMatch && orderIdMatch[1]) {\n              const orderId = orderIdMatch[1];\n              console.log(`🔄 Updating order status to 'checked' for order ${orderId}`);\n              await this.updateOrderStatusToChecked(orderId);\n            }\n          }\n\n          //update onhand trong kiotviet\n          this.kiotvietService.updateOnHandFromInvoiceToKiotviet(invoice, this.groupedProducts).then(async () => {\n            console.log('Sản phẩm đã được cập nhật onHand vào kiotviet.');\n          }).catch((err) => {\n            console.error('Lỗi khi cập nhật sản phẩm:', err);\n          });\n          console.info(`Đã thanh toán thành công: ${res}`)\n          console.error('✅ Notifying invoice creation via Socket.IO:', res);\n        } catch (error) {\n          console.error('❌ Error notifying invoice creation via Socket.IO:', error);\n        }\n      },\n      error: async err => {\n        console.error(`Không thể gửi lên Firebase: ${err}`);\n        // Lưu vào offline store nếu không thể gửi lên Firebase\n        try {\n          await this.invoiceService.saveInvoiceToOffline(invoice);\n          this.hasOfflineInvoices = true;\n          console.log('Đã lưu invoice vào offline store');\n        } catch (offlineError) {\n          console.error('Lỗi khi lưu vào offline store:', offlineError);\n        }\n      }\n    });\n\n    //gui den indexedDB\n    this.invoiceService.addInvoiceToDB(invoice).then(async () => {\n      console.log('Đã thêm hóa đơn vào indexedDB.');\n    }).catch((err) => {\n      console.error('Lỗi khi cập nhật tất cả sản phẩm:', err);\n    });\n\n\n    // Sau khi checkout, cập nhật lại OnHand cho tất cả sản phẩm trong cart\n    for (const item of this.cartItems) {\n      // Lấy OnHand mới nhất (sau khi chỉnh tay hoặc từ IndexedDB)\n      const currentOnHand = item.product.OnHand;\n      // Trừ đi số lượng bán ra\n      const newOnHand = currentOnHand - item.quantity;\n      // Cập nhật lại vào IndexedDB\n      await this.productService.updateProductOnHandLocal(item.product.Id, newOnHand);\n      // Nếu muốn đồng bộ lên Firestore, gọi updateProductOnHandToFireStore\n    }\n\n    // ✅ 6. Reset customer search (không cần reset cart vì đã chuyển tab)\n    this.discountAmount = 0;\n    this.change = 0;\n    this.formattedCustomerPaid = '0';\n    this.invoiceNote = '';\n\n    try {\n      // Chỉ truyền các sản phẩm chưa chỉnh tay vào API trừ OnHand\n      const res = await this.productService.updateProductsOnHandFromInvoiceToFireBase(\n        invoice,\n        this.groupedProducts,\n        this.manuallyEditedOnHandProductIds\n      );\n      console.log('Đã cập nhật tồn kho các sản phẩm từ hóa đơn đến fire store:', res);\n\n      // Cập nhật lại từng sản phẩm trong IndexedDB sử dụng new_OnHand từ response\n      if (res && res.updated_products) {\n        for (const p of res.updated_products) {\n          await this.productService.updateProductOnHandLocal(p.Id, p.new_OnHand);\n          console.log(`✅ Cập nhật sản phẩm ${p.Id}: OnHand = ${p.new_OnHand}`);\n        }\n      }\n\n      // Xóa các sản phẩm đã chỉnh tay khỏi set (nếu muốn)\n      this.manuallyEditedOnHandProductIds.clear();\n    } catch (err) {\n      console.error('Lỗi khi cập nhật tồn kho các sản phẩm:', err);\n    }\n\n  }\n\n  // ✅ Thêm hàm kiểm tra OnHand từ IndexedDB\n  private async checkOnHandFromIndexedDB(): Promise<boolean> {\n    try {\n  const db = await this.indexedDBService.getDB('SalesDB', 1);\n\n      // Gom các sản phẩm trong cart theo group (masterUnitId)\n      const groupMap: Record<number, { totalSell: number, totalOnHand: number }> = {};\n\n      for (const item of this.cartItems) {\n        const masterUnitId = item.product.MasterUnitId || item.product.Id;\n        const group = this.groupedProducts[masterUnitId];\n        if (!group) continue;\n\n        // Tính tổng số lượng bán quy đổi về master\n        const sellQty = item.quantity * item.product.ConversionValue;\n\n        if (!groupMap[masterUnitId]) {\n          // Lấy tổng OnHand thực tế của group (quy đổi về master)\n          let totalOnHand = 0;\n          for (const p of group) {\n            const latestProduct = await db.transaction('products', 'readonly').store.get(p.Id);\n            if (latestProduct) {\n              totalOnHand += latestProduct.OnHand * p.ConversionValue;\n            }\n          }\n          groupMap[masterUnitId] = { totalSell: 0, totalOnHand };\n        }\n        groupMap[masterUnitId].totalSell += sellQty;\n      }\n\n      // Kiểm tra từng group\n      for (const masterUnitId in groupMap) {\n        if (groupMap[masterUnitId].totalSell > groupMap[masterUnitId].totalOnHand) {\n          console.log(`❌ Không đủ hàng cho group ${masterUnitId}: cần ${groupMap[masterUnitId].totalSell}, có ${groupMap[masterUnitId].totalOnHand}`);\n          return true; // Không đủ hàng\n        }\n      }\n\n      return false; // Đủ hàng\n    } catch (error) {\n      console.error('❌ Lỗi khi kiểm tra OnHand từ IndexedDB:', error);\n      return true; // Nếu lỗi, không cho phép bán\n    }\n  }\n\n  ngDoCheck() {\n    this.setquickAmounts();\n  }\n  async groupProduct() {\n    const db = await this.indexedDBService.getDB('SalesDB', 1);\n    const tx = db.transaction('products', 'readonly');\n    this.filteredProducts = await tx.store.getAll();\n    this.groupedProducts = await this.groupService.group(this.filteredProducts)\n\n  }\n\n  scrollToActiveItem() {\n    const items = this.itemRefs.toArray();\n\n    if (this.activeIndex >= 0 && this.activeIndex < items.length) {\n      const element = items[this.activeIndex].nativeElement;\n      const container = this.dropdownContainer?.nativeElement;\n\n      if (element && container) {\n        const elementTop = element.offsetTop;\n        const elementBottom = elementTop + element.offsetHeight;\n        const containerTop = container.scrollTop;\n        const containerBottom = containerTop + container.offsetHeight;\n\n        if (elementBottom > containerBottom) {\n          container.scrollTop = elementBottom - container.offsetHeight;\n        } else if (elementTop < containerTop) {\n          container.scrollTop = elementTop;\n        }\n      }\n    }\n  }\n  private enterPressed = false;\n  onKeyDown(event: KeyboardEvent) {\n    if (event.key === 'Enter') {\n      this.enterPressed = true;\n      // Nếu có sản phẩm, chọn sản phẩm\n      if (this.showDropdown && this.filteredProducts.length > 0) {\n        event.preventDefault();\n        if (this.activeIndex >= 0 && this.activeIndex < this.filteredProducts.length) {\n          this.selectProduct(this.filteredProducts[this.activeIndex]);\n        }\n      }\n    } else if (!this.showDropdown || this.filteredProducts.length === 0) {\n      return;\n    } else if (event.key === 'ArrowDown') {\n      event.preventDefault();\n      if (this.activeIndex < this.filteredProducts.length - 1) {\n        this.activeIndex++;\n        setTimeout(() => this.scrollToActiveItem(), 0);\n      }\n    } else if (event.key === 'ArrowUp') {\n      event.preventDefault();\n      if (this.activeIndex > 0) {\n        this.activeIndex--;\n        setTimeout(() => this.scrollToActiveItem(), 0);\n      }\n    }\n  }\n  onSearchInput() {\n    this.searchChanged.next(this.searchTerm.trim());\n  }\n  lastCartItemsLength = 0;\n  async onSearchInputInternal(query: string): Promise<void> {\n    if (query.length === 0) {\n      this.filteredProducts = [];\n      this.showDropdown = false;\n      this.activeIndex = -1;\n      return;\n    }\n\n    let results = await this.productService.searchProducts(query);\n    results = results.filter((p): p is Product => !!p && typeof p === 'object' && 'Name' in p && 'Code' in p && 'Unit' in p);\n    if (results.length > 0) {\n      const queryLower = query.toLowerCase();\n\n      // ✅ KIỂM TRA TRÙNG KHỚP CHÍNH XÁC MÃ SẢN PHẨM\n      const exactCodeMatch = results.find(p => p.Code?.toLowerCase() === queryLower);\n\n      if (exactCodeMatch) {\n        // Nếu tìm thấy sản phẩm có mã trùng khớp chính xác, chọn ngay lập tức\n        this.selectProduct(exactCodeMatch);\n        return;\n      }\n\n      // Logic cũ để kiểm tra cảnh báo khi chưa chọn sản phẩm\n      let isProductCode = false;\n      if (queryLower.includes('-')) {\n        const baseQuery = queryLower.split('-')[0];\n        isProductCode = results.some(p => p.Code?.toLowerCase() === baseQuery);\n      } else {\n        isProductCode = results.some(p => p.Code?.toLowerCase() === queryLower);\n      }\n\n      if (isProductCode && this.showDropdown && this.cartItems.length === this.lastCartItemsLength) {\n        setTimeout(() => alert(`BẠN CHƯA CHỌN SẢN PHẨM TRƯỚC ĐÓ. \n       HÃY NHẬP LẠI !`), 1000);\n      }\n      this.showDropdown = true;\n      this.lastCartItemsLength = this.cartItems.length;\n    } else {\n      this.showDropdown = false;\n    }\n\n    if (results.length === 0) {\n      const fetched = await this.productService.loadProductsIfNotExist(query);\n      if (fetched && fetched.length > 0) {\n        results = await this.productService.searchProducts(query);\n        results = results.filter(p => p && p.Image && p.Name || p.FullName && p.Code && p.Unit && p.BasePrice);\n      }\n\n      if (results.length === 0) {\n        if (this.enterPressed) {\n          alert('Không tìm thấy sản phẩm');\n          this.enterPressed = false;\n        }\n        this.filteredProducts = [];\n        this.showDropdown = false;\n        this.activeIndex = -1;\n        return;\n      }\n\n      // ✅ KIỂM TRA LẠI SAU KHI FETCH\n      const queryLower = query.toLowerCase();\n      const exactCodeMatch = results.find(p => p.Code?.toLowerCase() === queryLower);\n\n      if (exactCodeMatch) {\n        this.selectProduct(exactCodeMatch);\n        return;\n      }\n    }\n\n    // ✅ Xóa logic cũ chọn tự động khi chỉ có 1 sản phẩm\n    // Bây giờ chỉ hiển thị dropdown để user có thể chọn\n\n    this.filteredProducts = results;\n    this.showDropdown = results.length > 0;\n    this.activeIndex = results.length > 0 ? 0 : -1;\n    console.log('Kết quả tìm kiếm cuối cùng:', this.filteredProducts);\n    setTimeout(() => this.scrollToActiveItem(), 0);\n    this.activeIndex = -1;\n  }\n\n  async updateItemUnit(index: number, unit: string) {\n    const item = this.cartItems[index];\n    const masterId = (item as any).masterId || item.product.MasterUnitId || item.product.Id;\n    const group = this.groupedProducts[masterId];\n\n    if (group) {\n      // Tìm sản phẩm đúng đơn vị\n      const newProduct = group.find(p => p.Unit === unit);\n      if (newProduct) {\n  // Lấy thông tin mới nhất từ IndexedDB\n  const db = await this.indexedDBService.getDB('SalesDB', 1);\n        const tx = db.transaction('products', 'readonly');\n        const latestProduct = await tx.store.get(newProduct.Id);\n\n        // Nếu lấy được sản phẩm mới nhất, dùng nó, nếu không thì dùng newProduct cũ\n        item.product = latestProduct ? { ...latestProduct } : { ...newProduct };\n        item.unitPrice = item.product.BasePrice;\n        this.updateItemTotal(item);\n      }\n    }\n    item.product.Unit = unit;\n    this.cartItems[index].unitPriceSaleOff = 0; // Reset giá sale off khi đổi đơn vị\n\n    // ✅ Cập nhật tổng tiền invoice\n    this.updateInvoiceTotalPrice();\n  }\n\n\n  getAvailableUnits(product: Product, cartItem?: any): string[] {\n    // Ưu tiên lấy masterId từ cartItem nếu có\n    const masterId = cartItem?.MasterUnitId || product.MasterUnitId || product.Id;\n    const masterProducts = this.groupedProducts[masterId];\n    if (masterProducts && masterProducts.length > 0) {\n      const units = new Set<string>();\n\n      masterProducts.forEach(p => {\n        if (p.Unit) {\n          units.add(p.Unit);\n        }\n      });\n      return Array.from(units);\n    }\n    if (product.Unit) {\n      return [product.Unit];\n    }\n\n    return [];\n  }\n  sortCartItemsByQuantity(productCode: string) {\n    const idx = this.cartItems.findIndex(item => item.product.Code === productCode);\n    if (idx > -1) {\n      const [item] = this.cartItems.splice(idx, 1);\n      this.cartItems.unshift(item);\n    }\n  }\n\n  selectProduct(product: Product) {\n    if (product.BasePrice < product.Cost) {\n      alert(`GIÁ BÁN đang thấp hơn GIÁ VỐN, cần kiểm tra lại  Sản phẩm: \n            ${product.Name}`);\n      return; // Không thêm vào cartItems\n    }\n    const existingItem = this.cartItems.find(item => item.product.Code === product.Code);\n\n    if (existingItem) {\n      existingItem.quantity += 1;\n      this.updateItemTotal(existingItem);\n      this.sortCartItemsByQuantity(product.Code);\n    } else {\n      const newItem: CartItem = {\n        product,\n        quantity: 1,\n        unitPrice: product.BasePrice,\n        totalPrice: product.BasePrice,\n        unitPriceSaleOff: 0\n      };\n\n      this.cartItems.unshift(newItem);\n    }\n\n    // ✅ Đồng bộ với invoice\n    this.syncCartWithInvoice();\n\n    this.showDropdown = false;\n    setTimeout(() => {\n      this.searchInput?.nativeElement.select(); // Bôi đen toàn bộ sau mỗi lần input thay đổi\n    }, 0);\n  }\n  getTotalQuantity(): number {\n    return this.cartItems.reduce((total, item) => total + item.quantity, 0);\n  }\n  getTotalAmount(): number {\n    return this.cartItems.reduce((total, item) => total + item.totalPrice, 0);\n  }\n  getTotalCost(): number {\n    return this.cartItems.reduce((total, item) => total + item.product.Cost * item.quantity, 0);\n  }\n  onDiscountChange() {\n    // Đồng bộ discount vào invoice hiện tại\n    if (this.invoices[this.activeTabIndex]) {\n      this.invoices[this.activeTabIndex].discountAmount = this.discountAmount;\n      if (!(this.invoices[this.activeTabIndex] as any).customerPaidManuallySet) {\n        this.invoices[this.activeTabIndex].customerPaid = this.getTotalAmount() - this.discountAmount;\n      }\n    }\n    this.saveDataToLocalStorage();\n  }\n  updateInvoiceTotalPrice() {\n    if (this.invoices[this.activeTabIndex]) {\n      if (!(this.invoices[this.activeTabIndex] as any).customerPaidManuallySet) {\n        this.invoices[this.activeTabIndex].customerPaid = this.getTotalAmount() - this.discountAmount;\n      }\n      this.invoices[this.activeTabIndex].totalPrice = this.getTotalAmount();\n      this.invoices[this.activeTabIndex].totalCost = this.getTotalCost();\n      this.invoices[this.activeTabIndex].totalQuantity = this.getTotalQuantity();\n      this.invoices[this.activeTabIndex].discountAmount = this.discountAmount;\n    }\n    this.saveDataToLocalStorage();\n  }\n\n  updateItemTotal(item: CartItem) {\n    item.totalPrice = item.quantity * item.unitPrice;\n\n    // ✅ THÊM DÒNG NÀY - Cập nhật tổng tiền invoice mỗi khi item thay đổi\n    this.updateInvoiceTotalPrice();\n  }\n  onQuantityChange(item: CartItem) {\n    this.updateItemTotal(item);\n  }\n  removeItem(index: number) {\n    this.cartItems.splice(index, 1);\n    // ✅ Đồng bộ với invoice\n    this.syncCartWithInvoice();\n  }\n  private syncCartWithInvoice() {\n    if (this.invoices[this.activeTabIndex]) {\n      // Đồng bộ cartItems vào invoice\n      this.invoices[this.activeTabIndex].cartItems = [...this.cartItems];\n      this.invoices[this.activeTabIndex].discountAmount = this.discountAmount;\n      this.invoices[this.activeTabIndex].customer = this.selectedCustomer;\n      this.updateInvoiceTotalPrice();\n    }\n  }\n  getItemStatus(product: Product): string {\n    if (!product) return '';\n    if (product.ProductAttributes[0]?.Value === undefined || product.ProductAttributes[0]?.Value === null) return '';\n\n    return product.ProductAttributes[0]?.Value || '';\n  }\n\n  showNoteInputIndex: number | null = null;\n\n  showNoteForProduct(index: number) {\n    this.showNoteInputIndex = index;\n    this.selectedItem = this.cartItems[index];\n    this.showNoteInput = true;\n    setTimeout(() => {\n      const input = this.noteInputs?.toArray()[0]?.nativeElement;\n      if (input) {\n        input.focus();\n        input.select();\n      }\n    }, 0);\n  }\n\n  calculateFinalPrice(): number {\n    if (!this.selectedItem) return 0;\n\n    let finalPrice = this.selectedItem.unitPrice;\n\n    if (this.discountType === 'VND') {\n      finalPrice -= this.discountAmount;\n    } else {\n      finalPrice = finalPrice * (1 - this.discountAmount / 100);\n    }\n\n    return Math.max(0, finalPrice);\n  }\n\n\n  selectQuickAmount(amount: number) {\n    if (this.invoices[this.activeTabIndex]) {\n      this.invoices[this.activeTabIndex].customerPaid = amount;\n      (this.invoices[this.activeTabIndex] as any).customerPaidManuallySet = true;\n    }\n  }\n\n  addNewProduct() {\n    console.log('Add new product');\n    this.showDropdown = false;\n  }\n\n\n\n  formatPrice(price: number): string {\n    return Math.abs(price).toLocaleString('en-US');\n  }\n\n  customerSuggestions: any[] = [];\n  customerSearchTerm = '';\n  selectedCustomer: Customer | null = null;\n\n  selectCustomer(customer: Customer) {\n    this.selectedCustomer = customer;\n    this.customerSearchTerm = customer.Name + ' - ' + (customer.ContactNumber || '');\n    this.customerSuggestions = [];\n\n    if (this.isOrderMode) {\n      if (this.orders[this.activeOrderTabIndex]) {\n        this.orders[this.activeOrderTabIndex].customer = { ...customer };\n      }\n    } else {\n      if (this.invoices[this.activeTabIndex]) {\n        this.invoices[this.activeTabIndex].customer = { ...customer };\n      }\n    }\n    this.showCustomerDropdown = false;\n    this.saveDataToLocalStorage();\n  }\n\n  activeCustomerIndex = 0;\n  async onCustomerSearchInput(event: any) {\n    const value = event.target.value.trim().toLowerCase();\n    this.customerSearchTerm = value;\n\n    if (!value) {\n      this.customerSuggestions = [];\n      this.showCustomerDropdown = false;\n      return;\n    }\n\n    // Lấy dữ liệu từ IndexedDB\n  const db = await this.indexedDBService.getDB('Client', 1);\n    const tx = db.transaction('customers', 'readonly');\n    const store = tx.objectStore('customers');\n    const allCustomers = await store.getAll();\n\n    this.customerSuggestions = allCustomers.filter(c =>\n      (c.Name || '').toLowerCase().includes(value) ||\n      (c.ContactNumber || '').toLowerCase().includes(value)\n    );\n\n    this.activeCustomerIndex = 0;\n    this.showCustomerDropdown = this.customerSuggestions.length > 0;\n    this.saveDataToLocalStorage();\n  }\n\n  onCustomerDelete(event: any) {\n    // Kiểm tra nếu sau khi delete/backspace mà input rỗng\n    setTimeout(() => {\n      const inputValue = event.target.value;\n      if (!inputValue || inputValue.trim() === '') {\n        this.selectedCustomer = null;\n        this.showCustomerDropdown = false;\n        this.customerSuggestions = [];\n        if (this.isOrderMode) {\n          if (this.orders[this.activeOrderTabIndex]) {\n            this.orders[this.activeOrderTabIndex].customer = null;\n          }\n        } else {\n          if (this.invoices[this.activeTabIndex]) {\n            this.invoices[this.activeTabIndex].customer = null;\n          }\n        }\n        this.saveDataToLocalStorage();\n      }\n    }, 0);\n  }\n  onCustomerKeyDown(event: KeyboardEvent) {\n    if (!this.customerSuggestions || this.customerSuggestions.length === 0) return;\n\n    if (event.key === 'ArrowDown') {\n      if (this.activeCustomerIndex < this.customerSuggestions.length - 1) {\n        this.activeCustomerIndex++;\n        event.preventDefault();\n      }\n    } else if (event.key === 'ArrowUp') {\n      if (this.activeCustomerIndex > 0) {\n        this.activeCustomerIndex--;\n        event.preventDefault();\n      }\n    } else if (event.key === 'Enter') {\n      if (this.customerSuggestions[this.activeCustomerIndex]) {\n        this.selectCustomer(this.customerSuggestions[this.activeCustomerIndex]);\n        event.preventDefault();\n      }\n    }\n  }\n\n  onCustomerEnter(index: number) {\n    this.selectCustomer(this.customerSuggestions[this.activeCustomerIndex]);\n  }\n  @HostListener('window:keydown', ['$event'])\n  handleKeyDown(event: KeyboardEvent) {\n    if (event.key === 'F3') {\n      event.preventDefault(); // Ngăn trình duyệt mở tìm kiếm mặc định\n      this.searchInput?.nativeElement.focus();\n      this.searchInput.nativeElement.select();\n    }\n    if (event.key === 'Enter') {\n      event.preventDefault(); // Ngăn trình duyệt mở tìm kiếm mặc định\n      this.searchInput?.nativeElement.focus();\n      this.searchInput.nativeElement.select();\n    }\n    if (event.key === 'F4') {\n      event.preventDefault(); // Ngăn trình duyệt mở tìm kiếm mặc định\n      this.searchCustomer?.nativeElement.focus();\n    }\n    if (event.key === 'F1') {\n      event.preventDefault();\n      setTimeout(() => {\n        this.searchInput?.nativeElement.select(); // Bôi đen toàn bộ sau mỗi lần input thay đổi\n      }, 0);\n      this.addInvoiceTab();\n    }\n    if (event.key === 'F2') {\n      event.preventDefault();\n      this.togglePrint();\n    }\n    if (event.key === 'F9') {\n      event.preventDefault();\n      if (this.isOrderMode) {\n        this.order();\n      } else {\n        this.checkout();\n      }\n    }\n    if (event.altKey && !event.ctrlKey && !event.metaKey) {\n      const key = event.key;\n      let idx = -1;\n      if (key >= '1' && key <= '9') {\n        idx = parseInt(key, 10) - 1;\n      } else if (key === '0') {\n        idx = 9;\n      }\n      if (idx >= 0 && idx < this.cartItems.length) {\n        event.preventDefault();\n        this.removeItem(idx);\n      }\n    }\n    // Alt + number sequence: xóa item ở index >= 0 (Alt+2+5 => xóa item 25)\n    if (event.altKey && !event.shiftKey && !event.ctrlKey && !event.metaKey) {\n      if (event.key >= '0' && event.key <= '9') {\n        this._removeItemKeyBuffer += event.key;\n        // Chỉ thực hiện xóa khi buffer có từ 2 số trở lên\n        if (this._removeItemKeyBuffer.length >= 2) {\n          const idx = parseInt(this._removeItemKeyBuffer, 10);\n          if (!isNaN(idx) && idx < this.cartItems.length) {\n            event.preventDefault();\n            this.removeItem(idx);\n          }\n          this._removeItemKeyBuffer = '';\n        }\n      } else {\n        // Nếu nhấn phím không phải số, reset buffer\n        this._removeItemKeyBuffer = '';\n      }\n      return;\n    }\n  }\n  private _removeItemKeyBuffer = '';\n  handleClick(event: MouseEvent) {\n    event.preventDefault(); // Ngăn trình duyệt mở tìm kiếm mặc định\n    this.searchInput?.nativeElement.focus();\n    this.searchInput.nativeElement.select();\n  }\n  getCartTotal(): number {\n    return this.cartItems.reduce((sum, item) => sum + (item.totalPrice || 0), 0);\n  }\n\n  invoiceNote = ''\n  createdDate = '';\n  async addInvoiceTab() {\n\n    const tabId = this.tabCounter;\n\n    const newId = Date.now().toString();\n    const newTab: InvoiceTab = {\n      id: 'HD' + newId,\n      name: 'Hóa đơn ' + tabId,\n      cartItems: [],\n      createdDate: this.createdDate,\n      totalPrice: 0, // ✅ Bắt đầu với 0\n      discountAmount: 0, // ✅ Reset discount\n      customer: null, // ✅ Reset customer\n      totalQuantity: 0,\n      debt: 0,\n      note: this.invoiceNote,\n      customerPaid: 0,\n      totalCost: 0, // ✅ Bắt đầu với 0\n    };\n    (newTab as any).customerPaidManuallySet = false;\n\n    this.tabCounter++;\n    this.invoices.push(newTab);\n    this.setActiveTab(this.invoices.length - 1);\n\n    // ✅ Reset các giá trị khi tạo tab mới\n    this.change = 0;\n    this.discountAmount = 0;\n    this.selectedCustomer = null;\n    this.customerSearchTerm = '';\n    this.formattedCustomerPaid = '0';\n    this.invoiceNote = '';\n    this.isOrderMode = false;\n    this.saveDataToLocalStorage();\n  }\n\n  removeInvoiceTab(index: number) {\n    const tabToRemove = this.invoices[index];\n\n    // Nếu tab không có item, xóa trực tiếp không cần dialog\n    if (!tabToRemove.cartItems || tabToRemove.cartItems.length === 0) {\n      this.handleRemoveTab(index);\n      return;\n    }\n\n    // Nếu tab có item, hiển thị dialog xác nhận\n    const dialogRef = this.dialog.open(ConfirmPopupComponent, {\n      width: '300px',\n      data: { message: 'Bạn có chắc chắn muốn đóng hóa đơn?' }\n    });\n\n    dialogRef.afterClosed().subscribe(result => {\n      if (result === true) {\n        this.handleRemoveTab(index);\n      }\n    });\n  }\n\n  private handleRemoveTab(index: number) {\n    // Xóa dữ liệu localStorage cho tab này trước khi xóa\n    this.localStorageService.clearTabData(index);\n\n    // Nếu chỉ còn 1 tab cuối cùng, reset về \"Hóa đơn 1\"\n    if (this.invoices.length === 1) {\n      const lastTab = this.invoices[0];\n      lastTab.name = 'Hóa đơn 1';\n      lastTab.id = 'HD' + Date.now().toString();\n      lastTab.cartItems = []; // Clear items nếu có\n      this.tabCounter = 2;\n      lastTab.customerPaid = 0;\n      this.setActiveTab(0);\n      return;\n    }\n\n    // Xóa tab\n    this.invoices.splice(index, 1);\n\n    // Đảm bảo luôn có ít nhất 1 tab\n    if (this.invoices.length === 0) {\n      this.addInvoiceTab();\n    } else {\n      // Set active tab mới\n      const newIndex = Math.max(index - 1, 0);\n      this.setActiveTab(newIndex);\n    }\n    // Nếu còn tab ở vị trí index, đồng bộ discount, nếu không thì lấy discount của tab đầu tiên\n    this.discountAmount = this.invoices[index]?.discountAmount || this.invoices[0]?.discountAmount || 0;\n    this.saveDataToLocalStorage();\n  }\n\n  setActiveTab(index: number) {\n    setTimeout(() => {\n      this.searchInput?.nativeElement.select(); // Bôi đen toàn bộ sau mỗi lần input thay đổi\n    }, 0);\n    this.activeTabIndex = index;\n    // ✅ Tạo copy thay vì reference trực tiếp\n    this.cartItems = [...this.invoices[index].cartItems];\n    // ✅ Đồng bộ thông tin customer\n    this.selectedCustomer = this.invoices[index].customer;\n\n    if (this.selectedCustomer) {\n      this.customerSearchTerm = this.selectedCustomer.Name + ' - ' + (this.selectedCustomer.ContactNumber || '');\n    } else {\n      this.customerSearchTerm = '';\n    }\n    this.invoiceNote = this.invoices[index].note || '';\n    // ✅ Đồng bộ discount\n    this.discountAmount = this.invoices[index].discountAmount || 0;\n    // Reset order mode khi chuyển tab\n    this.isOrderMode = false;\n    // Debug log để kiểm tra\n    console.log(`🔍 setActiveTab debug:`, {\n      index: index,\n      invoiceName: this.invoices[index].name,\n      customerPaidManuallySet: (this.invoices[index] as any).customerPaidManuallySet,\n      currentCustomerPaid: this.invoices[index].customerPaid,\n      isFromOrder: this.invoices[index].name?.includes('Hóa đơn từ đơn hàng'),\n      totalAmount: this.getTotalAmount(),\n      discountAmount: this.discountAmount\n    });\n\n    // Nếu chưa nhập tay và không phải invoice từ order, tự động set customerPaid = Khách cần trả\n    if (!(this.invoices[index] as any).customerPaidManuallySet &&\n      !this.invoices[index].name?.includes('Hóa đơn từ đơn hàng')) {\n      this.invoices[index].customerPaid = this.getTotalAmount() - this.discountAmount;\n      console.log(`🔄 Auto-set customerPaid to:`, this.invoices[index].customerPaid);\n    } else {\n      console.log(`✅ Keeping original customerPaid:`, this.invoices[index].customerPaid);\n    }\n  }\n\n  change = 0\n  getChangeAmount(): number {\n    if (this.invoices[this.activeTabIndex].cartItems.length === 0) {\n      this.change = 0;\n      return 0;\n    }\n    if (this.isOrderMode) {\n      const order = this.orders[this.activeOrderTabIndex];\n      const paid = order.customerPaid ? Number(order.customerPaid) : 0;\n      const total = this.getTotalAmount();\n      const discount = this.discountAmount || 0;\n      this.change = paid - (total - discount);\n      return this.change;\n    } else {\n      const invoice = this.invoices[this.activeTabIndex];\n      const paid = invoice?.customerPaid ? Number(invoice.customerPaid) : 0;\n      const total = this.getTotalAmount();\n      const discount = this.discountAmount || 0;\n      this.change = paid - (total - discount);\n      return this.change;\n    }\n  }\n  roundToNearestTenThousand(value: number): number {\n    return Math.round(value / 10000) * 10000;\n  }\n  quickAmounts: number[] = [];\n  roundUpToNearestStep(value: number, step: number): number {\n    return Math.ceil(value / step) * step;\n  }\n  setquickAmounts() {\n    const total = this.getTotalAmount() - (this.discountAmount || 0);\n    let quicks: number[] = [];\n    if (total < 10000) {\n      quicks = [total, 10000, 20000, 50000, 100000, 200000, 500000];\n    } else if (total < 20000) {\n      quicks = [total, 20000, 50000, 100000, 200000, 500000];\n    } else if (total < 50000) {\n      quicks = [total, 50000, 100000, 200000, 500000];\n    } else if (total < 100000) {\n      quicks = [total, 100000, 200000, 500000];\n    } else if (total < 150000) {\n      quicks = [total, 150000, 200000, 500000];\n    } else if (total < 200000) {\n      quicks = [total, 200000, 500000];\n    } else if (total < 250000) {\n      quicks = [total, 250000, 300000, 400000, 500000];\n    } else if (total < 300000) {\n      quicks = [total, 300000, 400000, 500000];\n    } else if (total < 350000) {\n      quicks = [total, 350000, 400000, 500000];\n    } else if (total < 400000) {\n      quicks = [total, 400000, 450000, 500000];\n    } else if (total < 450000) {\n      quicks = [total, 450000, 500000];\n    } else if (total < 500000) {\n      quicks = [total, 500000, 550000, 600000, 700000, 800000, 900000, 1000000];\n    } else if (total < 550000) {\n      quicks = [total, 550000, 600000, 700000, 800000, 900000, 1000000];\n    } else if (total < 600000) {\n      quicks = [total, 600000, 700000, 800000, 900000, 1000000];\n    } else if (total < 650000) {\n      quicks = [total, 650000, 700000, 800000, 900000, 1000000];\n    } else if (total < 700000) {\n      quicks = [total, 700000, 750000, 800000, 900000, 1000000];\n    } else if (total < 750000) {\n      quicks = [total, 750000, 800000, 900000, 1000000];\n    } else if (total < 800000) {\n      quicks = [total, 800000, 900000, 1000000];\n    } else if (total < 850000) {\n      quicks = [total, 850000, 900000, 1000000];\n    } else if (total < 900000) {\n      quicks = [total, 900000, 1000000];\n    } else if (total < 950000) {\n      quicks = [total, 950000];\n    } else if (total < 1000000) {\n      quicks = [total, 1000000];\n    } else if (total < 1100000) {\n      quicks = [total, 1100000, 1200000, 1500000];\n    } else if (total < 1200000) {\n      quicks = [total, 1200000, 1500000];\n    } else if (total < 1300000) {\n      quicks = [total, 1300000, 1400000, 1500000];\n    } else if (total < 1400000) {\n      quicks = [total, 1400000, 1500000];\n    } else if (total < 1500000) {\n      quicks = [total, 1500000];\n    } else if (total < 1600000) {\n      quicks = [total, 1600000];\n    } else if (total < 1700000) {\n      quicks = [total, 1700000];\n    } else if (total < 1800000) {\n      quicks = [total, 1800000];\n    } else if (total < 1900000) {\n      quicks = [total, 1900000];\n    } else if (total < 2000000) {\n      quicks = [total, 2000000];\n    } else if (total < 2500000) {\n      quicks = [total, 2500000, 3000000];\n    } else if (total < 3000000) {\n      quicks = [total, 3000000];\n    } else if (total < 4000000) {\n      quicks = [total, 4000000];\n    } else if (total < 5000000) {\n      quicks = [total, 5000000];\n    } else if (total < 10000000) {\n      quicks = [total, 10000000];\n    } else {\n      quicks = [total];\n    }\n    // Loại bỏ các giá trị trùng lặp và <=0\n    this.quickAmounts = quicks\n      .filter((v, i, arr) => arr.indexOf(v) === i && v > 0)\n      .map(v => this.roundUpToNearestStep(v, 1000));\n  }\n\n  onUnitPriceInput(event: any, item: CartItem) {\n    const value = Number(event.target.value.replace(/\\D/g, ''));\n    item.unitPrice = value;\n    this.updateItemTotal(item);\n\n    // Tính chênh lệch nếu giá nhập nhỏ hơn giá gốc\n    item.unitPriceSaleOff = item.product.BasePrice - value;\n\n  }\n\n  showMenuDropdown = false;\n\n  onMenuClick(type: string) {\n    this.showMenuDropdown = false;\n    // Xử lý chuyển tab hoặc mở modal tương ứng\n    if (type === 'hanghoa') {\n      this.saveDataToLocalStorage();\n      this.router.navigate(['/edit-product-page']);\n    } else if (type === 'hoadon') {\n      const dialogRef = this.dialog.open(InvoicesPageComponent, {\n        width: '100%',\n        height: '100%',\n        panelClass: 'slide-in-modal',\n        disableClose: false\n      });\n\n      // Handle when invoices dialog requests \"edit\" — open invoice in main page for editing\n      dialogRef.afterClosed().subscribe((result: any) => {\n        if (result?.edit && result.invoice) {\n          const inv = result.invoice as InvoiceTab;\n          // Create a new invoice tab from the selected invoice (so user can edit it)\n          const newTab: InvoiceTab = {\n            id: inv.id || ('HD' + Date.now().toString()),\n            name: inv.name || ('Hóa đơn ' + this.tabCounter),\n            cartItems: [...(inv.cartItems || [])],\n            createdDate: inv.createdDate || new Date().toISOString(),\n            totalPrice: inv.totalPrice || this.getTotalAmount(),\n            discountAmount: inv.discountAmount || 0,\n            customer: inv.customer ? { ...inv.customer } : null,\n            totalQuantity: inv.totalQuantity || 0,\n            debt: inv.debt || 0,\n            note: inv.note || '',\n            customerPaid: inv.customerPaid || 0,\n            totalCost: inv.totalCost || 0,\n          } as InvoiceTab;\n\n          // Add as a new tab and set active\n          this.tabCounter++;\n          this.invoices.push(newTab);\n          this.setActiveTab(this.invoices.length - 1);\n\n          // Load cart items and related fields into UI\n          this.cartItems = [...(inv.cartItems || [])];\n          this.discountAmount = inv.discountAmount || 0;\n          this.selectedCustomer = inv.customer ? { ...inv.customer } : null;\n          this.invoiceNote = inv.note || '';\n\n          // Enter edit mode so F9 becomes \"LƯU CHỈNH SỬA (F9)\"\n          this.isEditMode = true;\n\n          // Distinguish invoice-edit vs order-edit\n          this.isEditModeInvoice = !!result.isInvoiceEdit;\n          if (this.isEditModeInvoice) {\n            this.originalInvoiceId = inv.id || null;\n            this.originalOrderId = null;\n          } else {\n            this.originalOrderId = inv.id || null;\n            this.originalInvoiceId = null;\n          }\n\n          // Persist UI state\n          this.saveDataToLocalStorage();\n        }\n      });\n    } else if (type === 'khachhang') {\n      this.dialog.open(CustomersPageComponent, {\n        width: '100%',\n        height: '100%',\n        maxWidth: '100vw',\n        panelClass: 'slide-in-modal',\n        disableClose: false\n      });\n    } else if (type === 'baocao') {\n      this.dialog.open(ReportPageComponent, {\n        width: '100%',\n        height: '100%',\n        panelClass: 'slide-in-modal',\n        disableClose: false\n      });\n    } else if (type === 'dathang') {\n      this.saveDataToLocalStorage();\n      this.dialog.open(OrderPageComponent, {\n        width: '100%',\n        height: '100%',\n        maxWidth: '100vw',\n        panelClass: 'slide-in-modal',\n        disableClose: false\n      });\n    } else if (type === 'dangxuat') {\n      const confirmed = confirm('Bạn có chắc chắn muốn đăng xuất?');\n      if (confirmed) {\n        // Xóa thông tin đăng nhập khỏi localStorage\n        localStorage.removeItem('kv_access_token');\n        localStorage.removeItem('kv_retailer');\n        localStorage.removeItem('kv_branch_id');\n\n        // Chuyển hướng về trang login\n        this.router.navigate(['/login']);\n      }\n    }\n  }\n\n  isReloading = false;\n  hasOfflineInvoices = false;\n\n  isPrintEnabled = false;\n\n  togglePrint() {\n    this.isPrintEnabled = !this.isPrintEnabled;\n  }\n  selectIfNotSelected(event: MouseEvent): void {\n    const input = event.target as HTMLInputElement;\n    // Nếu chưa có phần nào được chọn (hoặc người dùng click sai vị trí)\n    if (input.selectionStart !== 0 || input.selectionEnd !== input.value.length) {\n      setTimeout(() => input.select(), 0);\n    }\n  }\n  increaseQuantity(item: CartItem): void {\n    if (item.quantity < item.product.OnHand) {\n      item.quantity += 1;\n      this.updateItemTotal(item); // Đã bao gồm updateInvoiceTotalPrice()\n    }\n  }\n  closeInvoice() {\n    const dialogRef = this.dialog.open(ConfirmPopupComponent, {\n      width: '300px',\n      data: { message: 'Bạn có chắc chắn muốn đóng hóa đơn?' }\n    });\n\n    dialogRef.afterClosed().subscribe(result => {\n      if (result === true) {\n        // Thực hiện đóng hóa đơn\n        console.log('Hóa đơn đã được đóng');\n      } else {\n        console.log('Hủy thao tác đóng hóa đơn');\n      }\n    });\n  }\n\n  formattedCustomerPaid = '0';\n\n  formatNumberWithCommas(value: number): string {\n    return value.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',');\n  }\n\n  onCustomerPaidChange(event: Event): void {\n    if (this.isOrderMode) {\n      const input = (event.target as HTMLInputElement).value;\n      const raw = parseInt(input.replace(/,/g, ''), 10);\n      const paid = isNaN(raw) ? 0 : raw;\n      if (this.orders[this.activeOrderTabIndex]) {\n        this.orders[this.activeOrderTabIndex].customerPaid = paid;\n        (this.orders[this.activeOrderTabIndex] as any).customerPaidManuallySet = true;\n      }\n      return;\n    } else {\n      const input = (event.target as HTMLInputElement).value;\n      const raw = parseInt(input.replace(/,/g, ''), 10);\n      const paid = isNaN(raw) ? 0 : raw;\n      if (this.invoices[this.activeTabIndex]) {\n        this.invoices[this.activeTabIndex].customerPaid = paid;\n        (this.invoices[this.activeTabIndex] as any).customerPaidManuallySet = true;\n      }\n    }\n\n  }\n\n  onNoteChange() {\n    if (this.invoices[this.activeTabIndex]) {\n      this.invoices[this.activeTabIndex].note = this.invoiceNote;\n    }\n    this.saveDataToLocalStorage();\n  }\n\n  openAddCustomerDialog() {\n    const dialogRef = this.dialog.open(AddCustomerComponent, {\n      width: '100%',\n      height: '100%',\n      disableClose: true,\n      data: { customer: null } // Truyền dữ liệu nếu cần\n    });\n\n    dialogRef.afterClosed().subscribe(result => {\n      if (result) {\n        // Nếu có kết quả trả về, cập nhật danh sách khách hàng\n        this.customerService.loadCustomersFromKiotvietToIndexedDB().then(() => {\n          console.log('Tất cả customer đã được tải và lưu vào IndexedDB.');\n        }).catch((err) => {\n          console.error('Lỗi khi tải tất cả customer:', err);\n        });\n      }\n    });\n  }\n\n  async syncCartItemsWithIndexedDB() {\n    const db = await this.indexedDBService.getDB('SalesDB', 1);\n    for (const item of this.cartItems) {\n      const latestProduct = await db.transaction('products', 'readonly').store.get(item.product.Id);\n      if (latestProduct) {\n        // Cập nhật các trường cần thiết\n        item.product = { ...latestProduct };\n        item.unitPrice = latestProduct.BasePrice;\n        // Nếu có các trường khác cần giữ lại (ví dụ: quantity, unitPriceSaleOff), giữ nguyên\n      }\n    }\n    // Đồng bộ lại với invoice\n    this.syncCartWithInvoice();\n  }\n\n  showEditOnHandIndex: number | null = null;\n  editOnHandValue = 0;\n\n  openEditOnHandPopup(index: number) {\n    this.showEditOnHandIndex = index;\n    this.editOnHandValue = this.cartItems[index].product.OnHand;\n  }\n  closeEditOnHandPopup() {\n    this.showEditOnHandIndex = null;\n  }\n  async confirmEditOnHand(index: number) {\n  const item = this.cartItems[index];\n  const newOnHand = this.editOnHandValue;\n  item.product.OnHand = this.editOnHandValue;\n\n  try {\n    const masterUnitId = item.product.MasterUnitId || item.product.Id;\n    const group = this.groupedProducts[masterUnitId];\n    if (!group || group.length === 0) {\n      console.error('Không tìm thấy group cho sản phẩm:', item.product.Id);\n      return;\n    }\n\n    // Tìm master item (nếu có)\n    const masterItem = group.find(p => p.MasterUnitId == null) || group[0];\n    const selectedProduct = item.product;\n    const masterOnHand = newOnHand * selectedProduct.ConversionValue;\n\n    console.log(`confirmEditOnHand: updating master ${masterItem.Id} OnHand -> ${masterOnHand}`);\n\n    // 1) Cập nhật KiotViet (master item)\n    try {\n      const formData = await this.kiotvietService.getRequestBody(masterItem.Id);\n      formData.Product.OnHand = masterOnHand;\n      const kvRes = await this.kiotvietService.updateProductToKiotviet(formData);\n      console.log('✅ KiotViet update result:', kvRes);\n    } catch (kvErr) {\n      console.error('❌ Lỗi khi cập nhật KiotViet:', kvErr);\n      // tiếp tục để cập nhật local/remote khác\n    }\n\n    // 2) Chuẩn bị danh sách sản phẩm để cập nhật (IndexedDB + Firestore/API)\n    const productsToUpdate: Product[] = [];\n    for (const p of group) {\n      const newProductOnHand = masterOnHand / p.ConversionValue;\n      p.OnHand = newProductOnHand;\n      productsToUpdate.push({ ...p });\n    }\n\n    // 3) Cập nhật IndexedDB cục bộ\n    try {\n      await this.productService.updateProductsOnHandLocal(productsToUpdate);\n      console.log(`✅ Updated ${productsToUpdate.length} product(s) in IndexedDB`);\n      // Also emit per-product update and notify server so other clients receive real-time event\n      for (const p of productsToUpdate) {\n        try {\n          await this.productService.updateSingleProductOnHandLocal(p.Id, p.OnHand);\n        } catch (e) {\n          console.warn('⚠️ updateSingleProductOnHandLocal failed for', p.Id, e);\n        }\n      }\n    } catch (dbErr) {\n      console.error('❌ Lỗi khi cập nhật IndexedDB:', dbErr);\n    }\n\n    // 4) Gửi lên Firestore / backend API\n    let remoteRes: any = null;\n    try {\n      if (typeof (this.productService as any).updateProductOnHandToFireStore === 'function') {\n        remoteRes = await (this.productService as any).updateProductOnHandToFireStore(productsToUpdate);\n        console.log('✅ Called productService.updateProductOnHandToFireStore(), result:', remoteRes);\n      } else if ((this.productService as any).http && (this.productService as any).firebase?.update_products_api) {\n        // fallback nếu service định nghĩa url trong productService.firebase.update_products_api\n        const url = environment.domainUrl + (this.productService as any).firebase.update_products_api;\n        remoteRes = await firstValueFrom((this.productService as any).http.put(url, productsToUpdate));\n        console.log('✅ Fallback HTTP PUT to', url, 'result:', remoteRes);\n      } else {\n        // Generic fallback to known endpoint\n        const url = environment.domainUrl + '/api/firebase/update/products';\n        if ((this.productService as any).http) {\n          remoteRes = await firstValueFrom((this.productService as any).http.put(url, productsToUpdate));\n          console.log('✅ Fallback HTTP PUT to /api/firebase/update/products result:', remoteRes);\n        } else {\n          console.warn('⚠️ No HTTP client available on productService to call backend update API.');\n        }\n      }\n    } catch (remoteErr) {\n      console.error('❌ Lỗi khi gửi cập nhật lên backend/Firestore:', remoteErr);\n    }\n\n    // 4b) Notify server per-product so it can emit socket events to other clients\n    try {\n      for (const p of productsToUpdate) {\n        this.productService.notifyServerProductOnHandChange(p.Id, p.OnHand).catch(err => {\n          console.warn('⚠️ notifyServerProductOnHandChange error for', p.Id, err);\n        });\n      }\n    } catch (notifyErr) {\n      console.warn('⚠️ Error while notifying server for OnHand changes', notifyErr);\n    }\n\n    // 5) Đánh dấu sản phẩm đã chỉnh tay để tránh ghi đè không mong muốn\n    productsToUpdate.forEach(p => this.manuallyEditedOnHandProductIds.add(p.Id));\n\n    // 6) Cập nhật UI / localStorage\n    this.saveDataToLocalStorage();\n\n    // 7) Optional: attach a one-time listener to websocket event to confirm server emitted update\n    try {\n      const socket = (this.invoiceService as any).socket || (this.orderService as any).socket;\n      if (socket && typeof socket.once === 'function') {\n        socket.once('product_onhand_updated', (data: any) => {\n          console.log('WS: product_onhand_updated received:', data);\n        });\n        console.log('ℹ️ Listening once for product_onhand_updated websocket event (if available)');\n      } else {\n        console.log('ℹ️ No socket exposed on invoiceService/orderService to listen for product_onhand_updated');\n      }\n    } catch (sockErr) {\n      console.warn('⚠️ Không thể gắn listener websocket tạm thời:', sockErr);\n    }\n\n    console.log(`✅ Hoàn thành cập nhật OnHand cho group ${masterUnitId}`);\n  } catch (e) {\n    console.error('❌ Lỗi cập nhật OnHand:', e);\n  }\n\n  this.closeEditOnHandPopup();\n}\n\n  // Kiểm tra có invoice offline không\n  async checkOfflineInvoices() {\n    try {\n      const offlineInvoices = await this.invoiceService.getAllOfflineInvoices();\n      this.hasOfflineInvoices = offlineInvoices.length > 0;\n    } catch (error) {\n      console.error('Lỗi khi kiểm tra offline invoices:', error);\n      this.hasOfflineInvoices = false;\n    }\n  }\n\n  openOfflineInvoicesDialog() {\n    const dialogRef = this.dialog.open(OfflineInvoicesListComponent, {\n      width: '90%',\n      maxWidth: '1000px',\n      height: '80%',\n      maxHeight: '400px',\n      disableClose: false,\n      panelClass: 'offline-invoices-dialog'\n    });\n    // this.productService.syncAllProductsFromIndexedDBToFirebase().then(() => {\n    //   console.log('Tất cả sản phẩm đã được tải và lưu lên Firebase.');\n    // }).catch((err) => {\n    //   console.error('Lỗi khi tải tất cả sản phẩm:', err);\n    // }),\n    dialogRef.afterClosed().subscribe(() => {\n      // Cập nhật trạng thái offline sau khi đóng dialog\n      this.checkOfflineInvoices();\n    });\n  }\n\n  ngOnDestroy() {\n    // 🔌 Cleanup Socket.IO connection when component is destroyed\n    this.invoiceService.disconnectSocket();\n    if (this.onHandReloadInterval) {\n      clearInterval(this.onHandReloadInterval);\n      this.onHandReloadInterval = null;\n    }\n\n    // Unsubscribe from all subscriptions\n    this.subscriptions.forEach(sub => sub.unsubscribe());\n    this.subscriptions = [];\n  }\n\n  private manuallyEditedOnHandProductIds = new Set<number>();\n\n\n  openOutOfStockDialog() {\n    this.dialog.open(OutOfStockDialogComponent, {\n      width: '100%',\n      maxWidth: '1000px',\n      height: '80%',\n      maxHeight: '600px',\n      disableClose: false\n    });\n  }\n\n  isOrderMode = false;\n\n  enableOrderMode() {\n    if (!this.isOrderMode) {\n      // Chuyển sang Order Mode\n      // Convert invoice tab hiện tại thành order tab\n      this.isOrderMode = true;\n\n      // Lấy invoice tab hiện tại\n      const currentInvoice = this.invoices[this.activeTabIndex];\n\n      // Tạo order tab mới từ invoice tab hiện tại\n      const newOrderTab: InvoiceTab = {\n        id: 'DH' + Date.now().toString(),\n        name: 'Đơn đặt hàng ' + (this.orders.length + 1),\n        cartItems: [...currentInvoice.cartItems],\n        createdDate: currentInvoice.createdDate,\n        totalPrice: currentInvoice.totalPrice,\n        discountAmount: currentInvoice.discountAmount,\n        customer: currentInvoice.customer ? { ...currentInvoice.customer } : null,\n        totalQuantity: currentInvoice.totalQuantity,\n        debt: currentInvoice.debt,\n        note: currentInvoice.note,\n        customerPaid: 0, // Order luôn có customerPaid = 0\n        totalCost: currentInvoice.totalCost\n      };\n      (newOrderTab as any).customerPaidManuallySet = false;\n\n      // Thêm order tab vào danh sách orders\n      this.orders.push(newOrderTab);\n      this.activeOrderTabIndex = this.orders.length - 1;\n\n      // Không xóa invoice tab hiện tại, chỉ chuyển sang order mode\n      // Giữ nguyên invoice tab để có thể chuyển về sau\n\n      // Đồng bộ cartItems với order tab mới (không gọi setActiveOrderTab vì nó sẽ reset cartItems)\n      this.cartItems = [...newOrderTab.cartItems];\n      this.discountAmount = newOrderTab.discountAmount;\n      this.selectedCustomer = newOrderTab.customer;\n      this.invoiceNote = newOrderTab.note || '';\n\n      // Cập nhật order tab với cartItems hiện tại\n      this.orders[this.activeOrderTabIndex].cartItems = [...this.cartItems];\n      this.orders[this.activeOrderTabIndex].discountAmount = this.discountAmount;\n      this.orders[this.activeOrderTabIndex].customer = this.selectedCustomer;\n      this.orders[this.activeOrderTabIndex].note = this.invoiceNote;\n\n      console.log('✅ Chuyển sang Order Mode - Convert invoice tab thành order tab');\n    } else {\n      // Tắt Order Mode, trở về invoice\n      this.isOrderMode = false;\n\n      // Đồng bộ dữ liệu từ order tab về invoice tab hiện tại\n      if (this.orders[this.activeOrderTabIndex]) {\n        const currentOrder = this.orders[this.activeOrderTabIndex];\n        this.invoices[this.activeTabIndex].cartItems = [...currentOrder.cartItems];\n        this.invoices[this.activeTabIndex].discountAmount = currentOrder.discountAmount;\n        this.invoices[this.activeTabIndex].customer = currentOrder.customer;\n        this.invoices[this.activeTabIndex].note = currentOrder.note;\n        this.invoices[this.activeTabIndex].totalPrice = currentOrder.totalPrice;\n        this.invoices[this.activeTabIndex].totalQuantity = currentOrder.totalQuantity;\n        this.invoices[this.activeTabIndex].totalCost = currentOrder.totalCost;\n      }\n\n      // Đồng bộ lại cartItems, discount, note, customer với invoice tab hiện tại\n      this.cartItems = [...this.invoices[this.activeTabIndex].cartItems];\n      this.discountAmount = this.invoices[this.activeTabIndex].discountAmount || 0;\n      this.selectedCustomer = this.invoices[this.activeTabIndex].customer;\n      this.invoiceNote = this.invoices[this.activeTabIndex].note || '';\n      this.saveDataToLocalStorage();\n    }\n  }\n\n  // Order tab management\n  orders: InvoiceTab[] = [];\n  activeOrderTabIndex = 0;\n\n  async addOrderTab() {\n    const tabId = this.orders.length + 1;\n    const newId = Date.now().toString();\n    const newTab: InvoiceTab = {\n      id: 'DH' + newId,\n      name: 'Đơn đặt hàng ' + tabId,\n      cartItems: [],\n      createdDate: '',\n      totalPrice: 0,\n      discountAmount: 0,\n      customer: null,\n      totalQuantity: 0,\n      debt: 0,\n      note: '',\n      customerPaid: 0,\n      totalCost: 0\n    };\n    (newTab as any).customerPaidManuallySet = false;\n    this.orders.push(newTab);\n    this.setActiveOrderTab(this.orders.length - 1);\n\n    // Reset các giá trị khi tạo tab mới từ UI\n    this.cartItems = [];\n    this.discountAmount = 0;\n    this.selectedCustomer = null;\n    this.customerSearchTerm = '';\n\n    // Đảm bảo customerPaid luôn = 0\n    this.orders[this.activeOrderTabIndex].customerPaid = 0;\n    this.saveDataToLocalStorage();\n  }\n\n  setActiveOrderTab(index: number) {\n    this.activeOrderTabIndex = index;\n    this.cartItems = [...this.orders[index].cartItems];\n    this.selectedCustomer = this.orders[index].customer;\n    if (this.selectedCustomer) {\n      this.customerSearchTerm = this.selectedCustomer.Name + ' - ' + (this.selectedCustomer.ContactNumber || '');\n    } else {\n      this.customerSearchTerm = '';\n    }\n    this.invoiceNote = this.orders[index].note || '';\n    this.discountAmount = this.orders[index].discountAmount || 0;\n    // Đảm bảo customerPaid luôn = 0 khi chuyển tab\n    this.orders[this.activeOrderTabIndex].customerPaid = 0;\n    this.saveDataToLocalStorage();\n  }\n\n  // Khi add item vào order.cartItems, luôn set customerPaid = 0\n  // private syncCartWithOrder() {\n  //   if (this.isOrderMode) {\n  //     if (this.orders[this.activeOrderTabIndex]) {\n  //       this.orders[this.activeOrderTabIndex].cartItems = [...this.cartItems];\n  //       this.orders[this.activeOrderTabIndex].discountAmount = this.discountAmount;\n  //       this.orders[this.activeOrderTabIndex].customer = this.selectedCustomer;\n  //       this.orders[this.activeOrderTabIndex].note = this.invoiceNote;\n  //       this.orders[this.activeOrderTabIndex].customerPaid = 0;\n  //     }\n  //   } else {\n  //     if (this.invoices[this.activeTabIndex]) {\n  //       this.invoices[this.activeTabIndex].cartItems = [...this.cartItems];\n  //       this.invoices[this.activeTabIndex].discountAmount = this.discountAmount;\n  //       this.invoices[this.activeTabIndex].customer = this.selectedCustomer;\n  //       this.invoices[this.activeTabIndex].note = this.invoiceNote;\n  //     }\n  //   }\n  //   this.updateInvoiceTotalPrice();\n  //   this.saveDataToLocalStorage();\n  // }\n\n  // ===================== UI TAB RENDER =====================\n  // (Phần này sẽ sửa ở HTML, nhưng cần thêm các hàm này để gọi từ template)\n  getOrderTabs() {\n    return this.orders;\n  }\n  getActiveOrderTabIndex() {\n    return this.activeOrderTabIndex;\n  }\n  setStatus(): string {\n    // Khi order được tạo, mặc định là pending\n    return 'pending';\n  }\n\n  // Method to update order status when checkout is successful\n  async updateOrderStatusToChecked(orderId: string): Promise<void> {\n    try {\n      const updateData = { status: 'checked' };\n      await firstValueFrom(this.orderService.updateOrderToFirestore(orderId, updateData));\n\n      // Update in IndexedDB\n      const order = await this.orderService.getOrderFromDBById(orderId);\n      if (order) {\n        order.status = 'checked';\n        await this.orderService.updateOrderInDB(order);\n      }\n\n      // Notify via WebSocket\n      await this.orderService.notifyOrderUpdated({ id: orderId, status: 'checked' });\n\n      console.log(`✅ Order ${orderId} status updated to 'checked'`);\n    } catch (error) {\n      console.error(`❌ Error updating order status to 'checked':`, error);\n    }\n  }\n\n  // Checkout order (convert order to invoice)\n  async checkoutOrder(orderId: string): Promise<void> {\n    try {\n      // Get order from IndexedDB\n      const order = await this.orderService.getOrderFromDBById(orderId);\n      if (!order) {\n        console.error(`❌ Order ${orderId} not found`);\n        return;\n      }\n\n      // Check if order is already checked or canceled\n      if (order.status === 'checked' || order.status === 'canceled') {\n        console.log(`ℹ️ Order ${orderId} is already ${order.status}`);\n        return;\n      }\n\n      // Update order status to 'checked'\n      await this.updateOrderStatusToChecked(orderId);\n\n      // Create invoice from order\n      const now = new Date();\n      const vnNow = this.timeZoneService.formatVietnamISOString(now);\n\n      const invoice: InvoiceTab = {\n        id: 'HD' + Date.now().toString(),\n        name: 'Hóa đơn từ đơn hàng ' + order.id,\n        cartItems: order.cartItems,\n        createdDate: vnNow,\n        totalPrice: order.totalPrice,\n        discountAmount: order.discountAmount,\n        customer: order.customer,\n        totalQuantity: order.totalQuantity,\n        debt: 0, // Orders don't have debt\n        note: order.note,\n        customerPaid: order.totalPrice - order.discountAmount, // Full payment\n        totalCost: order.totalCost\n      };\n\n      // Add invoice to Firestore\n      this.invoiceService.addInvoiceToFirestore(invoice).subscribe({\n        next: async (res) => {\n          try {\n            await this.invoiceService.notifyInvoiceCreated(invoice);\n            console.info(`✅ Order ${orderId} converted to invoice successfully: ${res}`);\n          } catch (error) {\n            console.error('❌ Error notifying invoice creation:', error);\n          }\n        },\n        error: async (err) => {\n          console.error(`❌ Error converting order to invoice: ${err}`);\n          // Save to offline store if needed\n          try {\n            await this.invoiceService.saveInvoiceToOffline(invoice);\n            console.log('✅ Invoice saved to offline store');\n          } catch (offlineError) {\n            console.error('❌ Error saving to offline store:', offlineError);\n          }\n        }\n      });\n\n      // Add invoice to IndexedDB\n      await this.invoiceService.addInvoiceToDB(invoice);\n      console.log(`✅ Invoice added to IndexedDB`);\n\n    } catch (error) {\n      console.error(`❌ Error during order checkout:`, error);\n    }\n  }\n\n  // Handle processed order from order page\n  private handleProcessedOrder(invoice: InvoiceTab, orderId: string): void {\n    try {\n      console.log(`🔄 Processing order ${orderId} as invoice ${invoice.id} on main page`);\n      console.log(`📊 Invoice data:`, {\n        customerPaid: invoice.customerPaid,\n        totalPrice: invoice.totalPrice,\n        discountAmount: invoice.discountAmount,\n        debt: invoice.debt,\n        isEditMode: (invoice as any).isEditMode\n      });\n\n      // Check if this is edit mode\n      const isEditMode = (invoice as any).isEditMode || false;\n\n      if (isEditMode) {\n        // Handle edit mode\n        this.isEditMode = true;\n        this.originalOrderId = (invoice as any).originalOrderId || orderId;\n        console.log(`📝 Entering edit mode for order ${this.originalOrderId}`);\n      } else {\n        // Normal processing mode\n        this.isEditMode = false;\n        this.originalOrderId = null;\n      }\n\n      // Switch to invoice mode if currently in order mode\n      if (this.isOrderMode) {\n        this.isOrderMode = false;\n        // Sync current order data before switching\n        if (this.orders[this.activeOrderTabIndex]) {\n          this.orders[this.activeOrderTabIndex].cartItems = [...this.cartItems];\n          this.orders[this.activeOrderTabIndex].discountAmount = this.discountAmount;\n          this.orders[this.activeOrderTabIndex].customer = this.selectedCustomer;\n          this.orders[this.activeOrderTabIndex].note = this.invoiceNote;\n        }\n      }\n\n      // Add the processed order as a new invoice tab\n      const newInvoiceTab: InvoiceTab = {\n        id: invoice.id,\n        name: invoice.name || (isEditMode ? `Chỉnh sửa đơn hàng ${orderId}` : `Hóa đơn từ đơn hàng ${orderId}`),\n        cartItems: [...invoice.cartItems],\n        createdDate: invoice.createdDate,\n        totalPrice: invoice.totalPrice,\n        discountAmount: invoice.discountAmount,\n        customer: invoice.customer ? { ...invoice.customer } : null,\n        totalQuantity: invoice.totalQuantity,\n        debt: invoice.debt || 0,\n        note: invoice.note,\n        customerPaid: invoice.customerPaid || 0,\n        totalCost: invoice.totalCost,\n        deliveryTime: invoice.deliveryTime\n      } as any;\n\n      // Mark as manually set to prevent auto-override\n      (newInvoiceTab as any).customerPaidManuallySet = true;\n      if (isEditMode) {\n        (newInvoiceTab as any).isEditMode = true;\n        (newInvoiceTab as any).originalOrderId = this.originalOrderId;\n      }\n\n      console.log(`📊 New invoice tab data:`, {\n        customerPaid: newInvoiceTab.customerPaid,\n        totalPrice: newInvoiceTab.totalPrice,\n        discountAmount: newInvoiceTab.discountAmount,\n        debt: newInvoiceTab.debt,\n        isEditMode: (newInvoiceTab as any).isEditMode\n      });\n\n      // Add to invoices array\n      this.invoices.push(newInvoiceTab);\n\n      // Set as active tab\n      this.setActiveTab(this.invoices.length - 1);\n\n      // Force update the invoice data to ensure it's not overridden\n      const finalInvoiceIndex = this.invoices.length - 1;\n      this.invoices[finalInvoiceIndex].customerPaid = invoice.customerPaid || 0;\n      this.invoices[finalInvoiceIndex].debt = invoice.debt || 0;\n      (this.invoices[finalInvoiceIndex] as any).customerPaidManuallySet = true;\n      if (isEditMode) {\n        (this.invoices[finalInvoiceIndex] as any).isEditMode = true;\n        (this.invoices[finalInvoiceIndex] as any).originalOrderId = this.originalOrderId;\n      }\n\n      console.log(`🔧 Force updated invoice data:`, {\n        customerPaid: this.invoices[finalInvoiceIndex].customerPaid,\n        debt: this.invoices[finalInvoiceIndex].debt,\n        customerPaidManuallySet: (this.invoices[finalInvoiceIndex] as any).customerPaidManuallySet,\n        isEditMode: (this.invoices[finalInvoiceIndex] as any).isEditMode\n      });\n\n      // Update cart items, customer, and other data\n      this.cartItems = [...invoice.cartItems];\n      this.selectedCustomer = invoice.customer;\n      this.discountAmount = invoice.discountAmount;\n      this.invoiceNote = invoice.note || '';\n\n      // Update customer search term\n      if (this.selectedCustomer) {\n        this.customerSearchTerm = this.selectedCustomer.Name + ' - ' + (this.selectedCustomer.ContactNumber || '');\n      } else {\n        this.customerSearchTerm = '';\n      }\n\n      // Keep the original customerPaid from the invoice (which was set from order)\n      this.formattedCustomerPaid = (invoice.customerPaid || 0).toString();\n\n      // Save to localStorage\n      this.saveDataToLocalStorage();\n\n      // Force UI update\n      this.updateInvoiceTotalPrice();\n\n      console.log(`✅ Đã xử lý đơn hàng ${orderId} thành công! Dữ liệu đã được thêm vào tab hóa đơn.`);\n      console.log(`📊 Final invoice tab data:`, {\n        customerPaid: this.invoices[this.activeTabIndex].customerPaid,\n        totalPrice: this.invoices[this.activeTabIndex].totalPrice,\n        discountAmount: this.invoices[this.activeTabIndex].discountAmount,\n        debt: this.invoices[this.activeTabIndex].debt,\n        isEditMode: (this.invoices[this.activeTabIndex] as any).isEditMode\n      });\n\n    } catch (error) {\n      console.error(`❌ Error handling processed order:`, error);\n    }\n  }\n  async order() {\n    if (!this.selectedCustomer) {\n      alert('Bạn phải select customer cho order!');\n      return;\n    }\n    const notEnough = await this.checkOnHandFromIndexedDB();\n    if (notEnough) {\n      alert('Không đủ số lượng');\n      return;\n    }\n    if (this.cartItems.length === 0) {\n      alert('Giỏ hàng trống!');\n      return;\n    }\n    // Lấy index order hiện tại\n    const currentOrderIndex = this.activeOrderTabIndex;\n    // Gán các giá trị vào order tab trước khi tạo order object\n    const now = new Date();\n    const vnNow = this.timeZoneService.formatVietnamISOString(now);\n    this.orders[currentOrderIndex].debt = this.getChangeAmount();\n    this.orders[currentOrderIndex].note = this.invoiceNote;\n    this.orders[currentOrderIndex].createdDate = vnNow;\n    this.orders[currentOrderIndex].totalPrice = this.getTotalAmount() - this.discountAmount;\n    this.orders[currentOrderIndex].customer = this.selectedCustomer ? { ...this.selectedCustomer } : null;\n    this.orders[currentOrderIndex].discountAmount = this.discountAmount;\n    this.orders[currentOrderIndex].customerPaid = this.orders[currentOrderIndex].customerPaid || 0;\n    this.orders[currentOrderIndex].totalCost = this.getTotalCost();\n    this.orders[currentOrderIndex].totalQuantity = this.getTotalQuantity();\n    this.orders[currentOrderIndex].deliveryTime = this.deliveryTime;\n    // Tạo order object từ tab hiện tại\n    const order = {\n      ...this.orders[currentOrderIndex],\n      cartItems: [...this.cartItems],\n      status: this.setStatus(),\n      customerPaidManuallySet: false\n    };\n    // Gửi lên Firestore\n    try {\n      await firstValueFrom(this.orderService.addOrderToFirestore(order));\n      // Phát WebSocket real-time (nếu muốn)\n      await this.orderService.notifyOrderCreated(order);\n      // Lưu vào IndexedDB (để đồng bộ offline)\n      await this.orderService.addOrderToDB(order);\n      alert('Đã lưu đơn đặt hàng!');\n    } catch (err) {\n      // Nếu lỗi, chỉ lưu local\n      await this.orderService.addOrderToDB(order);\n      alert('Đã lưu đơn đặt hàng (offline)!');\n    }\n    // Reset giỏ hàng và trạng thái\n    this.cartItems = [];\n    this.discountAmount = 0;\n    this.invoiceNote = '';\n    this.selectedCustomer = null;\n    this.customerSearchTerm = '';\n    this.saveDataToLocalStorage();\n  }\n\n  private async reloadCartItemsOnHand() {\n    for (const item of this.cartItems) {\n      if (item.product && item.product.Id) {\n        const latest = await this.productService.getProductByIdFromIndexedDB(item.product.Id);\n        if (latest) {\n          item.product.OnHand = latest.OnHand;\n        }\n      }\n    }\n  }\n\n  removeOrderTab(index: number) {\n    // Nếu tab không có item, xóa trực tiếp không cần dialog\n    if (!this.orders[index].cartItems || this.orders[index].cartItems.length === 0) {\n      this.handleRemoveOrderTab(index);\n      return;\n    }\n    // Nếu tab có item, hiển thị dialog xác nhận\n    const dialogRef = this.dialog.open(ConfirmPopupComponent, {\n      width: '300px',\n      data: { message: 'Bạn có chắc chắn muốn đóng đơn đặt hàng?' }\n    });\n    dialogRef.afterClosed().subscribe(result => {\n      if (result === true) {\n        this.handleRemoveOrderTab(index);\n      }\n    });\n  }\n\n  private handleRemoveOrderTab(index: number) {\n    // Nếu chỉ còn 1 tab cuối cùng, reset về \"Đơn đặt hàng 1\"\n    if (this.orders.length === 1) {\n      const lastTab = this.orders[0];\n      lastTab.name = 'Đơn đặt hàng 1';\n      lastTab.id = 'DH' + Date.now().toString();\n      lastTab.cartItems = [];\n      lastTab.customerPaid = 0;\n      this.setActiveOrderTab(0);\n      return;\n    }\n    // Xóa tab\n    this.orders.splice(index, 1);\n    // Đảm bảo luôn có ít nhất 1 tab\n    if (this.orders.length === 0) {\n      this.addOrderTab();\n    } else {\n      // Set active tab mới\n      const newIndex = Math.max(index - 1, 0);\n      this.setActiveOrderTab(newIndex);\n    }\n  }\n\n  async saveEditedOrder() {\n    if (!this.originalOrderId) {\n      console.error('❌ No original order ID found');\n      return;\n    }\n\n    const notEnough = await this.checkOnHandFromIndexedDB();\n    if (notEnough) {\n      alert('Không đủ số lượng');\n      return;\n    }\n\n    if (this.cartItems.length === 0) {\n      alert('Giỏ hàng trống!');\n      return;\n    }\n\n    // Get current invoice tab (which is the edited order)\n    const currentInvoiceIndex = this.activeTabIndex;\n  // removed unused timestamp variables (vnNow)\n\n    // Update order with edited data\n    const updatedOrder = {\n      id: this.originalOrderId,\n      name: 'Đơn đặt hàng ' + this.originalOrderId,\n      cartItems: [...this.cartItems],\n      createdDate: this.invoices[currentInvoiceIndex].createdDate, // Keep original creation date\n      totalPrice: this.getTotalAmount() - this.discountAmount,\n      discountAmount: this.discountAmount,\n      customer: this.selectedCustomer ? { ...this.selectedCustomer } : null,\n      totalQuantity: this.getTotalQuantity(),\n      debt: this.getChangeAmount(),\n      note: this.invoiceNote,\n      customerPaid: this.invoices[currentInvoiceIndex].customerPaid || 0,\n      totalCost: this.getTotalCost(),\n      status: 'edited', // Set status to 'edited'\n      deliveryTime: this.invoices[currentInvoiceIndex].deliveryTime\n    };\n\n    try {\n      // Update in Firestore\n      await firstValueFrom(this.orderService.updateOrderToFirestore(this.originalOrderId, updatedOrder));\n      console.log(`✅ Order ${this.originalOrderId} updated in Firestore`);\n\n      // Update in IndexedDB\n      await this.orderService.updateOrderInDB(updatedOrder);\n      console.log(`✅ Order ${this.originalOrderId} updated in IndexedDB`);\n\n      // Notify via WebSocket\n      await this.orderService.notifyOrderUpdated(updatedOrder);\n      console.log(`✅ Order ${this.originalOrderId} update notified via WebSocket`);\n\n      alert(`Đã lưu chỉnh sửa đơn hàng ${this.originalOrderId}!`);\n\n      // Clear local storage data for this tab and remove edit tab\n      this.localStorageService.clearTabData(currentInvoiceIndex);\n      this.invoices.splice(currentInvoiceIndex, 1);\n\n      // Reset edit flags\n      this.isEditMode = false;\n      this.originalOrderId = null;\n\n      // Restore tabs UI\n      if (this.invoices.length === 0) {\n        this.addInvoiceTab();\n      } else {\n        const newIndex = Math.min(currentInvoiceIndex, this.invoices.length - 1);\n        this.setActiveTab(newIndex);\n      }\n\n      // Reset UI values\n      this.discountAmount = 0;\n      this.change = 0;\n      this.formattedCustomerPaid = '0';\n      this.invoiceNote = '';\n\n      // Optionally notify realtime\n      if (typeof (this.invoiceService as any).notifyInvoiceUpdated === 'function') {\n        try {\n          await (this.invoiceService as any).notifyInvoiceUpdated(updatedOrder);\n        } catch (e) { /* ignore */ }\n      }\n    } catch (error) {\n      console.error('❌ Error saving edited order:', error);\n      alert('Lỗi khi lưu chỉnh sửa đơn hàng!');\n    }\n  }\n\n  // Edit mode tracking\n  isEditMode = false;\n  originalOrderId: string | null = null;\n  isEditModeInvoice = false;\n  originalInvoiceId: string | null = null;\n\n  // Add saveEditedInvoice implementation (place inside the MainPageComponent class)\n  async saveEditedInvoice() {\n    if (!this.originalInvoiceId) {\n      console.error('❌ No original invoice ID found');\n      return;\n    }\n\n    const notEnough = await this.checkOnHandFromIndexedDB();\n    if (notEnough) {\n      alert('Không đủ số lượng');\n      return;\n    }\n\n    if (this.cartItems.length === 0) {\n      alert('Giỏ hàng trống!');\n      return;\n    }\n\n    const currentInvoiceIndex = this.activeTabIndex;\n    const updatedInvoice: InvoiceTab = {\n      id: this.originalInvoiceId,\n      name: this.invoices[currentInvoiceIndex]?.name || ('Hóa đơn ' + this.originalInvoiceId),\n      cartItems: [...this.cartItems],\n      createdDate: this.invoices[currentInvoiceIndex]?.createdDate || new Date().toISOString(),\n      totalPrice: this.getTotalAmount() - (this.discountAmount || 0),\n      discountAmount: this.discountAmount || 0,\n      customer: this.selectedCustomer ? { ...this.selectedCustomer } : null,\n      totalQuantity: this.getTotalQuantity(),\n      debt: this.getChangeAmount(),\n      note: this.invoiceNote || '',\n      customerPaid: this.invoices[currentInvoiceIndex]?.customerPaid || 0,\n      totalCost: this.getTotalCost(),\n      deliveryTime: this.invoices[currentInvoiceIndex]?.deliveryTime || ''\n    };\n\n    try {\n      // Update remote (Firestore / API)\n      if (typeof (this.invoiceService as any).updateInvoiceToFirestore === 'function') {\n        await firstValueFrom((this.invoiceService as any).updateInvoiceToFirestore(updatedInvoice.id, updatedInvoice));\n      } else if ((this.invoiceService as any).http && (this.invoiceService as any).firebase?.put_update_invoice) {\n        const url = (this.invoiceService as any).firebase.put_update_invoice;\n        await firstValueFrom((this.invoiceService as any).http.put(url + updatedInvoice.id, updatedInvoice));\n      }\n\n      // Update local IndexedDB\n      if (typeof (this.invoiceService as any).updateInvoiceInDB === 'function') {\n        await (this.invoiceService as any).updateInvoiceInDB(updatedInvoice);\n      } else if (typeof (this.invoiceService as any).addInvoiceToDB === 'function') {\n        await (this.invoiceService as any).addInvoiceToDB(updatedInvoice);\n      }\n\n      alert(`Đã lưu chỉnh sửa hóa đơn ${updatedInvoice.id}!`);\n\n      // Clear local storage data for this tab and remove edit tab\n      this.localStorageService.clearTabData(currentInvoiceIndex);\n      this.invoices.splice(currentInvoiceIndex, 1);\n\n      // Reset edit flags\n      this.isEditMode = false;\n      this.isEditModeInvoice = false;\n      this.originalInvoiceId = null;\n\n      // Restore tabs UI\n      if (this.invoices.length === 0) {\n        this.addInvoiceTab();\n      } else {\n        const newIndex = Math.min(currentInvoiceIndex, this.invoices.length - 1);\n        this.setActiveTab(newIndex);\n      }\n\n      // Reset UI values\n      this.discountAmount = 0;\n      this.change = 0;\n      this.formattedCustomerPaid = '0';\n      this.invoiceNote = '';\n\n      // Optionally notify realtime\n      if (typeof (this.invoiceService as any).notifyInvoiceUpdated === 'function') {\n        try {\n          await (this.invoiceService as any).notifyInvoiceUpdated(updatedInvoice);\n        } catch (e) { /* ignore */ }\n      }\n    } catch (error) {\n      console.error('❌ Error saving edited invoice:', error);\n      alert('Lỗi khi lưu chỉnh sửa hóa đơn!');\n    }\n  }\n}","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\offline-invoices-list\\offline-invoices-list.component.html","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\offline-invoices-list\\offline-invoices-list.component.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'MAT_DIALOG_DATA' is defined but never used.","line":3,"column":24,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":39},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":35,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":35,"endColumn":66},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":36,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":36,"endColumn":43},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":37,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":37,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":38,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":38,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":39,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":39,"endColumn":39},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":40,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":40,"endColumn":47},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":42,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1785,1788],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1785,1788],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":74,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":74,"endColumn":19}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, OnInit } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatDialogRef, MAT_DIALOG_DATA, MatDialogModule } from '@angular/material/dialog';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTableModule } from '@angular/material/table';\r\nimport { MatProgressSpinnerModule } from '@angular/material/progress-spinner';\r\nimport { InvoiceTab } from '../../models/invoice.model';\r\nimport { InvoiceService } from '../../services/invoice.service';\r\nimport { TimeZoneService } from '../../services/time-zone.service';\r\nimport { KiotvietService } from '../../services/kiotviet.service';\r\nimport { GroupService } from '../../services/group.service';\r\nimport { IndexedDBService } from '../../services/indexed-db.service';\r\nimport { firstValueFrom } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'app-offline-invoices-list',\r\n  imports: [\r\n    CommonModule,\r\n    MatDialogModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatTableModule,\r\n    MatProgressSpinnerModule\r\n  ],\r\n  templateUrl: './offline-invoices-list.component.html',\r\n  styleUrl: './offline-invoices-list.component.css'\r\n})\r\nexport class OfflineInvoicesListComponent implements OnInit {\r\n  offlineInvoices: InvoiceTab[] = [];\r\n  displayedColumns: string[] = ['id', 'customer', 'totalPrice', 'createdDate', 'actions'];\r\n  isLoading = false;\r\n\r\n  constructor(\r\n    private dialogRef: MatDialogRef<OfflineInvoicesListComponent>,\r\n    private invoiceService: InvoiceService,\r\n    private timeZoneService: TimeZoneService,\r\n    private kiotvietService: KiotvietService,\r\n    private groupService: GroupService,\r\n    private indexedDBService: IndexedDBService,\r\n  ) { }\r\n  groupedProducts: Record<number, any[]> = {}\r\n\r\n  ngOnInit() {\r\n    this.loadOfflineInvoices();\r\n    this.groupDB();\r\n  }\r\n  private async groupDB() {\r\n    const db = await this.indexedDBService.getDB('SalesDB', 1);\r\n    const tx = db.transaction('products', 'readonly');\r\n    const filteredProducts = await tx.store.getAll();\r\n    this.groupedProducts = await this.groupService.group(filteredProducts)\r\n\r\n  }\r\n  async loadOfflineInvoices() {\r\n    this.isLoading = true;\r\n    try {\r\n      this.offlineInvoices = await this.invoiceService.getAllOfflineInvoices();\r\n    } catch (error) {\r\n      console.error('Lỗi khi tải danh sách offline invoices:', error);\r\n    } finally {\r\n      this.isLoading = false;\r\n    }\r\n  }\r\n\r\n  formatPrice(price: number): string {\r\n    return price.toLocaleString('en-US');\r\n  }\r\n\r\n  formatDate(dateString: string): string {\r\n    try {\r\n      const date = this.timeZoneService.parseApiDate(dateString);\r\n      return this.timeZoneService.formatVietnamISOString(date);\r\n    } catch (error) {\r\n      return dateString;\r\n    }\r\n  }\r\n\r\n  getCustomerName(invoice: InvoiceTab): string {\r\n    return invoice.customer?.Name || 'Khách lẻ';\r\n  }\r\n\r\n  async syncInvoice(invoice: InvoiceTab) {\r\n\r\n    try {\r\n      await firstValueFrom(this.invoiceService.addInvoiceToFirestore(invoice));\r\n      await this.invoiceService.deleteOfflineInvoice(invoice.id);\r\n      await this.loadOfflineInvoices(); // Reload list\r\n      await this.kiotvietService.updateOnHandFromInvoiceToKiotviet(invoice, this.groupedProducts);\r\n      console.log(`Đã sync thành công invoice ${invoice.id}`);\r\n    } catch (error) {\r\n      console.error(`Lỗi khi sync invoice ${invoice.id}:`, error);\r\n      alert('Không thể sync invoice này. Vui lòng thử lại sau.');\r\n    }\r\n  }\r\n\r\n  async syncAllInvoices() {\r\n    if (this.offlineInvoices.length === 0) {\r\n      alert('Không có invoice nào để sync');\r\n      return;\r\n    }\r\n\r\n    const confirmed = confirm(`Bạn có chắc chắn muốn sync tất cả ${this.offlineInvoices.length} invoice?`);\r\n    if (!confirmed) return;\r\n\r\n    this.isLoading = true;\r\n    let successCount = 0;\r\n    let failedCount = 0;\r\n\r\n    for (const invoice of this.offlineInvoices) {\r\n      try {\r\n        await firstValueFrom(this.invoiceService.addInvoiceToFirestore(invoice));\r\n        await this.invoiceService.deleteOfflineInvoice(invoice.id);\r\n        await this.kiotvietService.updateOnHandFromInvoiceToKiotviet(invoice, this.groupedProducts);\r\n        successCount++;\r\n      } catch (error) {\r\n        console.error(`Lỗi khi sync invoice ${invoice.id}:`, error);\r\n        failedCount++;\r\n      }\r\n    }\r\n\r\n    await this.loadOfflineInvoices(); // Reload list\r\n\r\n    if (successCount > 0) {\r\n      alert(`Đã sync thành công ${successCount} invoice${successCount > 1 ? 's' : ''}`);\r\n    }\r\n    if (failedCount > 0) {\r\n      alert(`Không thể sync ${failedCount} invoice${failedCount > 1 ? 's' : ''}`);\r\n    }\r\n\r\n    this.isLoading = false;\r\n  }\r\n\r\n  async deleteOfflineInvoice(invoice: InvoiceTab) {\r\n    if (!confirm(`Bạn có chắc chắn muốn xóa hóa đơn offline mã ${invoice.id}?`)) return;\r\n    try {\r\n      await this.invoiceService.deleteOfflineInvoice(invoice.id);\r\n      await this.loadOfflineInvoices();\r\n      console.log(`Đã xóa hóa đơn offline ${invoice.id}`);\r\n    } catch (error) {\r\n      console.error(`Lỗi khi xóa hóa đơn offline ${invoice.id}:`, error);\r\n      alert('Không thể xóa hóa đơn này. Vui lòng thử lại sau.');\r\n    }\r\n  }\r\n\r\n  closeDialog() {\r\n    this.dialogRef.close();\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\order-detail\\order-detail.component.html","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\order-detail\\order-detail.component.ts","messages":[{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":16,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":16,"endColumn":90},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":17,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":17,"endColumn":83},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":18,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":18,"endColumn":45}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, ElementRef, Inject, Input, ViewChild, OnInit, Optional } from '@angular/core';\r\nimport { InvoiceTab } from '../../models/invoice.model';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MAT_DIALOG_DATA, MatDialogRef } from '@angular/material/dialog';\r\nimport { TimeZoneService } from '../../services/time-zone.service';\r\n\r\n@Component({\r\n  selector: 'app-order-detail',\r\n  templateUrl: './order-detail.component.html',\r\n  styleUrl: './order-detail.component.css',\r\n  imports: [CommonModule]\r\n})\r\nexport class OrderDetailComponent implements OnInit {\r\n  @Input() order!: InvoiceTab;\r\n  constructor(\r\n    @Optional() @Inject(MAT_DIALOG_DATA) public data: { order: InvoiceTab } | null = null,\r\n    @Optional() public dialogRef: MatDialogRef<OrderDetailComponent> | null = null,\r\n    private timeZoneService: TimeZoneService,\r\n  ) { }\r\n\r\n  ngOnInit() {\r\n    // Nếu được mở như dialog, sử dụng data từ dialog\r\n    if (this.data && this.data.order) {\r\n      this.order = this.data.order;\r\n    }\r\n  }\r\n  @ViewChild('printSection', { static: false }) printSection!: ElementRef;\r\n  getHtmlContent(): string {\r\n    return this.printSection?.nativeElement?.innerHTML || '';\r\n  }\r\n\r\n  formatVietnameseDate(): string {\r\n    const now = new Date();\r\n    const vnNow = this.timeZoneService.formatVietnamISOString(now);\r\n    const d = new Date(vnNow);\r\n    const day = d.getDate().toString().padStart(2, '0');\r\n    const month = (d.getMonth() + 1).toString().padStart(2, '0');\r\n    const year = d.getFullYear();\r\n\r\n    return `Ngày ${day} tháng ${month} năm ${year}`;\r\n  }\r\n  getTotalDiscount(): number {\r\n    if (!this.order || !this.order.cartItems) return 0;\r\n    return this.order.cartItems\r\n      .filter(item => item.unitPriceSaleOff > 0)\r\n      .reduce((sum, item) => sum + item.unitPriceSaleOff * item.quantity, 0);\r\n  }\r\n  \r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\order-page\\order-page.component.html","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\order-page\\order-page.component.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ViewSwlectedInvoiceDialogComponent' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":44},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":46,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2203,2206],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2203,2206],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":47,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2234,2237],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2234,2237],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":63,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2819,2822],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2819,2822],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":66,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":66,"endColumn":30},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":67,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":67,"endColumn":43},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":68,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":68,"endColumn":39},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":69,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":69,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":70,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":70,"endColumn":34},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":71,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":71,"endColumn":43},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":72,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":72,"endColumn":39},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":73,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":73,"endColumn":27},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":74,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":74,"endColumn":55},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":265,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":265,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9703,9706],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9703,9706],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":291,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":291,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10582,10585],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10582,10585],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":344,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":344,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12133,12136],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12133,12136],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":363,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":363,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12948,12951],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12948,12951],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":432,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":432,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15549,15552],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15549,15552],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":545,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":545,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18978,18981],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18978,18981],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":578,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":578,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20092,20095],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20092,20095],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":588,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":588,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20370,20373],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20370,20373],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":601,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":601,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20794,20797],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20794,20797],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":668,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":668,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22659,22662],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22659,22662],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":676,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":676,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22870,22873],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22870,22873],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":694,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":694,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23591,23594],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23591,23594],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":740,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":740,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25183,25186],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25183,25186],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":26,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, OnInit, OnDestroy, ViewChild, ViewEncapsulation } from '@angular/core';\r\nimport { MatDialog, MatDialogRef } from '@angular/material/dialog';\r\nimport { ViewSwlectedInvoiceDialogComponent } from '../invoices-page/view-selected-invoice.component';\r\nimport { ProductService } from '../../services/product.service';\r\nimport { OrderService } from '../../services/order.service';\r\nimport { TimeZoneService } from '../../services/time-zone.service';\r\nimport { VietnameseService } from '../../services/vietnamese.service';\r\nimport { Router } from '@angular/router';\r\nimport { ConfirmPopupComponent } from '../confirm-popup/confirm-popup.component';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatDatepickerModule } from '@angular/material/datepicker';\r\nimport { MatNativeDateModule, DateAdapter } from '@angular/material/core';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatTableModule } from '@angular/material/table';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { Subscription, firstValueFrom } from 'rxjs';\r\nimport { OrderDetailComponent } from '../order-detail/order-detail.component';\r\nimport { PrintService } from '../../services/print.service';\r\nimport { ViewSwlectedOrderDialogComponent } from '../order-page/view-selected-order.component';\r\nimport { InvoiceTab } from '../../models/invoice.model';\r\n@Component({\r\n  selector: 'app-order-page',\r\n  templateUrl: './order-page.component.html',\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatDatepickerModule,\r\n    MatNativeDateModule,\r\n    MatSelectModule,\r\n    MatTableModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule\r\n  ],\r\n  styleUrls: ['./order-page.component.css'],\r\n  encapsulation: ViewEncapsulation.None\r\n})\r\nexport class OrderPageComponent implements OnInit, OnDestroy {\r\n  allOrders: any[] = [];\r\n  filteredOrders: any[] = [];\r\n  searchTerm = '';\r\n  searchTermProduct = '';\r\n  selectedDate: Date | null = null;\r\n  selectedCustomer = '';\r\n  customers: string[] = [];\r\n  pageSize = 10;\r\n  currentPage = 1;\r\n  displayedColumns: string[] = ['id', 'customer', 'totalPrice', 'createdDate', 'deliveryTime', 'status', 'actions'];\r\n  isLoading = false;\r\n  isWebSocketConnected = false;\r\n  lastSyncTime: Date | null = null;\r\n\r\n  // Real-time subscriptions\r\n  private subscriptions: Subscription[] = [];\r\n  private isSyncing = false; // Flag to prevent multiple simultaneous syncs\r\n  private syncDebounceTimer: any = null; // Debounce timer for sync operations\r\n\r\n  constructor(\r\n    private dialog: MatDialog,\r\n    private productService: ProductService,\r\n    private orderService: OrderService,\r\n    private timeZoneService: TimeZoneService,\r\n    private vi: VietnameseService,\r\n    private dateAdapter: DateAdapter<Date>,\r\n    private printService: PrintService,\r\n    private router: Router,\r\n    public dialogRef: MatDialogRef<OrderPageComponent> // <-- add this\r\n  ) {\r\n    this.dateAdapter.setLocale('vi-VN');\r\n  }\r\n\r\n  async ngOnInit() {\r\n    this.isLoading = true;\r\n    try {\r\n      // Gọi API lấy toàn bộ đơn hàng\r\n      const orders = await this.orderService.getAllOrdersFromDB(); // Hàm này gọi /api/firebase/orders\r\n      this.allOrders = orders || [];\r\n      \r\n      // Sắp xếp orders theo thời gian ngược lại (gần nhất lên đầu)\r\n      this.allOrders.sort((a, b) => {\r\n        if (!a.createdDate) return 1;\r\n        if (!b.createdDate) return -1;\r\n        return new Date(b.createdDate).getTime() - new Date(a.createdDate).getTime();\r\n      });\r\n      \r\n      this.filteredOrders = [...this.allOrders];\r\n      this.customers = [...new Set(this.allOrders.map(order =>\r\n        typeof order.customer === 'string' ? order.customer : order.customer?.Name ?? ''\r\n      ))];\r\n      this.applyFilters();\r\n    } catch (err) {\r\n      console.error('Error fetching orders:', err);\r\n      this.allOrders = [];\r\n      this.filteredOrders = [];\r\n    } finally {\r\n      this.isLoading = false;\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    // Cleanup WebSocket connections\r\n    this.productService.disconnectProductSocket();\r\n    this.orderService.disconnectSocket();\r\n\r\n    // Unsubscribe from all real-time events\r\n    this.subscriptions.forEach(sub => sub.unsubscribe());\r\n    this.subscriptions = [];\r\n\r\n    // Clear any pending sync timers\r\n    if (this.syncDebounceTimer) {\r\n      clearTimeout(this.syncDebounceTimer);\r\n    }\r\n\r\n    console.log('🔌 WebSocket connections closed for orders page');\r\n  }\r\n\r\n\r\n  @ViewChild(OrderDetailComponent, { static: false })\r\n  OrderDetailComponent!: OrderDetailComponent;\r\n  printOrder(order: InvoiceTab) {\r\n    const dialogRef = this.dialog.open(OrderDetailComponent, {\r\n      data: { order },\r\n      width: '0px',\r\n      height: '0px',\r\n      panelClass: 'hidden-dialog',\r\n      disableClose: true\r\n    });\r\n\r\n    dialogRef.afterOpened().subscribe(() => {\r\n      const componentInstance = dialogRef.componentInstance;\r\n      if (componentInstance) {\r\n        const html = componentInstance.getHtmlContent();\r\n        if (!html) {\r\n          console.error('Không lấy được nội dung HTML hóa đơn!');\r\n          dialogRef.close();\r\n          return;\r\n        }\r\n        this.printService.printHtml(html);\r\n        dialogRef.close();\r\n      } else {\r\n        console.error('Không thể lấy componentInstance của InvoiceDetailComponent!');\r\n        dialogRef.close();\r\n      }\r\n    });\r\n  }\r\n\r\n  private async loadLastSyncTime(): Promise<void> {\r\n    try {\r\n      this.lastSyncTime = await this.orderService.getLastSyncTime() || null;\r\n      console.log('📅 Last sync time loaded:', this.lastSyncTime);\r\n    } catch (error) {\r\n      console.error('❌ Error loading last sync time:', error);\r\n    }\r\n  }\r\n\r\n  private async initializeWebSocket(): Promise<void> {\r\n    try {\r\n      console.log('🔌 Initializing WebSocket for orders page...');\r\n\r\n      // Initialize product WebSocket\r\n      await this.productService.initializeProductWebSocket();\r\n\r\n      // Initialize order WebSocket if available\r\n      await this.orderService.initializeWebSocket();\r\n\r\n      this.isWebSocketConnected = this.productService.isProductWebSocketConnected() ||\r\n        this.orderService.isWebSocketConnected();\r\n\r\n      console.log('🔌 WebSocket initialized for real-time order updates');\r\n\r\n      // If WebSocket is connected, check if we need to sync\r\n      if (this.isWebSocketConnected) {\r\n        const needsSync = await this.orderService.needsSync();\r\n        if (needsSync) {\r\n          console.log('🔄 WebSocket connected and sync needed, triggering sync...');\r\n          setTimeout(() => {\r\n            this.triggerSyncIfNeeded();\r\n          }, 1000);\r\n        } else {\r\n          console.log('✅ WebSocket connected and data is up to date');\r\n          await this.loadLastSyncTime();\r\n        }\r\n      } else {\r\n        console.log('⚠️ WebSocket not connected, will sync when connection is established');\r\n        setTimeout(() => {\r\n          this.retryWebSocketConnection();\r\n        }, 5000);\r\n      }\r\n    } catch (error) {\r\n      console.error('❌ Failed to initialize WebSocket:', error);\r\n      this.isWebSocketConnected = false;\r\n    }\r\n  }\r\n\r\n  private async retryWebSocketConnection(): Promise<void> {\r\n    try {\r\n      console.log('🔄 Retrying WebSocket connection...');\r\n      await this.productService.initializeProductWebSocket();\r\n\r\n      await this.orderService.initializeWebSocket();\r\n\r\n      this.isWebSocketConnected = this.productService.isProductWebSocketConnected() ||\r\n        this.orderService.isWebSocketConnected();\r\n\r\n      if (this.isWebSocketConnected) {\r\n        console.log('✅ WebSocket reconnection successful');\r\n      } else {\r\n        console.log('❌ WebSocket reconnection failed');\r\n      }\r\n    } catch (error) {\r\n      console.error('❌ WebSocket reconnection error:', error);\r\n    }\r\n  }\r\n\r\n  private setupRealTimeSubscriptions(): void {\r\n    // Subscribe to product updates (existing functionality)\r\n    const productSub = this.productService.productOnHandUpdated$.subscribe(() => {\r\n      console.log('📦 Product updated, refreshing orders...');\r\n      this.fetchOrdersByDate();\r\n    });\r\n\r\n    // Subscribe to order-specific events if available\r\n    const createdSub = this.orderService.orderCreated$.subscribe(order => {\r\n      console.log(`🆕 Real-time: Order created - ${order.id}`);\r\n      this.handleOrderCreated(order);\r\n    });\r\n\r\n    const updatedSub = this.orderService.orderUpdated$.subscribe(order => {\r\n      console.log(`🔄 Real-time: Order updated - ${order.id}`);\r\n      this.handleOrderUpdated(order);\r\n    });\r\n\r\n    const deletedSub = this.orderService.orderDeleted$.subscribe(orderId => {\r\n      console.log(`🗑️ Real-time: Order deleted - ${orderId}`);\r\n      this.handleOrderDeleted(orderId);\r\n    });\r\n\r\n    const syncSub = this.orderService.syncCompleted$.subscribe(async () => {\r\n      console.log('🔄 Real-time: Sync completed, updating last sync time...');\r\n      this.isSyncing = false;\r\n      await this.loadLastSyncTime();\r\n    });\r\n\r\n    this.subscriptions.push(productSub, createdSub, updatedSub, deletedSub, syncSub);\r\n  }\r\n\r\n  async fetchOrdersByDate() {\r\n    this.isLoading = true;\r\n    if (!this.selectedDate) {\r\n      this.allOrders = [];\r\n      this.filteredOrders = [];\r\n      this.isLoading = false;\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Get orders from IndexedDB by date\r\n      const orders: any[] = await this.orderService.getOrdersByDateFromDB(this.selectedDate);\r\n\r\n      this.allOrders = orders || [];\r\n\r\n      // Sort orders to show the newest first\r\n      this.allOrders.sort((a, b) => {\r\n        if (!a.createdDate) return 1;\r\n        if (!b.createdDate) return -1;\r\n        return new Date(b.createdDate).getTime() - new Date(a.createdDate).getTime();\r\n      });\r\n\r\n      this.filteredOrders = [...this.allOrders];\r\n      this.customers = [...new Set(this.allOrders.map(order =>\r\n        typeof order.customer === 'string' ? order.customer : order.customer?.Name ?? ''\r\n      ))];\r\n      this.applyFilters();\r\n\r\n    } catch (err) {\r\n      console.error('Error fetching orders from IndexedDB:', err);\r\n      this.allOrders = [];\r\n      this.filteredOrders = [];\r\n    } finally {\r\n      this.isLoading = false;\r\n    }\r\n  }\r\n\r\n  private isOrderInSelectedDate(order: any): boolean {\r\n    if (!this.selectedDate || !order.createdDate) return false;\r\n\r\n    const orderDate = new Date(order.createdDate);\r\n    // So sánh chỉ theo ngày/tháng/năm, bỏ qua giờ\r\n    return orderDate.getDate() === this.selectedDate.getDate() &&\r\n      orderDate.getMonth() === this.selectedDate.getMonth() &&\r\n      orderDate.getFullYear() === this.selectedDate.getFullYear();\r\n  }\r\n\r\n  // Debounced sync method to prevent multiple rapid calls\r\n  private async debouncedSync(): Promise<void> {\r\n    if (this.syncDebounceTimer) {\r\n      clearTimeout(this.syncDebounceTimer);\r\n    }\r\n\r\n    this.syncDebounceTimer = setTimeout(async () => {\r\n      if (!this.isSyncing) {\r\n        await this.performSync();\r\n      }\r\n    }, 1000); // 1 second debounce\r\n  }\r\n\r\n  // Actual sync method with proper locking\r\n  private async performSync(): Promise<void> {\r\n    if (this.isSyncing) {\r\n      console.log('⚠️ Sync already in progress, skipping...');\r\n      return;\r\n    }\r\n\r\n    this.isSyncing = true;\r\n    try {\r\n      console.log('🔄 Starting sync with server...');\r\n\r\n      await this.orderService.syncOrdersBetweenFirestoreAndIndexedDB();\r\n\r\n\r\n      console.log('✅ Sync completed successfully');\r\n\r\n      // Update last sync time\r\n      await this.loadLastSyncTime();\r\n\r\n      // Refresh data after sync\r\n      await this.fetchOrdersByDate();\r\n\r\n    } catch (error) {\r\n      console.error('❌ Error during sync:', error);\r\n    } finally {\r\n      this.isSyncing = false;\r\n    }\r\n  }\r\n\r\n  // Real-time update methods\r\n  async handleOrderCreated(order: any): Promise<void> {\r\n    console.log(`🆕 Real-time: Processing order created - ${order.id}`);\r\n\r\n    // Check if the order belongs to the current date\r\n    if (this.selectedDate && this.isOrderInSelectedDate(order)) {\r\n      // Add to local list if not already present\r\n      const existingIndex = this.allOrders.findIndex(ord => ord.id === order.id);\r\n      if (existingIndex === -1) {\r\n        this.allOrders.unshift(order); // Add to beginning\r\n        this.updateFilteredOrders();\r\n        console.log(`✅ Order ${order.id} added to current view`);\r\n      } else {\r\n        console.log(`ℹ️ Order ${order.id} already exists in current view`);\r\n      }\r\n    } else {\r\n      console.log(`ℹ️ Order ${order.id} does not belong to current date, skipping UI update`);\r\n    }\r\n  }\r\n\r\n  async handleOrderUpdated(order: any): Promise<void> {\r\n    console.log(`🔄 Real-time: Processing order updated - ${order.id}`);\r\n\r\n    // Update in local list\r\n    const existingIndex = this.allOrders.findIndex(ord => ord.id === order.id);\r\n    if (existingIndex !== -1) {\r\n      this.allOrders[existingIndex] = order;\r\n      this.updateFilteredOrders();\r\n      console.log(`✅ Order ${order.id} updated in current view`);\r\n    } else {\r\n      console.log(`ℹ️ Order ${order.id} not found in current view, may need to refresh`);\r\n      await this.fetchOrdersByDate();\r\n    }\r\n  }\r\n\r\n  async handleOrderDeleted(orderId: string): Promise<void> {\r\n    console.log(`🗑️ Real-time: Processing order deleted - ${orderId}`);\r\n\r\n    // Remove from local list\r\n    const initialLength = this.allOrders.length;\r\n    this.allOrders = this.allOrders.filter(ord => ord.id !== orderId);\r\n\r\n    if (this.allOrders.length < initialLength) {\r\n      this.updateFilteredOrders();\r\n      console.log(`✅ Order ${orderId} removed from current view`);\r\n    } else {\r\n      console.log(`ℹ️ Order ${orderId} not found in current view`);\r\n    }\r\n  }\r\n\r\n  private updateFilteredOrders(): void {\r\n    this.filteredOrders = [...this.allOrders];\r\n    this.applyFilters();\r\n  }\r\n\r\n  // Enhanced delete method with WebSocket notification\r\n  async deleteOrdersByFilter() {\r\n    const dialogRef = this.dialog.open(ConfirmPopupComponent, {\r\n      width: '300px',\r\n      data: { message: 'Bạn có chắc chắn muốn xóa tất cả đơn hàng đang hiển thị?' }\r\n    });\r\n\r\n    dialogRef.afterClosed().subscribe(async (result) => {\r\n      if (result === true) {\r\n        this.isLoading = true;\r\n        let successCount = 0;\r\n        let errorCount = 0;\r\n\r\n        // Delete each order in filteredOrders\r\n        for (const order of this.filteredOrders) {\r\n          try {\r\n            // Delete from IndexedDB\r\n            if (this.orderService.deleteOrderFromDB) {\r\n              await this.orderService.deleteOrderFromDB(order.id);\r\n            }\r\n            console.log('Order deleted successfully from IndexedDB');\r\n\r\n            // Delete from Firestore\r\n            if (this.orderService.deleteOrderToFirestore) {\r\n              await firstValueFrom(this.orderService.deleteOrderToFirestore(order.id));\r\n            }\r\n            console.info(`Successfully deleted from Firestore: ${order.id}`);\r\n\r\n            // Notify other clients via WebSocket\r\n            if (this.isWebSocketReady() && this.orderService.notifyOrderDeleted) {\r\n              await this.orderService.notifyOrderDeleted(order.id);\r\n            }\r\n\r\n            successCount++;\r\n          } catch (error: any) {\r\n            console.error('Error deleting order:', error);\r\n            errorCount++;\r\n          }\r\n        }\r\n\r\n        // Show summary\r\n        if (successCount > 0) {\r\n          console.log(`✅ Successfully deleted ${successCount} orders`);\r\n        }\r\n        if (errorCount > 0) {\r\n          console.error(`❌ Failed to delete ${errorCount} orders`);\r\n        }\r\n\r\n        // Refresh the list\r\n        this.fetchOrdersByDate();\r\n      }\r\n    });\r\n  }\r\n\r\n  // Manual sync method with proper locking\r\n  async manualSync(): Promise<void> {\r\n    if (this.isSyncing) {\r\n      console.log('⚠️ Sync already in progress, please wait...');\r\n      return;\r\n    }\r\n\r\n    if (this.isLoading) {\r\n      console.log('⚠️ Component is loading, please wait...');\r\n      return;\r\n    }\r\n\r\n    console.log('🔄 Manual sync requested...');\r\n    this.isLoading = true;\r\n    try {\r\n      await this.performSync();\r\n      console.log('✅ Manual sync completed successfully');\r\n    } catch (error) {\r\n      console.error('❌ Manual sync failed:', error);\r\n    } finally {\r\n      this.isLoading = false;\r\n    }\r\n  }\r\n\r\n  // Get connection status with more detailed information\r\n  getConnectionStatus(): string {\r\n    const productStatus = this.productService.getProductWebSocketStatus();\r\n    const orderStatus = this.orderService.getWebSocketStatus?.() || { connected: false, initialized: false, socketExists: false };\r\n\r\n    // Check if either connection is active\r\n    const isConnected = productStatus.connected || orderStatus.connected;\r\n    const isConnecting = (productStatus.initialized && productStatus.socketExists) ||\r\n      (orderStatus.initialized && orderStatus.socketExists);\r\n\r\n    if (isConnected) {\r\n      return '🟢 Connected';\r\n    } else if (isConnecting) {\r\n      return '🟡 Connecting...';\r\n    } else {\r\n      return '🔴 Disconnected';\r\n    }\r\n  }\r\n\r\n  // Method to trigger sync when needed\r\n  async triggerSyncIfNeeded(): Promise<void> {\r\n    if (this.isWebSocketReady() && !this.isSyncing && !this.isLoading) {\r\n      console.log('🔄 Triggering sync due to WebSocket connection...');\r\n      await this.debouncedSync();\r\n    }\r\n  }\r\n\r\n  // Check sync status for template\r\n  isCurrentlySyncing(): boolean {\r\n    return this.isSyncing;\r\n  }\r\n\r\n  // Enhanced method to check if WebSocket is ready\r\n  isWebSocketReady(): boolean {\r\n    return this.productService.isProductWebSocketConnected() ||\r\n      this.orderService.isWebSocketConnected();\r\n  }\r\n\r\n  // Get last sync time\r\n  getLastSyncTime(): string {\r\n    if (this.lastSyncTime) {\r\n      const now = new Date();\r\n      const diffMs = now.getTime() - this.lastSyncTime.getTime();\r\n      const diffMins = Math.floor(diffMs / 60000);\r\n      const diffHours = Math.floor(diffMs / 3600000);\r\n      const diffDays = Math.floor(diffMs / 86400000);\r\n\r\n      if (diffMins < 1) {\r\n        return 'Vừa xong';\r\n      } else if (diffMins < 60) {\r\n        return `${diffMins} phút trước`;\r\n      } else if (diffHours < 24) {\r\n        return `${diffHours} giờ trước`;\r\n      } else if (diffDays < 7) {\r\n        return `${diffDays} ngày trước`;\r\n      } else {\r\n        return this.lastSyncTime.toLocaleDateString('vi-VN', {\r\n          year: 'numeric',\r\n          month: '2-digit',\r\n          day: '2-digit',\r\n          hour: '2-digit',\r\n          minute: '2-digit'\r\n        });\r\n      }\r\n    }\r\n    return 'Chưa đồng bộ';\r\n  }\r\n\r\n  // Filter and search methods\r\n  onDateChange(event: any) {\r\n    if (event.value) {\r\n      this.selectedDate = new Date(event.value);\r\n      this.selectedDate.setHours(0, 0, 0, 0);\r\n    } else {\r\n      this.selectedDate = null;\r\n    }\r\n    if (this.selectedDate) {\r\n      this.fetchOrdersByDate();\r\n    }\r\n  }\r\n\r\n  clearFilters() {\r\n    this.selectedDate = null;\r\n    this.searchTerm = '';\r\n    this.searchTermProduct = '';\r\n    this.selectedCustomer = '';\r\n    this.fetchOrdersByDate();\r\n  }\r\n\r\n  applyFilters() {\r\n    this.filteredOrders = this.allOrders.filter(order => {\r\n      const matchesSearch = this.searchTerm\r\n        ? String(order.id).toLowerCase().includes(this.searchTerm.toLowerCase()) ||\r\n        (typeof order.customer === 'string' ? order.customer : order.customer?.Name || '').toLowerCase().includes(this.searchTerm.toLowerCase())\r\n        : true;\r\n      const matchesProduct = this.checkProductFilter(order, this.searchTermProduct);\r\n      const matchesCustomer = this.checkCustomerFilter(order);\r\n      this.currentPage = 1;\r\n      return matchesSearch && matchesCustomer && matchesProduct;\r\n    });\r\n  }\r\n\r\n  private checkCustomerFilter(order: any): boolean {\r\n    if (!this.selectedCustomer) {\r\n      return true;\r\n    }\r\n\r\n    return typeof order.customer === 'string'\r\n      ? order.customer === this.selectedCustomer\r\n      : order.customer?.Name === this.selectedCustomer;\r\n  }\r\n\r\n  private checkProductFilter(order: any, searchTerm: string): boolean {\r\n    if (!searchTerm || searchTerm.trim() === '') {\r\n      return true;\r\n    }\r\n\r\n    if (!order.cartItems || order.cartItems.length === 0) {\r\n      return false;\r\n    }\r\n\r\n    const queryTokens = this.vi.normalizeAndTokenize(searchTerm);\r\n    const queryStr = queryTokens.join(' ').toLowerCase();\r\n    const rawQuery = searchTerm.toLowerCase();\r\n\r\n    return order.cartItems.some((item: any) => {\r\n      if (!item.product || !item.product.Name) {\r\n        return false;\r\n      }\r\n\r\n      const productName = item.product.Name;\r\n      const productCode = item.product.Code || '';\r\n\r\n      // Normalize product name\r\n      const normalizedProductName = this.vi.normalizeAndTokenize(productName).join(' ').toLowerCase();\r\n\r\n      // 1. Check if product name starts with search term (highest priority)\r\n      if (normalizedProductName.startsWith(queryStr)) {\r\n        return true;\r\n      }\r\n\r\n      // 2. Check if product name contains search term\r\n      if (normalizedProductName.includes(queryStr) || productName.toLowerCase().includes(rawQuery)) {\r\n        return true;\r\n      }\r\n\r\n      // 3. Check product code\r\n      const productCodeLower = productCode.toLowerCase();\r\n\r\n      // Check if query has format \"XXXXXXX-X\" (contains dash)\r\n      if (rawQuery.includes('-')) {\r\n        const baseQuery = rawQuery.split('-')[0];\r\n        return productCodeLower === baseQuery;\r\n      }\r\n\r\n      return productCodeLower.includes(rawQuery);\r\n    });\r\n  }\r\n\r\n  // Formatting methods\r\n  formatPrice(price: number): string {\r\n    return price ? price.toLocaleString('vi-VN') : '';\r\n  }\r\n\r\n  getStatusText(status: string | undefined): string {\r\n    switch (status) {\r\n      case 'pending':\r\n        return 'Chờ xử lý';\r\n      case 'checked':\r\n        return 'Đã xử lý';\r\n      case 'canceled':\r\n        return 'Đã hủy';\r\n      case 'edited':\r\n        return 'Đã chỉnh sửa';\r\n      default:\r\n        return 'Chờ xử lý';\r\n    }\r\n  }\r\n\r\n  formatDate(date: string | Date): string {\r\n    if (!date) return '';\r\n    const d = new Date(date);\r\n    return d.toLocaleDateString('vi-VN', {\r\n      year: 'numeric',\r\n      month: '2-digit',\r\n      day: '2-digit',\r\n      hour: '2-digit',\r\n      minute: '2-digit'\r\n    });\r\n  }\r\n\r\n  // View order details\r\n  viewOrder(order: any) {\r\n    const dialogRef = this.dialog.open(ViewSwlectedOrderDialogComponent, {\r\n      width: '600px',\r\n      data: {\r\n        order: order\r\n      }\r\n    });\r\n\r\n    dialogRef.afterClosed().subscribe((result: any) => {\r\n      if (result && result.success) {\r\n        // Order was processed and sent to main page\r\n        console.log(`✅ Order ${order.id} processed and sent to main page`);\r\n        this.dialogRef.close(); // Close the order page dialog\r\n      } else if (result && result.edit) {\r\n        // Order was sent to main page for editing\r\n        console.log(`📝 Order ${order.id} sent to main page for editing`);\r\n        this.dialogRef.close(); // Close the order page dialog\r\n      } else if (result === true) {\r\n        // Order was deleted\r\n        this.allOrders = this.allOrders.filter(o => o.id !== order.id);\r\n        this.applyFilters();\r\n      }\r\n    });\r\n  }\r\n\r\n  // Cancel order\r\n  async cancelOrder(order: any) {\r\n    const dialogRef = this.dialog.open(ConfirmPopupComponent, {\r\n      width: '300px',\r\n      data: { message: `Bạn có chắc chắn muốn hủy đơn hàng ${order.id}?` }\r\n    });\r\n\r\n    dialogRef.afterClosed().subscribe(async (result) => {\r\n      if (result === true) {\r\n        this.isLoading = true;\r\n        try {\r\n          // Update order status to 'canceled'\r\n          const updateData = { status: 'canceled' };\r\n          await firstValueFrom(this.orderService.updateOrderToFirestore(order.id, updateData));\r\n\r\n          // Update in IndexedDB\r\n          const updatedOrder = await this.orderService.getOrderFromDBById(order.id);\r\n          if (updatedOrder) {\r\n            updatedOrder.status = 'canceled';\r\n            await this.orderService.updateOrderInDB(updatedOrder);\r\n          }\r\n\r\n          // Notify via WebSocket\r\n          await this.orderService.notifyOrderUpdated({ id: order.id, status: 'canceled' });\r\n\r\n          // Update local list\r\n          const orderIndex = this.allOrders.findIndex(o => o.id === order.id);\r\n          if (orderIndex !== -1) {\r\n            this.allOrders[orderIndex].status = 'canceled';\r\n            this.updateFilteredOrders();\r\n          }\r\n\r\n          console.log(`✅ Order ${order.id} has been canceled`);\r\n        } catch (error) {\r\n          console.error('❌ Error canceling order:', error);\r\n        } finally {\r\n          this.isLoading = false;\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  // Pagination methods\r\n  get totalPages(): number {\r\n    return Math.ceil(this.filteredOrders.length / this.pageSize);\r\n  }\r\n\r\n  get pagedOrders(): any[] {\r\n    const start = (this.currentPage - 1) * this.pageSize;\r\n    return this.filteredOrders.slice(start, start + this.pageSize);\r\n  }\r\n\r\n  goToPage(page: number) {\r\n    if (page < 1 || page > this.totalPages) return;\r\n    this.currentPage = page;\r\n  }\r\n\r\n  nextPage() {\r\n    if (this.currentPage < this.totalPages) {\r\n      this.currentPage++;\r\n    }\r\n  }\r\n\r\n  prevPage() {\r\n    if (this.currentPage > 1) {\r\n      this.currentPage--;\r\n    }\r\n  }\r\n\r\n  // Scroll handling for filter visibility\r\n  lastScrollTop = 0;\r\n  hideFilters = false;\r\n\r\n  onScroll(event: Event) {\r\n    const target = event.target as HTMLElement;\r\n    const scrollTop = target.scrollTop;\r\n\r\n    if (scrollTop > this.lastScrollTop + 10) {\r\n      this.hideFilters = true;\r\n    } else if (scrollTop < this.lastScrollTop - 10 || scrollTop === 0) {\r\n      this.hideFilters = false;\r\n    }\r\n\r\n    this.lastScrollTop = scrollTop;\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\order-page\\view-selected-order.component.html","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\order-page\\view-selected-order.component.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Input' is defined but never used.","line":1,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":34},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":27,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":27,"endColumn":69},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":28,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":28,"endColumn":64},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":29,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":29,"endColumn":39},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":30,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":30,"endColumn":43},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":31,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":31,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":32,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":32,"endColumn":57},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":33,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":33,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":51,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":51,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":93,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":93,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":120,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3921,3924],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3921,3924],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'orderId' is defined but never used.","line":125,"column":22,"nodeType":null,"messageId":"unusedVar","endLine":125,"endColumn":29},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":219,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":219,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7793,7796],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7793,7796],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":222,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":222,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7893,7896],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7893,7896],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'vnNow' is assigned a value but never used.","line":252,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":252,"endColumn":18},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":288,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":288,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10501,10504],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10501,10504],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":291,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":291,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10587,10590],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10587,10590],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":292,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":292,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10647,10650],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10647,10650],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":293,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":293,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10715,10718],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10715,10718],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":297,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":297,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10907,10910],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10907,10910],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":298,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":298,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10966,10969],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10966,10969],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":21,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, Inject, Input, OnInit, OnDestroy } from '@angular/core';\r\nimport { MAT_DIALOG_DATA, MatDialogRef, MatDialog, MatDialogModule } from '@angular/material/dialog';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { OrderService } from '../../services/order.service';\r\nimport { InvoiceService } from '../../services/invoice.service';\r\nimport { TimeZoneService } from '../../services/time-zone.service';\r\nimport { OrderToInvoiceService } from '../../services/order-to-invoice.service';\r\nimport { ConfirmPopupComponent } from '../confirm-popup/confirm-popup.component';\r\nimport { Subscription, firstValueFrom } from 'rxjs';\r\nimport { InvoiceTab } from '../../models/invoice.model';\r\n\r\n@Component({\r\n  selector: 'app-order-detail',\r\n  templateUrl: './view-selected-order.component.html',\r\n  styleUrls: ['./view-selected-order.component.css'],\r\n  imports: [CommonModule, MatIconModule, MatButtonModule, MatDialogModule]\r\n})\r\nexport class ViewSwlectedOrderDialogComponent implements OnInit, OnDestroy {\r\n  isDeleting = false;\r\n  isWebSocketConnected = false;\r\n  lastUpdateTime: Date | null = null;\r\n  private subscriptions: Subscription[] = [];\r\n\r\n  constructor(\r\n    public dialogRef: MatDialogRef<ViewSwlectedOrderDialogComponent>,\r\n    @Inject(MAT_DIALOG_DATA) public data: { order: InvoiceTab },\r\n    private orderService: OrderService,\r\n    private invoiceService: InvoiceService,\r\n    private timeZoneService: TimeZoneService,\r\n    private orderToInvoiceService: OrderToInvoiceService,\r\n    private dialog: MatDialog,\r\n  ) { }\r\n\r\n  ngOnInit() {\r\n    this.initializeWebSocket();\r\n    this.setupRealTimeSubscriptions();\r\n    this.lastUpdateTime = new Date();\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.subscriptions.forEach(sub => sub.unsubscribe());\r\n    this.subscriptions = [];\r\n  }\r\n\r\n  private async initializeWebSocket(): Promise<void> {\r\n    try {\r\n      await this.orderService.initializeWebSocket();\r\n      this.isWebSocketConnected = this.orderService.isWebSocketConnected();\r\n    } catch (error) {\r\n      this.isWebSocketConnected = false;\r\n    }\r\n  }\r\n\r\n  private setupRealTimeSubscriptions(): void {\r\n    const updatedSub = this.orderService.orderUpdated$.subscribe(order => {\r\n      if (order.id === this.data.order.id) {\r\n        this.handleOrderUpdate(order);\r\n      }\r\n    });\r\n    const deletedSub = this.orderService.orderDeleted$.subscribe(orderId => {\r\n      if (orderId === this.data.order.id) {\r\n        this.handleOrderDeleted(orderId);\r\n      }\r\n    });\r\n    this.subscriptions.push(updatedSub, deletedSub);\r\n  }\r\n\r\n  close() {\r\n    this.dialogRef.close();\r\n  }\r\n\r\n  getTotalPrice(): number {\r\n    return this.data.order.totalPrice;\r\n  }\r\n\r\n  getTotalQuantity(): number {\r\n    return this.data.order.totalQuantity;\r\n  }\r\n\r\n  formatVnd(amount: number): string {\r\n    return amount ? amount.toLocaleString('vi-VN') + ' ₫' : '';\r\n  }\r\n\r\n  async refreshOrderData(): Promise<void> {\r\n    try {\r\n      const updatedOrder = await this.orderService.getOrderFromDBById(this.data.order.id);\r\n      if (updatedOrder) {\r\n        this.data.order = updatedOrder;\r\n        this.lastUpdateTime = new Date();\r\n      }\r\n    } catch (error) {\r\n      // handle error\r\n    }\r\n  }\r\n\r\n  getConnectionStatus(): string {\r\n    const status = this.orderService.getWebSocketStatus();\r\n    if (status.connected) {\r\n      return '🟢 Connected';\r\n    } else if (status.initialized && status.socketExists) {\r\n      return '🟡 Connecting...';\r\n    } else {\r\n      return '🔴 Disconnected';\r\n    }\r\n  }\r\n\r\n  isWebSocketReady(): boolean {\r\n    return this.orderService.isWebSocketConnected();\r\n  }\r\n\r\n  getLastUpdateTime(): string {\r\n    if (this.lastUpdateTime) {\r\n      return this.lastUpdateTime.toLocaleTimeString('vi-VN');\r\n    }\r\n    return 'Never';\r\n  }\r\n\r\n  handleOrderUpdate(updatedOrder: any): void {\r\n    this.data.order = updatedOrder;\r\n    this.lastUpdateTime = new Date();\r\n  }\r\n\r\n  handleOrderDeleted(orderId: string): void {\r\n    this.dialogRef.close(true); // true indicates deletion\r\n  }\r\n\r\n  // Delete order method\r\n  async deleteOrder() {\r\n    const dialogRef = this.dialog.open(ConfirmPopupComponent, {\r\n      width: '300px',\r\n      data: { message: `Bạn có chắc chắn muốn xóa đơn hàng ${this.data.order.id}?` }\r\n    });\r\n\r\n    dialogRef.afterClosed().subscribe(async (result) => {\r\n      if (result === true) {\r\n        try {\r\n          // Delete from IndexedDB\r\n          await this.orderService.deleteOrderFromDB(this.data.order.id);\r\n          \r\n          // Delete from Firestore\r\n          await firstValueFrom(this.orderService.deleteOrderToFirestore(this.data.order.id));\r\n          \r\n          // Notify via WebSocket\r\n          await this.orderService.notifyOrderDeleted(this.data.order.id);\r\n          \r\n          // Close dialog with deletion result\r\n          this.dialogRef.close(true);\r\n          console.log(`✅ Order ${this.data.order.id} has been deleted`);\r\n        } catch (error) {\r\n          console.error('❌ Error deleting order:', error);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  getHtmlContent(): string | null {\r\n    // Try to get the HTML content for printing\r\n    const el = document.querySelector('mat-dialog-content');\r\n    return el ? el.innerHTML : null;\r\n  }\r\n\r\n  getStatusText(status: string | undefined): string {\r\n    switch (status) {\r\n      case 'pending':\r\n        return 'Chờ xử lý';\r\n      case 'checked':\r\n        return 'Đã xử lý';\r\n      case 'canceled':\r\n        return 'Đã hủy';\r\n      default:\r\n        return 'Chờ xử lý';\r\n    }\r\n  }\r\n  async handleOrder() {\r\n    if (this.data.order.status === 'checked' || this.data.order.status === 'canceled') {\r\n      console.log(`ℹ️ Order ${this.data.order.id} is already ${this.data.order.status}`);\r\n      return;\r\n    }\r\n\r\n        try {\r\n          // Create invoice from order (without changing order status yet)\r\n          const now = new Date();\r\n          const vnNow = this.timeZoneService.formatVietnamISOString(now);\r\n          \r\n          // Calculate the amount due after discount\r\n          const amountDue = this.data.order.totalPrice - this.data.order.discountAmount;\r\n          \r\n          // Keep the original customerPaid from order (what customer has already paid)\r\n          const customerPaid = this.data.order.customerPaid || 0;\r\n          \r\n          // Calculate debt (change amount) - negative means customer owes money, positive means we owe customer\r\n          const debt = customerPaid - amountDue;\r\n          \r\n          console.log(`📊 Order to Invoice conversion:`, {\r\n            orderId: this.data.order.id,\r\n            orderTotalPrice: this.data.order.totalPrice,\r\n            orderDiscountAmount: this.data.order.discountAmount,\r\n            orderCustomerPaid: this.data.order.customerPaid,\r\n            calculatedAmountDue: amountDue,\r\n            calculatedCustomerPaid: customerPaid,\r\n            calculatedDebt: debt\r\n          });\r\n          \r\n          const invoice: InvoiceTab = {\r\n            id: 'HD' + Date.now().toString(),\r\n            name: 'Hóa đơn từ đơn hàng ' + this.data.order.id,\r\n            cartItems: [...this.data.order.cartItems],\r\n            createdDate: vnNow,\r\n            totalPrice: this.data.order.totalPrice,\r\n            discountAmount: this.data.order.discountAmount,\r\n            customer: this.data.order.customer ? { ...this.data.order.customer } : null,\r\n            totalQuantity: this.data.order.totalQuantity,\r\n            debt: debt, // Calculate debt based on what customer has paid vs amount due\r\n            note: this.data.order.note,\r\n            customerPaid: customerPaid, // Keep original customerPaid from order\r\n            totalCost: this.data.order.totalCost\r\n          } as any;\r\n          \r\n          // Mark as manually set to prevent auto-override\r\n          (invoice as any).customerPaidManuallySet = true;\r\n          \r\n          console.log(`📊 Created invoice:`, {\r\n            invoiceId: invoice.id,\r\n            invoiceCustomerPaid: invoice.customerPaid,\r\n            invoiceDebt: invoice.debt,\r\n            invoiceTotalPrice: invoice.totalPrice,\r\n            invoiceDiscountAmount: invoice.discountAmount\r\n          });\r\n\r\n          // Emit event to main page to add invoice\r\n          this.orderToInvoiceService.processOrder(invoice, this.data.order.id);\r\n\r\n          // Close dialog\r\n          this.dialogRef.close({ \r\n            success: true, \r\n            invoice: invoice,\r\n            orderId: this.data.order.id\r\n          });\r\n          console.log(`✅ Order ${this.data.order.id} has been processed and sent to main page`);\r\n\r\n        } catch (error) {\r\n          console.error('❌ Error processing order:', error);\r\n        }\r\n  }\r\n\r\n  editOrder() {\r\n    try {\r\n      // Create a copy of the order for editing\r\n      const now = new Date();\r\n      const vnNow = this.timeZoneService.formatVietnamISOString(now);\r\n\r\n      // Calculate the amount due after discount\r\n      const amountDue = this.data.order.totalPrice - this.data.order.discountAmount;\r\n\r\n      // Keep the original customerPaid from order\r\n      const customerPaid = this.data.order.customerPaid || 0;\r\n\r\n      // Calculate debt\r\n      const debt = customerPaid - amountDue;\r\n\r\n      console.log(`📝 Editing order ${this.data.order.id}`, {\r\n        orderId: this.data.order.id,\r\n        orderTotalPrice: this.data.order.totalPrice,\r\n        orderDiscountAmount: this.data.order.discountAmount,\r\n        orderCustomerPaid: this.data.order.customerPaid,\r\n        calculatedAmountDue: amountDue,\r\n        calculatedCustomerPaid: customerPaid,\r\n        calculatedDebt: debt\r\n      });\r\n\r\n      const editedOrder: InvoiceTab = {\r\n        id: this.data.order.id, // Keep the original order ID\r\n        name: 'Chỉnh sửa đơn hàng ' + this.data.order.id,\r\n        cartItems: [...this.data.order.cartItems],\r\n        createdDate: this.data.order.createdDate, // Keep original creation date\r\n        totalPrice: this.data.order.totalPrice,\r\n        discountAmount: this.data.order.discountAmount,\r\n        customer: this.data.order.customer ? { ...this.data.order.customer } : null,\r\n        totalQuantity: this.data.order.totalQuantity,\r\n        debt: debt,\r\n        note: this.data.order.note,\r\n        customerPaid: customerPaid,\r\n        totalCost: this.data.order.totalCost,\r\n        status: this.data.order.status, // Keep original status\r\n        deliveryTime: this.data.order.deliveryTime\r\n      } as any;\r\n\r\n      // Mark as manually set to prevent auto-override\r\n      (editedOrder as any).customerPaidManuallySet = true;\r\n      (editedOrder as any).isEditMode = true; // Mark as edit mode\r\n      (editedOrder as any).originalOrderId = this.data.order.id; // Store original order ID\r\n\r\n      console.log(`📝 Created edited order:`, {\r\n        orderId: editedOrder.id,\r\n        isEditMode: (editedOrder as any).isEditMode,\r\n        originalOrderId: (editedOrder as any).originalOrderId\r\n      });\r\n\r\n      // Emit event to main page to add order for editing\r\n      this.orderToInvoiceService.processOrder(editedOrder, this.data.order.id);\r\n\r\n      // Close dialog\r\n      this.dialogRef.close({\r\n        edit: true,\r\n        order: editedOrder,\r\n        orderId: this.data.order.id\r\n      });\r\n\r\n      console.log(`✅ Order ${this.data.order.id} has been sent to main page for editing`);\r\n\r\n    } catch (error) {\r\n      console.error('❌ Error editing order:', error);\r\n    }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\out-of-stock-dialog\\out-of-stock-dialog.component.html","messages":[{"ruleId":"@angular-eslint/template/alt-text","severity":2,"message":"<img/> element must have a text alternative.","line":20,"column":11,"nodeType":null,"messageId":"altText","endLine":20,"endColumn":48}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"<h2>Danh sách sản phẩm hết hàng</h2>\r\n<div>\r\n  <input class =\"input-search\" [(ngModel)]=\"searchTerm\" (input)=\"filter()\" placeholder=\"Tìm theo mã hoặc tên...\" />\r\n  <button  mat-button class=\"reload-button\" (click)=\"reload()\" [disabled]=\"isLoading\">Reload</button>\r\n</div>\r\n<div class=\"loading\" *ngIf=\"isLoading\">Đang tải...</div>\r\n<table *ngIf=\"!isLoading\">\r\n  <thead>\r\n    <tr>\r\n      <th>Ảnh</th>\r\n      <th>Mã</th>\r\n      <th>Tên</th>\r\n      <th>Giá vốn</th>\r\n      <th>Giá bán</th>\r\n      <th>Tồn kho</th>\r\n    </tr>\r\n  </thead>\r\n  <tbody>\r\n    <tr *ngFor=\"let item of filteredItems\">\r\n      <td><img [src]=\"item.Image\" width=\"40\" /></td>\r\n      <td>{{ item.Code }}</td>\r\n      <td>{{ item.FullName }}</td>\r\n      <td>{{ item.Cost | number:'1.0-0' }}</td>\r\n      <td>{{ item.BasePrice | number:'1.0-0' }}</td>\r\n      <td>{{ item.OnHand }}</td>\r\n    </tr>\r\n  </tbody>\r\n</table>\r\n<div class=\"pagination\">\r\n  <button (click)=\"prevPage()\" [disabled]=\"page === 1\">&lt;</button>\r\n  <span>Trang {{page}} / {{totalPages}} ({{totalItems}} sản phẩm)</span>\r\n  <button (click)=\"nextPage()\" [disabled]=\"page === totalPages\">&gt;</button>\r\n</div>","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\out-of-stock-dialog\\out-of-stock-dialog.component.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[671,674],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[671,674],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":17,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[701,704],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[701,704],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":31,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":31,"endColumn":62},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":32,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":32,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":33,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":33,"endColumn":47},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":34,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":34,"endColumn":46},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":34,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1130,1133],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1130,1133],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":52,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":52,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":71,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2235,2238],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2235,2238],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":87,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":87,"endColumn":15}],"suppressedMessages":[],"errorCount":10,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, Inject, OnInit } from '@angular/core';\r\nimport { MAT_DIALOG_DATA, MatDialogRef } from '@angular/material/dialog';\r\nimport { KiotvietService } from '../../services/kiotviet.service';\r\nimport { IndexedDBService } from '../../services/indexed-db.service';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\n\r\n@Component({\r\n  selector: 'app-out-of-stock-dialog',\r\n  standalone: true,\r\n  imports: [CommonModule, FormsModule],\r\n  templateUrl: './out-of-stock-dialog.component.html',\r\n  styleUrls: ['./out-of-stock-dialog.component.css']\r\n})\r\nexport class OutOfStockDialogComponent implements OnInit {\r\n  items: any[] = [];\r\n  filteredItems: any[] = [];\r\n  searchTerm = '';\r\n  isLoading = false;\r\n\r\n  private dbName = 'SalesDB';\r\n  private storeName = 'outofstock';\r\n\r\n  // Paging\r\n  page = 1;\r\n  pageSize = 20;\r\n  totalPages = 1;\r\n  totalItems = 0;\r\n\r\n  constructor(\r\n    public dialogRef: MatDialogRef<OutOfStockDialogComponent>,\r\n    private kiotvietService: KiotvietService,\r\n    private indexedDBService: IndexedDBService,\r\n    @Inject(MAT_DIALOG_DATA) public data: any\r\n  ) { }\r\n\r\n  async ngOnInit() {\r\n    // Khi mở dialog, load từ IndexedDB và phân trang local\r\n    this.isLoading = true;\r\n    try {\r\n      await this.indexedDBService.getDB(this.dbName, 1, db => {\r\n        if (!db.objectStoreNames.contains(this.storeName)) {\r\n          db.createObjectStore(this.storeName, { keyPath: 'Code' });\r\n        }\r\n      });\r\n      const data = await this.indexedDBService.getAll(this.dbName, 1, this.storeName);\r\n      this.items = data;\r\n      this.totalItems = data.length;\r\n      this.page = 1;\r\n      this.totalPages = Math.max(1, Math.ceil(this.totalItems / this.pageSize));\r\n      this.updateFilteredItems();\r\n    } catch (e) {\r\n      this.items = [];\r\n      this.filteredItems = [];\r\n      this.totalItems = 0;\r\n      this.page = 1;\r\n      this.totalPages = 1;\r\n    }\r\n    this.isLoading = false;\r\n  }\r\n\r\n  updateFilteredItems() {\r\n    const start = (this.page - 1) * this.pageSize;\r\n    const end = start + this.pageSize;\r\n    this.filteredItems = this.items.slice(start, end);\r\n  }\r\n\r\n  async reload() {\r\n    this.isLoading = true;\r\n    try {\r\n      const result: any = await this.kiotvietService.getOutOfStockItems();\r\n      if (result && result.items) {\r\n        await this.indexedDBService.clear(this.dbName, 1, this.storeName);\r\n        await this.indexedDBService.putMany(this.dbName, 1, this.storeName, result.items);\r\n        this.items = result.items;\r\n        this.totalItems = result.total_items || result.items.length;\r\n        this.page = 1;\r\n        this.totalPages = Math.max(1, Math.ceil(this.totalItems / this.pageSize));\r\n        this.updateFilteredItems();\r\n      } else {\r\n        this.items = [];\r\n        this.filteredItems = [];\r\n        this.totalItems = 0;\r\n        this.page = 1;\r\n        this.totalPages = 1;\r\n      }\r\n    } catch (e) {\r\n      alert('Lỗi khi tải dữ liệu!');\r\n    }\r\n    this.isLoading = false;\r\n  }\r\n  filter() {\r\n    const term = this.searchTerm.trim().toLowerCase();\r\n    if (!term) {\r\n      this.filteredItems = this.items;\r\n      return;\r\n    }\r\n    this.filteredItems = this.items.filter(item =>\r\n      (item.Code && item.Code.toLowerCase().includes(term)) ||\r\n      (item.FullName && item.FullName.toLowerCase().includes(term))\r\n    );\r\n  }\r\n  async goToPage(page: number) {\r\n    if (page < 1 || page > this.totalPages) return;\r\n    this.page = page;\r\n    this.updateFilteredItems();\r\n  }\r\n  nextPage() { if (this.page < this.totalPages) { this.page++; this.updateFilteredItems(); } }\r\n  prevPage() { if (this.page > 1) { this.page--; this.updateFilteredItems(); } }\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\report-page\\report-page.component.html","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\report-page\\report-page.component.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ViewEncapsulation' is defined but never used.","line":1,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":38},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ViewChild' is defined but never used.","line":1,"column":48,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":57},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'MatDialogRef' is defined but never used.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'MatDialog' is defined but never used.","line":2,"column":41,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DateAdapter' is defined but never used.","line":8,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":42},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'MAT_DATE_FORMATS' is defined but never used.","line":8,"column":44,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":60},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'MAT_DATE_LOCALE' is defined but never used.","line":8,"column":62,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":77},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Product' is defined but never used.","line":21,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":17},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":44,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":44,"endColumn":43},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":45,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":45,"endColumn":45},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":229,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":229,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6558,6561],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6558,6561],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":279,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":279,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8103,8106],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8103,8106],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":404,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":404,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11815,11818],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11815,11818],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":418,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":418,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12275,12278],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12275,12278],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":480,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":480,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14259,14262],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14259,14262],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":546,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":546,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16215,16218],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16215,16218],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":607,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":607,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18130,18133],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18130,18133],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":621,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":621,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18649,18652],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18649,18652],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":647,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":647,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19624,19627],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19624,19627],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":661,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":661,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20138,20141],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20138,20141],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":694,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":694,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21237,21240],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21237,21240],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":21,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, ViewEncapsulation, OnInit, ViewChild } from '@angular/core';\nimport { MatDialogRef, MatDialogModule, MatDialog } from '@angular/material/dialog';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport { MatFormFieldModule } from '@angular/material/form-field';\nimport { MatInputModule } from '@angular/material/input';\nimport { MatDatepickerModule } from '@angular/material/datepicker';\nimport { MatNativeDateModule, DateAdapter, MAT_DATE_FORMATS, MAT_DATE_LOCALE } from '@angular/material/core';\nimport { MatSelectModule } from '@angular/material/select';\nimport { MatTableModule } from '@angular/material/table';\nimport { MatIconModule } from '@angular/material/icon';\nimport { MatButtonModule } from '@angular/material/button';\nimport { InvoiceTab } from '../../models/invoice.model';\nimport { InvoiceService } from '../../services/invoice.service';\nimport { NgChartsModule } from 'ng2-charts';\nimport { ChartConfiguration, ChartData, ChartType } from 'chart.js';\nimport ChartDataLabels from 'chartjs-plugin-datalabels';\nimport { Chart } from 'chart.js';\nChart.register(ChartDataLabels);\nimport { TimeZoneService } from '../../services/time-zone.service';\nimport { Product } from '../../models/product.model';\n\n@Component({\n  selector: 'app-report-page',\n  imports: [\n    CommonModule,\n    MatDialogModule,\n    FormsModule,\n    MatFormFieldModule,\n    MatInputModule,\n    MatDatepickerModule,\n    MatNativeDateModule,\n    MatSelectModule,\n    MatTableModule,\n    MatIconModule,\n    MatButtonModule,\n    NgChartsModule\n  ],\n  templateUrl: './report-page.component.html',\n  styleUrl: './report-page.component.css'\n})\nexport class ReportPageComponent implements OnInit {\n  constructor(\n    private invoiceService: InvoiceService,\n    private timeZoneService: TimeZoneService\n  ) {\n\n  }\n  hideFilters = false;\n  selectedDate: Date | null = null;\n  allInvoices: InvoiceTab[] = [];\n  filteredInvoices: InvoiceTab[] = [];\n  isLoading = false;\n  isMonthlyChartLoading = false;\n  totalRevenue = 0;\n  totalCost = 0;\n  totalProfit = 0;\n  totalBuyer = 0;\n\n  // Biến cho dropdown năm\n  selectedYear: number | null = null;\n  availableYears: number[] = [];\n\n  // Biến cho biểu đồ - Fixed types\n  public barChartOptions: ChartConfiguration['options'] = {\n    responsive: true,\n    plugins: {\n      legend: { display: true },\n      title: { display: true, text: 'Top 20 sản phẩm bán chạy nhất' },\n      tooltip: {\n        callbacks: {\n          label: (context) => {\n            const idx = context.dataIndex;\n            // Lấy số lượng từ mảng topProducts (dựa trên label)\n            const quantity = this.barChartData.labels && this.barChartData.labels[idx]\n              ? (typeof this.barChartData.labels[idx] === 'string' && this.getQuantityByLabel(this.barChartData.labels[idx] as string))\n              : 0;\n            return `${context.dataset.label}: ${context.formattedValue} VNĐ | SL: ${quantity}`;\n          }\n        }\n      },\n      datalabels: {\n        anchor: 'end',\n        align: 'top',\n        formatter: () => '',\n        font: { weight: 'bold', size: 12 },\n        color: '#333'\n      }\n    },\n    scales: {\n      y: {\n        beginAtZero: true,\n        title: {\n          display: true,\n          text: 'Số tiền (VNĐ)'\n        },\n        stacked: true,\n        ticks: {\n          font: {\n            size: 5\n          },\n          autoSkip: false,\n          maxRotation: 0,\n          minRotation: 0\n        }\n      },\n      x: {\n        title: {\n          display: false,\n          text: 'Sản phẩm'\n        },\n        stacked: true\n      }\n    }\n  };\n\n  public barChartType: ChartType = 'bar';\n\n  public barChartData: ChartData<'bar'> = {\n    labels: [],\n    datasets: [\n      {\n        data: [],\n        label: 'Vốn',\n        backgroundColor: '#d6c14c',\n        borderColor: '#d6c14c',\n        borderWidth: 1\n      },\n      {\n        data: [],\n        label: 'Lợi nhuận',\n        backgroundColor: '#00b63e',\n        borderColor: '#00b63e',\n        borderWidth: 1\n      }\n    ]\n  };\n\n  // Biến cho chart 12 tháng\n  public monthlyChartOptions: ChartConfiguration['options'] = {\n    responsive: true,\n    plugins: {\n      legend: { display: true },\n      title: { display: true, text: 'Thống kê theo 12 tháng trong năm' }\n    },\n    scales: {\n      y: {\n        beginAtZero: true,\n        title: {\n          display: true,\n          text: 'Số tiền (VNĐ)'\n        },\n        stacked: true\n      },\n      x: {\n        title: {\n          display: false,\n          text: 'Tháng'\n        },\n        stacked: true\n      }\n    }\n  };\n\n  public monthlyChartType: ChartType = 'bar';\n\n  public monthlyChartData: ChartData<'bar'> = {\n    labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'],\n    datasets: [\n      {\n        data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n        label: 'Vốn',\n        backgroundColor: '#d6c14c',\n        borderColor: '#d6c14c',\n        borderWidth: 1\n      },\n      {\n        data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n        label: 'Lợi nhuận',\n        backgroundColor: '#00b63e',\n        borderColor: '#00b63e',\n        borderWidth: 1\n      }\n    ]\n  };\n\n  selectedMonth: number = new Date().getMonth() + 1;\n  selectedTopYear: number = new Date().getFullYear();\n  months = [\n    { value: 1, label: 'Tháng 1' },\n    { value: 2, label: 'Tháng 2' },\n    { value: 3, label: 'Tháng 3' },\n    { value: 4, label: 'Tháng 4' },\n    { value: 5, label: 'Tháng 5' },\n    { value: 6, label: 'Tháng 6' },\n    { value: 7, label: 'Tháng 7' },\n    { value: 8, label: 'Tháng 8' },\n    { value: 9, label: 'Tháng 9' },\n    { value: 10, label: 'Tháng 10' },\n    { value: 11, label: 'Tháng 11' },\n    { value: 12, label: 'Tháng 12' }\n  ];\n\n  showTopMonth() {\n    this.isLoading = true;\n    // Đảm bảo chart luôn là bar ngang khi filter theo tháng\n    this.barChartType = 'bar';\n    const baseOptions = this.barChartOptions ?? {};\n    this.barChartOptions = {\n      ...baseOptions,\n      indexAxis: 'y',\n      plugins: {\n        ...(baseOptions.plugins ?? {}),\n        title: { display: true, text: 'Top 20 sản phẩm bán chạy nhất' }\n      },\n      scales: {\n        x: {\n          beginAtZero: true,\n          title: { display: true, text: 'Số tiền (VNĐ)' },\n          stacked: false\n        },\n        y: {\n          title: { display: false, text: 'Sản phẩm' },\n          stacked: false\n        }\n      }\n    };\n    this.invoiceService.getTopSellProducts({ year: this.selectedTopYear, month: this.selectedMonth }).subscribe({\n      next: (products?: any[]) => {\n        const safeProducts = Array.isArray(products) ? products : [];\n        const topProducts = safeProducts.sort((a, b) => b.totalProfit - a.totalProfit).slice(0, 20);\n        this._topProducts = topProducts; // Lưu lại để tooltip dùng\n        this.barChartData = {\n          labels: topProducts.map(p => p.productName),\n          datasets: [\n            {\n              data: topProducts.map(p => p.totalProfit),\n              label: 'Lợi nhuận',\n              backgroundColor: '#0070F4',\n              borderColor: '#0070F4',\n              borderWidth: 1\n            }\n          ]\n        };\n        this.isLoading = false;\n      },\n      error: () => {\n        this.updateChartWithSummary([]);\n        this.isLoading = false;\n      }\n    });\n  }\n\n  showTopYear() {\n    this.isLoading = true;\n    // Đảm bảo chart luôn là bar ngang khi filter theo năm\n    this.barChartType = 'bar';\n    const baseOptions = this.barChartOptions ?? {};\n    this.barChartOptions = {\n      ...baseOptions,\n      indexAxis: 'y',\n      plugins: {\n        ...(baseOptions.plugins ?? {}),\n        title: { display: true, text: 'Top 20 sản phẩm bán chạy nhất' }\n      },\n      scales: {\n        x: {\n          beginAtZero: true,\n          title: { display: true, text: 'Số tiền (VNĐ)' },\n          stacked: false\n        },\n        y: {\n          title: { display: false, text: 'Sản phẩm' },\n          stacked: false\n        }\n      }\n    };\n    this.invoiceService.getTopSellProducts({ year: this.selectedTopYear }).subscribe({\n      next: (products?: any[]) => {\n        const safeProducts = Array.isArray(products) ? products : [];\n        const topProducts = safeProducts.sort((a, b) => b.totalProfit - a.totalProfit).slice(0, 20);\n        this._topProducts = topProducts; // Lưu lại để tooltip dùng\n        this.barChartData = {\n          labels: topProducts.map(p => p.productName),\n          datasets: [\n            {\n              data: topProducts.map(p => p.totalProfit),\n              label: 'Lợi nhuận',\n              backgroundColor: '#0070F4',\n              borderColor: '#0070F4',\n              borderWidth: 1\n            }\n          ]\n        };\n        this.isLoading = false;\n      },\n      error: () => {\n        this.updateChartWithSummary([]);\n        this.isLoading = false;\n      }\n    });\n  }\n  ngOnInit() {\n    this.barChartType = 'bar';\n    const baseOptions = this.barChartOptions ?? {};\n    this.barChartOptions = {\n      ...baseOptions,\n      indexAxis: 'y',\n      plugins: {\n        ...(baseOptions.plugins ?? {}),\n        title: { display: true, text: 'Top 20 sản phẩm bán chạy nhất' }\n      },\n      scales: {\n        x: {\n          beginAtZero: true,\n          title: { display: true, text: 'Số tiền (VNĐ)' },\n          stacked: false\n        },\n        y: {\n          title: { display: false, text: 'Sản phẩm' },\n          stacked: false\n        }\n      }\n    };\n    const now = new Date();\n    this.selectedDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);\n    this.fetchInvoicesByDate();\n    this.initializeAvailableYears();\n  }\n\n  private initializeAvailableYears() {\n    const currentYear = new Date().getFullYear();\n    // Tạo danh sách năm từ 2020 đến năm hiện tại\n    this.availableYears = [];\n    for (let year = 2025; year <= currentYear; year++) {\n      this.availableYears.push(year);\n    }\n    // Không set default year\n  }\n\n  onYearChange() {\n    if (this.selectedYear) {\n      this.isMonthlyChartLoading = true;\n      this.updateMonthlyChart();\n    } else {\n      // Reset monthly chart data when no year is selected\n      this.monthlyChartData = {\n        labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'],\n        datasets: [\n          {\n            data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n            label: 'Vốn',\n            backgroundColor: '#d6c14c',\n            borderColor: '#d6c14c',\n            borderWidth: 1\n          },\n          {\n            data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n            label: 'Lợi nhuận',\n            backgroundColor: '#00b63e',\n            borderColor: '#00b63e',\n            borderWidth: 1\n          }\n        ]\n      };\n    }\n  }\n\n  fetchInvoicesByDate() {\n    this.isLoading = true;\n    // Đảm bảo chart luôn là bar ngang khi filter theo ngày\n    this.barChartType = 'bar';\n    const baseOptions = this.barChartOptions ?? {};\n    this.barChartOptions = {\n      ...baseOptions,\n      indexAxis: 'y',\n      plugins: {\n        ...(baseOptions.plugins ?? {}),\n        title: { display: true, text: 'Top 20 sản phẩm bán chạy nhất' }\n      },\n      scales: {\n        x: {\n          beginAtZero: true,\n          title: { display: true, text: 'Số tiền (VNĐ)' },\n          stacked: false\n        },\n        y: {\n          title: { display: false, text: 'Sản phẩm' },\n          stacked: false\n        }\n      }\n    };\n    if (!this.selectedDate) {\n      this.totalRevenue = 0;\n      this.totalCost = 0;\n      this.totalProfit = 0;\n      this.totalBuyer = 0;\n      this.updateChartWithSummary([]);\n      this.isLoading = false;\n      return;\n    }\n    const date = this.timeZoneService.formatDateToVietnamString(this.selectedDate);\n    this.invoiceService.getDailySummary(date).subscribe({\n      next: (summary: any) => {\n        this.totalRevenue = summary.revenue || 0;\n        this.totalCost = summary.cost || 0;\n        this.totalProfit = summary.profit || 0;\n        this.totalBuyer = summary.buyer_quantity || 0;\n      },\n      error: () => {\n        this.totalRevenue = 0;\n        this.totalCost = 0;\n        this.totalProfit = 0;\n        this.totalBuyer = 0;\n      }\n    });\n    this.invoiceService.getTopSellProducts({ date }).subscribe({\n      next: (products?: any[]) => {\n        const safeProducts = Array.isArray(products) ? products : [];\n        const topProducts = safeProducts.sort((a, b) => b.totalProfit - a.totalProfit).slice(0, 20);\n        this._topProducts = topProducts; // Lưu lại để tooltip dùng\n        this.barChartData = {\n          labels: topProducts.map(p => p.productName),\n          datasets: [\n            {\n              data: topProducts.map(p => p.totalProfit),\n              label: 'Lợi nhuận',\n              backgroundColor: '#0070F4',\n              borderColor: '#0070F4',\n              borderWidth: 1\n            }\n          ]\n\n        };\n        this.isLoading = false;\n      },\n      error: () => {\n        this.updateChartWithSummary([]);\n        this.isLoading = false;\n      }\n    });\n  }\n\n  updateChartWithSummary(products: { productName: string, totalRevenue: number, totalCost: number, totalProfit: number, totalQuantity: number }[]) {\n    this.barChartData = {\n      labels: products.map(product => product.productName),\n      datasets: [\n        {\n          data: products.map(product => product.totalCost),\n          label: 'Vốn',\n          backgroundColor: '#d6c14c',\n          borderColor: '#d6c14c',\n          borderWidth: 1\n        },\n        {\n          data: products.map(product => product.totalProfit),\n          label: 'Lợi nhuận',\n          backgroundColor: '#00b63e',\n          borderColor: '#00b63e',\n          borderWidth: 1\n        },\n        {\n          data: products.map(product => product.totalQuantity),\n          label: 'Số lượng',\n          backgroundColor: '#f4b400',\n          borderColor: '#f4b400',\n          borderWidth: 1\n        }\n      ]\n    };\n  }\n\n  calculateSummary() {\n    const invoices = this.filteredInvoices;\n    this.totalRevenue = invoices.reduce((sum, inv) => sum + (inv.totalPrice || 0), 0);\n    this.totalCost = invoices.reduce((sum, inv) => sum + (inv.totalCost || 0), 0);\n    this.totalProfit = this.totalRevenue - this.totalCost;\n  }\n\n  onDateChange(event: any) {\n    if (event.value) {\n      this.selectedDate = new Date(event.value);\n      this.selectedDate.setHours(0, 0, 0, 0);\n    } else {\n      this.selectedDate = null;\n    }\n    if (this.selectedDate) {\n      this.fetchInvoicesByDate();\n    }\n  }\n\n  applyFilters() {\n    if (!this.selectedDate) {\n      this.filteredInvoices = [...this.allInvoices];\n    } else {\n      this.filteredInvoices = this.allInvoices.filter(invoice => {\n        return this.checkDateFilter(invoice);\n      });\n    }\n    this.calculateSummary();\n  }\n\n  clearFilters() {\n    this.selectedDate = null;\n    this.allInvoices = [];\n    this.filteredInvoices = [];\n    this.selectedMonth = 0;\n    this.selectedTopYear = 0;\n\n    this.calculateSummary();\n    this.isLoading = false;\n  }\n\n  private checkDateFilter(invoice: InvoiceTab): boolean {\n    if (!this.selectedDate) return true;\n    if (!invoice.createdDate) return false;\n    try {\n      const invoiceDate = this.timeZoneService.parseApiDate(invoice.createdDate);\n      if (isNaN(invoiceDate.getTime())) return false;\n      const invoiceDateStr = this.timeZoneService.formatDateToVietnamString(invoiceDate);\n      const selectedDateStr = this.timeZoneService.formatDateToVietnamString(this.selectedDate);\n      return invoiceDateStr === selectedDateStr;\n    } catch (error) {\n      console.error('Error parsing date:', error);\n      return false;\n    }\n  }\n\n\n  async updateMonthlyChart() {\n    if (!this.selectedYear) {\n      this.isMonthlyChartLoading = false;\n      return;\n    }\n\n    const selectedYear = this.selectedYear;\n    const monthlyData = { cost: new Array(12).fill(0), profit: new Array(12).fill(0), revenue: new Array(12).fill(0) };\n    const requests = [];\n    for (let month = 1; month <= 12; month++) {\n      requests.push(\n        this.invoiceService.getMonthlySummary(selectedYear, month).toPromise()\n      );\n    }\n    try {\n      const results = await Promise.all(requests);\n      results.forEach((summary: any, idx: number) => {\n        monthlyData.cost[idx] = summary?.cost || 0;\n        monthlyData.profit[idx] = summary?.profit || 0;\n        monthlyData.revenue[idx] = summary?.revenue || 0;\n      });\n      this.monthlyChartData = {\n        labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'],\n        datasets: [\n          {\n            data: monthlyData.cost,\n            label: 'Vốn',\n            backgroundColor: '#d6c14c',\n            borderColor: '#d6c14c',\n            borderWidth: 1\n          },\n          {\n            data: monthlyData.profit,\n            label: 'Lợi nhuận',\n            backgroundColor: '#00b63e',\n            borderColor: '#00b63e',\n            borderWidth: 1\n          }\n        ]\n      };\n    } catch (err) {\n      console.error('Error fetching monthly summaries:', err);\n    } finally {\n      this.isMonthlyChartLoading = false;\n    }\n  }\n\n  onTopMonthOrYearChange() {\n    this.isLoading = true;\n    // Đảm bảo chart luôn là bar ngang cho mọi filter\n    this.barChartType = 'bar';\n    const baseOptions = this.barChartOptions ?? {};\n    this.barChartOptions = {\n      ...baseOptions,\n      indexAxis: 'y',\n      plugins: {\n        ...(baseOptions.plugins ?? {}),\n        title: { display: true, text: 'Top 20 sản phẩm bán chạy nhất' }\n      },\n      scales: {\n        x: {\n          beginAtZero: true,\n          title: { display: true, text: 'Số tiền (VNĐ)' },\n          stacked: false\n        },\n        y: {\n          title: { display: false, text: 'Sản phẩm' },\n          stacked: false\n        }\n      }\n    };\n    // Cập nhật tổng hợp theo filter tháng/năm\n    if (this.selectedMonth) {\n      // Nếu chưa chọn năm, mặc định là năm hiện tại\n      const year = this.selectedTopYear || new Date().getFullYear();\n      // Lấy tổng hợp theo tháng\n      this.invoiceService.getMonthlySummary(year, this.selectedMonth).subscribe({\n        next: (summary: any) => {\n          this.totalRevenue = summary?.revenue || 0;\n          this.totalCost = summary?.cost || 0;\n          this.totalProfit = summary?.profit || 0;\n          this.totalBuyer = summary?.buyer_quantity || 0;\n        },\n        error: () => {\n          this.totalRevenue = 0;\n          this.totalCost = 0;\n          this.totalProfit = 0;\n          this.totalBuyer = 0;\n        }\n      });\n      this.invoiceService.getTopSellProducts({ year, month: this.selectedMonth }).subscribe({\n        next: (products?: any[]) => {\n          const safeProducts = Array.isArray(products) ? products : [];\n          const topProducts = safeProducts.sort((a, b) => b.totalProfit - a.totalProfit).slice(0, 20);\n          this._topProducts = topProducts; // Lưu lại để tooltip dùng\n          this.barChartData = {\n            labels: topProducts.map(p => p.productName),\n            datasets: [\n              {\n                data: topProducts.map(p => p.totalProfit),\n                label: 'Lợi nhuận',\n                backgroundColor: '#0070F4',\n                borderColor: '#0070F4',\n                borderWidth: 1\n              }\n            ]\n          };\n          this.isLoading = false;\n        },\n        error: () => {\n          this.updateChartWithSummary([]);\n          this.isLoading = false;\n        }\n      });\n    } else if (this.selectedTopYear) {\n      // Lấy tổng hợp theo năm\n      this.invoiceService.getYearlySummary(this.selectedTopYear).subscribe({\n        next: (summary: any) => {\n          this.totalRevenue = summary?.revenue || 0;\n          this.totalCost = summary?.cost || 0;\n          this.totalProfit = summary?.profit || 0;\n          this.totalBuyer = summary?.buyer_quantity || 0;\n        },\n        error: () => {\n          this.totalRevenue = 0;\n          this.totalCost = 0;\n          this.totalProfit = 0;\n          this.totalBuyer = 0;\n        }\n      });\n      this.invoiceService.getTopSellProducts({ year: this.selectedTopYear }).subscribe({\n        next: (products?: any[]) => {\n          const safeProducts = Array.isArray(products) ? products : [];\n          const topProducts = safeProducts.sort((a, b) => b.totalProfit - a.totalProfit).slice(0, 20);\n          this._topProducts = topProducts; // Lưu lại để tooltip dùng\n          this.barChartData = {\n            labels: topProducts.map(p => p.productName),\n            datasets: [\n              {\n                data: topProducts.map(p => p.totalProfit),\n                label: 'Lợi nhuận',\n                backgroundColor: '#0070F4',\n                borderColor: '#0070F4',\n                borderWidth: 1\n              }\n            ]\n          };\n          this.isLoading = false;\n        },\n        error: () => {\n          this.updateChartWithSummary([]);\n          this.isLoading = false;\n        }\n      });\n    }\n  }\n\n  private getQuantityByLabel(label: string): number {\n  if (!label || typeof label !== 'string') return 0;\n  const idx = this._topProducts.findIndex(p => p.productName === label);\n  if (idx < 0) return 0;\n  return this._topProducts[idx].totalQuantity ?? 0;\n}\n\n  private _topProducts: any[] = [];\n}","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\models\\cart-item.model.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\models\\category.model.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\models\\customer.model.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":15,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[352,355],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[352,355],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[529,532],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[529,532],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":25,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[602,605],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[602,605],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export interface Customer {\r\n    Code: string;\r\n    CompareCode: string;\r\n    CompareName: string;\r\n    ContactNumber: string;\r\n    CreatedBy: number;\r\n    CreatedDate: Date;\r\n    CreatedName: string;\r\n    CustomerType: string;\r\n    Debt: number;\r\n    GenderName: string;\r\n    Groups: string;\r\n    Id: number;\r\n    InvoiceCount: number;\r\n    Invoices: any[];\r\n    IsActive: boolean;\r\n    LastTradingDate: Date;\r\n    ModifiedDate: Date;\r\n    MustUpdateDebt: boolean;\r\n    MustUpdatePoint: boolean;\r\n    Name: string;\r\n    Orders: any[];\r\n    Organization: string;\r\n    RetailerId: number;\r\n    Returns: any[];\r\n    RewardPoint: number;\r\n    TotalInvoiced: number;\r\n    TotalPoint: number;\r\n    TotalReturn: number;\r\n    TotalRevenue: number;\r\n    Uuid: string;\r\n    isDeleted: boolean;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\models\\invoice.model.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\models\\product.model.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":21,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[457,460],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[457,460],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export interface Product {\r\n  Id: number;\r\n  Code: string;\r\n  Name: string;\r\n  FullName: string;\r\n  CategoryId: number;\r\n  isActive: boolean;\r\n  isDeleted: boolean;\r\n  Cost: number;\r\n  BasePrice: number;\r\n  OnHand: number;\r\n  Unit: string;\r\n  MasterUnitId: number;\r\n  MasterProductId: number;\r\n  ConversionValue: number;\r\n  Description: string;\r\n  IsRewardPoint: boolean;\r\n  ModifiedDate: Date;\r\n  Image: string;\r\n  CreatedDate: Date;\r\n  ProductAttributes: any[];\r\n  NormalizedName: string;\r\n  NormalizedCode: string;\r\n  OrderTemplate: string\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\services\\customer.service.ts","messages":[{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":20,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":20,"endColumn":29},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":21,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":21,"endColumn":47},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":22,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":22,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":23,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":23,"endColumn":45},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":150,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":150,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5137,5140],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5137,5140],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":154,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":154,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5301,5304],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5301,5304],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":154,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":154,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5315,5318],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5315,5318],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { environment } from '../../environments/environment';\r\nimport { Customer } from '../models/customer.model';\r\nimport { catchError, of, firstValueFrom } from 'rxjs';\r\nimport { IndexedDBService } from './indexed-db.service';\r\nimport { Observable } from 'rxjs';\r\nimport { KiotvietService } from '../services/kiotviet.service';\r\nimport { FirebaseService } from '../services/firebase.service';\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class CustomerService {\r\n  private dbName = 'Client';\r\n  private dbVersion = 1;\r\n  private storeName = 'customers';\r\n  get_all_customers_from_kiotviet = \"/api/kiotviet/customers\";\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private indexedDBService: IndexedDBService,\r\n    private kiotvietService: KiotvietService,\r\n    private firebaseService: FirebaseService\r\n  ) {\r\n  }\r\n\r\n  async initDB(): Promise<void> {\r\n    // Khởi tạo database với upgrade function\r\n    await this.indexedDBService.getDB(this.dbName, this.dbVersion, (db) => {\r\n      if (!db.objectStoreNames.contains(this.storeName)) {\r\n        db.createObjectStore(this.storeName, { keyPath: 'Id' });\r\n      }\r\n    });\r\n  }\r\n  async searchCustomers(query: string): Promise<Customer[]> {\r\n    const allCustomers = await this.getAllCustomersFromIndexedDB();\r\n\r\n    if (!query || query.trim() === '') {\r\n      return allCustomers;\r\n    }\r\n\r\n    const searchTerm = query.toLowerCase().trim();\r\n\r\n    return allCustomers.filter(customer =>\r\n      customer.Name?.toLowerCase().includes(searchTerm) ||\r\n      customer.ContactNumber?.toLowerCase().includes(searchTerm)\r\n      //|| customer.Email?.toLowerCase().includes(searchTerm) ||\r\n      // customer.Address?.toLowerCase().includes(searchTerm)\r\n    );\r\n  }\r\n  async loadCustomersFromKiotvietToIndexedDB(): Promise<void> {\r\n    // Lấy dữ liệu từ API\r\n    const customers = (await this.http.get<Customer[]>(`${environment.domainUrl}${this.get_all_customers_from_kiotviet}`)\r\n      .pipe(\r\n        catchError((err) => {\r\n          console.error('❌ Lỗi khi tải tất cả khách hàng:', err);\r\n          return of([]);\r\n        })\r\n      ).toPromise()) ?? [];\r\n\r\n    if (customers.length === 0) return;\r\n\r\n    // Lấy toàn bộ khách hàng đang có trong IndexedDB\r\n    const existingCustomers: Customer[] = await this.indexedDBService.getAll(\r\n      this.dbName,\r\n      this.dbVersion,\r\n      this.storeName\r\n    );\r\n\r\n    const existingMap = new Map(existingCustomers.map(c => [c.Id, c]));\r\n\r\n    // Chuẩn bị danh sách khách hàng cần cập nhật\r\n    const customersToUpdate: Customer[] = [];\r\n\r\n    for (const customer of customers) {\r\n      const existing = existingMap.get(customer.Id);\r\n\r\n      // So sánh nội dung\r\n      if (!existing || JSON.stringify(existing) !== JSON.stringify(customer)) {\r\n        if (!customer.Id) {\r\n          console.warn('Customer missing Id:', customer);\r\n          continue;\r\n        }\r\n        customersToUpdate.push(customer);\r\n      }\r\n    }\r\n\r\n    // Cập nhật nhiều khách hàng cùng lúc nếu có thay đổi\r\n    if (customersToUpdate.length > 0) {\r\n      await this.indexedDBService.putMany(\r\n        this.dbName,\r\n        this.dbVersion,\r\n        this.storeName,\r\n        customersToUpdate\r\n      );\r\n      console.log(`✅ Đã cập nhật ${customersToUpdate.length} khách hàng`);\r\n    }\r\n  }\r\n\r\n  async syncCustomersFromFirebaseToIndexedDB(): Promise<void> {\r\n    const customers = await firstValueFrom(this.getAllCustomersFromFirebase()) ?? [];\r\n\r\n    if (customers.length === 0) return;\r\n\r\n    const existingCustomers: Customer[] = await this.indexedDBService.getAll(\r\n      this.dbName,\r\n      this.dbVersion,\r\n      this.storeName\r\n    );\r\n\r\n    const existingMap = new Map(existingCustomers.map(c => [c.Id, c]));\r\n    const customersToUpdate: Customer[] = [];\r\n\r\n    for (const customer of customers) {\r\n      const existing = existingMap.get(customer.Id);\r\n      if (!existing || JSON.stringify(existing) !== JSON.stringify(customer)) {\r\n        if (!customer.Id) {\r\n          console.warn('Customer missing Id:', customer);\r\n          continue;\r\n        }\r\n        customersToUpdate.push(customer);\r\n      }\r\n    }\r\n\r\n    if (customersToUpdate.length > 0) {\r\n      await this.indexedDBService.putMany(\r\n        this.dbName,\r\n        this.dbVersion,\r\n        this.storeName,\r\n        customersToUpdate\r\n      );\r\n      console.log(`✅ Đã cập nhật ${customersToUpdate.length} khách hàng từ Firebase`);\r\n    }\r\n  }\r\n\r\n  async syncAllCustomersFromIndexedDBToFirebase(): Promise<void> {\r\n    try {\r\n      const allCustomers = await this.getAllCustomersFromIndexedDB();\r\n      if (allCustomers.length > 0) {\r\n        await firstValueFrom(this.saveAllCustomersToFirebase(allCustomers));\r\n        console.log(`✅ Đã đồng bộ ${allCustomers.length} khách hàng lên Firebase.`);\r\n      } else {\r\n        console.log('Không có khách hàng nào trong IndexedDB để đồng bộ.');\r\n      }\r\n    } catch (error) {\r\n      console.error('❌ Lỗi khi đồng bộ khách hàng từ IndexedDB lên Firebase:', error);\r\n    }\r\n  }\r\n\r\n  saveAllCustomersToFirebase(customers: Customer[]): Observable<any> {\r\n    return this.http.post(`${environment.domainUrl}${this.firebaseService.post_add_customers}`, customers);\r\n  }\r\n\r\n  async addCustomerTofireBase(customer: any): Promise<any> {\r\n    await this.http.post(`${environment.domainUrl}${this.firebaseService.post_add_customer}`, customer);\r\n  }\r\n\r\n  getAllCustomersFromKiotviet(): Observable<Customer[]> {\r\n    return this.http.get<Customer[]>(`${environment.domainUrl}${this.kiotvietService.kiotviet_customers_api}`).pipe(\r\n      catchError((err) => {\r\n        console.error('❌ Lỗi khi tải tất cả khách hàng từ Kiotviet:', err);\r\n        return of([]);\r\n      })\r\n    );\r\n  }\r\n\r\n  getAllCustomersFromFirebase(): Observable<Customer[]> {\r\n    return this.http.get<Customer[]>(`${environment.domainUrl}${this.firebaseService.get_all_customers}`).pipe(\r\n      catchError((err) => {\r\n        console.error('❌ Lỗi khi tải tất cả khách hàng từ Firebase:', err);\r\n        return of([]);\r\n      })\r\n    );\r\n  }\r\n  // Thêm các method tiện ích CRUD\r\n  async getCustomerByIdFromIndexedDB(id: number): Promise<Customer | undefined> {\r\n    return await this.indexedDBService.getByKey(\r\n      this.dbName,\r\n      this.dbVersion,\r\n      this.storeName,\r\n      id\r\n    );\r\n  }\r\n\r\n  async getAllCustomersFromIndexedDB(): Promise<Customer[]> {\r\n    return await this.indexedDBService.getAll(\r\n      this.dbName,\r\n      this.dbVersion,\r\n      this.storeName\r\n    );\r\n  }\r\n\r\n  async addCustomerFromIndexedDB(customer: Customer): Promise<void> {\r\n    await this.indexedDBService.put(\r\n      this.dbName,\r\n      this.dbVersion,\r\n      this.storeName,\r\n      customer\r\n    );\r\n  }\r\n\r\n  async updateCustomerFromIndexedDB(customer: Customer): Promise<void> {\r\n    await this.indexedDBService.put(\r\n      this.dbName,\r\n      this.dbVersion,\r\n      this.storeName,\r\n      customer\r\n    );\r\n  }\r\n\r\n  async deleteCustomerFromIndexedDB(id: number): Promise<void> {\r\n    await this.indexedDBService.delete(\r\n      this.dbName,\r\n      this.dbVersion,\r\n      this.storeName,\r\n      id\r\n    );\r\n  }\r\n\r\n  async clearAllCustomersFromIndexedDB(): Promise<void> {\r\n    await this.indexedDBService.clear(\r\n      this.dbName,\r\n      this.dbVersion,\r\n      this.storeName\r\n    );\r\n  }\r\n\r\n  // Tìm kiếm khách hàng\r\n\r\n  /**\r\n   * Cập nhật công nợ (Debt) của khách hàng vào cả IndexedDB và Firestore\r\n   */\r\n  async updateCustomerDebt(customerId: number, newDebt: number): Promise<void> {\r\n    // Cập nhật trong IndexedDB\r\n    const customer = await this.getCustomerByIdFromIndexedDB(customerId);\r\n    if (customer) {\r\n      customer.Debt = newDebt;\r\n      await this.updateCustomerFromIndexedDB(customer);\r\n      console.log(`✅ Đã cập nhật Debt cho khách hàng ${customerId} trong IndexedDB: ${newDebt}`);\r\n      // Cập nhật lên Firestore nếu có hàm\r\n      try {\r\n        await this.addCustomerTofireBase(customer); // Hàm này sẽ upsert customer lên Firestore\r\n        console.log(`✅ Đã cập nhật Debt cho khách hàng ${customerId} lên Firestore: ${newDebt}`);\r\n      } catch (err) {\r\n        console.error('❌ Lỗi khi cập nhật Debt lên Firestore:', err);\r\n      }\r\n    } else {\r\n      console.warn(`❌ Không tìm thấy khách hàng ${customerId} trong IndexedDB để cập nhật Debt.`);\r\n    }\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\services\\firebase.service.ts","messages":[{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty constructor.","line":9,"column":17,"nodeType":"FunctionExpression","messageId":"unexpected","endLine":9,"endColumn":20,"suggestions":[{"messageId":"suggestComment","data":{"name":"constructor"},"fix":{"range":[228,229],"text":" /* empty */ "},"desc":"Add comment inside empty constructor."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@angular/core';\r\n// import { Firestore, collection, getCountFromServer } from '@angular/fire/firestore';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class FirebaseService {\r\n\r\n  constructor() { }\r\n\r\n  get_all_invoices = \"/api/firebase/all_invoices\";\r\n  get_invoice_by_id = \"/api/firebase/invoices/\";//+invoiceId\r\n  get_invoice_by_date = \"/api/firebase/invoices/date\";\r\n  post_add_invoice = \"/api/firebase/add_invoice\";\r\n  put_update_invoice = \"/api/firebase/invoices/\";//+invoiceId\r\n  delete_del_invoice = \"/api/firebase/invoices/\";//+invoiceId\r\n  get_invoices_by_customer = \"/api/firebase/invoices/customer/\";//+ <customer_name>\r\n  post_all_products_indexedDB_firebase = \"/api/sync/kiotviet/firebase/products\";\r\n\r\n  post_add_customer = \"/api/firebase/add_customer\";\r\n  post_add_customers = \"/api/firebase/add_customers\";\r\n  get_all_customers = \"/api/firebase/get/customers\";\r\n\r\n  get_revenue_by_daily = \"/api/firebase/daily_summary\";\r\n  get_revenue_by_monthly = \"/api/firebase/monthly_summary\";\r\n  get_revenue_by_yearly = \"/api/firebase/yearly_summary\";\r\n  get_top_sell_products = \"/api/firebase/top_products\";\r\n\r\n  get_all_products_from_firebase = \"/api/firebase/get/products\";\r\n  get_product_by_id_from_firebase = \"/api/firebase/get/products/\";//+<product_id>\r\n  add_product_to_firebase = \"/api/firebase/add/product\";\r\n  update_product_by_id = \"/api/firebase/update/products/\";//+<product_id>\r\n  delete_poduct_by_id_from_firebase = \"/api/firebase/products/del/\";//+<product_id>\r\n  update_multi_products_by_id_to_firebase = \"/api/firebase/update/products/batch\";\r\n  delete_products_batch_from_firebase = \"/api/firebase/products/delete-batch\";\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\services\\group.service.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Product' is defined but never used.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":17},{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty constructor.","line":9,"column":17,"nodeType":"FunctionExpression","messageId":"unexpected","endLine":9,"endColumn":20,"suggestions":[{"messageId":"suggestComment","data":{"name":"constructor"},"fix":{"range":[188,189],"text":" /* empty */ "},"desc":"Add comment inside empty constructor."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[210,213],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[210,213],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[234,237],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[234,237],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[286,289],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[286,289],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":13,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[333,336],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[333,336],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":26,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[879,882],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[879,882],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1492,1495],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1492,1495],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@angular/core';\r\nimport { Product } from '../models/product.model';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class GroupService {\r\n\r\n  constructor() { }\r\n  group(products: any[],): Record<number, any[]> {\r\n    const groupedProducts: Record<number, any[]> = {};\r\n\r\n    products.forEach((product: any) => {\r\n      // Check if this is a master product (parent)\r\n      if (product.MasterProductId !== null && product.MasterUnitId === null) {\r\n        // Convert Id to number\r\n        const masterId = Number(product.Id);\r\n        // Initialize array for this master product if not exists\r\n        if (!groupedProducts[masterId]) {\r\n          groupedProducts[masterId] = [];\r\n        }\r\n        // Add the master product itself as the first item\r\n        groupedProducts[masterId].push(product);\r\n      }\r\n    });\r\n    products.forEach((product: any) => {\r\n      // Check if this is a master product (parent)\r\n      if (product.MasterProductId === null && product.MasterUnitId === null) {\r\n        // Convert Id to number\r\n        const masterId = Number(product.Id);\r\n        // Initialize array for this master product if not exists\r\n        if (!groupedProducts[masterId]) {\r\n          groupedProducts[masterId] = [];\r\n        }\r\n        // Add the master product itself as the first item\r\n        groupedProducts[masterId].push(product);\r\n      }\r\n    });\r\n\r\n    // Now add child products to their respective master groups\r\n    products.forEach((product: any) => {\r\n      // Check if this is a child product\r\n      if (product.MasterProductId !== null && product.MasterUnitId !== null) {\r\n        // Convert MasterProductId to number\r\n        const masterId = Number(product.MasterUnitId);\r\n        // If the master group exists, add this child to it\r\n        if (groupedProducts[masterId]) {\r\n          groupedProducts[masterId].push(product);\r\n        }\r\n      }\r\n    });\r\n    return groupedProducts;\r\n  }\r\n\r\n\r\n  // transformApiData(data: Product[]): any[] {\r\n  //   return data.map(item => ({\r\n  //     Id: item.Id || null,\r\n  //     Code: item.Code || null,\r\n  //     Name: item.Name || null,\r\n  //     FullName: item.FullName || null,\r\n  //     CategoryId: item.CategoryId || null,\r\n  //     isActive: item.isActive || null,\r\n  //     isDeleted: item.isDeleted || null,\r\n  //     Cost: item.Cost || null,\r\n  //     BasePrice: item.BasePrice || null,\r\n  //     OnHand: item.OnHand || null,\r\n  //     Unit: item.Unit || null,\r\n  //     MasterUnitId: item.MasterUnitId || null,\r\n  //     MasterProductId: item.MasterProductId || null,\r\n  //     ConversionValue: item.ConversionValue || null,\r\n  //     Description: item.Description || null,\r\n  //     IsRewardPoint: item.IsRewardPoint || null,\r\n  //     ModifiedDate: item.ModifiedDate || null,\r\n  //     Image: item.Image || null,\r\n  //     CreatedDate: item.CreatedDate || null,\r\n  //     ProductAttributes: item.ProductAttributes || [],\r\n  //     NormalizedName: item.NormalizedName || null,\r\n  //     NormalizedCode: item.NormalizedCode || null,\r\n  //   }));\r\n  // }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\services\\indexed-db.service.ts","messages":[{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty constructor.","line":12,"column":17,"nodeType":"FunctionExpression","messageId":"unexpected","endLine":12,"endColumn":19,"suggestions":[{"messageId":"suggestComment","data":{"name":"constructor"},"fix":{"range":[372,372],"text":" /* empty */ "},"desc":"Add comment inside empty constructor."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":77,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2746,2749],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2746,2749],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":82,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2872,2875],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2872,2875],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":96,"column":77,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":80,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3282,3285],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3282,3285],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":108,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":108,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3775,3778],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3775,3778],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":108,"column":89,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":108,"endColumn":92,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3789,3792],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3789,3792],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":120,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4254,4257],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4254,4257],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":131,"column":77,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":131,"endColumn":80,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4753,4756],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4753,4756],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":144,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":144,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5264,5267],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5264,5267],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@angular/core';\r\nimport { openDB, IDBPDatabase } from 'idb';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class IndexedDBService {\r\n  private dbs: Record<string, Promise<IDBPDatabase>> = {};\r\n  private dbConnections: Record<string, IDBPDatabase | null> = {};\r\n  private connectionStatus: Record<string, boolean> = {};\r\n\r\n  constructor() {}\r\n\r\n  async getDB(dbName: string, version: number, upgradeFn?: (db: IDBPDatabase) => void): Promise<IDBPDatabase> {\r\n    // Kiểm tra xem connection hiện tại có còn hợp lệ không\r\n    if (this.dbConnections[dbName] && this.connectionStatus[dbName]) {\r\n      return this.dbConnections[dbName]!;\r\n    }\r\n\r\n    // Nếu chưa có hoặc connection đã đóng, tạo mới\r\n    if (!this.dbs[dbName] || !this.connectionStatus[dbName]) {\r\n      console.log(`🔄 Tạo connection mới cho database: ${dbName} v${version}`);\r\n\r\n      this.dbs[dbName] = openDB(dbName, version, {\r\n        upgrade: upgradeFn,\r\n        blocked: (event) => {\r\n          console.warn(`⚠️ Database ${dbName} blocked (version conflict). Event:`, event);\r\n        },\r\n        blocking: (event) => {\r\n          console.warn(`⚠️ Database ${dbName} received blocking event, closing old connection. Event:`, event);\r\n          // attempt graceful close\r\n          try {\r\n            this.closeDB(dbName);\r\n          } catch (err) {\r\n            console.error(`❌ Error while closing DB ${dbName} during blocking:`, err);\r\n          }\r\n        }\r\n      });\r\n\r\n      // Lưu connection (await to ensure we have a real IDBDatabase instance)\r\n      try {\r\n        this.dbConnections[dbName] = await this.dbs[dbName];\r\n        this.connectionStatus[dbName] = true;\r\n        console.log(`✅ Connection opened for ${dbName} v${this.dbConnections[dbName]?.version}`);\r\n      } catch (err) {\r\n        console.error(`❌ Failed to open DB ${dbName}:`, err);\r\n        // ensure state is consistent\r\n        this.dbConnections[dbName] = null;\r\n        this.connectionStatus[dbName] = false;\r\n        delete this.dbs[dbName];\r\n        throw err;\r\n      }\r\n    }\r\n\r\n    // Return the resolved DB instance (awaited promise resolves to IDBPDatabase)\r\n    const resolved = await this.dbs[dbName];\r\n    return resolved;\r\n  }\r\n\r\n  // Đóng connection\r\n  async closeDB(dbName: string): Promise<void> {\r\n    if (this.dbConnections[dbName]) {\r\n      this.dbConnections[dbName]!.close();\r\n      console.log(`🔌 Đã đóng connection cho database: ${dbName}`);\r\n    }\r\n    this.dbConnections[dbName] = null;\r\n    this.connectionStatus[dbName] = false;\r\n    delete this.dbs[dbName];\r\n  }\r\n\r\n  // Retry mechanism\r\n  private async retryOperation<T>(\r\n    operation: () => Promise<T>, \r\n    maxRetries = 3, \r\n    delay = 100\r\n  ): Promise<T> {\r\n    let lastError: any;\r\n    \r\n    for (let i = 0; i < maxRetries; i++) {\r\n      try {\r\n        return await operation();\r\n      } catch (error: any) {\r\n        lastError = error;\r\n        console.warn(`⚠️ Lần thử ${i + 1}/${maxRetries} thất bại:`, error.message);\r\n        \r\n        if (i < maxRetries - 1) {\r\n          await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));\r\n        }\r\n      }\r\n    }\r\n    \r\n    throw lastError;\r\n  }\r\n\r\n  // Đọc tất cả với retry\r\n  async getAll(dbName: string, version: number, storeName: string): Promise<any[]> {\r\n    return this.retryOperation(async () => {\r\n      const db = await this.getDB(dbName, version);\r\n      console.log(`DB GETALL -> db=${dbName} v=${db.version} stores=${Array.from(db.objectStoreNames).join(',')}`);\r\n      const tx = db.transaction(storeName, 'readonly');\r\n      const result = await tx.store.getAll();\r\n      await tx.done;\r\n      return result;\r\n    });\r\n  }\r\n\r\n  // Đọc theo key với retry\r\n  async getByKey(dbName: string, version: number, storeName: string, key: any): Promise<any> {\r\n    return this.retryOperation(async () => {\r\n      const db = await this.getDB(dbName, version);\r\n      console.log(`DB GETBYKEY -> db=${dbName} v=${db.version} store=${storeName} key=${key}`);\r\n      const tx = db.transaction(storeName, 'readonly');\r\n      const result = await tx.store.get(key);\r\n      await tx.done;\r\n      return result;\r\n    });\r\n  }\r\n\r\n  // Ghi (put) với retry\r\n  async put(dbName: string, version: number, storeName: string, value: any): Promise<void> {\r\n    return this.retryOperation(async () => {\r\n      const db = await this.getDB(dbName, version);\r\n      console.log(`DB PUT -> db=${dbName} v=${db.version} store=${storeName} id=${(value && value.Id) || (value && value.id) || '<unknown>'}`);\r\n      const tx = db.transaction(storeName, 'readwrite');\r\n      await tx.store.put(value);\r\n      await tx.done;\r\n    });\r\n  }\r\n\r\n  // Ghi nhiều với retry\r\n  async putMany(dbName: string, version: number, storeName: string, values: any[]): Promise<void> {\r\n    return this.retryOperation(async () => {\r\n      const db = await this.getDB(dbName, version);\r\n      console.log(`DB PUTMANY -> db=${dbName} v=${db.version} store=${storeName} count=${values.length}`);\r\n      const tx = db.transaction(storeName, 'readwrite');\r\n      for (const value of values) {\r\n        await tx.store.put(value);\r\n      }\r\n      await tx.done;\r\n    });\r\n  }\r\n\r\n  // Xóa theo key với retry\r\n  async delete(dbName: string, version: number, storeName: string, key: any): Promise<void> {\r\n    return this.retryOperation(async () => {\r\n      const db = await this.getDB(dbName, version);\r\n      console.log(`DB DELETE -> db=${dbName} v=${db.version} store=${storeName} key=${key}`);\r\n      const tx = db.transaction(storeName, 'readwrite');\r\n      await tx.store.delete(key);\r\n      await tx.done;\r\n    });\r\n  }\r\n\r\n  // Xóa tất cả với retry\r\n  async clear(dbName: string, version: number, storeName: string): Promise<void> {\r\n    return this.retryOperation(async () => {\r\n      const db = await this.getDB(dbName, version);\r\n      console.log(`DB CLEAR -> db=${dbName} v=${db.version} store=${storeName}`);\r\n      const tx = db.transaction(storeName, 'readwrite');\r\n      await tx.store.clear();\r\n      await tx.done;\r\n    });\r\n  }\r\n\r\n  // Kiểm tra trạng thái connection\r\n  isConnectionOpen(dbName: string): boolean {\r\n    return this.connectionStatus[dbName] || false;\r\n  }\r\n\r\n  // Lấy thông tin connection\r\n  getConnectionInfo(dbName: string): { isOpen: boolean; version?: number } {\r\n    const connection = this.dbConnections[dbName];\r\n    return {\r\n      isOpen: this.connectionStatus[dbName] || false,\r\n      version: connection?.version\r\n    };\r\n  }\r\n\r\n  // Kiểm tra xem object store có tồn tại không\r\n  async checkObjectStoreExists(dbName: string, version: number, storeName: string): Promise<boolean> {\r\n    try {\r\n      const db = await this.getDB(dbName, version);\r\n      return db.objectStoreNames.contains(storeName);\r\n    } catch (error) {\r\n      console.error(`❌ Lỗi khi kiểm tra object store '${storeName}':`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // Lấy danh sách tất cả object stores trong database\r\n  async getObjectStoreNames(dbName: string, version: number): Promise<string[]> {\r\n    try {\r\n      const db = await this.getDB(dbName, version);\r\n      return Array.from(db.objectStoreNames);\r\n    } catch (error) {\r\n      console.error(`❌ Lỗi khi lấy danh sách object stores cho '${dbName}':`, error);\r\n      return [];\r\n    }\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\services\\invoice.service.ts","messages":[{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":44,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":44,"endColumn":29},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":45,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":45,"endColumn":47},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":46,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":46,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":47,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":47,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":48,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":48,"endColumn":43},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":49,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":49,"endColumn":39},{"ruleId":"@angular-eslint/contextual-lifecycle","severity":2,"message":"Angular will not invoke the `ngOnInit` lifecycle method within `@Injectable()` classes","line":54,"column":3,"nodeType":"Identifier","messageId":"contextualLifecycle","endLine":54,"endColumn":11},{"ruleId":"@angular-eslint/no-empty-lifecycle-method","severity":2,"message":"Lifecycle methods should not be empty","line":54,"column":3,"nodeType":"MethodDefinition","messageId":"noEmptyLifecycleMethod","endLine":55,"endColumn":4,"suggestions":[{"messageId":"suggestRemoveLifecycleMethod","fix":{"range":[19,2090],"text":" } from '@angular/core';\nimport { HttpClient } from '@angular/common/http';\nimport { environment } from '../../environments/environment';\nimport { catchError, firstValueFrom, Observable, of, Subject } from 'rxjs';\nimport { InvoiceTab } from '../models/invoice.model';\nimport { IndexedDBService } from './indexed-db.service';\nimport { FirebaseService } from '../services/firebase.service';\nimport { TimeZoneService } from '../services/time-zone.service';\nimport { io, Socket } from 'socket.io-client';\nimport { ProductService } from '../services/product.service'\nimport { GroupService } from '../services/group.service';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class InvoiceService  {\n  private dbName = 'Invoices';\n  private dbVersion = 1;\n  private storeName = 'invoice';\n\n  private socket: Socket | null = null;\n  private reconnectAttempts = 0;\n  private maxReconnectAttempts = 5;\n  private reconnectDelay = 1000; // 1 second\n  private socketInitialized = false;\n\n  // Real-time event subjects\n  private invoiceCreatedSubject = new Subject<InvoiceTab>();\n  private invoiceUpdatedSubject = new Subject<InvoiceTab>();\n  private invoiceDeletedSubject = new Subject<string>();\n  private syncCompletedSubject = new Subject<void>();\n\n  // Public observables for components to subscribe\n  public invoiceCreated$ = this.invoiceCreatedSubject.asObservable();\n  public invoiceUpdated$ = this.invoiceUpdatedSubject.asObservable();\n  public invoiceDeleted$ = this.invoiceDeletedSubject.asObservable();\n  public syncCompleted$ = this.syncCompletedSubject.asObservable();\n\n  // Sync tracking\n  private lastSyncTimestamp: Date | null = null;\n  private syncInProgress = false;\n\n  constructor(\n    private http: HttpClient,\n    private indexedDBService: IndexedDBService,\n    private timeZoneService: TimeZoneService,\n    private firebaseService: FirebaseService,\n    private productService: ProductService,\n    private groupService: GroupService,\n  ) {\n\n    // Remove immediate WebSocket initialization - will be initialized lazily\n  }\n  "},"desc":"Remove lifecycle method"}]},{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty method 'ngOnInit'.","line":54,"column":14,"nodeType":"FunctionExpression","messageId":"unexpected","endLine":55,"endColumn":4,"suggestions":[{"messageId":"suggestComment","data":{"name":"method 'ngOnInit'"},"fix":{"range":[2086,2089],"text":" /* empty */ "},"desc":"Add comment inside empty method 'ngOnInit'."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":172,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":172,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6029,6032],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6029,6032],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":241,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":241,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8366,8369],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8366,8369],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":241,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":241,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8383,8386],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8383,8386],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":246,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":246,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8619,8622],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8619,8622],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":246,"column":77,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":246,"endColumn":80,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8636,8639],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8636,8639],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":251,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":251,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8900,8903],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8900,8903],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":256,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":256,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9112,9115],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9112,9115],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":260,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":260,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9327,9330],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9327,9330],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":265,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":265,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9539,9542],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9539,9542],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":274,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":274,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9801,9804],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9801,9804],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":387,"column":77,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":387,"endColumn":80,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12841,12844],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12841,12844],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":414,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":414,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13598,13601],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13598,13601],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":420,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":420,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13801,13804],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13801,13804],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":426,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":426,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14049,14052],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14049,14052],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":432,"column":92,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":432,"endColumn":95,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14300,14303],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14300,14303],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":433,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":433,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14329,14332],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14329,14332],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":442,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":442,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14755,14758],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14755,14758],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":506,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":506,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16566,16569],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16566,16569],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":516,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":516,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17003,17006],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17003,17006],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":526,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":526,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17402,17405],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17402,17405],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":536,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":536,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17791,17794],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17791,17794],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":561,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":561,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18764,18767],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18764,18767],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'dbName' is assigned a value but never used.","line":599,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":599,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'dbVersion' is assigned a value but never used.","line":600,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":600,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'storeName' is assigned a value but never used.","line":601,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":601,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'data' is defined but never used.","line":654,"column":35,"nodeType":null,"messageId":"unusedVar","endLine":654,"endColumn":39},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":654,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":654,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22770,22773],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22770,22773],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":668,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":668,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[23304,23307],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[23304,23307],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":37,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable, OnInit } from '@angular/core';\nimport { HttpClient } from '@angular/common/http';\nimport { environment } from '../../environments/environment';\nimport { catchError, firstValueFrom, Observable, of, Subject } from 'rxjs';\nimport { InvoiceTab } from '../models/invoice.model';\nimport { IndexedDBService } from './indexed-db.service';\nimport { FirebaseService } from '../services/firebase.service';\nimport { TimeZoneService } from '../services/time-zone.service';\nimport { io, Socket } from 'socket.io-client';\nimport { ProductService } from '../services/product.service'\nimport { GroupService } from '../services/group.service';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class InvoiceService implements OnInit {\n  private dbName = 'Invoices';\n  private dbVersion = 1;\n  private storeName = 'invoice';\n\n  private socket: Socket | null = null;\n  private reconnectAttempts = 0;\n  private maxReconnectAttempts = 5;\n  private reconnectDelay = 1000; // 1 second\n  private socketInitialized = false;\n\n  // Real-time event subjects\n  private invoiceCreatedSubject = new Subject<InvoiceTab>();\n  private invoiceUpdatedSubject = new Subject<InvoiceTab>();\n  private invoiceDeletedSubject = new Subject<string>();\n  private syncCompletedSubject = new Subject<void>();\n\n  // Public observables for components to subscribe\n  public invoiceCreated$ = this.invoiceCreatedSubject.asObservable();\n  public invoiceUpdated$ = this.invoiceUpdatedSubject.asObservable();\n  public invoiceDeleted$ = this.invoiceDeletedSubject.asObservable();\n  public syncCompleted$ = this.syncCompletedSubject.asObservable();\n\n  // Sync tracking\n  private lastSyncTimestamp: Date | null = null;\n  private syncInProgress = false;\n\n  constructor(\n    private http: HttpClient,\n    private indexedDBService: IndexedDBService,\n    private timeZoneService: TimeZoneService,\n    private firebaseService: FirebaseService,\n    private productService: ProductService,\n    private groupService: GroupService,\n  ) {\n\n    // Remove immediate WebSocket initialization - will be initialized lazily\n  }\n  ngOnInit() {\n  }\n  async initDB(): Promise<void> {\n    try {\n      await this.indexedDBService.getDB(this.dbName, this.dbVersion, (db) => {\n        console.log('Upgrade callback running for DB:', this.dbName, 'version:', this.dbVersion);\n\n        db.createObjectStore(this.storeName, { keyPath: 'id' });\n        console.log('Created object store:', this.storeName);\n\n        db.createObjectStore('Offline', { keyPath: 'id' });\n        console.log('Created object store: Offline');\n\n        db.createObjectStore('SyncMetadata', { keyPath: 'key' });\n        console.log('Created object store: SyncMetadata');\n\n      });\n      console.log('initDB completed for', this.dbName);\n    } catch (error) {\n      console.error('❌ Error initializing IndexedDB:', error);\n    }\n  }\n\n  // Get last sync timestamp from IndexedDB\n  private async getLastSyncTimestamp(): Promise<Date | null> {\n    try {\n      const metadata = await this.indexedDBService.getByKey(\n        this.dbName,\n        this.dbVersion,\n        'SyncMetadata',\n        'lastSync'\n      );\n      return metadata ? new Date(metadata.timestamp) : null;\n    } catch (error) {\n      console.error('❌ Error getting last sync timestamp:', error);\n      return null;\n    }\n  }\n\n  // Save last sync timestamp to IndexedDB\n  private async saveLastSyncTimestamp(): Promise<void> {\n    try {\n      await this.indexedDBService.put(\n        this.dbName,\n        this.dbVersion,\n        'SyncMetadata',\n        {\n          key: 'lastSync',\n          timestamp: new Date().toISOString()\n        }\n      );\n    } catch (error) {\n      console.error('❌ Error saving last sync timestamp:', error);\n    }\n  }\n\n  // Optimized sync method that only fetches recent changes\n  async syncInvoicesBetweenFirestoreAndIndexedDB(forceFullSync = false): Promise<void> {\n    if (this.syncInProgress) {\n      console.log('⚠️ Sync already in progress, skipping...');\n      return;\n    }\n\n    this.syncInProgress = true;\n    try {\n      console.log('🔄 Starting sync with server...');\n\n      // Đảm bảo IndexedDB đã được khởi tạo\n      await this.initDB();\n\n      const lastSync = await this.getLastSyncTimestamp();\n      console.log(`🔄 Starting sync from ${lastSync ? lastSync.toISOString() : 'beginning'}`);\n\n      // Nếu forceFullSync hoặc IndexedDB rỗng, luôn lấy lại toàn bộ hóa đơn từ Firestore\n      const indexedDBInvoices: InvoiceTab[] = await this.indexedDBService.getAll(\n        this.dbName,\n        this.dbVersion,\n        this.storeName\n      );\n\n      if (forceFullSync || indexedDBInvoices.length === 0) {\n        console.log('🔄 Force full sync - lấy lại toàn bộ hóa đơn từ Firestore');\n        await this.performInitialSync();\n        return;\n      }\n\n      // For subsequent syncs, use real-time updates or minimal API calls\n      if (this.isWebSocketConnected()) {\n        console.log('🔄 Using real-time updates for sync');\n        // Real-time updates are handled by WebSocket events\n        // Just update the timestamp\n        await this.saveLastSyncTimestamp();\n        this.lastSyncTimestamp = new Date();\n        this.syncCompletedSubject.next();\n      } else {\n        console.log('🔄 WebSocket not connected, performing minimal sync');\n        await this.performMinimalSync(lastSync);\n      }\n\n    } catch (error) {\n      console.error('❌ Error during sync:', error);\n      throw error; // Re-throw để component có thể xử lý\n    } finally {\n      this.syncInProgress = false;\n    }\n  }\n\n  // Initial sync - only called when IndexedDB is empty\n  async performInitialSync(): Promise<void> {\n    try {\n      console.log('🔄 Performing initial sync from Firestore...');\n      const firestoreInvoices = await firstValueFrom(this.getAllInvoicesFromFirestore()\n        .pipe(catchError(err => {\n          console.error('❌ Lỗi khi tải hóa đơn từ Firestore:', err);\n          return of([]);\n        })));\n\n      if (firestoreInvoices.length > 0) {\n        const validInvoices = firestoreInvoices.filter((invoice: any) => invoice && invoice.id) as InvoiceTab[];\n        await this.indexedDBService.putMany(\n          this.dbName,\n          this.dbVersion,\n          this.storeName,\n          validInvoices\n        );\n        console.log(`✅ Initial sync completed: ${validInvoices.length} invoices loaded`);\n      } else {\n        console.warn('⚠️ Không có hóa đơn nào lấy được từ Firestore!');\n      }\n\n      await this.saveLastSyncTimestamp();\n      this.lastSyncTimestamp = new Date();\n      this.syncCompletedSubject.next();\n\n    } catch (error) {\n      console.error('❌ Error during initial sync:', error);\n    }\n  }\n\n  // Minimal sync - only fetch recent changes\n  private async performMinimalSync(lastSync: Date | null): Promise<void> {\n    try {\n      console.log('🔄 Performing minimal sync...');\n\n      if (!lastSync) {\n        // If no last sync, do initial sync\n        console.log('🔄 No last sync timestamp, performing initial sync');\n        await this.performInitialSync();\n        return;\n      }\n\n      // Check if we have recent local changes that need to be pushed to Firestore\n      const localInvoices = await this.getAllInvoicesFromDB();\n      const recentLocalChanges = localInvoices.filter(invoice => {\n        const invoiceDate = new Date(invoice.createdDate || 0);\n        return invoiceDate > lastSync;\n      });\n\n      if (recentLocalChanges.length > 0) {\n        console.log(`🔄 Found ${recentLocalChanges.length} recent local changes, pushing to Firestore`);\n        // Push recent changes to Firestore\n        for (const invoice of recentLocalChanges) {\n          try {\n            await firstValueFrom(this.addInvoiceToFirestore(invoice));\n            console.log(`✅ Pushed invoice ${invoice.id} to Firestore`);\n          } catch (error) {\n            console.error(`❌ Failed to push invoice ${invoice.id} to Firestore:`, error);\n          }\n        }\n      } else {\n        console.log('ℹ️ No recent local changes to sync');\n      }\n\n      // Update sync timestamp\n      await this.saveLastSyncTimestamp();\n      this.lastSyncTimestamp = new Date();\n      this.syncCompletedSubject.next();\n\n      console.log('✅ Minimal sync completed');\n\n    } catch (error) {\n      console.error('❌ Error during minimal sync:', error);\n      throw error;\n    }\n  }\n\n  // API Methods - giữ nguyên\n  addInvoiceToFirestore(invoiceData: any): Observable<any> {\n    // Gửi dữ liệu hóa đơn lên Firestore qua API backend\n    return this.http.post(`${environment.domainUrl}${this.firebaseService.post_add_invoice}`, invoiceData);\n  }\n\n  updateInvoiceToFirestore(invoiceID: string, invoiceData: any): Observable<any> {\n    // Gửi dữ liệu hóa đơn lên Firestore qua API backend\n    return this.http.put(`${environment.domainUrl}${this.firebaseService.put_update_invoice}${invoiceID}`, invoiceData);\n  }\n  // Lấy tất cả hóa đơn từ API\n  getAllInvoicesFromFirestore(): Observable<any> {\n    return this.http.get(`${environment.domainUrl}${this.firebaseService.get_all_invoices}`);\n  }\n\n  // Xóa hóa đơn khỏi Firestore qua API backend\n  deleteInvoiceToFirestore(invoiceId: string): Observable<any> {\n    return this.http.delete(`${environment.domainUrl}${this.firebaseService.delete_del_invoice}${invoiceId}`);\n  }\n  // Lấy hóa đơn theo ID từ API\n  getInvoiceByIdFromFirestore(invoiceId: string): Observable<any> {\n    return this.http.get(`${environment.domainUrl}${this.firebaseService.get_invoice_by_id}${invoiceId}`);\n  }\n\n  // Lấy hóa đơn theo ngày từ API\n  getInvoicesByDateFromFirestore(date: string): Observable<any> {\n    return this.http.get(`${environment.domainUrl}${this.firebaseService.get_invoice_by_date}`, {\n      params: {\n        date\n      }\n    });\n  }\n\n  // Lấy hóa đơn theo khách hàng từ API\n  getInvoicesByCustomerFromFirestore(customer: string): Observable<any> {\n    return this.http.get(`${environment.domainUrl}/api/firebase/invoices/customer/${customer}`);\n  }\n\n  // IndexedDB Methods - CRUD operations\n  async getInvoiceFromDBById(id: string): Promise<InvoiceTab | undefined> {\n    return await this.indexedDBService.getByKey(\n      this.dbName,\n      this.dbVersion,\n      this.storeName,\n      id\n    );\n  }\n\n  async getAllInvoicesFromDB(): Promise<InvoiceTab[]> {\n    return await this.indexedDBService.getAll(\n      this.dbName,\n      this.dbVersion,\n      this.storeName\n    );\n  }\n\n  async addInvoiceToDB(invoice: InvoiceTab): Promise<void> {\n    await this.indexedDBService.put(\n      this.dbName,\n      this.dbVersion,\n      this.storeName,\n      invoice\n    );\n  }\n\n  async updateInvoiceInDB(invoice: InvoiceTab): Promise<void> {\n    await this.indexedDBService.put(\n      this.dbName,\n      this.dbVersion,\n      this.storeName,\n      invoice\n    );\n  }\n\n  async deleteInvoiceFromDB(id: string): Promise<void> {\n    await this.indexedDBService.delete(\n      this.dbName,\n      this.dbVersion,\n      this.storeName,\n      id\n    );\n  }\n\n  async clearAllInvoicesFromDB(): Promise<void> {\n    await this.indexedDBService.clear(\n      this.dbName,\n      this.dbVersion,\n      this.storeName\n    );\n  }\n\n  // Utility methods\n  async searchInvoicesInDB(query: string): Promise<InvoiceTab[]> {\n    const allInvoices = await this.getAllInvoicesFromDB();\n\n    if (!query || query.trim() === '') {\n      return allInvoices;\n    }\n\n    const searchTerm = query.toLowerCase().trim();\n\n    return allInvoices.filter(invoice =>\n      invoice.id?.toLowerCase().includes(searchTerm) ||\n      invoice.customer?.Name?.toLowerCase().includes(searchTerm)\n    );\n  }\n\n  async getInvoicesByDateFromDB(date: Date): Promise<InvoiceTab[]> {\n    const allInvoices = await this.getAllInvoicesFromDB();\n    console.log('Total invoices in DB:', allInvoices.length);\n\n    // Tạo ngày bắt đầu và kết thúc của ngày được chọn\n    const startOfDay = new Date(date);\n    startOfDay.setHours(0, 0, 0, 0);\n    const endOfDay = new Date(date);\n    endOfDay.setHours(23, 59, 59, 999);\n\n    const result = allInvoices.filter(invoice => {\n      if (!invoice.createdDate) {\n        return false;\n      }\n\n      try {\n        const invoiceDate = new Date(invoice.createdDate);\n        if (isNaN(invoiceDate.getTime())) {\n          return false;\n        }\n        const isInRange = invoiceDate >= startOfDay && invoiceDate <= endOfDay;\n        return isInRange;\n      } catch (error) {\n        console.error('Error parsing date for invoice:', invoice.id, error);\n        return false;\n      }\n    });\n\n    return result;\n  }\n\n  async getInvoicesByCustomerFromDB(customerName: string): Promise<InvoiceTab[]> {\n    const allInvoices = await this.getAllInvoicesFromDB();\n\n    return allInvoices.filter(invoice =>\n      invoice.customer?.Name.toLowerCase().includes(customerName.toLowerCase())\n    );\n  }\n\n  // Hybrid methods - combine API and IndexedDB\n  async getInvoiceHybrid(id: string, useCache = true): Promise<InvoiceTab | any> {\n    if (useCache) {\n      // Thử lấy từ IndexedDB trước\n      const cachedInvoice = await this.getInvoiceFromDBById(id);\n      if (cachedInvoice) {\n        return cachedInvoice;\n      }\n    }\n\n    // Nếu không có trong cache hoặc không dùng cache, lấy từ API\n    try {\n      const apiInvoice = await firstValueFrom(this.getInvoiceByIdFromFirestore(id));\n\n      // Lưu vào cache nếu lấy được từ API\n      if (apiInvoice) {\n        await this.addInvoiceToDB(apiInvoice);\n      }\n\n      return apiInvoice;\n    } catch (error) {\n      console.error('Lỗi khi lấy hóa đơn từ API:', error);\n      // Fallback về cache nếu API lỗi\n      return await this.getInvoiceFromDBById(id);\n    }\n  }\n\n  // API tổng hợp mới\n  getDailySummary(date: string): Observable<any> {\n    return this.http.get(`${environment.domainUrl}${this.firebaseService.get_revenue_by_daily}`, {\n      params: { date }\n    });\n  }\n\n  getMonthlySummary(year: number, month: number): Observable<any> {\n    return this.http.get(`${environment.domainUrl}${this.firebaseService.get_revenue_by_monthly}`, {\n      params: { year: year.toString(), month: month.toString().padStart(2, '0') }\n    });\n  }\n\n  getYearlySummary(year: number): Observable<any> {\n    return this.http.get(`${environment.domainUrl}${this.firebaseService.get_revenue_by_yearly}`, {\n      params: { year: year.toString() }\n    });\n  }\n\n  getTopSellProducts(params: { date?: string, year?: number, month?: number }): Observable<any[]> {\n    let httpParams: any = {};\n    const url = `${environment.domainUrl}${this.firebaseService.get_top_sell_products}`;\n    if (params.date) {\n      httpParams = { date: params.date };\n    } else if (params.year && params.month) {\n      httpParams = { year: params.year.toString(), month: params.month.toString().padStart(2, '0') };\n    } else if (params.year) {\n      httpParams = { year: params.year.toString() };\n    }\n    return this.http.get<any[]>(url, { params: httpParams });\n  }\n\n  // Offline Methods\n  async saveInvoiceToOffline(invoice: InvoiceTab): Promise<void> {\n    await this.indexedDBService.put(\n      this.dbName,\n      this.dbVersion,\n      'Offline',\n      invoice\n    );\n  }\n\n  async getAllOfflineInvoices(): Promise<InvoiceTab[]> {\n    return await this.indexedDBService.getAll(\n      this.dbName,\n      this.dbVersion,\n      'Offline'\n    );\n  }\n\n  async deleteOfflineInvoice(id: string): Promise<void> {\n    await this.indexedDBService.delete(\n      this.dbName,\n      this.dbVersion,\n      'Offline',\n      id\n    );\n  }\n\n  // Socket.IO Methods - Lazy initialization\n  private async initializeSocketIfNeeded(): Promise<void> {\n    if (this.socketInitialized && this.socket && this.socket.connected) {\n      return; // Already connected\n    }\n\n    try {\n      this.socketInitialized = true;\n      this.socket = io(environment.domainUrl + '/api/websocket/invoices', {\n        path: '/socket.io',\n        transports: ['websocket', 'polling'],\n        autoConnect: true,\n        reconnection: true,\n        reconnectionAttempts: this.maxReconnectAttempts,\n        reconnectionDelay: this.reconnectDelay,\n        // Thêm namespace nếu cần:\n        // 'namespace': '/api/websocket/invoices'\n      });\n\n      if (this.socket) {\n        this.socket.on('connect', () => {\n          console.log('🔌 Socket.IO connected for real-time invoice sync');\n          this.reconnectAttempts = 0;\n        });\n\n        this.socket.on('disconnect', () => {\n          console.log('🔌 Socket.IO disconnected');\n        });\n\n        this.socket.on('connect_error', (error) => {\n          console.error('❌ Socket.IO connection error:', error);\n        });\n\n        // Listen for invoice events from server\n        this.socket.on('invoice_created', (payload: any) => {\n          console.log('🆕 WebSocket: Received invoice_created event:', payload);\n          const invoice = payload.data || payload; // fallback nếu backend trả trực tiếp\n          if (invoice && invoice.id) {\n            this.handleInvoiceCreated(invoice);\n          } else {\n            console.warn('⚠️ Invalid invoice_created payload:', payload);\n          }\n        });\n\n        this.socket.on('invoice_updated', (payload: any) => {\n          console.log('🔄 WebSocket: Received invoice_updated event:', payload);\n          const invoice = payload.data || payload;\n          if (invoice && invoice.id) {\n            this.handleInvoiceUpdated(invoice);\n          } else {\n            console.warn('⚠️ Invalid invoice_updated payload:', payload);\n          }\n        });\n\n        this.socket.on('invoice_deleted', (payload: any) => {\n          console.log('🗑️ WebSocket: Received invoice_deleted event:', payload);\n          const invoiceId = payload.data || payload;\n          if (invoiceId) {\n            this.handleInvoiceDeleted(invoiceId);\n          } else {\n            console.warn('⚠️ Invalid invoice_deleted payload:', payload);\n          }\n        });\n\n        this.socket.on('sync_request', (payload: any) => {\n          console.log('🔄 WebSocket: Received sync_request event:', payload);\n          this.handleSyncRequest(payload);\n        });\n      }\n\n    } catch (error) {\n      console.error('❌ Failed to initialize Socket.IO:', error);\n      this.socketInitialized = false;\n    }\n  }\n\n  private async handleInvoiceCreated(invoice: InvoiceTab): Promise<void> {\n    try {\n      console.log('🆕 Real-time: Received invoice created event:', invoice);\n\n      // Kiểm tra xem hóa đơn đã tồn tại trong IndexedDB chưa\n      const existing = await this.indexedDBService.getByKey(this.dbName, this.dbVersion, this.storeName, invoice.id);\n\n      if (!existing) {\n        // Thêm hóa đơn mới vào IndexedDB\n        await this.indexedDBService.put(this.dbName, this.dbVersion, this.storeName, invoice);\n        console.log(`✅ Real-time: Đã thêm hóa đơn ${invoice.id} vào IndexedDB`);\n\n        // === Build groupedProducts from all products in IndexedDB ===\n        const allProducts: any[] = await this.productService.getAllProductsFromIndexedDB();\n        const groupedProducts = this.groupService.group(allProducts);\n\n\n        // === Build currentOnHandMap for all involved productIds ===\n        const productIds = new Set<number>();\n        for (const cartItem of invoice.cartItems) {\n          const masterUnitId = cartItem.product.MasterUnitId || cartItem.product.Id;\n          const group = groupedProducts[masterUnitId];\n          if (group) {\n            group.forEach(product => productIds.add(product.Id));\n          }\n        }\n        const currentOnHandMap: Record<number, number> = {};\n        for (const productId of productIds) {\n          const product = await this.productService.getProductByIdFromIndexedDB(productId);\n          if (product) {\n            currentOnHandMap[productId] = product.OnHand;\n          }\n        }\n\n        // === Calculate updates for each product in group ===\n        const updates: Record<number, number> = {};\n        for (const cartItem of invoice.cartItems) {\n          const masterUnitId = cartItem.product.MasterUnitId || cartItem.product.Id;\n          const group = groupedProducts[masterUnitId];\n          if (!group) continue;\n          const masterQty = cartItem.quantity * cartItem.product.ConversionValue;\n          for (const product of group) {\n            const minus = masterQty / product.ConversionValue;\n            updates[product.Id] = (updates[product.Id] || 0) + minus;\n          }\n        }\n\n        // === Update OnHand for each product in IndexedDB ===\n        for (const productIdStr of Object.keys(updates)) {\n          const productId = Number(productIdStr);\n          try {\n            const dbName = 'SalesDB';\n            const dbVersion = 1;\n            const storeName = 'products';\n            const existingProduct = await this.productService.getProductByIdFromIndexedDB(productId);\n            if (existingProduct) {\n              const oldOnHand = currentOnHandMap[productId] ?? existingProduct.OnHand ?? 0;\n              existingProduct.OnHand = oldOnHand - updates[productId];\n              await this.productService.updateProductFromIndexedDB(existingProduct);\n              console.log(`✅ Real-time: Đã cập nhật OnHand cho sản phẩm ${productId} (${existingProduct.FullName || existingProduct.Name || ''}) = ${existingProduct.OnHand}`);\n            }\n          } catch (err) {\n            console.error(`❌ Lỗi khi cập nhật OnHand cho sản phẩm ${productId}:`, err);\n          }\n        }\n\n        // Emit event để components có thể cập nhật UI\n        this.invoiceCreatedSubject.next(invoice);\n      } else {\n        console.log(`ℹ️ Real-time: Hóa đơn ${invoice.id} đã tồn tại trong IndexedDB`);\n      }\n    } catch (error) {\n      console.error(`❌ Error handling invoice created:`, error);\n    }\n  }\n\n  private async handleInvoiceUpdated(invoice: InvoiceTab): Promise<void> {\n    try {\n      console.log('🔄 Real-time: Received invoice updated event:', invoice);\n\n      // Cập nhật hóa đơn trong IndexedDB\n      await this.indexedDBService.put(this.dbName, this.dbVersion, this.storeName, invoice);\n      console.log(`✅ Real-time: Đã cập nhật hóa đơn ${invoice.id} trong IndexedDB`);\n\n      // Emit event để components có thể cập nhật UI\n      this.invoiceUpdatedSubject.next(invoice);\n    } catch (error) {\n      console.error(`❌ Error handling invoice updated:`, error);\n    }\n  }\n\n  private async handleInvoiceDeleted(invoiceId: string): Promise<void> {\n    try {\n      console.log('🗑️ Real-time: Received invoice deleted event:', invoiceId);\n\n      // Xóa hóa đơn khỏi IndexedDB\n      await this.indexedDBService.delete(this.dbName, this.dbVersion, this.storeName, invoiceId);\n      console.log(`✅ Real-time: Đã xóa hóa đơn ${invoiceId} khỏi IndexedDB`);\n\n      // Emit event để components có thể cập nhật UI\n      this.invoiceDeletedSubject.next(invoiceId);\n    } catch (error) {\n      console.error(`❌ Error handling invoice deleted:`, error);\n    }\n  }\n\n  private async handleSyncRequest(data: any): Promise<void> {\n    try {\n      // Server yêu cầu đồng bộ - gửi danh sách hóa đơn local\n      const localInvoices = await this.getAllInvoicesFromDB();\n      this.sendSocketMessage('sync_response', {\n        invoices: localInvoices,\n        timestamp: new Date().toISOString()\n      });\n      console.log(`📤 Real-time: Đã gửi ${localInvoices.length} hóa đơn local để đồng bộ`);\n    } catch (error) {\n      console.error(`❌ Error handling sync request:`, error);\n    }\n  }\n\n  private async sendSocketMessage(event: string, data: any): Promise<void> {\n    try {\n      await this.initializeSocketIfNeeded();\n\n      if (this.socket && this.socket.connected) {\n        this.socket.emit(event, data);\n      } else {\n        console.warn('⚠️ Socket.IO not connected, cannot send message');\n      }\n    } catch (error) {\n      console.error('❌ Error sending Socket.IO message:', error);\n    }\n  }\n\n  // Public method để gửi thông báo tạo hóa đơn mới\n  public async notifyInvoiceCreated(invoice: InvoiceTab): Promise<void> {\n    try {\n      await this.sendSocketMessage('invoice_created', invoice);\n    } catch (error) {\n      console.error('❌ Error notifying invoice created:', error);\n    }\n  }\n\n  // Public method để gửi thông báo cập nhật hóa đơn\n  public async notifyInvoiceUpdated(invoice: InvoiceTab): Promise<void> {\n    try {\n      await this.sendSocketMessage('invoice_updated', invoice);\n    } catch (error) {\n      console.error('❌ Error notifying invoice updated:', error);\n    }\n  }\n\n  // Public method để gửi thông báo xóa hóa đơn\n  public async notifyInvoiceDeleted(invoiceId: string): Promise<void> {\n    try {\n      await this.sendSocketMessage('invoice_deleted', invoiceId);\n    } catch (error) {\n      console.error('❌ Error notifying invoice deleted:', error);\n    }\n  }\n\n  // Method để đóng Socket.IO khi component bị destroy\n  public disconnectSocket(): void {\n    if (this.socket) {\n      this.socket.disconnect();\n      this.socket = null;\n      this.socketInitialized = false;\n    }\n  }\n\n  // Public method để khởi tạo WebSocket an toàn cho components\n  public async initializeWebSocket(): Promise<void> {\n    await this.initializeSocketIfNeeded();\n  }\n\n  // Public method để kiểm tra trạng thái kết nối WebSocket\n  public isWebSocketConnected(): boolean {\n    return this.socketInitialized && this.socket !== null && this.socket.connected;\n  }\n\n  // Public method để lấy thông tin kết nối\n  public getWebSocketStatus(): { connected: boolean; initialized: boolean; socketExists: boolean } {\n    return {\n      connected: this.socket?.connected || false,\n      initialized: this.socketInitialized,\n      socketExists: this.socket !== null\n    };\n  }\n\n  // Public method để lấy thời gian sync cuối cùng\n  public async getLastSyncTime(): Promise<Date | null> {\n    if (this.lastSyncTimestamp) {\n      return this.lastSyncTimestamp;\n    }\n    return await this.getLastSyncTimestamp();\n  }\n\n  // Public method để kiểm tra xem có cần sync hay không\n  public async needsSync(): Promise<boolean> {\n    const lastSync = await this.getLastSyncTimestamp();\n    if (!lastSync) {\n      return true; // Never synced before\n    }\n\n    // Check if last sync was more than 5 minutes ago\n    const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);\n    return lastSync < fiveMinutesAgo;\n  }\n}","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\services\\kiotviet.service.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Observable' is defined but never used.","line":6,"column":22,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":32},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'KiotVietAuthResponse' is defined but never used.","line":8,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":31},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":18,"column":15,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":18,"endColumn":57},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":18,"column":59,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":18,"endColumn":83},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[831,834],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[831,834],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":23,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[906,909],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[906,909],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":33,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1313,1316],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1313,1316],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":33,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1327,1330],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1327,1330],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":120,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4478,4481],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4478,4481],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":120,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4492,4495],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4492,4495],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":148,"column":96,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":148,"endColumn":99,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5460,5463],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5460,5463],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":148,"column":113,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":148,"endColumn":116,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5477,5480],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5477,5480],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":148,"column":132,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":148,"endColumn":135,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5496,5499],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5496,5499],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":149,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":149,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5536,5539],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5536,5539],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":149,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":149,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5550,5553],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5550,5553],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":149,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":149,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5563,5566],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5563,5566],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":171,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":171,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6579,6582],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6579,6582],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":171,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":171,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6593,6596],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6593,6596],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":229,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":229,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8513,8516],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8513,8516],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":230,"column":5,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":236,"endColumn":28},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":239,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":239,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8865,8868],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8865,8868],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":241,"column":5,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":247,"endColumn":28}],"suppressedMessages":[],"errorCount":22,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@angular/core';\r\nimport { environment } from \"../../environments/environment\";\r\nimport { InvoiceTab } from '../models/invoice.model';\r\nimport { IndexedDBService } from './indexed-db.service'; // Thêm import này\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { catchError, Observable, of } from 'rxjs';\r\n\r\ninterface KiotVietAuthResponse {\r\n  access_token: string;\r\n  retailer: number;\r\n  LatestBranchId: string;\r\n}\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class KiotvietService {\r\n\r\n  constructor(private indexedDBService: IndexedDBService, private http: HttpClient) { }\r\n  private readonly updateItemUrl = 'https://api-man1.kiotviet.vn/api';\r\n  private readonly getUpdateItemUrl = 'https://api-man1.kiotviet.vn/api/products';\r\n  private retailerId = 500111210;\r\n  private retailer: any | null = null;// Replace with your retailer\r\n  private LatestBranchId: any | null = null; // Replace with your branch ID\r\n  private accessToken: string | null = null;\r\n  private dbName = 'SalesDB';\r\n  private dbVersion = 1;\r\n  private storeName = 'outofstock';\r\n\r\n  kiotviet_items_api = \"/api/kiotviet/items/all\";\r\n  kiotviet_customers_api = \"/api/kiotviet/customers\";\r\n  kiotviet_item_outofstock_api = \"/api/kiotviet/items/out_of_stock\";\r\n\r\n  async getOutOfStockItems(params?: any): Promise<any> {\r\n    return await this.http.get(`${environment.domainUrl}${this.kiotviet_item_outofstock_api}`, { params }).toPromise();\r\n  }\r\n  private async getAccessToken(): Promise<string> {\r\n    // Ưu tiên lấy từ localStorage nếu đã đăng nhập\r\n    const storedToken = localStorage.getItem('kv_access_token');\r\n    const storedRetailer = localStorage.getItem('kv_retailer');\r\n    const storedBranchId = localStorage.getItem('kv_branch_id');\r\n\r\n    if (storedToken && storedRetailer && storedBranchId) {\r\n      // Kiểm tra token có expired không\r\n      if (this.isTokenExpired(storedToken)) {\r\n        console.log('Token đã hết hạn, yêu cầu đăng nhập lại');\r\n        this.clearStoredCredentials();\r\n        throw new Error('Token đã hết hạn. Vui lòng đăng nhập lại.');\r\n      }\r\n\r\n      this.accessToken = storedToken;\r\n      this.retailer = storedRetailer;\r\n      this.LatestBranchId = storedBranchId;\r\n      return this.accessToken;\r\n    }\r\n\r\n    // Nếu chưa có, yêu cầu đăng nhập lại\r\n    throw new Error('Chưa đăng nhập KiotViet. Vui lòng đăng nhập lại.');\r\n  }\r\n\r\n  private isTokenExpired(token: string): boolean {\r\n    try {\r\n      // JWT token có 3 phần, phần thứ 2 là payload\r\n      const payload = token.split('.')[1];\r\n      const decodedPayload = JSON.parse(atob(payload));\r\n\r\n      // Kiểm tra thời gian hết hạn (exp)\r\n      if (decodedPayload.exp) {\r\n        const currentTime = Math.floor(Date.now() / 1000);\r\n        return currentTime >= decodedPayload.exp;\r\n      }\r\n\r\n      // Nếu không có exp, kiểm tra thời gian tạo token (iat) + thời gian sống ước tính\r\n      if (decodedPayload.iat) {\r\n        const currentTime = Math.floor(Date.now() / 1000);\r\n        const estimatedExpiry = decodedPayload.iat + (24 * 60 * 60); // Ước tính 24 giờ\r\n        return currentTime >= estimatedExpiry;\r\n      }\r\n\r\n      // Nếu không có thông tin thời gian, coi như không expired\r\n      return false;\r\n    } catch (error) {\r\n      console.error('Lỗi khi kiểm tra token expired:', error);\r\n      // Nếu không parse được token, coi như expired để đảm bảo an toàn\r\n      return true;\r\n    }\r\n  }\r\n\r\n  private clearStoredCredentials(): void {\r\n    localStorage.removeItem('kv_access_token');\r\n    localStorage.removeItem('kv_retailer');\r\n    localStorage.removeItem('kv_branch_id');\r\n    this.accessToken = null;\r\n    this.retailer = null;\r\n    this.LatestBranchId = null;\r\n  }\r\n\r\n  async getRequestBody(Id: number) {\r\n    try {\r\n      const token = await this.getAccessToken();\r\n      const response = await fetch(`${this.getUpdateItemUrl}/${Id}/initialdata?Includes=ProductAttributes&ProductType=2`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': token,\r\n          'Retailer': this.retailer,\r\n          'BranchId': this.LatestBranchId,\r\n        }\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error('Failed to get product');\r\n      }\r\n      const formData = await response.json();\r\n      return formData\r\n    } catch (error) {\r\n      console.error('Error getting product', error);\r\n      throw error;\r\n    }\r\n  }\r\n  async updateProductToKiotviet(formDataGetFromKiotViet: any): Promise<any> {\r\n    const fD = new FormData();\r\n    fD.append(\"product\", JSON.stringify(formDataGetFromKiotViet.Product))\r\n    fD.append(\"BranchForProductCostss\", `[{ \"Id\": ${this.LatestBranchId}, \"Name\": \"Chi nhánh trung tâm\" }]`)\r\n    fD.append(\"ListUnitPriceBookDetail\", \"[]\")\r\n    try {\r\n      const response = await fetch(`${this.updateItemUrl}/products/photo`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Authorization': this.accessToken || '',\r\n          'Retailer': this.retailer,\r\n          'BranchId': this.LatestBranchId\r\n        },\r\n        body: fD\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n\r\n      const result = await response.json();\r\n      return result;\r\n    } catch (error) {\r\n      console.error('Error sending product data:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async updateOnHandFromInvoiceToKiotviet(invoice: InvoiceTab, groupedProducts: { [x: string]: any;[x: number]: any[]; }): Promise<any> {\r\n    const results: { productId: any; result?: any; error?: any; }[] = []; // Tạo mảng để lưu kết quả\r\n\r\n    for (const cartItem of invoice.cartItems) {\r\n      const masterUnitId = cartItem.product.MasterUnitId || cartItem.product.Id;\r\n      const group = groupedProducts[masterUnitId];\r\n      const masterItem = group?.find(item => item.MasterUnitId == null);\r\n\r\n      const formDataGetFromKiotViet = await this.getRequestBody(masterItem.Id)\r\n      formDataGetFromKiotViet.Product.OnHand = formDataGetFromKiotViet.Product.OnHand - (cartItem.quantity * cartItem.product.ConversionValue);\r\n      await this.updateProductToKiotviet(formDataGetFromKiotViet)\r\n        .then(result => {\r\n          results.push({ productId: masterItem.Id, result });\r\n        })\r\n        .catch(error => {\r\n          console.error(`Error updating product ${masterItem.Id}:`, error);\r\n          results.push({ productId: masterItem.Id, error: error.message });\r\n        });\r\n    }\r\n\r\n    return results; // Return tất cả kết quả sau khi hoàn thành vòng lặp\r\n  }\r\n\r\n  async addCustomer(customerData: any): Promise<any> {\r\n    const token = await this.getAccessToken();\r\n\r\n    const payload = {\r\n      Customer: {\r\n        BranchId: Number(this.LatestBranchId),\r\n        IsActive: true,\r\n        Uuid: crypto.randomUUID(),\r\n        Type: 0,\r\n        temploc: \"\",\r\n        tempw: \"\",\r\n        EmployeeInChargeIds: [],\r\n        Name: customerData.name,\r\n        Organization: customerData.organization || \"\",\r\n        ContactNumber: customerData.phone,\r\n        Gender: customerData.gender === 'Nam' ? 1 : (customerData.gender === 'Nữ' ? 0 : null),\r\n        BirthDate: customerData.birthDate ? new Date(customerData.birthDate).toISOString() : null,\r\n        TaxCode: customerData.taxCode,\r\n        IdentificationNumber: customerData.idCard,\r\n        Email: customerData.email,\r\n        Facebook: customerData.facebook,\r\n        Comments: customerData.notes,\r\n        LocationName: \"\",\r\n        AdministrativeAreaId: null,\r\n        WardName: \"\",\r\n        CustomerGroupDetails: [],\r\n        RetailerId: this.retailerId\r\n      },\r\n      isMergedSupplier: false,\r\n      isCreateNewSupplier: false,\r\n      MergedSupplierId: 0,\r\n      SkipValidateEmail: false,\r\n    };\r\n\r\n    try {\r\n      const response = await fetch(`https://api-man1.kiotviet.vn/api/customers`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': token,\r\n          'Retailer': this.retailer,\r\n          'BranchId': this.LatestBranchId\r\n        },\r\n        body: JSON.stringify(payload)\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorText = await response.text();\r\n        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);\r\n      }\r\n\r\n      const result = await response.json();\r\n      return result;\r\n    } catch (error) {\r\n      console.error('Error adding customer:', error);\r\n      throw error;\r\n    }\r\n  }\r\n  async syncProductFromKiotvietToFirebase(data: any): Promise<void> {\r\n    (await this.http.put(`${environment.domainUrl}/api/sync/kiotviet/firebase/products`, data)\r\n      .pipe(\r\n        catchError((err) => {\r\n          console.error('❌ Lỗi khi tải tất cả sản phẩm:', err);\r\n          return of([]);\r\n        })\r\n      ).toPromise()) ?? [];\r\n  }\r\n\r\n  async syncCustomerFromKiotvietToFirebase(data: any): Promise<void> {\r\n    // Lấy dữ liệu từ API\r\n    (await this.http.put(`${environment.domainUrl}/api/sync/kiotviet/firebase/customers`, data)\r\n      .pipe(\r\n        catchError((err) => {\r\n          console.error('❌ Lỗi khi tải tất cả khách hàng:', err);\r\n          return of([]);\r\n        })\r\n      ).toPromise()) ?? [];\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\services\\local-storage.service.ts","messages":[{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty constructor.","line":9,"column":17,"nodeType":"FunctionExpression","messageId":"unexpected","endLine":9,"endColumn":20,"suggestions":[{"messageId":"suggestComment","data":{"name":"constructor"},"fix":{"range":[251,252],"text":" /* empty */ "},"desc":"Add comment inside empty constructor."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":112,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":112,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3154,3157],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3154,3157],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":117,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":117,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3332,3335],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3332,3335],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-prototype-builtins","severity":2,"message":"Do not access Object.prototype method 'hasOwnProperty' from target object.","line":186,"column":24,"nodeType":"CallExpression","messageId":"prototypeBuildIn","endLine":186,"endColumn":38,"suggestions":[{"messageId":"callObjectPrototype","data":{"prop":"hasOwnProperty"},"fix":{"range":[5604,5632],"text":"Object.prototype.hasOwnProperty.call(localStorage, "},"desc":"Call Object.prototype.hasOwnProperty explicitly."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":200,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":200,"endColumn":19}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@angular/core';\r\nimport { CartItem } from '../models/cart-item.model';\r\nimport { InvoiceTab } from '../models/invoice.model';\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class LocalStorageService {\r\n\r\n  constructor() { }\r\n   public setItem<T>(key: string, value: T): void {\r\n    try {\r\n      const serializedValue = JSON.stringify(value);\r\n      localStorage.setItem(key, serializedValue);\r\n    } catch (error) {\r\n      console.error(`Error saving to localStorage with key \"${key}\":`, error);\r\n    }\r\n  }\r\n\r\n  public getItem<T>(key: string): T | null {\r\n    try {\r\n      const item = localStorage.getItem(key);\r\n      if (item === null) {\r\n        return null;\r\n      }\r\n      return JSON.parse(item) as T;\r\n    } catch (error) {\r\n      console.error(`Error getting from localStorage with key \"${key}\":`, error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  private removeItem(key: string): void {\r\n    try {\r\n      localStorage.removeItem(key);\r\n    } catch (error) {\r\n      console.error(`Error removing from localStorage with key \"${key}\":`, error);\r\n    }\r\n  }\r\n\r\n  private hasItem(key: string): boolean {\r\n    return localStorage.getItem(key) !== null;\r\n  }\r\n\r\n  // CartItems specific methods\r\n  saveCartItems(cartItems: CartItem[], activeTabIndex = 0): void {\r\n    const key = `cartItems_tab_${activeTabIndex}`;\r\n    this.setItem(key, cartItems);\r\n  }\r\n\r\n  getCartItems(activeTabIndex = 0): CartItem[] {\r\n    const key = `cartItems_tab_${activeTabIndex}`;\r\n    const cartItems = this.getItem<CartItem[]>(key);\r\n    return cartItems || [];\r\n  }\r\n\r\n  clearCartItems(activeTabIndex = 0): void {\r\n    const key = `cartItems_tab_${activeTabIndex}`;\r\n    this.removeItem(key);\r\n  }\r\n\r\n  hasCartItems(activeTabIndex = 0): boolean {\r\n    const key = `cartItems_tab_${activeTabIndex}`;\r\n    return this.hasItem(key);\r\n  }\r\n\r\n  // Invoice tabs specific methods\r\n  saveInvoiceTabs(invoices: InvoiceTab[]): void {\r\n    this.setItem('invoice_tabs', invoices);\r\n  }\r\n\r\n  getInvoiceTabs(): InvoiceTab[] {\r\n    const invoices = this.getItem<InvoiceTab[]>('invoice_tabs');\r\n    return invoices || [];\r\n  }\r\n\r\n  clearInvoiceTabs(): void {\r\n    this.removeItem('invoice_tabs');\r\n  }\r\n\r\n  // Active tab index\r\n  saveActiveTabIndex(index: number): void {\r\n    this.setItem('active_tab_index', index);\r\n  }\r\n\r\n  getActiveTabIndex(): number {\r\n    const index = this.getItem<number>('active_tab_index');\r\n    return index !== null ? index : 0;\r\n  }\r\n\r\n  clearActiveTabIndex(): void {\r\n    this.removeItem('active_tab_index');\r\n  }\r\n\r\n  // Discount amount\r\n  saveDiscountAmount(discountAmount: number, activeTabIndex = 0): void {\r\n    const key = `discount_amount_tab_${activeTabIndex}`;\r\n    this.setItem(key, discountAmount);\r\n  }\r\n\r\n  getDiscountAmount(activeTabIndex = 0): number {\r\n    const key = `discount_amount_tab_${activeTabIndex}`;\r\n    const discount = this.getItem<number>(key);\r\n    return discount !== null ? discount : 0;\r\n  }\r\n\r\n  clearDiscountAmount(activeTabIndex = 0): void {\r\n    const key = `discount_amount_tab_${activeTabIndex}`;\r\n    this.removeItem(key);\r\n  }\r\n\r\n  // Selected customer\r\n  saveSelectedCustomer(customer: any, activeTabIndex = 0): void {\r\n    const key = `selected_customer_tab_${activeTabIndex}`;\r\n    this.setItem(key, customer);\r\n  }\r\n\r\n  getSelectedCustomer(activeTabIndex = 0): any {\r\n    const key = `selected_customer_tab_${activeTabIndex}`;\r\n    return this.getItem(key);\r\n  }\r\n\r\n  clearSelectedCustomer(activeTabIndex = 0): void {\r\n    const key = `selected_customer_tab_${activeTabIndex}`;\r\n    this.removeItem(key);\r\n  }\r\n\r\n  // Invoice note\r\n  saveInvoiceNote(note: string, activeTabIndex = 0): void {\r\n    const key = `invoice_note_tab_${activeTabIndex}`;\r\n    this.setItem(key, note);\r\n  }\r\n\r\n  getInvoiceNote(activeTabIndex = 0): string {\r\n    const key = `invoice_note_tab_${activeTabIndex}`;\r\n    const note = this.getItem<string>(key);\r\n    return note || '';\r\n  }\r\n\r\n  clearInvoiceNote(activeTabIndex = 0): void {\r\n    const key = `invoice_note_tab_${activeTabIndex}`;\r\n    this.removeItem(key);\r\n  }\r\n\r\n  // Clear all data for a specific tab\r\n  clearTabData(activeTabIndex: number): void {\r\n    this.clearCartItems(activeTabIndex);\r\n    this.clearDiscountAmount(activeTabIndex);\r\n    this.clearSelectedCustomer(activeTabIndex);\r\n    this.clearInvoiceNote(activeTabIndex);\r\n    this.clearInvoiceTabs()\r\n  }\r\n\r\n  // Clear all localStorage data\r\n  // clearAllData(): void {\r\n  //   try {\r\n  //     // Get all keys that start with our prefixes\r\n  //     const keysToRemove: string[] = [];\r\n  //     for (let i = 0; i < localStorage.length; i++) {\r\n  //       const key = localStorage.key(i);\r\n  //       if (key && (\r\n  //         key.startsWith('cartItems_tab_') ||\r\n  //         key.startsWith('discount_amount_tab_') ||\r\n  //         key.startsWith('selected_customer_tab_') ||\r\n  //         key.startsWith('invoice_note_tab_') ||\r\n  //          key.startsWith('grouped_') ||\r\n  //           key.startsWith('search_') ||\r\n  //            key.startsWith('edited_products_') ||\r\n  //         key === 'invoice_tabs' ||\r\n  //         key === 'active_tab_index'\r\n  //       )) {\r\n  //         keysToRemove.push(key);\r\n  //       }\r\n  //     }\r\n      \r\n  //     // Remove all identified keys\r\n  //     keysToRemove.forEach(key => localStorage.removeItem(key));\r\n  //   } catch (error) {\r\n  //     console.error('Error clearing all localStorage data:', error);\r\n  //   }\r\n  // }\r\n\r\n  // Utility method to get localStorage size (for debugging)\r\n  getStorageSize(): string {\r\n    let total = 0;\r\n    for (const key in localStorage) {\r\n      if (localStorage.hasOwnProperty(key)) {\r\n        total += localStorage[key].length + key.length;\r\n      }\r\n    }\r\n    return (total / 1024).toFixed(2) + ' KB';\r\n  }\r\n\r\n  // Method to check if localStorage is available\r\n  isStorageAvailable(): boolean {\r\n    try {\r\n      const test = '__localStorage_test__';\r\n      localStorage.setItem(test, test);\r\n      localStorage.removeItem(test);\r\n      return true;\r\n    } catch (error) {\r\n      return false;\r\n    }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\services\\order-to-invoice.service.ts","messages":[{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty constructor.","line":17,"column":17,"nodeType":"FunctionExpression","messageId":"unexpected","endLine":17,"endColumn":20,"suggestions":[{"messageId":"suggestComment","data":{"name":"constructor"},"fix":{"range":[460,461],"text":" /* empty */ "},"desc":"Add comment inside empty constructor."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@angular/core';\r\nimport { Subject } from 'rxjs';\r\nimport { InvoiceTab } from '../models/invoice.model';\r\n\r\nexport interface OrderToInvoiceData {\r\n  order: InvoiceTab;\r\n  orderId: string;\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class OrderToInvoiceService {\r\n  private orderProcessedSubject = new Subject<OrderToInvoiceData>();\r\n  public orderProcessed$ = this.orderProcessedSubject.asObservable();\r\n\r\n  constructor() { }\r\n\r\n  // Emit event when order is processed\r\n  processOrder(order: InvoiceTab, orderId: string): void {\r\n    this.orderProcessedSubject.next({ order, orderId });\r\n  }\r\n} ","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\services\\order.service.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'catchError' is defined but never used.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'of' is defined but never used.","line":4,"column":50,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":52},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":25,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[904,907],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[904,907],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":26,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[957,960],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[957,960],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":40,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":40,"endColumn":29},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":41,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":41,"endColumn":47},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":42,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":42,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":43,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":43,"endColumn":45},{"ruleId":"@angular-eslint/contextual-lifecycle","severity":2,"message":"Angular will not invoke the `ngOnInit` lifecycle method within `@Injectable()` classes","line":46,"column":3,"nodeType":"Identifier","messageId":"contextualLifecycle","endLine":46,"endColumn":11},{"ruleId":"@angular-eslint/no-empty-lifecycle-method","severity":2,"message":"Lifecycle methods should not be empty","line":46,"column":3,"nodeType":"MethodDefinition","messageId":"noEmptyLifecycleMethod","endLine":46,"endColumn":16,"suggestions":[{"messageId":"suggestRemoveLifecycleMethod","fix":{"range":[19,1677],"text":" } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { environment } from '../../environments/environment';\r\nimport { catchError, firstValueFrom, Observable, of, Subject } from 'rxjs';\r\nimport { IndexedDBService } from './indexed-db.service';\r\nimport { FirebaseService } from './firebase.service';\r\nimport { TimeZoneService } from './time-zone.service';\r\nimport { io, Socket } from 'socket.io-client';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class OrderService  {\r\n  private dbName = 'SalesDB';\r\n  private dbVersion = 1;\r\n  private storeName = 'order';\r\n\r\n  private socket: Socket | null = null;\r\n  private reconnectAttempts = 0;\r\n  private maxReconnectAttempts = 5;\r\n  private reconnectDelay = 1000;\r\n  private socketInitialized = false;\r\n\r\n  // Real-time event subjects\r\n  private orderCreatedSubject = new Subject<any>();\r\n  private orderUpdatedSubject = new Subject<any>();\r\n  private orderDeletedSubject = new Subject<string>();\r\n  private syncCompletedSubject = new Subject<void>();\r\n\r\n  // Public observables\r\n  public orderCreated$ = this.orderCreatedSubject.asObservable();\r\n  public orderUpdated$ = this.orderUpdatedSubject.asObservable();\r\n  public orderDeleted$ = this.orderDeletedSubject.asObservable();\r\n  public syncCompleted$ = this.syncCompletedSubject.asObservable();\r\n\r\n  private lastSyncTimestamp: Date | null = null;\r\n  private syncInProgress = false;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private indexedDBService: IndexedDBService,\r\n    private timeZoneService: TimeZoneService,\r\n    private firebaseService: FirebaseService\r\n  ) {}\r\n\r\n  "},"desc":"Remove lifecycle method"}]},{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty method 'ngOnInit'.","line":46,"column":14,"nodeType":"FunctionExpression","messageId":"unexpected","endLine":46,"endColumn":16,"suggestions":[{"messageId":"suggestComment","data":{"name":"method 'ngOnInit'"},"fix":{"range":[1676,1676],"text":" /* empty */ "},"desc":"Add comment inside empty method 'ngOnInit'."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":61,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2133,2136],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2133,2136],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":70,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2332,2335],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2332,2335],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":78,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":78,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2498,2501],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2498,2501],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":87,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":87,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2684,2687],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2684,2687],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":114,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":114,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3294,3297],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3294,3297],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":114,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":114,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3311,3314],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3311,3314],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":118,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":118,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3467,3470],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3467,3470],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":118,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":118,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3484,3487],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3484,3487],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":122,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":122,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3642,3645],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3642,3645],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":126,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3786,3789],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3786,3789],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":130,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3947,3950],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3947,3950],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":134,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4105,4108],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4105,4108],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":141,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":141,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4316,4319],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4316,4319],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty arrow function.","line":178,"column":44,"nodeType":"ArrowFunctionExpression","messageId":"unexpected","endLine":178,"endColumn":46,"suggestions":[{"messageId":"suggestComment","data":{"name":"arrow function"},"fix":{"range":[5599,5599],"text":" /* empty */ "},"desc":"Add comment inside empty arrow function."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":182,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":182,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5793,5796],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5793,5796],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":188,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":188,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6011,6014],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6011,6014],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":194,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":194,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6229,6232],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6229,6232],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":200,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":200,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6440,6443],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6440,6443],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":204,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":204,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":209,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":209,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6635,6638],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6635,6638],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":221,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":221,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6998,7001],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6998,7001],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'data' is defined but never used.","line":239,"column":35,"nodeType":null,"messageId":"unusedVar","endLine":239,"endColumn":39},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":239,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":239,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7535,7538],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7535,7538],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":251,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":251,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7919,7922],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7919,7922],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":257,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":257,"endColumn":19},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":257,"column":21,"nodeType":"BlockStatement","messageId":"unexpected","endLine":257,"endColumn":23,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[8120,8120],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":261,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":261,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8202,8205],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8202,8205],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":264,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":264,"endColumn":19},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":264,"column":21,"nodeType":"BlockStatement","messageId":"unexpected","endLine":264,"endColumn":23,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[8318,8318],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":266,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":266,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8367,8370],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8367,8370],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":269,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":269,"endColumn":19},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":269,"column":21,"nodeType":"BlockStatement","messageId":"unexpected","endLine":269,"endColumn":23,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[8483,8483],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":274,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":274,"endColumn":19},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":274,"column":21,"nodeType":"BlockStatement","messageId":"unexpected","endLine":274,"endColumn":23,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[8655,8655],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":311,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":311,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9912,9915],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9912,9915],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":46,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable, OnInit } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { environment } from '../../environments/environment';\r\nimport { catchError, firstValueFrom, Observable, of, Subject } from 'rxjs';\r\nimport { IndexedDBService } from './indexed-db.service';\r\nimport { FirebaseService } from './firebase.service';\r\nimport { TimeZoneService } from './time-zone.service';\r\nimport { io, Socket } from 'socket.io-client';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class OrderService implements OnInit {\r\n  private dbName = 'SalesDB';\r\n  private dbVersion = 1;\r\n  private storeName = 'order';\r\n\r\n  private socket: Socket | null = null;\r\n  private reconnectAttempts = 0;\r\n  private maxReconnectAttempts = 5;\r\n  private reconnectDelay = 1000;\r\n  private socketInitialized = false;\r\n\r\n  // Real-time event subjects\r\n  private orderCreatedSubject = new Subject<any>();\r\n  private orderUpdatedSubject = new Subject<any>();\r\n  private orderDeletedSubject = new Subject<string>();\r\n  private syncCompletedSubject = new Subject<void>();\r\n\r\n  // Public observables\r\n  public orderCreated$ = this.orderCreatedSubject.asObservable();\r\n  public orderUpdated$ = this.orderUpdatedSubject.asObservable();\r\n  public orderDeleted$ = this.orderDeletedSubject.asObservable();\r\n  public syncCompleted$ = this.syncCompletedSubject.asObservable();\r\n\r\n  private lastSyncTimestamp: Date | null = null;\r\n  private syncInProgress = false;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private indexedDBService: IndexedDBService,\r\n    private timeZoneService: TimeZoneService,\r\n    private firebaseService: FirebaseService\r\n  ) {}\r\n\r\n  ngOnInit() {}\r\n\r\n  async initDB(): Promise<void> {\r\n    try {\r\n      await this.indexedDBService.getDB(this.dbName, this.dbVersion, (db) => {\r\n        if (!db.objectStoreNames.contains(this.storeName)) {\r\n          db.createObjectStore(this.storeName, { keyPath: 'id' });\r\n        }\r\n      });\r\n    } catch (error) {\r\n      console.error('❌ Error initializing IndexedDB:', error);\r\n    }\r\n  }\r\n\r\n  // CRUD for IndexedDB\r\n  async getOrderFromDBById(id: string): Promise<any | undefined> {\r\n    return await this.indexedDBService.getByKey(\r\n      this.dbName,\r\n      this.dbVersion,\r\n      this.storeName,\r\n      id\r\n    );\r\n  }\r\n\r\n  async getAllOrdersFromDB(): Promise<any[]> {\r\n    return await this.indexedDBService.getAll(\r\n      this.dbName,\r\n      this.dbVersion,\r\n      this.storeName\r\n    );\r\n  }\r\n\r\n  async addOrderToDB(order: any): Promise<void> {\r\n    await this.indexedDBService.put(\r\n      this.dbName,\r\n      this.dbVersion,\r\n      this.storeName,\r\n      order\r\n    );\r\n  }\r\n\r\n  async updateOrderInDB(order: any): Promise<void> {\r\n    await this.indexedDBService.put(\r\n      this.dbName,\r\n      this.dbVersion,\r\n      this.storeName,\r\n      order\r\n    );\r\n  }\r\n\r\n  async deleteOrderFromDB(id: string): Promise<void> {\r\n    await this.indexedDBService.delete(\r\n      this.dbName,\r\n      this.dbVersion,\r\n      this.storeName,\r\n      id\r\n    );\r\n  }\r\n\r\n  async clearAllOrdersFromDB(): Promise<void> {\r\n    await this.indexedDBService.clear(\r\n      this.dbName,\r\n      this.dbVersion,\r\n      this.storeName\r\n    );\r\n  }\r\n\r\n  // API methods (TODO: update endpoints when backend is ready)\r\n  addOrderToFirestore(orderData: any): Observable<any> {\r\n    return this.http.post(`${environment.domainUrl}/api/firebase/add_order`, orderData);\r\n  }\r\n\r\n  updateOrderToFirestore(orderId: string, updates: any): Observable<any> {\r\n    return this.http.put(`${environment.domainUrl}/api/firebase/update_order/${orderId}`, updates);\r\n  }\r\n\r\n  getAllOrdersFromFirestore(): Observable<any> {\r\n    return this.http.get(`${environment.domainUrl}/api/firebase/orders`);\r\n  }\r\n\r\n  deleteOrderToFirestore(orderId: string): Observable<any> {\r\n    return this.http.delete(`${environment.domainUrl}/api/firebase/orders/${orderId}`);\r\n  }\r\n\r\n  getOrderByIdFromFirestore(orderId: string): Observable<any> {\r\n    return this.http.get(`${environment.domainUrl}/api/firebase/orders/${orderId}`);\r\n  }\r\n\r\n  getOrdersByDateFromFirestore(date: string): Observable<any> {\r\n    return this.http.get(`${environment.domainUrl}/api/firebase/orders/date`, {\r\n      params: { date }\r\n    });\r\n  }\r\n\r\n  // IndexedDB filter by date\r\n  async getOrdersByDateFromDB(date: Date): Promise<any[]> {\r\n    const allOrders = await this.getAllOrdersFromDB();\r\n    const startOfDay = new Date(date);\r\n    startOfDay.setHours(0, 0, 0, 0);\r\n    const endOfDay = new Date(date);\r\n    endOfDay.setHours(23, 59, 59, 999);\r\n    return allOrders.filter(order => {\r\n      if (!order.createdDate) return false;\r\n      try {\r\n        const orderDate = new Date(order.createdDate);\r\n        if (isNaN(orderDate.getTime())) return false;\r\n        return orderDate >= startOfDay && orderDate <= endOfDay;\r\n      } catch {\r\n        return false;\r\n      }\r\n    });\r\n  }\r\n\r\n  // WebSocket logic\r\n  private async initializeSocketIfNeeded(): Promise<void> {\r\n    if (this.socketInitialized && this.socket && this.socket.connected) {\r\n      return;\r\n    }\r\n    try {\r\n      this.socketInitialized = true;\r\n      this.socket = io(environment.domainUrl + '/api/websocket/orders', {\r\n        path: '/socket.io',\r\n        transports: ['websocket', 'polling'],\r\n        autoConnect: true,\r\n        reconnection: true,\r\n        reconnectionAttempts: this.maxReconnectAttempts,\r\n        reconnectionDelay: this.reconnectDelay,\r\n      });\r\n      if (this.socket) {\r\n        this.socket.on('connect', () => {\r\n          this.reconnectAttempts = 0;\r\n        });\r\n        this.socket.on('disconnect', () => {});\r\n        this.socket.on('connect_error', (error) => {\r\n          console.error('❌ Order WebSocket connection error:', error);\r\n        });\r\n        this.socket.on('order_created', (payload: any) => {\r\n          const order = payload.data || payload;\r\n          if (order && order.id) {\r\n            this.handleOrderCreated(order);\r\n          }\r\n        });\r\n        this.socket.on('order_updated', (payload: any) => {\r\n          const order = payload.data || payload;\r\n          if (order && order.id) {\r\n            this.handleOrderUpdated(order);\r\n          }\r\n        });\r\n        this.socket.on('order_deleted', (payload: any) => {\r\n          const orderId = payload.data || payload;\r\n          if (orderId) {\r\n            this.handleOrderDeleted(orderId);\r\n          }\r\n        });\r\n        this.socket.on('sync_request', (payload: any) => {\r\n          this.handleSyncRequest(payload);\r\n        });\r\n      }\r\n    } catch (error) {\r\n      this.socketInitialized = false;\r\n    }\r\n  }\r\n\r\n  private async handleOrderCreated(order: any): Promise<void> {\r\n    try {\r\n      const existing = await this.getOrderFromDBById(order.id);\r\n      if (!existing) {\r\n        await this.addOrderToDB(order);\r\n        this.orderCreatedSubject.next(order);\r\n      }\r\n    } catch (error) {\r\n      console.error('❌ Error handling order created:', error);\r\n    }\r\n  }\r\n\r\n  private async handleOrderUpdated(order: any): Promise<void> {\r\n    try {\r\n      await this.updateOrderInDB(order);\r\n      this.orderUpdatedSubject.next(order);\r\n    } catch (error) {\r\n      console.error('❌ Error handling order updated:', error);\r\n    }\r\n  }\r\n\r\n  private async handleOrderDeleted(orderId: string): Promise<void> {\r\n    try {\r\n      await this.deleteOrderFromDB(orderId);\r\n      this.orderDeletedSubject.next(orderId);\r\n    } catch (error) {\r\n      console.error('❌ Error handling order deleted:', error);\r\n    }\r\n  }\r\n\r\n  private async handleSyncRequest(data: any): Promise<void> {\r\n    try {\r\n      const localOrders = await this.getAllOrdersFromDB();\r\n      this.sendSocketMessage('sync_response', {\r\n        orders: localOrders,\r\n        timestamp: new Date().toISOString()\r\n      });\r\n    } catch (error) {\r\n      console.error('❌ Error handling sync request:', error);\r\n    }\r\n  }\r\n\r\n  private async sendSocketMessage(event: string, data: any): Promise<void> {\r\n    try {\r\n      await this.initializeSocketIfNeeded();\r\n      if (this.socket && this.socket.connected) {\r\n        this.socket.emit(event, data);\r\n      }\r\n    } catch (error) {}\r\n  }\r\n\r\n  // Public WebSocket methods\r\n  public async notifyOrderCreated(order: any): Promise<void> {\r\n    try {\r\n      await this.sendSocketMessage('order_created', order);\r\n    } catch (error) {}\r\n  }\r\n  public async notifyOrderUpdated(order: any): Promise<void> {\r\n    try {\r\n      await this.sendSocketMessage('order_updated', order);\r\n    } catch (error) {}\r\n  }\r\n  public async notifyOrderDeleted(orderId: string): Promise<void> {\r\n    try {\r\n      await this.sendSocketMessage('order_deleted', orderId);\r\n    } catch (error) {}\r\n  }\r\n  public disconnectSocket(): void {\r\n    if (this.socket) {\r\n      this.socket.disconnect();\r\n      this.socket = null;\r\n      this.socketInitialized = false;\r\n    }\r\n  }\r\n  public async initializeWebSocket(): Promise<void> {\r\n    await this.initializeSocketIfNeeded();\r\n  }\r\n  public isWebSocketConnected(): boolean {\r\n    return this.socketInitialized && this.socket !== null && this.socket.connected;\r\n  }\r\n  public getWebSocketStatus(): { connected: boolean; initialized: boolean; socketExists: boolean } {\r\n    return {\r\n      connected: this.socket?.connected || false,\r\n      initialized: this.socketInitialized,\r\n      socketExists: this.socket !== null\r\n    };\r\n  }\r\n  public async getLastSyncTime(): Promise<Date | null> {\r\n    if (this.lastSyncTimestamp) {\r\n      return this.lastSyncTimestamp;\r\n    }\r\n    return null;\r\n  }\r\n  public async needsSync(): Promise<boolean> {\r\n    // TODO: Implement logic to check if sync is needed\r\n    return true;\r\n  }\r\n  // Sync logic (placeholder)\r\n  public async syncOrdersBetweenFirestoreAndIndexedDB(forceFullSync = false): Promise<void> {\r\n    try {\r\n      // 1. Lấy tất cả order từ Firestore\r\n      const ordersResponse = await firstValueFrom(this.getAllOrdersFromFirestore());\r\n      let orders: any[] = [];\r\n      if (Array.isArray(ordersResponse)) {\r\n        orders = ordersResponse;\r\n      } else if (ordersResponse && Array.isArray(ordersResponse.data)) {\r\n        orders = ordersResponse.data;\r\n      } else if (ordersResponse && Array.isArray(ordersResponse.orders)) {\r\n        orders = ordersResponse.orders;\r\n      } else if (ordersResponse && typeof ordersResponse === 'object') {\r\n        // fallback: flatten all values\r\n        orders = Object.values(ordersResponse).flat();\r\n      }\r\n      // 2. Xóa hết order cũ nếu forceFullSync\r\n      if (forceFullSync) {\r\n        await this.clearAllOrdersFromDB();\r\n      }\r\n      // 3. Lưu từng order vào IndexedDB\r\n      if (orders && orders.length > 0) {\r\n        for (const order of orders) {\r\n          await this.addOrderToDB(order);\r\n        }\r\n        console.log(`✅ Đã đồng bộ ${orders.length} order từ Firestore vào IndexedDB`);\r\n      } else {\r\n        console.log('ℹ️ Không có order nào từ Firestore');\r\n      }\r\n      this.syncCompletedSubject.next();\r\n    } catch (error) {\r\n      console.error('❌ Lỗi khi đồng bộ order từ Firestore về IndexedDB:', error);\r\n      this.syncCompletedSubject.next();\r\n    }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\services\\print.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\services\\product.service.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'forkJoin' is defined but never used.","line":4,"column":26,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":34},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'switchMap' is defined but never used.","line":4,"column":41,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":50},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":30,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1196,1199],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1196,1199],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":59,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":59,"endColumn":29},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":60,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":60,"endColumn":34},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":61,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":61,"endColumn":47},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":62,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":62,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":63,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":63,"endColumn":45},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":568,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":568,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21439,21442],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21439,21442],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":690,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":690,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25906,25909],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25906,25909],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":752,"column":104,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":752,"endColumn":107,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27536,27539],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27536,27539],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":752,"column":121,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":752,"endColumn":124,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27553,27556],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27553,27556],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'manuallyEditedIds' is defined but never used.","line":752,"column":131,"nodeType":null,"messageId":"unusedVar","endLine":752,"endColumn":148},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":752,"column":172,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":752,"endColumn":175,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27604,27607],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27604,27607],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1478,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1478,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[54724,54727],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[54724,54727],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1484,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1484,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[54944,54947],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[54944,54947],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1511,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1511,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[56058,56061],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[56058,56061],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1515,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1515,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[56199,56202],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[56199,56202],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1525,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1525,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[56572,56575],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[56572,56575],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1527,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1527,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[56665,56668],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[56665,56668],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1530,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1530,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[56788,56791],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[56788,56791],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1539,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1539,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[57096,57099],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[57096,57099],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1548,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1548,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[57670,57673],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[57670,57673],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1552,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1552,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[57816,57819],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[57816,57819],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1557,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1557,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[58137,58140],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[58137,58140],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1558,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1558,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[58215,58218],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[58215,58218],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1562,"column":77,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1562,"endColumn":80,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[58344,58347],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[58344,58347],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1562,"column":118,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1562,"endColumn":121,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[58385,58388],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[58385,58388],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1563,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1563,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[58445,58448],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[58445,58448],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":1588,"column":25,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":1588,"endColumn":124},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1588,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1588,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[59793,59796],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[59793,59796],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1588,"column":98,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1588,"endColumn":101,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[59843,59846],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[59843,59846],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":1588,"column":133,"nodeType":null,"messageId":"unusedVar","endLine":1588,"endColumn":134},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":1588,"column":135,"nodeType":"BlockStatement","messageId":"unexpected","endLine":1588,"endColumn":137,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[59881,59881],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":1589,"column":25,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":1589,"endColumn":108},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1589,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1589,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[59930,59933],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[59930,59933],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1589,"column":90,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1589,"endColumn":93,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[59972,59975],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[59972,59975],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":1589,"column":117,"nodeType":null,"messageId":"unusedVar","endLine":1589,"endColumn":118},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":1589,"column":119,"nodeType":"BlockStatement","messageId":"unexpected","endLine":1589,"endColumn":121,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[60002,60002],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1607,"column":169,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1607,"endColumn":172,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[61117,61120],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[61117,61120],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":1614,"column":65,"nodeType":null,"messageId":"unusedVar","endLine":1614,"endColumn":66},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1627,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1627,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[62224,62227],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[62224,62227],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1628,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1628,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[62374,62377],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[62374,62377],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1653,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1653,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[63688,63691],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[63688,63691],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1698,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1698,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[65702,65705],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[65702,65705],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1702,"column":113,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1702,"endColumn":116,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[65982,65985],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[65982,65985],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1719,"column":122,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1719,"endColumn":125,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[66722,66725],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[66722,66725],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1769,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1769,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[68915,68918],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[68915,68918],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1769,"column":92,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1769,"endColumn":95,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[68973,68976],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[68973,68976],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1814,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1814,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[70922,70925],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[70922,70925],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1814,"column":88,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1814,"endColumn":91,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[70978,70981],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[70978,70981],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":51,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@angular/core';\nimport { Product } from '../models/product.model';\nimport { HttpClient } from '@angular/common/http';\nimport { firstValueFrom, forkJoin, map, switchMap } from 'rxjs';\nimport { environment } from '../../environments/environment';\nimport { catchError, of } from 'rxjs';\nimport { VietnameseService } from '../services/vietnamese.service';\nimport { KiotvietService } from '../services/kiotviet.service';\nimport { FirebaseService } from '../services/firebase.service';\nimport { IndexedDBService } from './indexed-db.service';\nimport { Observable } from 'rxjs';\nimport { InvoiceTab } from '../models/invoice.model';\nimport { io, Socket } from 'socket.io-client';\nimport { Subject } from 'rxjs';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class ProductService {\n  private dbName = 'SalesDB';\n  private dbVersion = 1;\n  private storeName = 'products';\n\n  // Cache mechanism để tránh gọi API trùng lặp\n  private firebaseProductsCache: Product[] | null = null;\n  private cacheTimestamp = 0;\n  private readonly CACHE_DURATION = 5 * 60 * 1000; // 5 phút\n\n  // Debounce mechanism để tránh gọi saveAllProductsToFirebase trùng lặp\n  private saveToFirebaseTimeout: any = null;\n  private pendingProductsToSave: Product[] = [];\n  private isSavingToFirebase = false;\n\n  // Counter để theo dõi số lần gọi API\n  private apiCallCount = 0;\n  private cacheHitCount = 0;\n\n  // Shared Promise để tránh gọi API đồng thời\n  private currentFirebaseRequest: Promise<Product[]> | null = null;\n\n  // WebSocket fields (rewrite)\n  private productSocket: Socket | null = null;\n  private productSocketInitialized = false;\n  private productReconnectAttempts = 0;\n  private readonly productMaxReconnectAttempts = 5;\n  private readonly productReconnectDelay = 1000;\n  // Flag to indicate we've already tried a polling-only fallback\n  private productPollingFallbackTried = false;\n  // Queue for pending notifications when socket/http unavailable\n  private pendingOnHandNotifications: { productId: number; onHand: number; timestamp: number }[] = [];\n\n  // Real-time event subjects\n  private productOnHandUpdatedSubject = new Subject<{ productId: number, onHand: number }>();\n\n  // Public observable for components\n  public productOnHandUpdated$ = this.productOnHandUpdatedSubject.asObservable();\n\n  constructor(\n    private http: HttpClient,\n    private vi: VietnameseService,\n    private indexedDBService: IndexedDBService,\n    private kiotvietService: KiotvietService,\n    private firebaseService: FirebaseService\n  ) {\n    // Không gọi initDB() nặng trong constructor vì có thể gây lỗi,\n    // nhưng khởi tạo websocket nhẹ sau 500ms để các service khác sẵn sàng.\n    setTimeout(() => this.initializeProductWebSocket(), 500);\n  }\n  \n  async initDB(): Promise<void> {\n    try {\n      console.log('🔄 Khởi tạo ProductService IndexedDB...');\n\n      // Khởi tạo database với upgrade function\n      await this.indexedDBService.getDB(this.dbName, this.dbVersion, (db) => {\n        console.log(`📦 Đang tạo object store '${this.storeName}' cho database '${this.dbName}' v${this.dbVersion}`);\n\n        if (!db.objectStoreNames.contains(this.storeName)) {\n          const store = db.createObjectStore(this.storeName, { keyPath: 'Id' });\n          store.createIndex('Name', 'Name', { unique: false });\n          store.createIndex('MasterProductId', 'MasterProductId', { unique: false });\n          store.createIndex('Code', 'Code', { unique: false });\n\n        } else {\n          console.log(`ℹ️ Object store '${this.storeName}' đã tồn tại`);\n        }\n        if (!db.objectStoreNames.contains('outofstock')) {\n          const outofstore = db.createObjectStore('outofstock', { keyPath: 'Code' });\n          outofstore.createIndex('FullName', 'FullName', { unique: false });\n          console.log(`✅ Đã tạo object store 'outofstock' thành công`);\n        }\n        if (!db.objectStoreNames.contains('order')) {\n          const outofstore = db.createObjectStore('order', { keyPath: 'id' });\n          outofstore.createIndex('name', 'name', { unique: false });\n          outofstore.createIndex('TotalPrice', 'totalPrice', { unique: false });\n          console.log(`✅ Đã tạo object store 'order' thành công`);\n        }\n      });\n\n      console.log('✅ ProductService IndexedDB đã sẵn sàng');\n    } catch (error) {\n      console.error('❌ Lỗi khi khởi tạo ProductService IndexedDB:', error);\n      throw error;\n    }\n  }\n\n  // Method để kiểm tra và đảm bảo IndexedDB đã được khởi tạo\n  private async ensureDBInitialized(): Promise<void> {\n    try {\n      // Kiểm tra xem connection có tồn tại và mở không\n      if (!this.indexedDBService.isConnectionOpen(this.dbName)) {\n        console.log('🔄 IndexedDB chưa được khởi tạo, đang khởi tạo...');\n        await this.initDB();\n      }\n\n      // Kiểm tra xem object store có tồn tại không\n      const storeExists = await this.indexedDBService.checkObjectStoreExists(this.dbName, this.dbVersion, this.storeName);\n      if (!storeExists) {\n        console.warn(`⚠️ Object store '${this.storeName}' không tồn tại, đang khởi tạo lại...`);\n        await this.initDB();\n      }\n    } catch (error) {\n      console.error('❌ Lỗi khi đảm bảo IndexedDB được khởi tạo:', error);\n      // Thử khởi tạo lại\n      await this.initDB();\n    }\n  }\n\n  // Refactored: Accept apiProducts as optional parameter\n  async loadItemsFromKiotVietToIndexedDB(apiProducts?: Product[]): Promise<void> {\n    // Đảm bảo IndexedDB đã được khởi tạo\n    await this.ensureDBInitialized();\n\n    let allProducts: Product[];\n    if (apiProducts) {\n      allProducts = apiProducts;\n    } else {\n      // Gọi API lấy toàn bộ sản phẩm từ KiotViet\n      allProducts = await firstValueFrom(\n        this.http.get<Product[]>(`${environment.domainUrl}${this.kiotvietService.kiotviet_items_api}`).pipe(\n          catchError((err) => {\n            console.error('❌ Lỗi khi tải tất cả sản phẩm từ KiotViet:', err);\n            return of([]);\n          })\n        )\n      ) ?? [];\n    }\n\n    if (allProducts.length === 0) {\n      console.log('ℹ️ Không có sản phẩm nào từ KiotViet');\n      return;\n    }\n\n    console.log(`📦 Nhận được ${allProducts.length} sản phẩm từ KiotViet`);\n\n    // Lọc và validate products\n    const validProducts = allProducts.filter(product => {\n      if (!product || !product.Id) {\n        console.warn('⚠️ Product không hợp lệ:', product);\n        return false;\n      }\n      return true;\n    });\n\n    if (validProducts.length === 0) {\n      console.warn('⚠️ Không có products hợp lệ nào từ KiotViet');\n      return;\n    }\n\n    console.log(`✅ Có ${validProducts.length} products hợp lệ từ KiotViet`);\n\n    // Lấy toàn bộ sản phẩm đang có trong IndexedDB\n    const existingProducts: Product[] = await this.indexedDBService.getAll(\n      this.dbName,\n      this.dbVersion,\n      this.storeName\n    );\n\n    console.log(`📋 Có ${existingProducts.length} products trong IndexedDB`);\n\n    // ✅ Thực hiện cleanup: xóa products trong IndexedDB mà không có trong API\n    await this.cleanupOrphanedProducts(existingProducts, validProducts);\n\n    const existingMap = new Map(existingProducts.map(p => [p.Id, p]));\n\n    // Chuẩn bị danh sách sản phẩm cần cập nhật\n    const productsToUpdate: Product[] = [];\n\n    for (const product of validProducts) {\n      const existing = existingMap.get(product.Id);\n\n      // Tạo bản sao của product để không ảnh hưởng đến dữ liệu gốc\n      const productToUpdate = { ...product };\n\n      if (existing) {\n        // Kiểm tra xem có thay đổi gì không (trừ OnHand)\n        const hasChanges = this.hasProductChanges(existing, product);\n        if (hasChanges) {\n          console.log(`🔄 Phát hiện thay đổi cho product ${product.Id} (${product.Name})`);\n          this.logProductChanges(existing, product);\n          productsToUpdate.push(productToUpdate);\n        } else {\n          console.log(`ℹ️ Product ${product.Id} (${product.Name}) không có thay đổi`);\n        }\n      } else {\n        // Product mới, thêm vào danh sách cập nhật\n        console.log(`🆕 Thêm product mới: ${product.Id} (${product.Name})`);\n        productsToUpdate.push(productToUpdate);\n      }\n    }\n\n    // Cập nhật nhiều sản phẩm cùng lúc nếu có thay đổi\n    if (productsToUpdate.length > 0) {\n      console.log(`🔄 Cập nhật ${productsToUpdate.length} sản phẩm vào IndexedDB...`);\n\n      await this.indexedDBService.putMany(\n        this.dbName,\n        this.dbVersion,\n        this.storeName,\n        productsToUpdate\n      );\n\n      console.log(`✅ Đã cập nhật ${productsToUpdate.length} sản phẩm từ KiotViet vào IndexedDB`);\n\n      // Đồng bộ lên Firestore (không thay đổi OnHand)\n      console.log('🔄 Đồng bộ sản phẩm lên Firestore...');\n      await this.syncProductsToFirestoreWithoutOnHand(productsToUpdate);\n\n      // Đợi một chút để Firestore được cập nhật\n      console.log('⏳ Đợi Firestore cập nhật...');\n      await new Promise(resolve => setTimeout(resolve, 2000));\n\n      // Sync từ Firestore về IndexedDB để đảm bảo dữ liệu đồng bộ\n      // Chỉ sync nếu cache quá cũ hoặc không có cache\n      if (this.shouldClearCache()) {\n        console.log('🔄 Cache quá cũ, sync từ Firestore về IndexedDB...');\n        await this.syncProductsFromFirebaseToIndexedDB();\n      } else {\n        console.log('ℹ️ Cache còn mới, bỏ qua sync từ Firestore về IndexedDB');\n      }\n\n    } else {\n      console.log('ℹ️ Tất cả sản phẩm đã được đồng bộ, không cần cập nhật');\n    }\n  }\n\n  // ✅ Method mới để cleanup products trong IndexedDB mà không có trong API\n  private async cleanupOrphanedProducts(existingProducts: Product[], apiProducts: Product[]): Promise<void> {\n    try {\n      console.log('🧹 Bắt đầu cleanup orphaned products...');\n\n      // Tạo Set các product IDs từ API để tìm kiếm nhanh\n      const apiProductIds = new Set(apiProducts.map(p => p.Id));\n      \n      // Tìm products trong IndexedDB mà không có trong API\n      const orphanedProducts = existingProducts.filter(existingProduct => \n        !apiProductIds.has(existingProduct.Id)\n      );\n\n      if (orphanedProducts.length === 0) {\n        console.log('✅ Không có orphaned products cần xóa');\n        return;\n      }\n\n      console.log(`🗑️ Tìm thấy ${orphanedProducts.length} orphaned products cần xóa:`);\n      orphanedProducts.forEach(product => {\n        console.log(`   - ${product.Id}: ${product.Name} (${product.Code})`);\n      });\n\n      // Xóa từng orphaned product khỏi IndexedDB\n      const deletedIds: number[] = [];\n      for (const orphanedProduct of orphanedProducts) {\n        try {\n          await this.indexedDBService.delete(\n            this.dbName,\n            this.dbVersion,\n            this.storeName,\n            orphanedProduct.Id\n          );\n          deletedIds.push(orphanedProduct.Id);\n          console.log(`✅ Đã xóa orphaned product: ${orphanedProduct.Id} - ${orphanedProduct.Name}`);\n        } catch (error) {\n          console.error(`❌ Lỗi khi xóa orphaned product ${orphanedProduct.Id}:`, error);\n        }\n      }\n\n      console.log(`✅ Cleanup hoàn thành: đã xóa ${deletedIds.length}/${orphanedProducts.length} orphaned products`);\n\n      // ✅ Đồng bộ việc xóa lên Firestore\n      if (deletedIds.length > 0) {\n        console.log('🔄 Đồng bộ việc xóa orphaned products lên Firestore...');\n        await this.syncDeletedProductsToFirestore(deletedIds);\n      }\n\n    } catch (error) {\n      console.error('❌ Lỗi khi cleanup orphaned products:', error);\n      throw error;\n    }\n  }\n\n  // ✅ Method để đồng bộ việc xóa products lên Firestore\n  private async syncDeletedProductsToFirestore(deletedProductIds: number[]): Promise<void> {\n    try {\n      console.log(`🔄 Đồng bộ việc xóa ${deletedProductIds.length} products lên Firestore...`);\n      \n      // Gọi API để xóa products khỏi Firestore\n      const response = await firstValueFrom(\n        this.http.post(`${environment.domainUrl}${this.firebaseService.delete_products_batch_from_firebase}`, {\n          productIds: deletedProductIds\n        })\n      );\n\n      console.log(`✅ Đã đồng bộ việc xóa ${deletedProductIds.length} products lên Firestore:`, response);\n\n    } catch (error) {\n      console.error('❌ Lỗi khi đồng bộ việc xóa products lên Firestore:', error);\n      // Không throw error để không ảnh hưởng đến quá trình chính\n    }\n  }\n\n  // Refactored: Accept apiProducts as optional parameter\n  public async cleanupOrphanedProductsFromAPI(apiProducts?: Product[]): Promise<{ deletedCount: number; totalChecked: number }> {\n    try {\n      await this.ensureDBInitialized();\n\n      let productsFromAPI: Product[];\n      if (apiProducts) {\n        productsFromAPI = apiProducts;\n      } else {\n        // Lấy products từ API nếu chưa truyền vào\n        productsFromAPI = await firstValueFrom(\n          this.http.get<Product[]>(`${environment.domainUrl}${this.kiotvietService.kiotviet_items_api}`).pipe(\n            catchError((err) => {\n              console.error('❌ Lỗi khi tải products từ API:', err);\n              return of([]);\n            })\n          )\n        ) ?? [];\n      }\n\n      if (productsFromAPI.length === 0) {\n        console.log('ℹ️ Không có products nào từ API');\n        return { deletedCount: 0, totalChecked: 0 };\n      }\n\n      // Lọc valid products\n      const validApiProducts = productsFromAPI.filter(product => product && product.Id);\n      console.log(`📦 Nhận được ${validApiProducts.length} valid products từ API`);\n\n      // Lấy products từ IndexedDB\n      const existingProducts = await this.getAllProductsFromIndexedDB();\n      console.log(`📋 Có ${existingProducts.length} products trong IndexedDB`);\n\n      // Thực hiện cleanup\n      await this.cleanupOrphanedProducts(existingProducts, validApiProducts);\n\n      // Đếm số lượng đã xóa\n      const apiProductIds = new Set(validApiProducts.map(p => p.Id));\n      const orphanedProducts = existingProducts.filter(existingProduct => \n        !apiProductIds.has(existingProduct.Id)\n      );\n\n      return {\n        deletedCount: orphanedProducts.length,\n        totalChecked: existingProducts.length\n      };\n\n    } catch (error) {\n      console.error('❌ Lỗi khi cleanup orphaned products từ API:', error);\n      throw error;\n    }\n  }\n\n  // ✅ Method để kiểm tra orphaned products mà không xóa\n  public async checkOrphanedProducts(): Promise<{ orphanedCount: number; totalInIndexedDB: number; totalInAPI: number; orphanedProducts: Product[] }> {\n    try {\n      await this.ensureDBInitialized();\n\n      console.log('🔍 Kiểm tra orphaned products...');\n\n      // Lấy products từ API\n      const apiProducts = await firstValueFrom(\n        this.http.get<Product[]>(`${environment.domainUrl}${this.kiotvietService.kiotviet_items_api}`).pipe(\n          catchError((err) => {\n            console.error('❌ Lỗi khi tải products từ API:', err);\n            return of([]);\n          })\n        )\n      ) ?? [];\n\n      // Lọc valid products\n      const validApiProducts = apiProducts.filter(product => product && product.Id);\n      console.log(`📦 Nhận được ${validApiProducts.length} valid products từ API`);\n\n      // Lấy products từ IndexedDB\n      const existingProducts = await this.getAllProductsFromIndexedDB();\n      console.log(`📋 Có ${existingProducts.length} products trong IndexedDB`);\n\n      // Tìm orphaned products\n      const apiProductIds = new Set(validApiProducts.map(p => p.Id));\n      const orphanedProducts = existingProducts.filter(existingProduct => \n        !apiProductIds.has(existingProduct.Id)\n      );\n\n      console.log(`🔍 Tìm thấy ${orphanedProducts.length} orphaned products`);\n\n      return {\n        orphanedCount: orphanedProducts.length,\n        totalInIndexedDB: existingProducts.length,\n        totalInAPI: validApiProducts.length,\n        orphanedProducts: orphanedProducts\n      };\n\n    } catch (error) {\n      console.error('❌ Lỗi khi kiểm tra orphaned products:', error);\n      throw error;\n    }\n  }\n\n  // Method mới để đồng bộ sản phẩm lên Firestore mà không thay đổi OnHand\n  private async syncProductsToFirestoreWithoutOnHand(products: Product[]): Promise<void> {\n    try {\n      console.log(`🔄 Chuẩn bị đồng bộ ${products.length} sản phẩm lên Firestore...`);\n\n      // Lấy OnHand hiện tại từ Firestore cho các sản phẩm cần cập nhật\n      const firebaseProducts = await this.getProductsFromFirebaseWithCache();\n      const firebaseMap = new Map(firebaseProducts.map(p => [p.Id, p]));\n\n      // Chuẩn bị danh sách sản phẩm để gửi lên Firestore\n      const productsForFirestore: Product[] = [];\n\n      for (const product of products) {\n        const firebaseProduct = firebaseMap.get(product.Id);\n\n        // Tạo bản sao của product\n        const productForFirestore = { ...product };\n\n        if (firebaseProduct) {\n          productForFirestore.OnHand = firebaseProduct.OnHand;\n        }\n\n        productsForFirestore.push(productForFirestore);\n      }\n\n      // Sử dụng debounce mechanism thay vì gọi trực tiếp\n      await this.debouncedSaveToFirebase(productsForFirestore);\n\n      console.log(`✅ Đã chuẩn bị đồng bộ ${productsForFirestore.length} sản phẩm lên Firestore (sẽ được gửi sau 1 giây)`);\n\n    } catch (error) {\n      console.error('❌ Lỗi khi chuẩn bị đồng bộ sản phẩm lên Firestore:', error);\n      throw error;\n    }\n  }\n\n  async syncProductsFromFirebaseToIndexedDB(): Promise<void> {\n    try {\n      // Đảm bảo IndexedDB đã được khởi tạo\n      await this.ensureDBInitialized();\n\n      console.log('🔄 Bắt đầu đồng bộ products từ Firebase về IndexedDB...');\n\n      // Lấy tất cả products từ Firebase (sử dụng cache nếu có)\n      const allProducts = await this.getProductsFromFirebaseWithCache();\n      console.log('🔎 [DEBUG] syncProductsFromFirebaseToIndexedDB: nhận được', (allProducts && allProducts.length) || 0, 'products từ Firebase');\n\n      if (!allProducts || allProducts.length === 0) {\n        console.log('ℹ️ Không có products nào từ Firebase');\n        return;\n      }\n\n      console.log(`📦 Nhận được ${allProducts.length} products từ Firebase`);\n\n      // Lọc và validate products\n      const validProducts = allProducts.filter(product => {\n        if (!product || !product.Id) {\n          console.warn('⚠️ Product không hợp lệ:', product);\n          return false;\n        }\n        return true;\n      });\n\n      if (validProducts.length === 0) {\n        console.warn('⚠️ Không có products hợp lệ nào từ Firebase');\n        return;\n      }\n\n      console.log(`✅ Có ${validProducts.length} products hợp lệ`);\n\n      // Lấy products hiện tại từ IndexedDB\n      const existingProducts: Product[] = await this.indexedDBService.getAll(\n        this.dbName,\n        this.dbVersion,\n        this.storeName\n      );\n\n      console.log(`📋 Có ${existingProducts.length} products trong IndexedDB`);\n\n      // Tạo map để so sánh nhanh\n      const existingMap = new Map(existingProducts.map(p => [p.Id, p]));\n      const productsToUpdate: Product[] = [];\n\n      // So sánh và tìm products cần cập nhật\n      for (const product of validProducts) {\n        const existing = existingMap.get(product.Id);\n\n        if (existing) {\n          // Tạo bản sao của product từ Firestore\n          const productToUpdate = { ...product };\n\n          // Kiểm tra xem có thay đổi gì không (trừ OnHand)\n          const hasChanges = this.hasProductChanges(existing, product);\n          if (hasChanges) {\n            console.log(`🔄 Phát hiện thay đổi từ Firestore cho product ${product.Id} (${product.Name})`);\n            this.logProductChanges(existing, product);\n            this.logOnHandComparison(product.Id, existing.OnHand, productToUpdate.OnHand, 'Firestore->IndexedDB');\n            productsToUpdate.push(productToUpdate);\n          } else {\n            console.log(`ℹ️ Product ${product.Id} (${product.Name}) không có thay đổi từ Firestore`);\n            this.logOnHandComparison(product.Id, existing.OnHand, productToUpdate.OnHand, 'Firestore->IndexedDB (no changes)');\n          }\n        } else {\n          // Product mới từ Firestore\n          productsToUpdate.push(product);\n        }\n      }\n\n      if (productsToUpdate.length > 0) {\n        console.log(`🔄 Cập nhật ${productsToUpdate.length} products vào IndexedDB...`);\n\n        // Cập nhật nhiều products cùng lúc\n        await this.indexedDBService.putMany(\n          this.dbName,\n          this.dbVersion,\n          this.storeName,\n          productsToUpdate\n        );\n\n        console.log(`✅ Đã cập nhật thành công ${productsToUpdate.length} products từ Firebase vào IndexedDB`);\n      } else {\n        console.log('ℹ️ Tất cả products đã được đồng bộ, không cần cập nhật');\n      }\n\n    } catch (error) {\n      console.error('❌ Lỗi khi đồng bộ products từ Firebase:', error);\n      throw error; // Re-throw để component có thể xử lý\n    }\n  }\n\n  async syncAllProductsFromIndexedDBToFirebase(): Promise<void> {\n    try {\n      const allProducts = await this.getAllProductsFromIndexedDB();\n      if (allProducts.length > 0) {\n        console.log(`🔄 Chuẩn bị đồng bộ ${allProducts.length} sản phẩm từ IndexedDB lên Firebase...`);\n\n        // Sử dụng debounce mechanism thay vì gọi trực tiếp\n        await this.debouncedSaveToFirebase(allProducts);\n\n        console.log(`✅ Đã chuẩn bị đồng bộ ${allProducts.length} sản phẩm từ IndexedDB lên Firebase (sẽ được gửi sau 1 giây)`);\n      } else {\n        console.log('Không có sản phẩm nào trong IndexedDB để đồng bộ.');\n      }\n    } catch (error) {\n      console.error('❌ Lỗi khi chuẩn bị đồng bộ sản phẩm từ IndexedDB lên Firebase:', error);\n    }\n  }\n\n  saveAllProductsToFirebase(products: Product[]): Observable<any> {\n    return this.http.put(`${environment.domainUrl}${this.firebaseService.post_all_products_indexedDB_firebase}`, products);\n  }\n\n  getAllProductsFromFirebase(): Observable<Product[]> {\n    // Sử dụng cache nếu có và còn hợp lệ\n    const now = Date.now();\n    if (this.firebaseProductsCache && (now - this.cacheTimestamp) < this.CACHE_DURATION) {\n      console.log('📦 Sử dụng cache cho getAllProductsFromFirebase');\n      this.cacheHitCount++;\n      this.logCacheUsage('getAllProductsFromFirebase', true, this.firebaseProductsCache.length);\n      return of(this.firebaseProductsCache);\n    }\n\n    // Cache hết hạn hoặc chưa có, gọi API mới\n    console.log('🔄 Gọi API Firebase để lấy products mới (getAllProductsFromFirebase)');\n    this.apiCallCount++;\n    return this.getAllProductsFromFirebaseAPI().pipe(\n      map(products => {\n        this.firebaseProductsCache = products || [];\n        this.cacheTimestamp = now;\n        console.log(`📦 Đã cache ${this.firebaseProductsCache.length} products từ Firebase (getAllProductsFromFirebase)`);\n        this.logCacheUsage('getAllProductsFromFirebase', false, this.firebaseProductsCache.length);\n        return this.firebaseProductsCache;\n      }),\n      catchError((error) => {\n        console.error('❌ Lỗi khi lấy products từ Firebase (getAllProductsFromFirebase):', error);\n        // Trả về cache cũ nếu có, hoặc array rỗng\n        const fallbackProducts = this.firebaseProductsCache || [];\n        this.logCacheUsage('getAllProductsFromFirebase_fallback', true, fallbackProducts.length);\n        return of(fallbackProducts);\n      })\n    );\n  }\n\n  // Method private để gọi API thực tế\n  private getAllProductsFromFirebaseAPI(): Observable<Product[]> {\n    return this.http.get<Product[]>(`${environment.domainUrl}${this.firebaseService.get_all_products_from_firebase}`).pipe(\n      catchError((err) => {\n        console.error('❌ Lỗi khi tải tất cả sản phẩm từ Firebase API:', err);\n        return of([]);\n      })\n    );\n  }\n\n  async loadProductsIfNotExist(searchTerm: string): Promise<Product[] | null> {\n    await this.ensureDBInitialized();\n\n    const existingProducts: Product[] = await this.indexedDBService.getAll(\n      this.dbName,\n      this.dbVersion,\n      this.storeName\n    );\n\n    const existing = existingProducts.find(\n      p => p.Code?.trim().toLowerCase() === searchTerm.toLowerCase() ||\n        p.Name?.trim().toLowerCase() === searchTerm.toLowerCase()\n    );\n\n    // Nếu đã tồn tại thì return null\n    if (existing) {\n      return null;\n    }\n\n    // Logic để load từ API nếu cần (có thể bổ sung thêm)\n    // Hiện tại chỉ return null nếu không tìm thấy\n    return null;\n  }\n\n  async searchProducts(query: string): Promise<Product[]> {\n    await this.ensureDBInitialized();\n\n    const allProducts: Product[] = await this.indexedDBService.getAll(\n      this.dbName,\n      this.dbVersion,\n      this.storeName\n    );\n\n    const queryTokens = this.vi.normalizeAndTokenize(query);\n    const queryStr = queryTokens.join(' ').toLowerCase();\n    const rawQuery = query.toLowerCase();\n\n    // 1. Sản phẩm có tên bắt đầu bằng searchTerm\n    const startsWithMatches = allProducts.filter(product =>\n      this.vi.normalizeAndTokenize(product.Name).join(' ').toLowerCase().startsWith(queryStr)\n    );\n\n    // 2. Sản phẩm có tên chứa searchTerm (nhưng không bắt đầu)\n    const containsNameMatches = allProducts.filter(product =>\n      !startsWithMatches.includes(product) &&\n      (\n        this.vi.normalizeAndTokenize(product.Name).join(' ').toLowerCase().includes(queryStr) ||\n        product.Name.toLowerCase().includes(rawQuery)\n      )\n    );\n\n    // 3. Sản phẩm có mã chứa searchTerm (nhưng không nằm trong 2 nhóm trên)\n    const codeMatches = allProducts.filter(product => {\n      if (startsWithMatches.includes(product) || containsNameMatches.includes(product)) {\n        return false;\n      }\n\n      const productCode = product.Code?.toLowerCase() || '';\n\n      // Kiểm tra nếu query có dạng \"XXXXXXX-X\" (có chứa dấu gạch ngang)\n      if (rawQuery.includes('-')) {\n        const baseQuery = rawQuery.split('-')[0]; // Lấy phần trước dấu gạch ngang\n        return productCode === baseQuery;\n      }\n\n      return productCode.includes(rawQuery);\n    });\n\n    // Gộp lại theo đúng độ ưu tiên\n    const products = [\n      ...startsWithMatches,\n      ...containsNameMatches,\n      ...codeMatches\n    ];\n\n    return products;\n  }\n  updateProductsOnHandFromInvoice(invoice: InvoiceTab): Observable<any> {\n    return this.http.put(`${environment.domainUrl}/api/firebase/products/update_onhand_from_invoice`, invoice);\n  }\n  // Thêm các method tiện ích khác\n  async getProductByIdFromIndexedDB(id: number): Promise<Product | undefined> {\n    await this.ensureDBInitialized();\n    return await this.indexedDBService.getByKey(\n      this.dbName,\n      this.dbVersion,\n      this.storeName,\n      id\n    );\n  }\n\n  async addProductFromIndexedDB(product: Product): Promise<void> {\n    await this.ensureDBInitialized();\n    await this.indexedDBService.put(\n      this.dbName,\n      this.dbVersion,\n      this.storeName,\n      product\n    );\n  }\n\n  async updateProductFromIndexedDB(product: Product): Promise<void> {\n    await this.ensureDBInitialized();\n    await this.indexedDBService.put(\n      this.dbName,\n      this.dbVersion,\n      this.storeName,\n      product\n    );\n  }\n\n  async deleteProductFromIndexedDB(id: number): Promise<void> {\n    await this.ensureDBInitialized();\n    await this.indexedDBService.delete(\n      this.dbName,\n      this.dbVersion,\n      this.storeName,\n      id\n    );\n  }\n\n  async clearAllProductsFromIndexedDB(): Promise<void> {\n    await this.ensureDBInitialized();\n    await this.indexedDBService.clear(\n      this.dbName,\n      this.dbVersion,\n      this.storeName\n    );\n  }\n\n  async getAllProductsFromIndexedDB(): Promise<Product[]> {\n    await this.ensureDBInitialized();\n    return await this.indexedDBService.getAll(\n      this.dbName,\n      this.dbVersion,\n      this.storeName\n    );\n  }\n\n  async updateProductsOnHandFromInvoiceToFireBase(invoice: InvoiceTab, groupedProducts: { [x: string]: any;[x: number]: any[]; }, manuallyEditedIds: Set<number>): Promise<any> {\n    // ✅ Lấy OnHand hiện tại từ IndexedDB để đảm bảo đồng bộ với confirmEditOnHand\n\n    const currentOnHandMap: Record<number, number> = {};\n\n    // Lấy tất cả product IDs cần cập nhật\n    const productIds = new Set<number>();\n    for (const cartItem of invoice.cartItems) {\n      const masterUnitId = cartItem.product.MasterUnitId || cartItem.product.Id;\n      const group = groupedProducts[masterUnitId];\n      if (group) {\n        group.forEach(product => productIds.add(product.Id));\n      }\n    }\n\n    // Lấy OnHand hiện tại từ IndexedDB\n    for (const productId of productIds) {\n      const product = await this.getProductByIdFromIndexedDB(productId);\n      if (product) {\n        currentOnHandMap[productId] = product.OnHand;\n      }\n    }\n\n    // Tạo map để gom các cập nhật onHand cho từng productId\n    const updates: Record<number, number> = {};\n\n    for (const cartItem of invoice.cartItems) {\n      const masterUnitId = cartItem.product.MasterUnitId || cartItem.product.Id;\n      const group = groupedProducts[masterUnitId];\n      if (!group) continue;\n\n      // Số lượng quy đổi về đơn vị nhỏ nhất (master)\n      const masterQty = cartItem.quantity * cartItem.product.ConversionValue;\n\n      for (const product of group) {\n        // if (manuallyEditedIds.has(product.Id)) {\n        //   console.log(`⚠️ Bỏ qua product ${product.Id} (đã chỉnh tay)`);\n        //   continue;\n        // }\n        // Số lượng bị trừ cho từng sản phẩm trong group\n        const minus = masterQty / product.ConversionValue;\n        // Cộng dồn nếu 1 sản phẩm xuất hiện nhiều lần trong cart\n        updates[product.Id] = (updates[product.Id] || 0) + minus;\n      }\n    }\n\n    // ✅ Chuẩn bị payload với OnHand hiện tại và số lượng trừ\n    const updatePayload = Object.entries(updates).map(([productId, minus]) => ({\n      productId: Number(productId),\n      currentOnHand: currentOnHandMap[Number(productId)] || 0,\n      minus: minus,\n      newOnHand: (currentOnHandMap[Number(productId)] || 0) - minus\n    }));\n\n    console.log('🔄 Cập nhật OnHand cho Firestore:', updatePayload);\n\n    return await this.http.put(`${environment.domainUrl}/api/firebase/products/update_onhand_batch`, updatePayload).toPromise();\n  }\n\n  async updateProductOnHandLocal(productId: number, onHand: number): Promise<void> {\n    await this.ensureDBInitialized();\n    const product = await this.indexedDBService.getByKey(this.dbName, this.dbVersion, this.storeName, productId);\n    if (product) {\n      product.OnHand = onHand;\n      await this.indexedDBService.put(this.dbName, this.dbVersion, this.storeName, product);\n    }\n  }\n\n  // Method để cập nhật OnHand cho nhiều sản phẩm cùng lúc\n  async updateProductsOnHandLocal(products: Product[]): Promise<void> {\n    await this.ensureDBInitialized();\n\n    if (!products || products.length === 0) {\n      console.warn('⚠️ Không có sản phẩm nào để cập nhật OnHand');\n      return;\n    }\n\n    console.log(`🔄 Cập nhật OnHand cho ${products.length} sản phẩm...`);\n\n    // Cập nhật tất cả sản phẩm cùng lúc\n    await this.indexedDBService.putMany(\n      this.dbName,\n      this.dbVersion,\n      this.storeName,\n      products\n    );\n\n    console.log(`✅ Đã cập nhật OnHand cho ${products.length} sản phẩm`);\n  }\n\n  // Method để kiểm tra trạng thái đồng bộ với cache (không gọi API nếu cache còn hợp lệ)\n  async getSyncStatusWithCache(): Promise<{ totalInFirebase: number; totalInIndexedDB: number; needsSync: boolean; usedCache: boolean }> {\n    try {\n      await this.ensureDBInitialized();\n\n      const cacheInfo = this.getDetailedCacheInfo();\n      let firebaseProducts: Product[] = [];\n      let usedCache = false;\n\n      if (cacheInfo.hasCache && !cacheInfo.isExpired) {\n        // Sử dụng cache nếu còn hợp lệ\n        firebaseProducts = this.firebaseProductsCache || [];\n        usedCache = true;\n        console.log(`📦 Sử dụng cache cho sync status: ${firebaseProducts.length} products`);\n      } else {\n        // Chỉ gọi API nếu cache không có hoặc đã hết hạn\n        firebaseProducts = await this.getProductsFromFirebaseWithCache();\n        usedCache = false;\n      }\n\n      const indexedDBProducts = await this.getAllProductsFromIndexedDB();\n\n      // Log cache usage\n      this.logCacheUsage('getSyncStatus', usedCache, firebaseProducts.length);\n\n      return {\n        totalInFirebase: firebaseProducts?.length || 0,\n        totalInIndexedDB: indexedDBProducts?.length || 0,\n        needsSync: (firebaseProducts?.length || 0) > (indexedDBProducts?.length || 0),\n        usedCache: usedCache\n      };\n    } catch (error) {\n      console.error('❌ Lỗi khi kiểm tra trạng thái đồng bộ:', error);\n      return { totalInFirebase: 0, totalInIndexedDB: 0, needsSync: false, usedCache: false };\n    }\n  }\n\n  // Method để kiểm tra trạng thái đồng bộ\n  async getSyncStatus(): Promise<{ totalInFirebase: number; totalInIndexedDB: number; needsSync: boolean }> {\n    try {\n      await this.ensureDBInitialized();\n\n      // Kiểm tra cache trước khi gọi API\n      const cacheInfo = this.getDetailedCacheInfo();\n      let firebaseProducts: Product[] = [];\n\n      if (cacheInfo.hasCache && !cacheInfo.isExpired) {\n        // Sử dụng cache nếu còn hợp lệ\n        firebaseProducts = this.firebaseProductsCache || [];\n        console.log(`📦 Sử dụng cache cho sync status check: ${firebaseProducts.length} products`);\n      } else {\n        // Chỉ gọi API nếu cache không có hoặc đã hết hạn\n        firebaseProducts = await this.getProductsFromFirebaseWithCache();\n      }\n\n      const indexedDBProducts = await this.getAllProductsFromIndexedDB();\n\n      return {\n        totalInFirebase: firebaseProducts?.length || 0,\n        totalInIndexedDB: indexedDBProducts?.length || 0,\n        needsSync: (firebaseProducts?.length || 0) > (indexedDBProducts?.length || 0)\n      };\n    } catch (error) {\n      console.error('❌ Lỗi khi kiểm tra trạng thái đồng bộ:', error);\n      return { totalInFirebase: 0, totalInIndexedDB: 0, needsSync: false };\n    }\n  }\n\n  // Method để force sync tất cả products từ Firebase (bỏ qua so sánh)\n  async forceSyncAllProductsFromFirebase(): Promise<void> {\n    try {\n      await this.ensureDBInitialized();\n\n      console.log('🔄 Force sync tất cả products từ Firebase...');\n\n      // Force refresh cache và lấy products mới\n      this.clearFirebaseCache();\n      const allProducts = await this.getProductsFromFirebaseWithCache();\n\n      if (!allProducts || allProducts.length === 0) {\n        console.log('ℹ️ Không có products nào từ Firebase');\n        return;\n      }\n\n      const validProducts = allProducts.filter(product => product && product.Id);\n\n      if (validProducts.length > 0) {\n        // Xóa tất cả products cũ và thêm mới\n        await this.indexedDBService.clear(this.dbName, this.dbVersion, this.storeName);\n        await this.indexedDBService.putMany(this.dbName, this.dbVersion, this.storeName, validProducts);\n\n        console.log(`✅ Force sync thành công: ${validProducts.length} products`);\n      }\n    } catch (error) {\n      console.error('❌ Lỗi khi force sync products:', error);\n      throw error;\n    }\n  }\n\n  // Method để force refresh cache (public)\n  public async refreshFirebaseCache(): Promise<void> {\n    this.clearFirebaseCache();\n    await this.getProductsFromFirebaseWithCache();\n  }\n\n  // Method để kiểm tra trạng thái cache\n  public getCacheStatus(): { hasCache: boolean; cacheAge: number; cacheSize: number } {\n    const now = Date.now();\n    const cacheAge = now - this.cacheTimestamp;\n\n    return {\n      hasCache: this.firebaseProductsCache !== null,\n      cacheAge: cacheAge,\n      cacheSize: this.firebaseProductsCache?.length || 0\n    };\n  }\n\n  // Method để lấy thông tin cache chi tiết\n  public getDetailedCacheInfo(): {\n    hasCache: boolean;\n    cacheAge: number;\n    cacheSize: number;\n    isExpired: boolean;\n    timeUntilExpiry: number;\n  } {\n    const now = Date.now();\n    const cacheAge = now - this.cacheTimestamp;\n    const isExpired = cacheAge >= this.CACHE_DURATION;\n    const timeUntilExpiry = Math.max(0, this.CACHE_DURATION - cacheAge);\n\n    return {\n      hasCache: this.firebaseProductsCache !== null,\n      cacheAge: cacheAge,\n      cacheSize: this.firebaseProductsCache?.length || 0,\n      isExpired: isExpired,\n      timeUntilExpiry: timeUntilExpiry\n    };\n  }\n\n  // Method để lấy products từ Firebase với cache\n  private async getProductsFromFirebaseWithCache(): Promise<Product[]> {\n    const now = Date.now();\n\n    // Kiểm tra cache có hợp lệ không\n    if (this.firebaseProductsCache && (now - this.cacheTimestamp) < this.CACHE_DURATION) {\n      console.log('📦 Sử dụng cache cho getProductsFromFirebaseWithCache');\n      this.cacheHitCount++;\n      this.logCacheUsage('getProductsFromFirebaseWithCache', true, this.firebaseProductsCache.length);\n      return this.firebaseProductsCache;\n    }\n\n    // Nếu đang có request đang chạy, đợi kết quả\n    if (this.currentFirebaseRequest) {\n      console.log('⏳ Đợi request Firebase đang chạy...');\n      try {\n        const products = await this.currentFirebaseRequest;\n        console.log(`📦 Nhận kết quả từ request đang chạy: ${products.length} products`);\n        return products;\n      } catch (error) {\n        console.error('❌ Lỗi từ request đang chạy:', error);\n        // Nếu request đang chạy bị lỗi, tiếp tục với request mới\n      }\n    }\n\n    // Cache hết hạn hoặc chưa có, tạo request mới\n    console.log('🔄 Tạo request Firebase mới (getProductsFromFirebaseWithCache)');\n    this.currentFirebaseRequest = this.fetchProductsFromFirebase();\n\n    try {\n      const products = await this.currentFirebaseRequest;\n      console.log(`📦 Đã nhận ${products.length} products từ request mới (getProductsFromFirebaseWithCache)`);\n      this.logCacheUsage('getProductsFromFirebaseWithCache', false, products.length);\n      return products;\n    } catch (error) {\n      console.error('❌ Lỗi khi lấy products từ request mới (getProductsFromFirebaseWithCache):', error);\n      // Trả về cache cũ nếu có, hoặc array rỗng\n      const fallbackProducts = this.firebaseProductsCache || [];\n      this.logCacheUsage('getProductsFromFirebaseWithCache_fallback', true, fallbackProducts.length);\n      return fallbackProducts;\n    } finally {\n      // Clear request đang chạy\n      this.currentFirebaseRequest = null;\n    }\n  }\n\n  // Method private để thực hiện việc fetch products từ Firebase\n   private async fetchProductsFromFirebase(): Promise<Product[]> {\n    try {\n      console.log('🔎 [DEBUG] fetchProductsFromFirebase: gọi getAllProductsFromFirebase API');\n      const products = await firstValueFrom(this.getAllProductsFromFirebase());\n      console.log(`🔎 [DEBUG] fetchProductsFromFirebase: API trả về ${Array.isArray(products) ? products.length : 'non-array'} items`);\n      return Array.isArray(products) ? products : [];\n    } catch (error) {\n      console.error('❌ Lỗi trong fetchProductsFromFirebase:', error);\n      return []; // trả về mảng rỗng để không làm sập luồng\n    }\n  }\n\n  // Clear cache khi cần thiết\n  private clearFirebaseCache(): void {\n    this.firebaseProductsCache = null;\n    this.cacheTimestamp = 0;\n    this.currentFirebaseRequest = null; // Clear shared request\n    console.log('🗑️ Đã xóa cache Firebase products và shared request');\n  }\n\n  // Method để force clear shared request\n  public forceClearSharedRequest(): void {\n    this.currentFirebaseRequest = null;\n    console.log('🔄 Đã force clear shared Firebase request');\n  }\n\n  // Method để force clear cache khi thực sự cần thiết\n  public forceClearCache(): void {\n    this.clearFirebaseCache();\n    console.log('🔄 Đã force clear Firebase cache');\n  }\n\n  // Method để kiểm tra xem có cần clear cache không\n  private shouldClearCache(): boolean {\n    const cacheInfo = this.getDetailedCacheInfo();\n    // Chỉ clear cache nếu cache quá cũ (hơn 10 phút) hoặc không có cache\n    return !cacheInfo.hasCache || cacheInfo.cacheAge > 10 * 60 * 1000;\n  }\n\n  // Method để reset database (xóa và tạo lại)\n  async resetDatabase(): Promise<void> {\n    try {\n      console.log('🔄 Reset ProductService IndexedDB...');\n\n      // Đóng connection hiện tại nếu có\n      await this.indexedDBService.closeDB(this.dbName);\n\n      // Tăng version để force upgrade\n      this.dbVersion++;\n      console.log(`📦 Tăng database version lên ${this.dbVersion}`);\n\n      // Khởi tạo lại database\n      await this.initDB();\n\n      console.log('✅ ProductService IndexedDB đã được reset thành công');\n    } catch (error) {\n      console.error('❌ Lỗi khi reset ProductService IndexedDB:', error);\n      throw error;\n    }\n  }\n\n  // Method để debug trạng thái database\n  async debugDatabaseStatus(): Promise<void> {\n    try {\n      console.log('🔍 Debug ProductService IndexedDB status...');\n\n      const connectionInfo = this.indexedDBService.getConnectionInfo(this.dbName);\n      console.log(`📊 Connection info:`, connectionInfo);\n\n      const objectStores = await this.indexedDBService.getObjectStoreNames(this.dbName, this.dbVersion);\n      console.log(`📦 Object stores:`, objectStores);\n\n      const storeExists = await this.indexedDBService.checkObjectStoreExists(this.dbName, this.dbVersion, this.storeName);\n      console.log(`🔍 Store '${this.storeName}' exists:`, storeExists);\n\n      if (storeExists) {\n        try {\n          const products = await this.getAllProductsFromIndexedDB();\n          console.log(`📦 Products count: ${products.length}`);\n        } catch (error) {\n          console.error('❌ Không thể đọc products:', error);\n        }\n      }\n    } catch (error) {\n      console.error('❌ Lỗi khi debug database status:', error);\n    }\n  }\n\n  // Method để log cache usage\n  private logCacheUsage(operation: string, usedCache: boolean, productCount: number): void {\n    const cacheInfo = this.getDetailedCacheInfo();\n    console.log(`📊 Cache Usage [${operation}] - Used Cache: ${usedCache}, Products: ${productCount}, Cache Age: ${Math.round(cacheInfo.cacheAge / 1000)}s, Expired: ${cacheInfo.isExpired}`);\n  }\n\n  // Method để preload cache (gọi trước khi thực hiện các operation khác)\n  async preloadFirebaseCache(): Promise<void> {\n    try {\n      console.log('🔄 Preloading Firebase cache...');\n      const cacheInfo = this.getDetailedCacheInfo();\n\n      if (!cacheInfo.hasCache || cacheInfo.isExpired) {\n        console.log('📦 Cache không hợp lệ, bắt đầu preload...');\n        await this.getProductsFromFirebaseWithCache(); // Sử dụng shared request mechanism\n        console.log('✅ Firebase cache đã được preload');\n      } else {\n        console.log('ℹ️ Firebase cache đã có và còn hợp lệ, bỏ qua preload');\n      }\n    } catch (error) {\n      console.error('❌ Lỗi khi preload Firebase cache:', error);\n    }\n  }\n\n  // Method để preload cache với force refresh\n  async forcePreloadFirebaseCache(): Promise<void> {\n    try {\n      console.log('🔄 Force preloading Firebase cache...');\n      this.clearFirebaseCache(); // Clear cache và shared request\n      await this.getProductsFromFirebaseWithCache(); // Tạo request mới\n      console.log('✅ Firebase cache đã được force preload');\n    } catch (error) {\n      console.error('❌ Lỗi khi force preload Firebase cache:', error);\n    }\n  }\n\n  // Method mới để xử lý việc gửi lên Firestore với debounce\n  public async debouncedSaveToFirebase(products: Product[], delay = 1000): Promise<void> {\n    // Thêm products vào danh sách chờ\n    this.pendingProductsToSave.push(...products);\n\n    // Clear timeout cũ nếu có\n    if (this.saveToFirebaseTimeout) {\n      clearTimeout(this.saveToFirebaseTimeout);\n    }\n\n    // Set timeout mới\n    this.saveToFirebaseTimeout = setTimeout(async () => {\n      await this.executeSaveToFirebase();\n    }, delay);\n  }\n\n  // Method để thực hiện việc gửi lên Firestore\n  private async executeSaveToFirebase(): Promise<void> {\n    if (this.isSavingToFirebase || this.pendingProductsToSave.length === 0) {\n      return;\n    }\n\n    try {\n      this.isSavingToFirebase = true;\n\n      // Lấy tất cả products chờ và xóa danh sách chờ\n      const productsToSave = [...this.pendingProductsToSave];\n      this.pendingProductsToSave = [];\n\n      console.log(`🔄 Thực hiện gửi ${productsToSave.length} sản phẩm lên Firestore...`);\n\n      // Loại bỏ duplicates dựa trên Id\n      const uniqueProducts = this.removeDuplicateProducts(productsToSave);\n\n      if (uniqueProducts.length > 0) {\n        await firstValueFrom(this.saveAllProductsToFirebase(uniqueProducts));\n        console.log(`✅ Đã gửi thành công ${uniqueProducts.length} sản phẩm lên Firestore`);\n\n        // Không clear cache ngay lập tức để tránh gọi API trùng lặp\n        // Cache sẽ được clear khi cần thiết hoặc khi hết hạn\n      }\n\n    } catch (error) {\n      console.error('❌ Lỗi khi gửi sản phẩm lên Firestore:', error);\n      // Thêm lại products vào danh sách chờ nếu có lỗi\n      this.pendingProductsToSave.unshift(...this.pendingProductsToSave);\n    } finally {\n      this.isSavingToFirebase = false;\n    }\n  }\n\n  // Method để loại bỏ products trùng lặp\n  private removeDuplicateProducts(products: Product[]): Product[] {\n    const uniqueMap = new Map<number, Product>();\n\n    for (const product of products) {\n      if (product.Id) {\n        uniqueMap.set(product.Id, product);\n      }\n    }\n\n    return Array.from(uniqueMap.values());\n  }\n\n  // Method để force execute save to Firebase ngay lập tức\n  public async forceExecuteSaveToFirebase(): Promise<void> {\n    // Clear timeout nếu có\n    if (this.saveToFirebaseTimeout) {\n      clearTimeout(this.saveToFirebaseTimeout);\n      this.saveToFirebaseTimeout = null;\n    }\n\n    // Execute ngay lập tức\n    await this.executeSaveToFirebase();\n  }\n\n  // Method để lấy trạng thái của debounce mechanism\n  public getSaveToFirebaseStatus(): {\n    isSaving: boolean;\n    pendingCount: number;\n    hasTimeout: boolean;\n  } {\n    return {\n      isSaving: this.isSavingToFirebase,\n      pendingCount: this.pendingProductsToSave.length,\n      hasTimeout: this.saveToFirebaseTimeout !== null\n    };\n  }\n\n  // Method để kiểm tra xem có thay đổi gì không (trừ OnHand)\n  private hasProductChanges(existing: Product, newProduct: Product): boolean {\n    // Danh sách các trường quan trọng cần so sánh\n    const importantFields: (keyof Product)[] = [\n      'Name', 'FullName', 'Code', 'Cost', 'BasePrice', 'Unit',\n      'Description', 'CategoryId', 'MasterUnitId', 'MasterProductId',\n      'ConversionValue', 'IsRewardPoint', 'isActive', 'isDeleted',\n      'Image', 'ProductAttributes', 'NormalizedName', 'NormalizedCode',\n      'OrderTemplate', 'ModifiedDate', 'CreatedDate'\n    ];\n\n    let hasChanges = false;\n    const changes: string[] = [];\n\n    for (const field of importantFields) {\n      const existingValue = existing[field];\n      const newValue = newProduct[field];\n\n      // So sánh giá trị\n      if (existingValue !== newValue) {\n        changes.push(`${field}: ${existingValue} -> ${newValue}`);\n        hasChanges = true;\n      }\n    }\n\n    if (hasChanges) {\n      console.log(`📊 Thay đổi cho product ${newProduct.Id} (${newProduct.Name}):`, changes.join(', '));\n    }\n\n    return hasChanges;\n  }\n\n  // Method để log chi tiết thay đổi của product\n  private logProductChanges(existing: Product, newProduct: Product): void {\n    console.log(`🔍 Chi tiết thay đổi cho product ${newProduct.Id}:`);\n    console.log(`   Tên: ${existing.Name} -> ${newProduct.Name}`);\n    console.log(`   Mã: ${existing.Code} -> ${newProduct.Code}`);\n    console.log(`   Giá gốc: ${existing.Cost} -> ${newProduct.Cost}`);\n    console.log(`   Giá bán: ${existing.BasePrice} -> ${newProduct.BasePrice}`);\n    console.log(`   Đơn vị: ${existing.Unit} -> ${newProduct.Unit}`);\n    console.log(`   OnHand: ${existing.OnHand} -> ${newProduct.OnHand}`);\n  }\n\n  // Method để log OnHand trước và sau khi sync\n  private logOnHandComparison(productId: number, beforeOnHand: number, afterOnHand: number, source: string): void {\n    if (beforeOnHand !== afterOnHand) {\n      console.warn(`⚠️ OnHand thay đổi cho product ${productId}: ${beforeOnHand} -> ${afterOnHand} (${source})`);\n    } else {\n      console.log(`✅ OnHand giữ nguyên cho product ${productId}: ${beforeOnHand} (${source})`);\n    }\n  }\n\n  // Method để debug OnHand trong toàn bộ quá trình\n  public async debugOnHandForProduct(productId: number): Promise<void> {\n    try {\n      console.log(`🔍 Debug OnHand cho product ${productId}:`);\n\n      // Lấy từ IndexedDB\n      const indexedDBProduct = await this.getProductByIdFromIndexedDB(productId);\n      console.log(`   IndexedDB OnHand: ${indexedDBProduct?.OnHand || 'N/A'}`);\n\n      // Lấy từ Firestore (force clear cache)\n      this.clearFirebaseCache();\n      const firebaseProducts = await this.getProductsFromFirebaseWithCache();\n      const firebaseProduct = firebaseProducts.find(p => p.Id === productId);\n      console.log(`   Firestore OnHand: ${firebaseProduct?.OnHand || 'N/A'}`);\n\n      // So sánh\n      if (indexedDBProduct && firebaseProduct) {\n        if (indexedDBProduct.OnHand === firebaseProduct.OnHand) {\n          console.log(`   ✅ OnHand đồng bộ: ${indexedDBProduct.OnHand}`);\n        } else {\n          console.warn(`   ⚠️ OnHand không đồng bộ: IndexedDB=${indexedDBProduct.OnHand}, Firestore=${firebaseProduct.OnHand}`);\n        }\n      }\n\n    } catch (error) {\n      console.error(`❌ Lỗi khi debug OnHand cho product ${productId}:`, error);\n    }\n  }\n\n  // Method để force sync OnHand từ IndexedDB lên Firestore\n  public async forceSyncOnHandToFirestore(): Promise<void> {\n    try {\n      console.log('🔄 Force sync OnHand từ IndexedDB lên Firestore...');\n\n      // Lấy tất cả products từ IndexedDB\n      const indexedDBProducts = await this.getAllProductsFromIndexedDB();\n\n      if (indexedDBProducts.length === 0) {\n        console.log('ℹ️ Không có products nào trong IndexedDB');\n        return;\n      }\n\n      // Lấy products từ Firestore\n      this.clearFirebaseCache();\n      const firebaseProducts = await this.getProductsFromFirebaseWithCache();\n      const firebaseMap = new Map(firebaseProducts.map(p => [p.Id, p]));\n\n      // Chuẩn bị products để gửi lên Firestore\n      const productsToSync: Product[] = [];\n\n      for (const indexedDBProduct of indexedDBProducts) {\n        const firebaseProduct = firebaseMap.get(indexedDBProduct.Id);\n\n        if (firebaseProduct) {\n          // Tạo bản sao từ Firestore và cập nhật OnHand\n          const productToSync = { ...firebaseProduct };\n          productToSync.OnHand = indexedDBProduct.OnHand;\n\n          if (firebaseProduct.OnHand !== indexedDBProduct.OnHand) {\n            console.log(`🔄 Sync OnHand cho product ${indexedDBProduct.Id}: ${firebaseProduct.OnHand} -> ${indexedDBProduct.OnHand}`);\n            productsToSync.push(productToSync);\n          }\n        }\n      }\n\n      if (productsToSync.length > 0) {\n        console.log(`🔄 Gửi ${productsToSync.length} products với OnHand đã cập nhật lên Firestore...`);\n        await this.debouncedSaveToFirebase(productsToSync);\n        console.log(`✅ Đã force sync OnHand cho ${productsToSync.length} products`);\n      } else {\n        console.log('ℹ️ Tất cả OnHand đã đồng bộ, không cần cập nhật');\n      }\n\n    } catch (error) {\n      console.error('❌ Lỗi khi force sync OnHand:', error);\n      throw error;\n    }\n  }\n\n  // Method để lấy trạng thái cache performance\n  public getCachePerformanceStats(): {\n    apiCallCount: number;\n    cacheHitCount: number;\n    cacheHitRate: number;\n    cacheAge: number;\n    cacheSize: number;\n    isExpired: boolean;\n  } {\n    const totalCalls = this.apiCallCount + this.cacheHitCount;\n    const cacheHitRate = totalCalls > 0 ? (this.cacheHitCount / totalCalls) * 100 : 0;\n    const cacheInfo = this.getDetailedCacheInfo();\n\n    return {\n      apiCallCount: this.apiCallCount,\n      cacheHitCount: this.cacheHitCount,\n      cacheHitRate: Math.round(cacheHitRate * 100) / 100, // Làm tròn 2 chữ số thập phân\n      cacheAge: cacheInfo.cacheAge,\n      cacheSize: cacheInfo.cacheSize,\n      isExpired: cacheInfo.isExpired\n    };\n  }\n\n  // Method để reset cache performance stats\n  public resetCachePerformanceStats(): void {\n    this.apiCallCount = 0;\n    this.cacheHitCount = 0;\n    console.log('🔄 Đã reset cache performance stats');\n  }\n\n  // Method để log cache performance stats\n  public logCachePerformanceStats(): void {\n    const stats = this.getCachePerformanceStats();\n    console.log('📊 Cache Performance Stats:');\n    console.log(`   API Calls: ${stats.apiCallCount}`);\n    console.log(`   Cache Hits: ${stats.cacheHitCount}`);\n    console.log(`   Cache Hit Rate: ${stats.cacheHitRate}%`);\n    console.log(`   Cache Age: ${Math.round(stats.cacheAge / 1000)}s`);\n    console.log(`   Cache Size: ${stats.cacheSize} products`);\n    console.log(`   Cache Expired: ${stats.isExpired}`);\n    console.log(`   Shared Request Active: ${this.currentFirebaseRequest !== null}`);\n  }\n\n  // Method để lấy trạng thái shared request\n  public getSharedRequestStatus(): {\n    hasActiveRequest: boolean;\n    cacheStatus: string;\n    requestCount: number;\n  } {\n    const cacheInfo = this.getDetailedCacheInfo();\n    let cacheStatus = 'No Cache';\n\n    if (cacheInfo.hasCache) {\n      if (cacheInfo.isExpired) {\n        cacheStatus = 'Expired';\n      } else {\n        cacheStatus = 'Valid';\n      }\n    }\n\n    return {\n      hasActiveRequest: this.currentFirebaseRequest !== null,\n      cacheStatus: cacheStatus,\n      requestCount: this.apiCallCount\n    };\n  }\n\n  // Method để debug API calls\n  public debugAPICalls(): void {\n    const stats = this.getCachePerformanceStats();\n    const status = this.getSharedRequestStatus();\n\n    console.log('🔍 API Calls Debug:');\n    console.log(`   Total API Calls: ${stats.apiCallCount}`);\n    console.log(`   Cache Hits: ${stats.cacheHitCount}`);\n    console.log(`   Cache Hit Rate: ${stats.cacheHitRate}%`);\n    console.log(`   Active Request: ${status.hasActiveRequest}`);\n    console.log(`   Cache Status: ${status.cacheStatus}`);\n    console.log(`   Should Clear Cache: ${this.shouldClearCache()}`);\n  }\n\n  async updateProductOnHandToFireStore(products: Product[]): Promise<void> {\n    const minimalProducts = products.map(p => ({ Id: p.Id, OnHand: p.OnHand }));\n    const url = `${environment.domainUrl}/api/firebase/update/products`;\n    const t0 = performance.now();\n    await this.http.put(url, minimalProducts).toPromise();\n    const t1 = performance.now();\n    console.log(`⏱️ Gửi lên Firestore (API /api/firebase/update/products) mất ${t1 - t0} ms`);\n  }\n\n  public async updateProductsBatchToFirebase(groupedProducts: Record<string, Product[]>): Promise<void> {\n    // Nếu API backend nhận object group, gửi trực tiếp:\n    // Nếu API backend chỉ nhận array, cần chuyển về array:\n    // const allProducts: Product[] = Object.values(groupedProducts).flat();\n\n    const url = `${environment.domainUrl}${this.firebaseService.update_multi_products_by_id_to_firebase}`;\n    try {\n      await this.http.put(url, groupedProducts).toPromise();\n      console.log('✅ Đã gửi batch sản phẩm lên Firestore thành công!');\n    } catch (error) {\n      console.error('❌ Lỗi khi gửi batch sản phẩm lên Firestore:', error);\n      throw error;\n    }\n  }\n\n  // Lưu đơn đặt hàng vào IndexedDB\n  async addOrderToIndexedDB(order: any): Promise<void> {\n    await this.ensureDBInitialized();\n    await this.indexedDBService.put('SalesDB', 1, 'order', order);\n  }\n\n  // Lấy toàn bộ đơn đặt hàng từ IndexedDB\n  async getAllOrdersFromIndexedDB(): Promise<any[]> {\n    await this.ensureDBInitialized();\n    return await this.indexedDBService.getAll('SalesDB', 1, 'order');\n  }\n\n  // ======= WebSocket Real-time Sync Methods (Rewrite) =======\n\n  private async initializeProductSocketIfNeeded(): Promise<void> {\n    if (this.productSocketInitialized && this.productSocket && this.productSocket.connected) {\n      return; // Already connected\n    }\n    try {\n      this.productSocketInitialized = true;\n      const socketUrl = environment.domainUrl + '/api/websocket/products';\n      console.log('ℹ️ Initializing Product WebSocket to', socketUrl);\n      // Force polling-only transport to avoid websocket handshake issues in restrictive networks\n      this.productSocket = io(socketUrl, {\n        path: '/socket.io',\n        transports: ['polling'],\n        upgrade: false,\n        autoConnect: true,\n        reconnection: true,\n        reconnectionAttempts: this.productMaxReconnectAttempts,\n        reconnectionDelay: this.productReconnectDelay,\n      });\n      if (this.productSocket) {\n        // Extra diagnostic listeners\n        this.productSocket.on('error', (err: any) => {\n          console.error('❌ Product socket error event:', err);\n        });\n\n        this.productSocket.on('reconnect_error', (err: any) => {\n          console.error('❌ Product socket reconnect_error event:', err);\n        });\n\n        this.productSocket.on('reconnect_failed', () => {\n          console.error('❌ Product socket reconnect_failed');\n        });\n\n        // If engine exists, listen for low-level packets to see server responses\n        try {\n          const engine = (this.productSocket as any)?.io?.engine;\n          if (engine && engine.on) {\n            engine.on('packet', (pkt: any) => {\n              console.log('🔍 engine packet:', pkt);\n            });\n            engine.on('packetCreate', (pkt: any) => {\n              console.log('🔍 engine packetCreate:', pkt);\n            });\n          }\n        } catch (e) {\n          console.warn('⚠️ Unable to attach engine packet listeners', e);\n        }\n\n        this.productSocket.on('connect', () => {\n          const transportName = (this.productSocket as any)?.io?.engine?.transport?.name || 'unknown';\n          console.log('🔌 Product WebSocket connected (transport =', transportName, ')');\n          this.productReconnectAttempts = 0;\n          // reset polling fallback flag when successfully connected\n          this.productPollingFallbackTried = false;\n          // flush any queued notifications when we regain connection\n          this.flushPendingOnHandNotifications().catch(err => console.warn('⚠️ Error flushing pending OnHand notifications:', err));\n        });\n\n        this.productSocket.on('disconnect', (reason?: any) => {\n          console.log('🔌 Product WebSocket disconnected', reason);\n        });\n\n        this.productSocket.on('connect_error', (error: any) => {\n          try {\n            // Log as much useful diagnostic info as possible without throwing\n            const msg = error && (error.message || (typeof error === 'string' ? error : 'unknown'));\n            console.error('❌ Product WebSocket connection error:', msg, error);\n            if (error && (error as any).stack) {\n              console.error('❌ connect_error stack:', (error as any).stack, error);\n            }\n\n            try {\n              console.log('ℹ️ productSocket.opts =', (this.productSocket as any)?.io?.opts || (this.productSocket as any)?.io);\n              const eng = (this.productSocket as any)?.io?.engine;\n              if (eng) {\n                console.log('ℹ️ productSocket.engine readyState=', eng.readyState, 'transport=', eng.transport?.name);\n                // If engine has lastPacket or transport details, print limited view\n                console.log('ℹ️ engine objectStoreNames/log:', {\n                  hasEngine: true,\n                  engineType: typeof eng,\n                });\n              }\n            } catch (engErr) {\n              console.warn('⚠️ Error while reading productSocket engine/opts for diagnostics', engErr);\n            }\n          } catch (e) {\n            console.error('❌ Product WebSocket connect_error (logging failed):', e, error);\n          }\n\n          // Simple backoff: attempt re-init after a delay if not exceeded attempts\n          if (this.productReconnectAttempts < this.productMaxReconnectAttempts) {\n            this.productReconnectAttempts++;\n            const backoff = Math.min(5000 * this.productReconnectAttempts, 30000);\n            console.log(`ℹ️ Will retry Product WebSocket init in ${backoff}ms (attempt ${this.productReconnectAttempts})`);\n            setTimeout(() => {\n              // Clean up old socket (remove listeners and disconnect) before retrying\n              try {\n                if (this.productSocket) {\n                  try { (this.productSocket as any).removeAllListeners && (this.productSocket as any).removeAllListeners(); } catch(e){}\n                  try { (this.productSocket as any).disconnect && (this.productSocket as any).disconnect(); } catch(e){}\n                }\n              } catch (cleanupErr) {\n                console.warn('⚠️ Error during productSocket cleanup before retry:', cleanupErr);\n              }\n\n              this.productSocketInitialized = false;\n              this.initializeProductSocketIfNeeded().catch(err => console.error('❌ Retry initializeProductSocketIfNeeded failed:', err));\n            }, backoff);\n          } else {\n            console.warn('⚠️ Max Product WebSocket reconnect attempts reached');\n          }\n\n          // If the error mentions websocket transport and we haven't yet tried polling-only fallback,\n          // try a single attempt to connect using polling transport only (XHR) which may work through proxies.\n          const msgStr = (error && (error.message || '')).toString().toLowerCase();\n          // If the error indicates websocket transport problems, xhr issues, or HTTP 400 status,\n          // attempt a one-time polling fallback.\n          const shouldFallback = msgStr.includes('websocket') || msgStr.includes('xhr') || msgStr.includes('polling') || msgStr.includes('400') || ((error && (error as any).status) === 400);\n          if (!this.productPollingFallbackTried && shouldFallback) {\n            console.log('ℹ️ Detected websocket transport error — attempting one-time fallback to polling transport');\n            this.productPollingFallbackTried = true;\n            try {\n              // disconnect and recreate socket with polling only\n              if (this.productSocket) {\n                try { this.productSocket.disconnect(); } catch (e) { /* ignore */ }\n                this.productSocket = null;\n                this.productSocketInitialized = false;\n              }\n              // create polling-only socket (no auto multiple retries)\n              const pollingSocket = io(socketUrl, {\n                path: '/socket.io',\n                transports: ['polling'],\n                autoConnect: true,\n                reconnection: false\n              });\n              // attach minimal listeners so it reuses our handler logic\n              pollingSocket.on('connect', () => console.log('🔌 Product polling-only socket connected'));\n              pollingSocket.on('connect_error', (err: any) => console.error('❌ Product polling-only socket connect_error:', err));\n              pollingSocket.on('product_onhand_updated', async (payload: any) => {\n                console.log('🟢 Polling socket: Received product_onhand_updated:', payload);\n                try {\n                  const rawId = payload.productId ?? payload.id ?? payload.product_id;\n                  const parsedId = Number(rawId);\n                  const onHand = typeof payload.onHand === 'number' ? payload.onHand : Number(payload.onHand);\n                  if (!Number.isFinite(parsedId) || !Number.isFinite(onHand)) {\n                    console.warn('⚠️ Invalid payload on polling socket:', payload);\n                    return;\n                  }\n                  await this.handleProductOnHandUpdated(parsedId, onHand);\n                } catch (err) {\n                  console.error('❌ Error handling product_onhand_updated (polling):', err, payload);\n                }\n              });\n              // store it as productSocket so other methods observe it\n              this.productSocket = pollingSocket as unknown as Socket;\n              this.productSocketInitialized = true;\n            } catch (fallbackErr) {\n              console.error('❌ Failed to initialize polling fallback socket:', fallbackErr);\n            }\n          }\n        });\n\n        // Listen for product_onhand_updated event\n        this.productSocket.on('product_onhand_updated', async (payload: any) => {\n          console.log('🟢 WebSocket: Received product_onhand_updated:', payload);\n          try {\n            if (!payload) {\n              console.warn('⚠️ product_onhand_updated payload empty');\n              return;\n            }\n\n            // Normalize productId to number\n            const rawId = payload.productId ?? payload.id ?? payload.product_id;\n            const parsedId = Number(rawId);\n            const onHand = typeof payload.onHand === 'number' ? payload.onHand : Number(payload.onHand);\n\n            if (!Number.isFinite(parsedId) || !Number.isFinite(onHand)) {\n              console.warn('⚠️ Invalid product_onhand_updated payload (bad id/onHand):', payload);\n              return;\n            }\n\n            await this.handleProductOnHandUpdated(parsedId, onHand);\n          } catch (err) {\n            console.error('❌ Error processing product_onhand_updated payload:', err, payload);\n          }\n        });\n      }\n    } catch (error) {\n      console.error('❌ Failed to initialize Product WebSocket:', error);\n      this.productSocketInitialized = false;\n    }\n  }\n\n  private async handleProductOnHandUpdated(productId: number, newOnHand: number): Promise<void> {\n    try {\n      // Use the same DB/store used across the service\n      console.log(`ℹ️ handleProductOnHandUpdated called for id=${productId}, onHand=${newOnHand}`);\n      await this.ensureDBInitialized();\n\n      // Try direct lookup first\n      let product = await this.indexedDBService.getByKey(this.dbName, this.dbVersion, this.storeName, productId);\n      if (!product) {\n        console.warn(`⚠️ Real-time: Product ${productId} not found by numeric key. Attempting fallback lookups...`);\n\n        try {\n          // Read a few entries from the store to inspect keys and types\n          const all = await this.indexedDBService.getAll(this.dbName, this.dbVersion, this.storeName);\n          console.warn(`ℹ️ IndexedDB contains ${all.length} products (showing up to 5 ids):`,\n            all.slice(0, 5).map((p: any) => ({ Id: p?.Id, typeOfId: typeof p?.Id })));\n\n          // Try string-key lookup (some clients store keys as strings)\n          const strKey = String(productId);\n          product = await this.indexedDBService.getByKey(this.dbName, this.dbVersion, this.storeName, strKey as any);\n          if (product) {\n            console.log(`ℹ️ Fallback: found product with string key '${strKey}'`);\n          }\n        } catch (readErr) {\n          console.error('❌ Error during fallback IndexedDB inspection:', readErr);\n        }\n      }\n\n      if (product) {\n        const before = product.OnHand;\n        product.OnHand = newOnHand;\n        await this.indexedDBService.put(this.dbName, this.dbVersion, this.storeName, product);\n        console.log(`✅ Real-time: Updated OnHand for product ${productId} in IndexedDB: ${before} -> ${newOnHand}`);\n\n        // Verify write by reading back\n        try {\n          const verify = await this.indexedDBService.getByKey(this.dbName, this.dbVersion, this.storeName, product.Id as any);\n          console.log('🔍 Verified IndexedDB value after write:', { idRead: verify?.Id, OnHand: verify?.OnHand });\n        } catch (verifyErr) {\n          console.error('❌ Error verifying IndexedDB write:', verifyErr);\n        }\n      } else {\n        console.warn(`⚠️ Real-time: Product ${productId} not present in IndexedDB after fallback attempts`);\n      }\n\n      // Emit event for UI/components regardless (so UI can decide to reload or fetch)\n      this.productOnHandUpdatedSubject.next({ productId, onHand: newOnHand });\n    } catch (error) {\n      console.error(`❌ Error handling product_onhand_updated:`, error);\n    }\n  }\n\n  // Helper: update single product OnHand locally and emit\n  public async updateSingleProductOnHandLocal(productId: number | string, onHand: number): Promise<void> {\n    try {\n      await this.ensureDBInitialized();\n      const id = Number(productId);\n      const product = await this.indexedDBService.getByKey(this.dbName, this.dbVersion, this.storeName, id);\n      if (product) {\n        product.OnHand = onHand;\n        await this.indexedDBService.put(this.dbName, this.dbVersion, this.storeName, product);\n        this.productOnHandUpdatedSubject.next({ productId: id, onHand });\n        console.log(`✅ updateSingleProductOnHandLocal: updated ${id} -> ${onHand}`);\n      } else {\n        console.warn(`⚠️ updateSingleProductOnHandLocal: product ${id} not found`);\n      }\n    } catch (err) {\n      console.error('❌ updateSingleProductOnHandLocal error:', err);\n    }\n  }\n\n  // Public method to initialize WebSocket safely\n  public async initializeProductWebSocket(): Promise<void> {\n    await this.initializeProductSocketIfNeeded();\n  }\n\n  // Notify server about an OnHand change so server can emit to other connected clients\n  // Payload: { productId, onHand }\n  public async notifyServerProductOnHandChange(productId: number, onHand: number): Promise<void> {\n    const pid = Number(productId);\n    const oh = Number(onHand);\n    const payload = { productId: pid, onHand: oh };\n    // Prefer emitting over socket when connected\n    try {\n      if (this.productSocket && this.productSocket.connected) {\n        try {\n          (this.productSocket as any).emit('product_onhand_update_request', payload, (ack: any) => {\n            console.log('📡 socket emit ack for product_onhand_update_request', payload, ack);\n          });\n          return;\n        } catch (emitErr) {\n          console.warn('⚠️ Socket emit failed, will fallback to HTTP/queue', emitErr);\n        }\n      }\n\n      // If no socket or emit failed, attempt HTTP PUT\n      try {\n        console.log('📡 notifyServerProductOnHandChange (HTTP fallback)', payload);\n        await this.http.put(`${environment.domainUrl}/api/firebase/update/products`, payload).toPromise();\n        return;\n      } catch (httpErr) {\n        console.warn('⚠️ HTTP notify failed, enqueueing notification for later flush', httpErr);\n      }\n\n      // As last resort, enqueue for later flush\n      this.enqueuePendingOnHandNotification(pid, oh);\n    } catch (err) {\n      console.warn('⚠️ notifyServerProductOnHandChange unexpected error', err);\n      this.enqueuePendingOnHandNotification(pid, oh);\n    }\n  }\n\n  private enqueuePendingOnHandNotification(productId: number, onHand: number) {\n    const entry = { productId, onHand, timestamp: Date.now() };\n    this.pendingOnHandNotifications.push(entry);\n    console.log('🗳️ Enqueued OnHand notification', entry, 'queueLength=', this.pendingOnHandNotifications.length);\n    // Keep queue bounded to a sensible size (e.g., 500)\n    if (this.pendingOnHandNotifications.length > 500) {\n      this.pendingOnHandNotifications.shift();\n    }\n  }\n\n  private async flushPendingOnHandNotifications(): Promise<void> {\n    if (!this.pendingOnHandNotifications || this.pendingOnHandNotifications.length === 0) return;\n    console.log('🔄 Flushing', this.pendingOnHandNotifications.length, 'pending OnHand notifications');\n    const toFlush = [...this.pendingOnHandNotifications];\n    this.pendingOnHandNotifications = [];\n\n    // Try socket emit batch if socket available\n    if (this.productSocket && this.productSocket.connected) {\n      try {\n        (this.productSocket as any).emit('product_onhand_update_batch', toFlush, (ack: any) => {\n          console.log('📡 socket batch emit ack', ack);\n        });\n        return;\n      } catch (err) {\n        console.warn('⚠️ socket batch emit failed, will try HTTP per-item', err);\n      }\n    }\n\n    // Fallback to per-item HTTP calls; do them sequentially to avoid overloading\n    for (const entry of toFlush) {\n      try {\n        await this.http.put(`${environment.domainUrl}/api/firebase/update/products`, { productId: entry.productId, onHand: entry.onHand }).toPromise();\n      } catch (err) {\n        console.warn('⚠️ flushPendingOnHandNotifications: HTTP notify failed for', entry, err);\n        // re-enqueue failed ones at front\n        this.pendingOnHandNotifications.unshift(entry);\n        // stop further attempts for now\n        break;\n      }\n    }\n  }\n\n  // Public method to disconnect WebSocket\n  public disconnectProductSocket(): void {\n    if (this.productSocket) {\n      this.productSocket.disconnect();\n      this.productSocket = null;\n      this.productSocketInitialized = false;\n    }\n  }\n\n  // Public method to check WebSocket connection status\n  public isProductWebSocketConnected(): boolean {\n    return this.productSocketInitialized && this.productSocket !== null && this.productSocket.connected;\n  }\n\n  // Public method to get WebSocket status\n  public getProductWebSocketStatus(): { connected: boolean; initialized: boolean; socketExists: boolean } {\n    return {\n      connected: this.productSocket?.connected || false,\n      initialized: this.productSocketInitialized,\n      socketExists: this.productSocket !== null\n    };\n  }\n}","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\services\\time-zone.service.ts","messages":[{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty constructor.","line":8,"column":17,"nodeType":"FunctionExpression","messageId":"unexpected","endLine":8,"endColumn":20,"suggestions":[{"messageId":"suggestComment","data":{"name":"constructor"},"fix":{"range":[139,140],"text":" /* empty */ "},"desc":"Add comment inside empty constructor."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@angular/core';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class TimeZoneService {\r\n\r\n  constructor() { }\r\n\r\n  formatDateToVietnamString(date: Date): string {\r\n    // Vietnam timezone: UTC+7\r\n    const vietnamOffset = 7 * 60; // 7 hours in minutes\r\n    const utc = date.getTime() + (date.getTimezoneOffset() * 60000);\r\n    const vietnamTime = new Date(utc + (vietnamOffset * 60000));\r\n\r\n    const year = vietnamTime.getFullYear();\r\n    const month = String(vietnamTime.getMonth() + 1).padStart(2, '0');\r\n    const day = String(vietnamTime.getDate()).padStart(2, '0');\r\n\r\n    return `${year}-${month}-${day}`;\r\n  }\r\n\r\n  // Utility method để tạo Date object theo timezone Vietnam\r\n  createVietnamDate(dateString: string): Date {\r\n    // Tạo date theo Vietnam timezone (UTC+7)\r\n    const date = new Date(dateString + 'T00:00:00+07:00');\r\n    return date;\r\n  }\r\n\r\n  // Utility method để parse date từ API response\r\n  parseApiDate(dateString: string): Date {\r\n    // Giả sử API trả về ISO string hoặc format có timezone info\r\n    return new Date(dateString);\r\n  }\r\n  formatVietnamISOString(date: Date): string {\r\n    // Nếu máy đã ở UTC+7, chỉ cần format lại\r\n    const year = date.getFullYear();\r\n    const month = String(date.getMonth() + 1).padStart(2, '0');\r\n    const day = String(date.getDate()).padStart(2, '0');\r\n    const hour = String(date.getHours()).padStart(2, '0');\r\n    const min = String(date.getMinutes()).padStart(2, '0');\r\n    const sec = String(date.getSeconds()).padStart(2, '0');\r\n    const ms = String(date.getMilliseconds()).padStart(3, '0');\r\n    return `${year}-${month}-${day}T${hour}:${min}:${sec}.${ms}`;\r\n  }\r\n\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\services\\utility.service.ts","messages":[{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty constructor.","line":8,"column":17,"nodeType":"FunctionExpression","messageId":"unexpected","endLine":8,"endColumn":20,"suggestions":[{"messageId":"suggestComment","data":{"name":"constructor"},"fix":{"range":[138,139],"text":" /* empty */ "},"desc":"Add comment inside empty constructor."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@angular/core';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class UtilityService {\r\n\r\n  constructor() { }\r\n  validateNumber(event: KeyboardEvent) {\r\n    const allowedKeys = ['Backspace', 'ArrowLeft', 'ArrowRight', 'Delete', 'Tab'];\r\n\r\n    const isCtrlOrMeta = event.ctrlKey || event.metaKey;\r\n    const isCtrlCombination = isCtrlOrMeta && ['a', 'c', 'v', 'x'].includes(event.key.toLowerCase());\r\n\r\n    // Cho phép các phím điều hướng, tổ hợp Ctrl (copy, paste, cut, select all)\r\n    if (allowedKeys.includes(event.key) || isCtrlCombination) {\r\n      return;\r\n    }\r\n\r\n    const isNumberOrSymbol = /^[0-9=+\\-*/]$/.test(event.key);\r\n    if (!isNumberOrSymbol) {\r\n      event.preventDefault();\r\n    }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\services\\vietnamese.service.ts","messages":[{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty constructor.","line":8,"column":17,"nodeType":"FunctionExpression","messageId":"unexpected","endLine":8,"endColumn":20,"suggestions":[{"messageId":"suggestComment","data":{"name":"constructor"},"fix":{"range":[141,142],"text":" /* empty */ "},"desc":"Add comment inside empty constructor."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Injectable } from '@angular/core';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class VietnameseService {\r\n\r\n  constructor() { }\r\n  normalizeAndTokenize(str: string): string[] {\r\n    return str\r\n      .replace(/[^a-zA-Z0-9À-ỹ\\s]/g, '') // Xóa ký tự đặc biệt, giữ dấu và chữ hoa/thường\r\n      .split(/\\s+/)\r\n      .filter(Boolean);\r\n  }\r\n  generateNGrams(tokens: string[], maxN = 3): Set<string> {\r\n    const ngrams = new Set<string>();\r\n    for (let n = 1; n <= maxN; n++) {\r\n      for (let i = 0; i <= tokens.length - n; i++) {\r\n        const gram = tokens.slice(i, i + n).join(' ');\r\n        ngrams.add(gram);\r\n      }\r\n    }\r\n    return ngrams;\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\environments\\environment.prod.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\environments\\environment.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\index.html","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\main.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]