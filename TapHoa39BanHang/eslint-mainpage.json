[{"filePath":"E:\\TapHoa39\\TapHoa39BanHang\\src\\app\\components\\main-page\\main-page.component.ts","messages":[{"ruleId":"@angular-eslint/component-selector","severity":2,"message":"The selector should start with one of these prefixes: \"app\" (https://angular.dev/style-guide#style-02-07)","line":59,"column":13,"nodeType":"Literal","messageId":"prefixFailure","endLine":59,"endColumn":24},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":89,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":89,"endColumn":43},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":90,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":90,"endColumn":39},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":91,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":91,"endColumn":43},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":92,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":92,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":93,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":93,"endColumn":39},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":94,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":94,"endColumn":30},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":95,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":95,"endColumn":27},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":96,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":96,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":97,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":97,"endColumn":53},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":98,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":98,"endColumn":45},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":99,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":99,"endColumn":43},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":100,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":100,"endColumn":39},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":101,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":101,"endColumn":57},{"ruleId":"@angular-eslint/prefer-inject","severity":2,"message":"Prefer using the inject() function over constructor parameter injection. Use Angular's migration schematic to automatically refactor: ng generate @angular/core:inject","line":103,"column":5,"nodeType":"TSParameterProperty","messageId":"preferInject","endLine":103,"endColumn":47},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":119,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5063,5066],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5063,5066],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":212,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":212,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8427,8430],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8427,8430],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":327,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":327,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12709,12712],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12709,12712],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":747,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":747,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29018,29021],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29018,29021],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":773,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":773,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[30002,30005],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[30002,30005],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":846,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":846,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32319,32322],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32319,32322],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":854,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":854,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32633,32636],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32633,32636],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":928,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":928,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35091,35094],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35091,35094],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":943,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":943,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35352,35355],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35352,35355],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":966,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":966,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36085,36088],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36085,36088],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":992,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":992,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36897,36900],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36897,36900],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'index' is defined but never used.","line":1034,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":1034,"endColumn":24},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1136,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1136,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[41603,41606],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[41603,41606],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1231,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1231,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[44724,44727],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[44724,44727],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1239,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1239,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[45120,45123],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[45120,45123],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1363,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1363,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[49899,49902],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[49899,49902],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1390,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1390,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[50795,50798],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[50795,50798],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1525,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1525,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[55492,55495],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[55492,55495],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1534,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1534,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[55883,55886],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[55883,55886],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1648,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1648,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[59849,59852],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[59849,59852],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1650,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1650,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[59912,59915],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[59912,59915],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1651,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1651,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[60016,60019],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[60016,60019],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1653,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1653,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[60213,60216],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[60213,60216],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1653,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1653,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[60250,60253],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[60250,60253],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1655,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1655,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[60453,60456],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[60453,60456],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1656,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1656,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[60553,60556],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[60553,60556],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1661,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1661,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[60840,60843],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[60840,60843],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1662,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1662,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[60920,60923],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[60920,60923],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1691,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1691,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[62137,62140],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[62137,62140],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1691,"column":83,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1691,"endColumn":86,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[62174,62177],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[62174,62177],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1693,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1693,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[62297,62300],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[62297,62300],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1795,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1795,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[65646,65649],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[65646,65649],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1863,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1863,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[68494,68497],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[68494,68497],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2029,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2029,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[74696,74699],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[74696,74699],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2033,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2033,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[74796,74799],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[74796,74799],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2038,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2038,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[74950,74953],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[74950,74953],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2073,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2073,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[76483,76486],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[76483,76486],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2076,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2076,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[76568,76571],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[76568,76571],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2078,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2078,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[76655,76658],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[76655,76658],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2079,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2079,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[76705,76708],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[76705,76708],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2087,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2087,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[77029,77032],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[77029,77032],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2100,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2100,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[77524,77527],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[77524,77527],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2102,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2102,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[77630,77633],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[77630,77633],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2103,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2103,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[77699,77702],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[77699,77702],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2109,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2109,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[77999,78002],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[77999,78002],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2110,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2110,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[78086,78089],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[78086,78089],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2141,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2141,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[79381,79384],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[79381,79384],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'err' is defined but never used.","line":2192,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":2192,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2335,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2335,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[86123,86126],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[86123,86126],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2337,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2337,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[86221,86224],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[86221,86224],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":2338,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":2338,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2389,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2389,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88021,88024],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88021,88024],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2390,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2390,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88122,88125],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88122,88125],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2391,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2391,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88230,88233],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88230,88233],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2391,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2391,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88267,88270],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88267,88270],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2392,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2392,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88348,88351],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88348,88351],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2393,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2393,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88435,88438],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88435,88438],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2397,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2397,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88574,88577],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88574,88577],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2398,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2398,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88653,88656],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88653,88656],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2399,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2399,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88741,88744],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88741,88744],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2400,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2400,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88817,88820],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88817,88820],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2429,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2429,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[89710,89713],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[89710,89713],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":2431,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2431,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[89808,89811],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[89808,89811],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":2432,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":2432,"endColumn":19}],"suppressedMessages":[],"errorCount":79,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Component, OnInit, ViewChild, ElementRef, HostListener, ViewChildren, QueryList, OnDestroy, DoCheck } from '@angular/core';\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\nimport { CommonModule } from '@angular/common';\nimport { MatIconModule, } from '@angular/material/icon';\nimport { MatTabsModule } from '@angular/material/tabs';\nimport { MatTooltipModule } from '@angular/material/tooltip';\nimport { MatDialogModule } from '@angular/material/dialog';\nimport { MatInputModule } from '@angular/material/input';\nimport { MatSelectModule } from '@angular/material/select';\nimport { MatDatepickerModule } from '@angular/material/datepicker';\nimport { MatNativeDateModule } from '@angular/material/core';\nimport { MatButtonModule } from '@angular/material/button';\nimport { MatSnackBarModule } from '@angular/material/snack-bar';\nimport { MatTableModule } from '@angular/material/table';\nimport { MatPaginatorModule } from '@angular/material/paginator';\nimport { MatSortModule } from '@angular/material/sort';\nimport { MatRadioModule } from '@angular/material/radio';\nimport { debounceTime } from 'rxjs/operators';\nimport { Subscription } from 'rxjs';\nimport { MatDialog } from '@angular/material/dialog';\nimport { Router } from '@angular/router';\nimport { RouterModule } from '@angular/router';\nimport { MatFormFieldModule } from '@angular/material/form-field';\n//libs\nimport { IndexedDBService } from '../../services/indexed-db.service';\nimport { firstValueFrom, Subject } from 'rxjs';\n//component\nimport { InvoiceDetailComponent } from \"../../components/invoice-detail/invoice-detail.component\";\nimport { ConfirmPopupComponent } from '../../components/confirm-popup/confirm-popup.component';\nimport { InvoicesPageComponent } from '../../components/invoices-page/invoices-page.component';\nimport { OutOfStockDialogComponent } from '../../components/out-of-stock-dialog/out-of-stock-dialog.component';\nimport { OrderPageComponent } from '../../components/order-page/order-page.component';\n\n//model\nimport { Product } from '../../models/product.model';\nimport { CartItem } from '../../models/cart-item.model';\nimport { InvoiceTab } from '../../models/invoice.model';\nimport { Customer } from '../../models/customer.model';\n//services\nimport { CustomerService } from '../../services/customer.service';\nimport { PrintService } from '../../services/print.service';\nimport { ProductService } from '../../services/product.service';\nimport { GroupService } from '../../services/group.service';\nimport { InvoiceService } from '../../services/invoice.service';\nimport { OrderService } from '../../services/order.service';\nimport { OrderToInvoiceService } from '../../services/order-to-invoice.service';\nimport { KiotvietService } from '../../services/kiotviet.service';\nimport { LocalStorageService } from '../../services/local-storage.service';\nimport { ReportPageComponent } from '../report-page/report-page.component';\nimport { AddCustomerComponent } from '../add-customer/add-customer.component';\nimport { CustomersPageComponent } from '../customers-page/customers-page.component';\nimport { TimeZoneService } from '../../services/time-zone.service';\nimport { OfflineInvoicesListComponent } from '../offline-invoices-list/offline-invoices-list.component';\nimport { UtilityService } from '../../services/utility.service';\n\nimport { environment } from '../../../environments/environment';\n\n@Component({\n  selector: 'main-page',\n  standalone: true,\n  imports: [CommonModule,\n    FormsModule,\n    ReactiveFormsModule,\n    MatIconModule,\n    MatTabsModule,\n    InvoiceDetailComponent,\n    MatTooltipModule,\n    RouterModule,\n    MatFormFieldModule,\n    MatDialogModule,\n    MatInputModule,\n    MatSelectModule,\n    MatDatepickerModule,\n    MatNativeDateModule,\n    MatButtonModule,\n    MatSnackBarModule,\n    MatTableModule,\n    MatPaginatorModule,\n    MatSortModule,\n    MatRadioModule\n  ],\n  templateUrl: './main-page.component.html',\n  styleUrls: ['./main-page.component.css'],\n\n})\nexport class MainPageComponent implements OnInit, OnDestroy, DoCheck {\n\n  constructor(\n    private productService: ProductService,\n    private groupService: GroupService,\n    private invoiceService: InvoiceService,\n    private customerService: CustomerService,\n    private printService: PrintService,\n    private dialog: MatDialog,\n    private router: Router,\n    private kiotvietService: KiotvietService,\n    private localStorageService: LocalStorageService,\n    private timeZoneService: TimeZoneService,\n    private utilityService: UtilityService,\n    private orderService: OrderService,\n    private orderToInvoiceService: OrderToInvoiceService\n    ,\n    private indexedDBService: IndexedDBService\n  ) {\n    // this.addInvoiceTab();\n  }\n\n  searchTerm = '';\n  showDropdown = false;\n  showCustomerDropdown = false;\n  filteredProducts: Product[] = [];\n\n  showNoteInput = false;\n  selectedItem: CartItem | null = null;\n  // removed unused variable `swtichedItem`\n  discountAmount = 0;\n  discountType = 'VND';\n  deliveryTime = '';\n  groupedProducts: Record<number, any[]> = {}\n  paymentMode: 'normal' | 'debt' = 'normal';\n  cartItems: CartItem[] = [];\n  invoices: InvoiceTab[] = [];\n  tabCounter = 1;\n  activeIndex = 0;\n  activeTabIndex = 0;\n\n  @ViewChild(InvoiceDetailComponent, { static: false })\n  invoiceDetailComponent!: InvoiceDetailComponent;\n\n\n  get selectedInvoice(): InvoiceTab | null {\n    return this.invoices[this.activeTabIndex] || null;\n  }\n  searchChanged: Subject<string> = new Subject<string>();\n\n  @ViewChild('printSection', { static: false }) printSection!: ElementRef;\n  @ViewChildren('itemRefs') itemRefs!: QueryList<ElementRef>;\n  @ViewChild('dropdownContainer') dropdownContainer!: ElementRef;\n  @ViewChild('searchInput') searchInput!: ElementRef;\n  @ViewChild('searchCustomer') searchCustomer!: ElementRef;\n  @ViewChildren('noteInput') noteInputs!: QueryList<ElementRef>;\n\n\n  validateNumber(event: KeyboardEvent) {\n    this.utilityService.validateNumber(event)\n  }\n\n  // Load data from localStorage on component initialization\n  private loadDataFromLocalStorage(): void {\n    if (!this.localStorageService.isStorageAvailable()) {\n      console.warn('localStorage is not available');\n      return;\n    }\n\n    // Load invoice tabs\n    const savedInvoices = this.localStorageService.getInvoiceTabs();\n    if (savedInvoices.length > 0) {\n      this.invoices = savedInvoices;\n      this.tabCounter = savedInvoices.length + 1;\n    }\n\n    // Load active tab index\n    this.activeTabIndex = this.localStorageService.getActiveTabIndex();\n\n    // Ensure activeTabIndex is within bounds\n    if (this.activeTabIndex >= this.invoices.length) {\n      this.activeTabIndex = 0;\n    }\n\n    // Load cart items for the active tab\n    if (this.invoices.length > 0) {\n      const savedCartItems = this.localStorageService.getCartItems(this.activeTabIndex);\n      this.cartItems = savedCartItems;\n\n      // Sync cart items with the active invoice\n      if (this.invoices[this.activeTabIndex]) {\n        this.invoices[this.activeTabIndex].cartItems = [...this.cartItems];\n      }\n\n      // Load other tab-specific data\n      this.discountAmount = this.localStorageService.getDiscountAmount(this.activeTabIndex);\n      this.selectedCustomer = this.localStorageService.getSelectedCustomer(this.activeTabIndex);\n      this.invoiceNote = this.localStorageService.getInvoiceNote(this.activeTabIndex);\n\n      // Update customer search term if customer exists\n      if (this.selectedCustomer) {\n        this.customerSearchTerm = this.selectedCustomer.Name + ' - ' + (this.selectedCustomer.ContactNumber || '');\n      }\n    }\n  }\n\n  // Save data to localStorage\n  private saveDataToLocalStorage(): void {\n    if (!this.localStorageService.isStorageAvailable()) {\n      return;\n    }\n\n    // Save cart items for current tab\n    this.localStorageService.saveCartItems(this.cartItems, this.activeTabIndex);\n\n    // Save invoice tabs\n    this.localStorageService.saveInvoiceTabs(this.invoices);\n\n    // Save active tab index\n    this.localStorageService.saveActiveTabIndex(this.activeTabIndex);\n\n    // Save other tab-specific data\n    this.localStorageService.saveDiscountAmount(this.discountAmount, this.activeTabIndex);\n    this.localStorageService.saveSelectedCustomer(this.selectedCustomer, this.activeTabIndex);\n    this.localStorageService.saveInvoiceNote(this.invoiceNote, this.activeTabIndex);\n  }\n  private onHandReloadInterval: any = null;\n  private subscriptions: Subscription[] = [];\n  async ngOnInit() {\n\n    // this.productService.loadItemsFromKiotVietToIndexedDB().then(() => {\n    //   console.log('Tt c sn phm  c ti v lu vo IndexedDB.');\n    // }).catch((err) => {\n    //   console.error('Li khi ti tt c sn phm:', err);\n    // });\n\n    this.loadDataFromLocalStorage();\n    if (this.invoices.length === 0) {\n      this.addInvoiceTab();\n    }\n    await this.syncCartItemsWithIndexedDB();\n    setTimeout(() => {\n      this.searchInput?.nativeElement.focus();\n    }, 0);\n\n    await this.groupProduct();\n    const searchSub = this.searchChanged.pipe(\n      debounceTime(400) // 300ms sau khi dng nhp mi search\n    ).subscribe(query => {\n      this.onSearchInputInternal(query);\n    });\n    this.subscriptions.push(searchSub);\n    //download product tu kiotviet den indexedDB\n\n    // Initialize WebSocket for real-time notifications\n    await this.initializeWebSocket();\n\n    // Kim tra c invoice offline khng\n    this.checkOfflineInvoices();\n\n    this.setquickAmounts();\n\n    // nh k reload li OnHand cho cartItems mi 10s\n    this.onHandReloadInterval = setInterval(() => {\n      this.reloadCartItemsOnHand();\n    }, 10000);\n\n    // Nu ang  Order Mode m cha c order tab th to mi\n    if (this.isOrderMode && this.orders.length === 0) {\n      this.addOrderTab();\n    }\n\n    // Subscribe to invoice created events to handle orders converted to invoices\n    const invoiceCreatedSub = this.invoiceService.invoiceCreated$.subscribe(invoice => {\n      console.log(` Main page: Invoice created from order - ${invoice.id}`);\n      // If the invoice name contains \"t n hng\", it was converted from an order\n      if (invoice.name && invoice.name.includes('t n hng')) {\n        console.log(` Invoice ${invoice.id} was converted from an order and is now available in the invoice system`);\n      }\n    });\n    this.subscriptions.push(invoiceCreatedSub);\n\n    // Subscribe to order processed events\n    const orderProcessedSub = this.orderToInvoiceService.orderProcessed$.subscribe(data => {\n      console.log(` Main page: Received order processed data - ${data.orderId}`);\n      this.handleProcessedOrder(data.order, data.orderId);\n    });\n    this.subscriptions.push(orderProcessedSub);\n    \n    // Subscribe to real-time product OnHand updates\n    const onHandSub = this.productService.productOnHandUpdated$.subscribe(({ productId, onHand }) => {\n      try {\n        console.log(' MainPageComponent: received productOnHandUpdated', { productId, onHand });\n        \n        // Update in-memory filteredProducts / groupedProducts if present\n        let updated = false;\n        for (const p of this.filteredProducts) {\n          if (p?.Id === productId) {\n            p.OnHand = onHand;\n            updated = true;\n          }\n        }\n        \n        // Update cartItems if they reference the product\n        for (const item of this.cartItems) {\n          if (item.product?.Id === productId) {\n            item.product.OnHand = onHand;\n            updated = true;\n          }\n        }\n        \n        if (updated) {\n          // Refresh groupedProducts to reflect updated OnHand where necessary\n          this.groupProduct().catch(err => console.error('Error refreshing groupedProducts after OnHand update', err));\n        }\n      } catch (err) {\n        console.error('Error handling productOnHandUpdated in MainPageComponent', err);\n      }\n    });\n    this.subscriptions.push(onHandSub);\n  }\n\n  private async initializeWebSocket(): Promise<void> {\n    try {\n      // Initialize WebSocket connection for real-time notifications\n      await this.invoiceService.initializeWebSocket();\n      console.log(' WebSocket initialized for main page real-time notifications');\n    } catch (error) {\n      console.error(' Failed to initialize WebSocket for main page:', error);\n    }\n  }\n\n  async reload() {\n    this.isReloading = true;\n    try {\n      console.log(' Bt u reload d liu...');\n\n      //  Gi API ly ton b sn phm t KiotViet ch 1 ln\n      const apiUrl = environment.domainUrl + this.kiotvietService.kiotviet_items_api;\n      let apiProducts = await this.productService['http'].get<Product[]>(apiUrl)\n        .toPromise()\n        .catch((err: any) => {\n          console.error(' Li khi ti tt c sn phm t KiotViet:', err);\n          return [] as Product[];\n        });\n      if (!apiProducts) apiProducts = [];\n\n      //  Bc 1: Cleanup orphaned products (xa products trong IndexedDB m khng c trong API)\n      console.log(' Bc 1: Cleanup orphaned products...');\n      const cleanupResult = await this.productService.cleanupOrphanedProductsFromAPI(apiProducts).catch((err) => {\n        console.error(' Li khi cleanup orphaned products:', err);\n        return { deletedCount: 0, totalChecked: 0 };\n      });\n\n      console.log(` Cleanup hon thnh:  xa ${cleanupResult.deletedCount}/${cleanupResult.totalChecked} orphaned products`);\n\n      //  Bc 2: Load v sync products t KiotViet\n      console.log(' Bc 2: Load v sync products t KiotViet...');\n      await this.productService.loadItemsFromKiotVietToIndexedDB(apiProducts).then(() => {\n        console.log(' Tt c sn phm  c ti v lu vo IndexedDB.');\n      }).catch((err) => {\n        console.error(' Li khi ti tt c sn phm:', err);\n      });\n\n      //  Bc 3: Sync customers (nu cn)\n      console.log(' Bc 3: Sync customers t KiotViet...');\n      await this.customerService.loadCustomersFromKiotvietToIndexedDB().then(() => {\n        console.log(' Tt c customer  c ti v lu vo IndexedDB.');\n      }).catch((err) => {\n        console.error(' Li khi ti tt c customer:', err);\n      });\n\n      //  Bc 4: Sync invoices (nu cn)\n      console.log(' Bc 4: Sync invoices...');\n      await this.invoiceService.syncInvoicesBetweenFirestoreAndIndexedDB().then(() => {\n        console.info(' Tt c invoices  c ti v lu vo IndexedDB thnh cng!');\n      }).catch(err => {\n        console.error(` Li khi ti v lu invoices vo IndexedDB: ${err}`);\n      });\n\n      console.log(' Tt c d liu  c reload thnh cng!');\n      console.log(` Tm tt:  xa ${cleanupResult.deletedCount} orphaned products, sync products, customers v invoices`);\n\n    } catch (err) {\n      console.error(' Li khi reload d liu:', err);\n    } finally {\n      this.isReloading = false;\n    }\n  }\n\n\n  async checkout() {\n    // Check if in edit mode\n    if (this.isEditMode) {\n      await this.saveEditedOrder();\n      return;\n    }\n\n    //  Kim tra OnHand t IndexedDB thay v t cartItems\n    const notEnough = await this.checkOnHandFromIndexedDB();\n    if (notEnough) {\n      alert('Khng  s lng');\n      return;\n    }\n\n    if (this.cartItems.length === 0) {\n      alert('Gi hng trng!');\n      return;\n    }\n    // Kim tra nu s tin tha (change) khc 0 m cha nhp khch hng\n    if (this.getChangeAmount() < 0 && !this.selectedCustomer) {\n      alert('CN NHP KHCH HNG  QUN L CNG N');\n      return;\n    }\n\n    //  1. Lu thng tin invoice hin ti TRC KHI thay i activeTab\n    const now = new Date();\n    const vnNow = this.timeZoneService.formatVietnamISOString(now);\n    const currentInvoiceIndex = this.activeTabIndex;\n    this.invoices[currentInvoiceIndex].debt = this.getChangeAmount();\n    this.invoices[currentInvoiceIndex].note = this.invoiceNote;\n    this.createdDate = vnNow\n\n    const invoice: InvoiceTab = {\n      ...this.invoices[currentInvoiceIndex],\n      createdDate: this.createdDate,\n      totalPrice: this.invoices[currentInvoiceIndex].totalPrice - this.invoices[currentInvoiceIndex].discountAmount,\n      customer: this.invoices[currentInvoiceIndex].customer ? { ...this.invoices[currentInvoiceIndex].customer } : null,\n      debt: this.invoices[currentInvoiceIndex].debt >= 0 ? 0 : this.invoices[currentInvoiceIndex].debt,\n      discountAmount: this.invoices[currentInvoiceIndex].discountAmount,\n      note: this.invoices[currentInvoiceIndex].note\n    };\n\n    // Trc khi reset selectedCustomer hoc sau khi to invoice:\n    if (this.paymentMode === 'debt' && invoice.customer?.Id) {\n      const changeAmount = this.getChangeAmount();\n      if (changeAmount < 0) {\n        invoice.customer.Debt += Math.abs(changeAmount);\n      } else {\n        invoice.customer.Debt -= changeAmount;\n        if (invoice.customer.Debt < 0) invoice.customer.Debt = 0;\n      }\n      // Nu cn update customer vo DB:\n      console.log('Bt u update customer debt:', invoice.customer.Id, invoice.customer.Debt);\n      try {\n        await this.customerService.updateCustomerDebt(invoice.customer.Id, invoice.customer.Debt);\n        console.log(' gi updateCustomerDebt');\n        const updatedCustomer = await this.customerService.getCustomerByIdFromIndexedDB(invoice.customer.Id);\n        console.log(' Customer sau khi update Debt:', updatedCustomer);\n      } catch (err) {\n        console.error(' Li khi update customer debt:', err);\n      }\n    }\n    //  3. Print TRC KHI xa invoice (nu cn)\n    if (this.isPrintEnabled) {\n      // Gn invoice va to vo component  in ng createdDate\n      if (this.invoiceDetailComponent) {\n        this.invoiceDetailComponent.invoice = invoice;\n      }\n      const html = this.invoiceDetailComponent?.getHtmlContent();\n      if (html) {\n        this.printService.printHtml(html);\n      }\n    }\n    //  Clear localStorage data for the current tab before removing it\n    this.localStorageService.clearTabData(currentInvoiceIndex);\n    //  4. Xa invoice  checkout\n    this.invoices.splice(currentInvoiceIndex, 1);\n\n    //  5. X l chuyn tab\n    if (this.invoices.length === 0) {\n      // To tab mi nu khng cn invoice no\n      this.addInvoiceTab();\n    } else {\n      // Chuyn sang tab cn li\n      const newIndex = Math.min(currentInvoiceIndex, this.invoices.length - 1);\n      this.setActiveTab(newIndex);\n    }\n\n    //  2. Gi ln Firestore vi x l offline\n    this.invoiceService.addInvoiceToFirestore(invoice).subscribe({\n      next: async res => {\n        //  Real-time: Thng bo to ha n mi qua Socket.IO\n        try {\n          await this.invoiceService.notifyInvoiceCreated(invoice);\n\n          // Check if this invoice was created from an order and update order status\n          if (invoice.name && invoice.name.includes('t n hng')) {\n            const orderIdMatch = invoice.name.match(/t n hng (DH\\d+)/);\n            if (orderIdMatch && orderIdMatch[1]) {\n              const orderId = orderIdMatch[1];\n              console.log(` Updating order status to 'checked' for order ${orderId}`);\n              await this.updateOrderStatusToChecked(orderId);\n            }\n          }\n\n          //update onhand trong kiotviet\n          this.kiotvietService.updateOnHandFromInvoiceToKiotviet(invoice, this.groupedProducts).then(async () => {\n            console.log('Sn phm  c cp nht onHand vo kiotviet.');\n          }).catch((err) => {\n            console.error('Li khi cp nht sn phm:', err);\n          });\n          console.info(` thanh ton thnh cng: ${res}`)\n          console.error(' Notifying invoice creation via Socket.IO:', res);\n        } catch (error) {\n          console.error(' Error notifying invoice creation via Socket.IO:', error);\n        }\n      },\n      error: async err => {\n        console.error(`Khng th gi ln Firebase: ${err}`);\n        // Lu vo offline store nu khng th gi ln Firebase\n        try {\n          await this.invoiceService.saveInvoiceToOffline(invoice);\n          this.hasOfflineInvoices = true;\n          console.log(' lu invoice vo offline store');\n        } catch (offlineError) {\n          console.error('Li khi lu vo offline store:', offlineError);\n        }\n      }\n    });\n\n    //gui den indexedDB\n    this.invoiceService.addInvoiceToDB(invoice).then(async () => {\n      console.log(' thm ha n vo indexedDB.');\n    }).catch((err) => {\n      console.error('Li khi cp nht tt c sn phm:', err);\n    });\n\n\n    // Sau khi checkout, cp nht li OnHand cho tt c sn phm trong cart\n    for (const item of this.cartItems) {\n      // Ly OnHand mi nht (sau khi chnh tay hoc t IndexedDB)\n      const currentOnHand = item.product.OnHand;\n      // Tr i s lng bn ra\n      const newOnHand = currentOnHand - item.quantity;\n      // Cp nht li vo IndexedDB\n      await this.productService.updateProductOnHandLocal(item.product.Id, newOnHand);\n      // Nu mun ng b ln Firestore, gi updateProductOnHandToFireStore\n    }\n\n    //  6. Reset customer search (khng cn reset cart v  chuyn tab)\n    this.discountAmount = 0;\n    this.change = 0;\n    this.formattedCustomerPaid = '0';\n    this.invoiceNote = '';\n\n    try {\n      // Ch truyn cc sn phm cha chnh tay vo API tr OnHand\n      const res = await this.productService.updateProductsOnHandFromInvoiceToFireBase(\n        invoice,\n        this.groupedProducts,\n        this.manuallyEditedOnHandProductIds\n      );\n      console.log(' cp nht tn kho cc sn phm t ha n n fire store:', res);\n\n      // Cp nht li tng sn phm trong IndexedDB s dng new_OnHand t response\n      if (res && res.updated_products) {\n        for (const p of res.updated_products) {\n          await this.productService.updateProductOnHandLocal(p.Id, p.new_OnHand);\n          console.log(` Cp nht sn phm ${p.Id}: OnHand = ${p.new_OnHand}`);\n        }\n      }\n\n      // Xa cc sn phm  chnh tay khi set (nu mun)\n      this.manuallyEditedOnHandProductIds.clear();\n    } catch (err) {\n      console.error('Li khi cp nht tn kho cc sn phm:', err);\n    }\n\n  }\n\n  //  Thm hm kim tra OnHand t IndexedDB\n  private async checkOnHandFromIndexedDB(): Promise<boolean> {\n    try {\n  const db = await this.indexedDBService.getDB('SalesDB', 1);\n\n      // Gom cc sn phm trong cart theo group (masterUnitId)\n      const groupMap: Record<number, { totalSell: number, totalOnHand: number }> = {};\n\n      for (const item of this.cartItems) {\n        const masterUnitId = item.product.MasterUnitId || item.product.Id;\n        const group = this.groupedProducts[masterUnitId];\n        if (!group) continue;\n\n        // Tnh tng s lng bn quy i v master\n        const sellQty = item.quantity * item.product.ConversionValue;\n\n        if (!groupMap[masterUnitId]) {\n          // Ly tng OnHand thc t ca group (quy i v master)\n          let totalOnHand = 0;\n          for (const p of group) {\n            const latestProduct = await db.transaction('products', 'readonly').store.get(p.Id);\n            if (latestProduct) {\n              totalOnHand += latestProduct.OnHand * p.ConversionValue;\n            }\n          }\n          groupMap[masterUnitId] = { totalSell: 0, totalOnHand };\n        }\n        groupMap[masterUnitId].totalSell += sellQty;\n      }\n\n      // Kim tra tng group\n      for (const masterUnitId in groupMap) {\n        if (groupMap[masterUnitId].totalSell > groupMap[masterUnitId].totalOnHand) {\n          console.log(` Khng  hng cho group ${masterUnitId}: cn ${groupMap[masterUnitId].totalSell}, c ${groupMap[masterUnitId].totalOnHand}`);\n          return true; // Khng  hng\n        }\n      }\n\n      return false; //  hng\n    } catch (error) {\n      console.error(' Li khi kim tra OnHand t IndexedDB:', error);\n      return true; // Nu li, khng cho php bn\n    }\n  }\n\n  ngDoCheck() {\n    this.setquickAmounts();\n  }\n  async groupProduct() {\n    const db = await this.indexedDBService.getDB('SalesDB', 1);\n    const tx = db.transaction('products', 'readonly');\n    this.filteredProducts = await tx.store.getAll();\n    this.groupedProducts = await this.groupService.group(this.filteredProducts)\n\n  }\n\n  scrollToActiveItem() {\n    const items = this.itemRefs.toArray();\n\n    if (this.activeIndex >= 0 && this.activeIndex < items.length) {\n      const element = items[this.activeIndex].nativeElement;\n      const container = this.dropdownContainer?.nativeElement;\n\n      if (element && container) {\n        const elementTop = element.offsetTop;\n        const elementBottom = elementTop + element.offsetHeight;\n        const containerTop = container.scrollTop;\n        const containerBottom = containerTop + container.offsetHeight;\n\n        if (elementBottom > containerBottom) {\n          container.scrollTop = elementBottom - container.offsetHeight;\n        } else if (elementTop < containerTop) {\n          container.scrollTop = elementTop;\n        }\n      }\n    }\n  }\n  private enterPressed = false;\n  onKeyDown(event: KeyboardEvent) {\n    if (event.key === 'Enter') {\n      this.enterPressed = true;\n      // Nu c sn phm, chn sn phm\n      if (this.showDropdown && this.filteredProducts.length > 0) {\n        event.preventDefault();\n        if (this.activeIndex >= 0 && this.activeIndex < this.filteredProducts.length) {\n          this.selectProduct(this.filteredProducts[this.activeIndex]);\n        }\n      }\n    } else if (!this.showDropdown || this.filteredProducts.length === 0) {\n      return;\n    } else if (event.key === 'ArrowDown') {\n      event.preventDefault();\n      if (this.activeIndex < this.filteredProducts.length - 1) {\n        this.activeIndex++;\n        setTimeout(() => this.scrollToActiveItem(), 0);\n      }\n    } else if (event.key === 'ArrowUp') {\n      event.preventDefault();\n      if (this.activeIndex > 0) {\n        this.activeIndex--;\n        setTimeout(() => this.scrollToActiveItem(), 0);\n      }\n    }\n  }\n  onSearchInput() {\n    this.searchChanged.next(this.searchTerm.trim());\n  }\n  lastCartItemsLength = 0;\n  async onSearchInputInternal(query: string): Promise<void> {\n    if (query.length === 0) {\n      this.filteredProducts = [];\n      this.showDropdown = false;\n      this.activeIndex = -1;\n      return;\n    }\n\n    let results = await this.productService.searchProducts(query);\n    results = results.filter((p): p is Product => !!p && typeof p === 'object' && 'Name' in p && 'Code' in p && 'Unit' in p);\n    if (results.length > 0) {\n      const queryLower = query.toLowerCase();\n\n      //  KIM TRA TRNG KHP CHNH XC M SN PHM\n      const exactCodeMatch = results.find(p => p.Code?.toLowerCase() === queryLower);\n\n      if (exactCodeMatch) {\n        // Nu tm thy sn phm c m trng khp chnh xc, chn ngay lp tc\n        this.selectProduct(exactCodeMatch);\n        return;\n      }\n\n      // Logic c  kim tra cnh bo khi cha chn sn phm\n      let isProductCode = false;\n      if (queryLower.includes('-')) {\n        const baseQuery = queryLower.split('-')[0];\n        isProductCode = results.some(p => p.Code?.toLowerCase() === baseQuery);\n      } else {\n        isProductCode = results.some(p => p.Code?.toLowerCase() === queryLower);\n      }\n\n      if (isProductCode && this.showDropdown && this.cartItems.length === this.lastCartItemsLength) {\n        setTimeout(() => alert(`BN CHA CHN SN PHM TRC . \n       HY NHP LI !`), 1000);\n      }\n      this.showDropdown = true;\n      this.lastCartItemsLength = this.cartItems.length;\n    } else {\n      this.showDropdown = false;\n    }\n\n    if (results.length === 0) {\n      const fetched = await this.productService.loadProductsIfNotExist(query);\n      if (fetched && fetched.length > 0) {\n        results = await this.productService.searchProducts(query);\n        results = results.filter(p => p && p.Image && p.Name || p.FullName && p.Code && p.Unit && p.BasePrice);\n      }\n\n      if (results.length === 0) {\n        if (this.enterPressed) {\n          alert('Khng tm thy sn phm');\n          this.enterPressed = false;\n        }\n        this.filteredProducts = [];\n        this.showDropdown = false;\n        this.activeIndex = -1;\n        return;\n      }\n\n      //  KIM TRA LI SAU KHI FETCH\n      const queryLower = query.toLowerCase();\n      const exactCodeMatch = results.find(p => p.Code?.toLowerCase() === queryLower);\n\n      if (exactCodeMatch) {\n        this.selectProduct(exactCodeMatch);\n        return;\n      }\n    }\n\n    //  Xa logic c chn t ng khi ch c 1 sn phm\n    // By gi ch hin th dropdown  user c th chn\n\n    this.filteredProducts = results;\n    this.showDropdown = results.length > 0;\n    this.activeIndex = results.length > 0 ? 0 : -1;\n    console.log('Kt qu tm kim cui cng:', this.filteredProducts);\n    setTimeout(() => this.scrollToActiveItem(), 0);\n    this.activeIndex = -1;\n  }\n\n  async updateItemUnit(index: number, unit: string) {\n    const item = this.cartItems[index];\n    const masterId = (item as any).masterId || item.product.MasterUnitId || item.product.Id;\n    const group = this.groupedProducts[masterId];\n\n    if (group) {\n      // Tm sn phm ng n v\n      const newProduct = group.find(p => p.Unit === unit);\n      if (newProduct) {\n  // Ly thng tin mi nht t IndexedDB\n  const db = await this.indexedDBService.getDB('SalesDB', 1);\n        const tx = db.transaction('products', 'readonly');\n        const latestProduct = await tx.store.get(newProduct.Id);\n\n        // Nu ly c sn phm mi nht, dng n, nu khng th dng newProduct c\n        item.product = latestProduct ? { ...latestProduct } : { ...newProduct };\n        item.unitPrice = item.product.BasePrice;\n        this.updateItemTotal(item);\n      }\n    }\n    item.product.Unit = unit;\n    this.cartItems[index].unitPriceSaleOff = 0; // Reset gi sale off khi i n v\n\n    //  Cp nht tng tin invoice\n    this.updateInvoiceTotalPrice();\n  }\n\n\n  getAvailableUnits(product: Product, cartItem?: any): string[] {\n    // u tin ly masterId t cartItem nu c\n    const masterId = cartItem?.MasterUnitId || product.MasterUnitId || product.Id;\n    const masterProducts = this.groupedProducts[masterId];\n    if (masterProducts && masterProducts.length > 0) {\n      const units = new Set<string>();\n\n      masterProducts.forEach(p => {\n        if (p.Unit) {\n          units.add(p.Unit);\n        }\n      });\n      return Array.from(units);\n    }\n    if (product.Unit) {\n      return [product.Unit];\n    }\n\n    return [];\n  }\n  sortCartItemsByQuantity(productCode: string) {\n    const idx = this.cartItems.findIndex(item => item.product.Code === productCode);\n    if (idx > -1) {\n      const [item] = this.cartItems.splice(idx, 1);\n      this.cartItems.unshift(item);\n    }\n  }\n\n  selectProduct(product: Product) {\n    if (product.BasePrice < product.Cost) {\n      alert(`GI BN ang thp hn GI VN, cn kim tra li  Sn phm: \n            ${product.Name}`);\n      return; // Khng thm vo cartItems\n    }\n    const existingItem = this.cartItems.find(item => item.product.Code === product.Code);\n\n    if (existingItem) {\n      existingItem.quantity += 1;\n      this.updateItemTotal(existingItem);\n      this.sortCartItemsByQuantity(product.Code);\n    } else {\n      const newItem: CartItem = {\n        product,\n        quantity: 1,\n        unitPrice: product.BasePrice,\n        totalPrice: product.BasePrice,\n        unitPriceSaleOff: 0\n      };\n\n      this.cartItems.unshift(newItem);\n    }\n\n    //  ng b vi invoice\n    this.syncCartWithInvoice();\n\n    this.showDropdown = false;\n    setTimeout(() => {\n      this.searchInput?.nativeElement.select(); // Bi en ton b sau mi ln input thay i\n    }, 0);\n  }\n  getTotalQuantity(): number {\n    return this.cartItems.reduce((total, item) => total + item.quantity, 0);\n  }\n  getTotalAmount(): number {\n    return this.cartItems.reduce((total, item) => total + item.totalPrice, 0);\n  }\n  getTotalCost(): number {\n    return this.cartItems.reduce((total, item) => total + item.product.Cost * item.quantity, 0);\n  }\n  onDiscountChange() {\n    // ng b discount vo invoice hin ti\n    if (this.invoices[this.activeTabIndex]) {\n      this.invoices[this.activeTabIndex].discountAmount = this.discountAmount;\n      if (!(this.invoices[this.activeTabIndex] as any).customerPaidManuallySet) {\n        this.invoices[this.activeTabIndex].customerPaid = this.getTotalAmount() - this.discountAmount;\n      }\n    }\n    this.saveDataToLocalStorage();\n  }\n  updateInvoiceTotalPrice() {\n    if (this.invoices[this.activeTabIndex]) {\n      if (!(this.invoices[this.activeTabIndex] as any).customerPaidManuallySet) {\n        this.invoices[this.activeTabIndex].customerPaid = this.getTotalAmount() - this.discountAmount;\n      }\n      this.invoices[this.activeTabIndex].totalPrice = this.getTotalAmount();\n      this.invoices[this.activeTabIndex].totalCost = this.getTotalCost();\n      this.invoices[this.activeTabIndex].totalQuantity = this.getTotalQuantity();\n      this.invoices[this.activeTabIndex].discountAmount = this.discountAmount;\n    }\n    this.saveDataToLocalStorage();\n  }\n\n  updateItemTotal(item: CartItem) {\n    item.totalPrice = item.quantity * item.unitPrice;\n\n    //  THM DNG NY - Cp nht tng tin invoice mi khi item thay i\n    this.updateInvoiceTotalPrice();\n  }\n  onQuantityChange(item: CartItem) {\n    this.updateItemTotal(item);\n  }\n  removeItem(index: number) {\n    this.cartItems.splice(index, 1);\n    //  ng b vi invoice\n    this.syncCartWithInvoice();\n  }\n  private syncCartWithInvoice() {\n    if (this.invoices[this.activeTabIndex]) {\n      // ng b cartItems vo invoice\n      this.invoices[this.activeTabIndex].cartItems = [...this.cartItems];\n      this.invoices[this.activeTabIndex].discountAmount = this.discountAmount;\n      this.invoices[this.activeTabIndex].customer = this.selectedCustomer;\n      this.updateInvoiceTotalPrice();\n    }\n  }\n  getItemStatus(product: Product): string {\n    if (!product) return '';\n    if (product.ProductAttributes[0]?.Value === undefined || product.ProductAttributes[0]?.Value === null) return '';\n\n    return product.ProductAttributes[0]?.Value || '';\n  }\n\n  showNoteInputIndex: number | null = null;\n\n  showNoteForProduct(index: number) {\n    this.showNoteInputIndex = index;\n    this.selectedItem = this.cartItems[index];\n    this.showNoteInput = true;\n    setTimeout(() => {\n      const input = this.noteInputs?.toArray()[0]?.nativeElement;\n      if (input) {\n        input.focus();\n        input.select();\n      }\n    }, 0);\n  }\n\n  calculateFinalPrice(): number {\n    if (!this.selectedItem) return 0;\n\n    let finalPrice = this.selectedItem.unitPrice;\n\n    if (this.discountType === 'VND') {\n      finalPrice -= this.discountAmount;\n    } else {\n      finalPrice = finalPrice * (1 - this.discountAmount / 100);\n    }\n\n    return Math.max(0, finalPrice);\n  }\n\n\n  selectQuickAmount(amount: number) {\n    if (this.invoices[this.activeTabIndex]) {\n      this.invoices[this.activeTabIndex].customerPaid = amount;\n      (this.invoices[this.activeTabIndex] as any).customerPaidManuallySet = true;\n    }\n  }\n\n  addNewProduct() {\n    console.log('Add new product');\n    this.showDropdown = false;\n  }\n\n\n\n  formatPrice(price: number): string {\n    return Math.abs(price).toLocaleString('en-US');\n  }\n\n  customerSuggestions: any[] = [];\n  customerSearchTerm = '';\n  selectedCustomer: Customer | null = null;\n\n  selectCustomer(customer: Customer) {\n    this.selectedCustomer = customer;\n    this.customerSearchTerm = customer.Name + ' - ' + (customer.ContactNumber || '');\n    this.customerSuggestions = [];\n\n    if (this.isOrderMode) {\n      if (this.orders[this.activeOrderTabIndex]) {\n        this.orders[this.activeOrderTabIndex].customer = { ...customer };\n      }\n    } else {\n      if (this.invoices[this.activeTabIndex]) {\n        this.invoices[this.activeTabIndex].customer = { ...customer };\n      }\n    }\n    this.showCustomerDropdown = false;\n    this.saveDataToLocalStorage();\n  }\n\n  activeCustomerIndex = 0;\n  async onCustomerSearchInput(event: any) {\n    const value = event.target.value.trim().toLowerCase();\n    this.customerSearchTerm = value;\n\n    if (!value) {\n      this.customerSuggestions = [];\n      this.showCustomerDropdown = false;\n      return;\n    }\n\n    // Ly d liu t IndexedDB\n  const db = await this.indexedDBService.getDB('Client', 1);\n    const tx = db.transaction('customers', 'readonly');\n    const store = tx.objectStore('customers');\n    const allCustomers = await store.getAll();\n\n    this.customerSuggestions = allCustomers.filter(c =>\n      (c.Name || '').toLowerCase().includes(value) ||\n      (c.ContactNumber || '').toLowerCase().includes(value)\n    );\n\n    this.activeCustomerIndex = 0;\n    this.showCustomerDropdown = this.customerSuggestions.length > 0;\n    this.saveDataToLocalStorage();\n  }\n\n  onCustomerDelete(event: any) {\n    // Kim tra nu sau khi delete/backspace m input rng\n    setTimeout(() => {\n      const inputValue = event.target.value;\n      if (!inputValue || inputValue.trim() === '') {\n        this.selectedCustomer = null;\n        this.showCustomerDropdown = false;\n        this.customerSuggestions = [];\n        if (this.isOrderMode) {\n          if (this.orders[this.activeOrderTabIndex]) {\n            this.orders[this.activeOrderTabIndex].customer = null;\n          }\n        } else {\n          if (this.invoices[this.activeTabIndex]) {\n            this.invoices[this.activeTabIndex].customer = null;\n          }\n        }\n        this.saveDataToLocalStorage();\n      }\n    }, 0);\n  }\n  onCustomerKeyDown(event: KeyboardEvent) {\n    if (!this.customerSuggestions || this.customerSuggestions.length === 0) return;\n\n    if (event.key === 'ArrowDown') {\n      if (this.activeCustomerIndex < this.customerSuggestions.length - 1) {\n        this.activeCustomerIndex++;\n        event.preventDefault();\n      }\n    } else if (event.key === 'ArrowUp') {\n      if (this.activeCustomerIndex > 0) {\n        this.activeCustomerIndex--;\n        event.preventDefault();\n      }\n    } else if (event.key === 'Enter') {\n      if (this.customerSuggestions[this.activeCustomerIndex]) {\n        this.selectCustomer(this.customerSuggestions[this.activeCustomerIndex]);\n        event.preventDefault();\n      }\n    }\n  }\n\n  onCustomerEnter(index: number) {\n    this.selectCustomer(this.customerSuggestions[this.activeCustomerIndex]);\n  }\n  @HostListener('window:keydown', ['$event'])\n  handleKeyDown(event: KeyboardEvent) {\n    if (event.key === 'F3') {\n      event.preventDefault(); // Ngn trnh duyt m tm kim mc nh\n      this.searchInput?.nativeElement.focus();\n      this.searchInput.nativeElement.select();\n    }\n    if (event.key === 'Enter') {\n      event.preventDefault(); // Ngn trnh duyt m tm kim mc nh\n      this.searchInput?.nativeElement.focus();\n      this.searchInput.nativeElement.select();\n    }\n    if (event.key === 'F4') {\n      event.preventDefault(); // Ngn trnh duyt m tm kim mc nh\n      this.searchCustomer?.nativeElement.focus();\n    }\n    if (event.key === 'F1') {\n      event.preventDefault();\n      setTimeout(() => {\n        this.searchInput?.nativeElement.select(); // Bi en ton b sau mi ln input thay i\n      }, 0);\n      this.addInvoiceTab();\n    }\n    if (event.key === 'F2') {\n      event.preventDefault();\n      this.togglePrint();\n    }\n    if (event.key === 'F9') {\n      event.preventDefault();\n      if (this.isOrderMode) {\n        this.order();\n      } else {\n        this.checkout();\n      }\n    }\n    if (event.altKey && !event.ctrlKey && !event.metaKey) {\n      const key = event.key;\n      let idx = -1;\n      if (key >= '1' && key <= '9') {\n        idx = parseInt(key, 10) - 1;\n      } else if (key === '0') {\n        idx = 9;\n      }\n      if (idx >= 0 && idx < this.cartItems.length) {\n        event.preventDefault();\n        this.removeItem(idx);\n      }\n    }\n    // Alt + number sequence: xa item  index >= 0 (Alt+2+5 => xa item 25)\n    if (event.altKey && !event.shiftKey && !event.ctrlKey && !event.metaKey) {\n      if (event.key >= '0' && event.key <= '9') {\n        this._removeItemKeyBuffer += event.key;\n        // Ch thc hin xa khi buffer c t 2 s tr ln\n        if (this._removeItemKeyBuffer.length >= 2) {\n          const idx = parseInt(this._removeItemKeyBuffer, 10);\n          if (!isNaN(idx) && idx < this.cartItems.length) {\n            event.preventDefault();\n            this.removeItem(idx);\n          }\n          this._removeItemKeyBuffer = '';\n        }\n      } else {\n        // Nu nhn phm khng phi s, reset buffer\n        this._removeItemKeyBuffer = '';\n      }\n      return;\n    }\n  }\n  private _removeItemKeyBuffer = '';\n  handleClick(event: MouseEvent) {\n    event.preventDefault(); // Ngn trnh duyt m tm kim mc nh\n    this.searchInput?.nativeElement.focus();\n    this.searchInput.nativeElement.select();\n  }\n  getCartTotal(): number {\n    return this.cartItems.reduce((sum, item) => sum + (item.totalPrice || 0), 0);\n  }\n\n  invoiceNote = ''\n  createdDate = '';\n  async addInvoiceTab() {\n\n    const tabId = this.tabCounter;\n\n    const newId = Date.now().toString();\n    const newTab: InvoiceTab = {\n      id: 'HD' + newId,\n      name: 'Ha n ' + tabId,\n      cartItems: [],\n      createdDate: this.createdDate,\n      totalPrice: 0, //  Bt u vi 0\n      discountAmount: 0, //  Reset discount\n      customer: null, //  Reset customer\n      totalQuantity: 0,\n      debt: 0,\n      note: this.invoiceNote,\n      customerPaid: 0,\n      totalCost: 0, //  Bt u vi 0\n    };\n    (newTab as any).customerPaidManuallySet = false;\n\n    this.tabCounter++;\n    this.invoices.push(newTab);\n    this.setActiveTab(this.invoices.length - 1);\n\n    //  Reset cc gi tr khi to tab mi\n    this.change = 0;\n    this.discountAmount = 0;\n    this.selectedCustomer = null;\n    this.customerSearchTerm = '';\n    this.formattedCustomerPaid = '0';\n    this.invoiceNote = '';\n    this.isOrderMode = false;\n    this.saveDataToLocalStorage();\n  }\n\n  removeInvoiceTab(index: number) {\n    const tabToRemove = this.invoices[index];\n\n    // Nu tab khng c item, xa trc tip khng cn dialog\n    if (!tabToRemove.cartItems || tabToRemove.cartItems.length === 0) {\n      this.handleRemoveTab(index);\n      return;\n    }\n\n    // Nu tab c item, hin th dialog xc nhn\n    const dialogRef = this.dialog.open(ConfirmPopupComponent, {\n      width: '300px',\n      data: { message: 'Bn c chc chn mun ng ha n?' }\n    });\n\n    dialogRef.afterClosed().subscribe(result => {\n      if (result === true) {\n        this.handleRemoveTab(index);\n      }\n    });\n  }\n\n  private handleRemoveTab(index: number) {\n    // Xa d liu localStorage cho tab ny trc khi xa\n    this.localStorageService.clearTabData(index);\n\n    // Nu ch cn 1 tab cui cng, reset v \"Ha n 1\"\n    if (this.invoices.length === 1) {\n      const lastTab = this.invoices[0];\n      lastTab.name = 'Ha n 1';\n      lastTab.id = 'HD' + Date.now().toString();\n      lastTab.cartItems = []; // Clear items nu c\n      this.tabCounter = 2;\n      lastTab.customerPaid = 0;\n      this.setActiveTab(0);\n      return;\n    }\n\n    // Xa tab\n    this.invoices.splice(index, 1);\n\n    // m bo lun c t nht 1 tab\n    if (this.invoices.length === 0) {\n      this.addInvoiceTab();\n    } else {\n      // Set active tab mi\n      const newIndex = Math.max(index - 1, 0);\n      this.setActiveTab(newIndex);\n    }\n    // Nu cn tab  v tr index, ng b discount, nu khng th ly discount ca tab u tin\n    this.discountAmount = this.invoices[index]?.discountAmount || this.invoices[0]?.discountAmount || 0;\n    this.saveDataToLocalStorage();\n  }\n\n  setActiveTab(index: number) {\n    setTimeout(() => {\n      this.searchInput?.nativeElement.select(); // Bi en ton b sau mi ln input thay i\n    }, 0);\n    this.activeTabIndex = index;\n    //  To copy thay v reference trc tip\n    this.cartItems = [...this.invoices[index].cartItems];\n    //  ng b thng tin customer\n    this.selectedCustomer = this.invoices[index].customer;\n\n    if (this.selectedCustomer) {\n      this.customerSearchTerm = this.selectedCustomer.Name + ' - ' + (this.selectedCustomer.ContactNumber || '');\n    } else {\n      this.customerSearchTerm = '';\n    }\n    this.invoiceNote = this.invoices[index].note || '';\n    //  ng b discount\n    this.discountAmount = this.invoices[index].discountAmount || 0;\n    // Reset order mode khi chuyn tab\n    this.isOrderMode = false;\n    // Debug log  kim tra\n    console.log(` setActiveTab debug:`, {\n      index: index,\n      invoiceName: this.invoices[index].name,\n      customerPaidManuallySet: (this.invoices[index] as any).customerPaidManuallySet,\n      currentCustomerPaid: this.invoices[index].customerPaid,\n      isFromOrder: this.invoices[index].name?.includes('Ha n t n hng'),\n      totalAmount: this.getTotalAmount(),\n      discountAmount: this.discountAmount\n    });\n\n    // Nu cha nhp tay v khng phi invoice t order, t ng set customerPaid = Khch cn tr\n    if (!(this.invoices[index] as any).customerPaidManuallySet &&\n      !this.invoices[index].name?.includes('Ha n t n hng')) {\n      this.invoices[index].customerPaid = this.getTotalAmount() - this.discountAmount;\n      console.log(` Auto-set customerPaid to:`, this.invoices[index].customerPaid);\n    } else {\n      console.log(` Keeping original customerPaid:`, this.invoices[index].customerPaid);\n    }\n  }\n\n  change = 0\n  getChangeAmount(): number {\n    if (this.invoices[this.activeTabIndex].cartItems.length === 0) {\n      this.change = 0;\n      return 0;\n    }\n    if (this.isOrderMode) {\n      const order = this.orders[this.activeOrderTabIndex];\n      const paid = order.customerPaid ? Number(order.customerPaid) : 0;\n      const total = this.getTotalAmount();\n      const discount = this.discountAmount || 0;\n      this.change = paid - (total - discount);\n      return this.change;\n    } else {\n      const invoice = this.invoices[this.activeTabIndex];\n      const paid = invoice?.customerPaid ? Number(invoice.customerPaid) : 0;\n      const total = this.getTotalAmount();\n      const discount = this.discountAmount || 0;\n      this.change = paid - (total - discount);\n      return this.change;\n    }\n  }\n  roundToNearestTenThousand(value: number): number {\n    return Math.round(value / 10000) * 10000;\n  }\n  quickAmounts: number[] = [];\n  roundUpToNearestStep(value: number, step: number): number {\n    return Math.ceil(value / step) * step;\n  }\n  setquickAmounts() {\n    const total = this.getTotalAmount() - (this.discountAmount || 0);\n    let quicks: number[] = [];\n    if (total < 10000) {\n      quicks = [total, 10000, 20000, 50000, 100000, 200000, 500000];\n    } else if (total < 20000) {\n      quicks = [total, 20000, 50000, 100000, 200000, 500000];\n    } else if (total < 50000) {\n      quicks = [total, 50000, 100000, 200000, 500000];\n    } else if (total < 100000) {\n      quicks = [total, 100000, 200000, 500000];\n    } else if (total < 150000) {\n      quicks = [total, 150000, 200000, 500000];\n    } else if (total < 200000) {\n      quicks = [total, 200000, 500000];\n    } else if (total < 250000) {\n      quicks = [total, 250000, 300000, 400000, 500000];\n    } else if (total < 300000) {\n      quicks = [total, 300000, 400000, 500000];\n    } else if (total < 350000) {\n      quicks = [total, 350000, 400000, 500000];\n    } else if (total < 400000) {\n      quicks = [total, 400000, 450000, 500000];\n    } else if (total < 450000) {\n      quicks = [total, 450000, 500000];\n    } else if (total < 500000) {\n      quicks = [total, 500000, 550000, 600000, 700000, 800000, 900000, 1000000];\n    } else if (total < 550000) {\n      quicks = [total, 550000, 600000, 700000, 800000, 900000, 1000000];\n    } else if (total < 600000) {\n      quicks = [total, 600000, 700000, 800000, 900000, 1000000];\n    } else if (total < 650000) {\n      quicks = [total, 650000, 700000, 800000, 900000, 1000000];\n    } else if (total < 700000) {\n      quicks = [total, 700000, 750000, 800000, 900000, 1000000];\n    } else if (total < 750000) {\n      quicks = [total, 750000, 800000, 900000, 1000000];\n    } else if (total < 800000) {\n      quicks = [total, 800000, 900000, 1000000];\n    } else if (total < 850000) {\n      quicks = [total, 850000, 900000, 1000000];\n    } else if (total < 900000) {\n      quicks = [total, 900000, 1000000];\n    } else if (total < 950000) {\n      quicks = [total, 950000];\n    } else if (total < 1000000) {\n      quicks = [total, 1000000];\n    } else if (total < 1100000) {\n      quicks = [total, 1100000, 1200000, 1500000];\n    } else if (total < 1200000) {\n      quicks = [total, 1200000, 1500000];\n    } else if (total < 1300000) {\n      quicks = [total, 1300000, 1400000, 1500000];\n    } else if (total < 1400000) {\n      quicks = [total, 1400000, 1500000];\n    } else if (total < 1500000) {\n      quicks = [total, 1500000];\n    } else if (total < 1600000) {\n      quicks = [total, 1600000];\n    } else if (total < 1700000) {\n      quicks = [total, 1700000];\n    } else if (total < 1800000) {\n      quicks = [total, 1800000];\n    } else if (total < 1900000) {\n      quicks = [total, 1900000];\n    } else if (total < 2000000) {\n      quicks = [total, 2000000];\n    } else if (total < 2500000) {\n      quicks = [total, 2500000, 3000000];\n    } else if (total < 3000000) {\n      quicks = [total, 3000000];\n    } else if (total < 4000000) {\n      quicks = [total, 4000000];\n    } else if (total < 5000000) {\n      quicks = [total, 5000000];\n    } else if (total < 10000000) {\n      quicks = [total, 10000000];\n    } else {\n      quicks = [total];\n    }\n    // Loi b cc gi tr trng lp v <=0\n    this.quickAmounts = quicks\n      .filter((v, i, arr) => arr.indexOf(v) === i && v > 0)\n      .map(v => this.roundUpToNearestStep(v, 1000));\n  }\n\n  onUnitPriceInput(event: any, item: CartItem) {\n    const value = Number(event.target.value.replace(/\\D/g, ''));\n    item.unitPrice = value;\n    this.updateItemTotal(item);\n\n    // Tnh chnh lch nu gi nhp nh hn gi gc\n    item.unitPriceSaleOff = item.product.BasePrice - value;\n\n  }\n\n  showMenuDropdown = false;\n\n  onMenuClick(type: string) {\n    this.showMenuDropdown = false;\n    // X l chuyn tab hoc m modal tng ng\n    if (type === 'hanghoa') {\n      this.saveDataToLocalStorage();\n      this.router.navigate(['/edit-product-page']);\n    } else if (type === 'hoadon') {\n      const dialogRef = this.dialog.open(InvoicesPageComponent, {\n        width: '100%',\n        height: '100%',\n        panelClass: 'slide-in-modal',\n        disableClose: false\n      });\n\n      // Handle when invoices dialog requests \"edit\"  open invoice in main page for editing\n      dialogRef.afterClosed().subscribe((result: any) => {\n        if (result?.edit && result.invoice) {\n          const inv = result.invoice as InvoiceTab;\n          // Create a new invoice tab from the selected invoice (so user can edit it)\n          const newTab: InvoiceTab = {\n            id: inv.id || ('HD' + Date.now().toString()),\n            name: inv.name || ('Ha n ' + this.tabCounter),\n            cartItems: [...(inv.cartItems || [])],\n            createdDate: inv.createdDate || new Date().toISOString(),\n            totalPrice: inv.totalPrice || this.getTotalAmount(),\n            discountAmount: inv.discountAmount || 0,\n            customer: inv.customer ? { ...inv.customer } : null,\n            totalQuantity: inv.totalQuantity || 0,\n            debt: inv.debt || 0,\n            note: inv.note || '',\n            customerPaid: inv.customerPaid || 0,\n            totalCost: inv.totalCost || 0,\n          } as InvoiceTab;\n\n          // Add as a new tab and set active\n          this.tabCounter++;\n          this.invoices.push(newTab);\n          this.setActiveTab(this.invoices.length - 1);\n\n          // Load cart items and related fields into UI\n          this.cartItems = [...(inv.cartItems || [])];\n          this.discountAmount = inv.discountAmount || 0;\n          this.selectedCustomer = inv.customer ? { ...inv.customer } : null;\n          this.invoiceNote = inv.note || '';\n\n          // Enter edit mode so F9 becomes \"LU CHNH SA (F9)\"\n          this.isEditMode = true;\n\n          // Distinguish invoice-edit vs order-edit\n          this.isEditModeInvoice = !!result.isInvoiceEdit;\n          if (this.isEditModeInvoice) {\n            this.originalInvoiceId = inv.id || null;\n            this.originalOrderId = null;\n          } else {\n            this.originalOrderId = inv.id || null;\n            this.originalInvoiceId = null;\n          }\n\n          // Persist UI state\n          this.saveDataToLocalStorage();\n        }\n      });\n    } else if (type === 'khachhang') {\n      this.dialog.open(CustomersPageComponent, {\n        width: '100%',\n        height: '100%',\n        maxWidth: '100vw',\n        panelClass: 'slide-in-modal',\n        disableClose: false\n      });\n    } else if (type === 'baocao') {\n      this.dialog.open(ReportPageComponent, {\n        width: '100%',\n        height: '100%',\n        panelClass: 'slide-in-modal',\n        disableClose: false\n      });\n    } else if (type === 'dathang') {\n      this.saveDataToLocalStorage();\n      this.dialog.open(OrderPageComponent, {\n        width: '100%',\n        height: '100%',\n        maxWidth: '100vw',\n        panelClass: 'slide-in-modal',\n        disableClose: false\n      });\n    } else if (type === 'dangxuat') {\n      const confirmed = confirm('Bn c chc chn mun ng xut?');\n      if (confirmed) {\n        // Xa thng tin ng nhp khi localStorage\n        localStorage.removeItem('kv_access_token');\n        localStorage.removeItem('kv_retailer');\n        localStorage.removeItem('kv_branch_id');\n\n        // Chuyn hng v trang login\n        this.router.navigate(['/login']);\n      }\n    }\n  }\n\n  isReloading = false;\n  hasOfflineInvoices = false;\n\n  isPrintEnabled = false;\n\n  togglePrint() {\n    this.isPrintEnabled = !this.isPrintEnabled;\n  }\n  selectIfNotSelected(event: MouseEvent): void {\n    const input = event.target as HTMLInputElement;\n    // Nu cha c phn no c chn (hoc ngi dng click sai v tr)\n    if (input.selectionStart !== 0 || input.selectionEnd !== input.value.length) {\n      setTimeout(() => input.select(), 0);\n    }\n  }\n  increaseQuantity(item: CartItem): void {\n    if (item.quantity < item.product.OnHand) {\n      item.quantity += 1;\n      this.updateItemTotal(item); //  bao gm updateInvoiceTotalPrice()\n    }\n  }\n  closeInvoice() {\n    const dialogRef = this.dialog.open(ConfirmPopupComponent, {\n      width: '300px',\n      data: { message: 'Bn c chc chn mun ng ha n?' }\n    });\n\n    dialogRef.afterClosed().subscribe(result => {\n      if (result === true) {\n        // Thc hin ng ha n\n        console.log('Ha n  c ng');\n      } else {\n        console.log('Hy thao tc ng ha n');\n      }\n    });\n  }\n\n  formattedCustomerPaid = '0';\n\n  formatNumberWithCommas(value: number): string {\n    return value.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',');\n  }\n\n  onCustomerPaidChange(event: Event): void {\n    if (this.isOrderMode) {\n      const input = (event.target as HTMLInputElement).value;\n      const raw = parseInt(input.replace(/,/g, ''), 10);\n      const paid = isNaN(raw) ? 0 : raw;\n      if (this.orders[this.activeOrderTabIndex]) {\n        this.orders[this.activeOrderTabIndex].customerPaid = paid;\n        (this.orders[this.activeOrderTabIndex] as any).customerPaidManuallySet = true;\n      }\n      return;\n    } else {\n      const input = (event.target as HTMLInputElement).value;\n      const raw = parseInt(input.replace(/,/g, ''), 10);\n      const paid = isNaN(raw) ? 0 : raw;\n      if (this.invoices[this.activeTabIndex]) {\n        this.invoices[this.activeTabIndex].customerPaid = paid;\n        (this.invoices[this.activeTabIndex] as any).customerPaidManuallySet = true;\n      }\n    }\n\n  }\n\n  onNoteChange() {\n    if (this.invoices[this.activeTabIndex]) {\n      this.invoices[this.activeTabIndex].note = this.invoiceNote;\n    }\n    this.saveDataToLocalStorage();\n  }\n\n  openAddCustomerDialog() {\n    const dialogRef = this.dialog.open(AddCustomerComponent, {\n      width: '100%',\n      height: '100%',\n      disableClose: true,\n      data: { customer: null } // Truyn d liu nu cn\n    });\n\n    dialogRef.afterClosed().subscribe(result => {\n      if (result) {\n        // Nu c kt qu tr v, cp nht danh sch khch hng\n        this.customerService.loadCustomersFromKiotvietToIndexedDB().then(() => {\n          console.log('Tt c customer  c ti v lu vo IndexedDB.');\n        }).catch((err) => {\n          console.error('Li khi ti tt c customer:', err);\n        });\n      }\n    });\n  }\n\n  async syncCartItemsWithIndexedDB() {\n    const db = await this.indexedDBService.getDB('SalesDB', 1);\n    for (const item of this.cartItems) {\n      const latestProduct = await db.transaction('products', 'readonly').store.get(item.product.Id);\n      if (latestProduct) {\n        // Cp nht cc trng cn thit\n        item.product = { ...latestProduct };\n        item.unitPrice = latestProduct.BasePrice;\n        // Nu c cc trng khc cn gi li (v d: quantity, unitPriceSaleOff), gi nguyn\n      }\n    }\n    // ng b li vi invoice\n    this.syncCartWithInvoice();\n  }\n\n  showEditOnHandIndex: number | null = null;\n  editOnHandValue = 0;\n\n  openEditOnHandPopup(index: number) {\n    this.showEditOnHandIndex = index;\n    this.editOnHandValue = this.cartItems[index].product.OnHand;\n  }\n  closeEditOnHandPopup() {\n    this.showEditOnHandIndex = null;\n  }\n  async confirmEditOnHand(index: number) {\n  const item = this.cartItems[index];\n  const newOnHand = this.editOnHandValue;\n  item.product.OnHand = this.editOnHandValue;\n\n  try {\n    const masterUnitId = item.product.MasterUnitId || item.product.Id;\n    const group = this.groupedProducts[masterUnitId];\n    if (!group || group.length === 0) {\n      console.error('Khng tm thy group cho sn phm:', item.product.Id);\n      return;\n    }\n\n    // Tm master item (nu c)\n    const masterItem = group.find(p => p.MasterUnitId == null) || group[0];\n    const selectedProduct = item.product;\n    const masterOnHand = newOnHand * selectedProduct.ConversionValue;\n\n    console.log(`confirmEditOnHand: updating master ${masterItem.Id} OnHand -> ${masterOnHand}`);\n\n    // 1) Cp nht KiotViet (master item)\n    try {\n      const formData = await this.kiotvietService.getRequestBody(masterItem.Id);\n      formData.Product.OnHand = masterOnHand;\n      const kvRes = await this.kiotvietService.updateProductToKiotviet(formData);\n      console.log(' KiotViet update result:', kvRes);\n    } catch (kvErr) {\n      console.error(' Li khi cp nht KiotViet:', kvErr);\n      // tip tc  cp nht local/remote khc\n    }\n\n    // 2) Chun b danh sch sn phm  cp nht (IndexedDB + Firestore/API)\n    const productsToUpdate: Product[] = [];\n    for (const p of group) {\n      const newProductOnHand = masterOnHand / p.ConversionValue;\n      p.OnHand = newProductOnHand;\n      productsToUpdate.push({ ...p });\n    }\n\n    // 3) Cp nht IndexedDB cc b\n    try {\n      await this.productService.updateProductsOnHandLocal(productsToUpdate);\n      console.log(` Updated ${productsToUpdate.length} product(s) in IndexedDB`);\n      // Also emit per-product update and notify server so other clients receive real-time event\n      for (const p of productsToUpdate) {\n        try {\n          await this.productService.updateSingleProductOnHandLocal(p.Id, p.OnHand);\n        } catch (e) {\n          console.warn(' updateSingleProductOnHandLocal failed for', p.Id, e);\n        }\n      }\n    } catch (dbErr) {\n      console.error(' Li khi cp nht IndexedDB:', dbErr);\n    }\n\n    // 4) Gi ln Firestore / backend API\n    let remoteRes: any = null;\n    try {\n      if (typeof (this.productService as any).updateProductOnHandToFireStore === 'function') {\n        remoteRes = await (this.productService as any).updateProductOnHandToFireStore(productsToUpdate);\n        console.log(' Called productService.updateProductOnHandToFireStore(), result:', remoteRes);\n      } else if ((this.productService as any).http && (this.productService as any).firebase?.update_products_api) {\n        // fallback nu service nh ngha url trong productService.firebase.update_products_api\n        const url = environment.domainUrl + (this.productService as any).firebase.update_products_api;\n        remoteRes = await firstValueFrom((this.productService as any).http.put(url, productsToUpdate));\n        console.log(' Fallback HTTP PUT to', url, 'result:', remoteRes);\n      } else {\n        // Generic fallback to known endpoint\n        const url = environment.domainUrl + '/api/firebase/update/products';\n        if ((this.productService as any).http) {\n          remoteRes = await firstValueFrom((this.productService as any).http.put(url, productsToUpdate));\n          console.log(' Fallback HTTP PUT to /api/firebase/update/products result:', remoteRes);\n        } else {\n          console.warn(' No HTTP client available on productService to call backend update API.');\n        }\n      }\n    } catch (remoteErr) {\n      console.error(' Li khi gi cp nht ln backend/Firestore:', remoteErr);\n    }\n\n    // 4b) Notify server per-product so it can emit socket events to other clients\n    try {\n      for (const p of productsToUpdate) {\n        this.productService.notifyServerProductOnHandChange(p.Id, p.OnHand).catch(err => {\n          console.warn(' notifyServerProductOnHandChange error for', p.Id, err);\n        });\n      }\n    } catch (notifyErr) {\n      console.warn(' Error while notifying server for OnHand changes', notifyErr);\n    }\n\n    // 5) nh du sn phm  chnh tay  trnh ghi  khng mong mun\n    productsToUpdate.forEach(p => this.manuallyEditedOnHandProductIds.add(p.Id));\n\n    // 6) Cp nht UI / localStorage\n    this.saveDataToLocalStorage();\n\n    // 7) Optional: attach a one-time listener to websocket event to confirm server emitted update\n    try {\n      const socket = (this.invoiceService as any).socket || (this.orderService as any).socket;\n      if (socket && typeof socket.once === 'function') {\n        socket.once('product_onhand_updated', (data: any) => {\n          console.log('WS: product_onhand_updated received:', data);\n        });\n        console.log(' Listening once for product_onhand_updated websocket event (if available)');\n      } else {\n        console.log(' No socket exposed on invoiceService/orderService to listen for product_onhand_updated');\n      }\n    } catch (sockErr) {\n      console.warn(' Khng th gn listener websocket tm thi:', sockErr);\n    }\n\n    console.log(` Hon thnh cp nht OnHand cho group ${masterUnitId}`);\n  } catch (e) {\n    console.error(' Li cp nht OnHand:', e);\n  }\n\n  this.closeEditOnHandPopup();\n}\n\n  // Kim tra c invoice offline khng\n  async checkOfflineInvoices() {\n    try {\n      const offlineInvoices = await this.invoiceService.getAllOfflineInvoices();\n      this.hasOfflineInvoices = offlineInvoices.length > 0;\n    } catch (error) {\n      console.error('Li khi kim tra offline invoices:', error);\n      this.hasOfflineInvoices = false;\n    }\n  }\n\n  openOfflineInvoicesDialog() {\n    const dialogRef = this.dialog.open(OfflineInvoicesListComponent, {\n      width: '90%',\n      maxWidth: '1000px',\n      height: '80%',\n      maxHeight: '400px',\n      disableClose: false,\n      panelClass: 'offline-invoices-dialog'\n    });\n    // this.productService.syncAllProductsFromIndexedDBToFirebase().then(() => {\n    //   console.log('Tt c sn phm  c ti v lu ln Firebase.');\n    // }).catch((err) => {\n    //   console.error('Li khi ti tt c sn phm:', err);\n    // }),\n    dialogRef.afterClosed().subscribe(() => {\n      // Cp nht trng thi offline sau khi ng dialog\n      this.checkOfflineInvoices();\n    });\n  }\n\n  ngOnDestroy() {\n    //  Cleanup Socket.IO connection when component is destroyed\n    this.invoiceService.disconnectSocket();\n    if (this.onHandReloadInterval) {\n      clearInterval(this.onHandReloadInterval);\n      this.onHandReloadInterval = null;\n    }\n\n    // Unsubscribe from all subscriptions\n    this.subscriptions.forEach(sub => sub.unsubscribe());\n    this.subscriptions = [];\n  }\n\n  private manuallyEditedOnHandProductIds = new Set<number>();\n\n\n  openOutOfStockDialog() {\n    this.dialog.open(OutOfStockDialogComponent, {\n      width: '100%',\n      maxWidth: '1000px',\n      height: '80%',\n      maxHeight: '600px',\n      disableClose: false\n    });\n  }\n\n  isOrderMode = false;\n\n  enableOrderMode() {\n    if (!this.isOrderMode) {\n      // Chuyn sang Order Mode\n      // Convert invoice tab hin ti thnh order tab\n      this.isOrderMode = true;\n\n      // Ly invoice tab hin ti\n      const currentInvoice = this.invoices[this.activeTabIndex];\n\n      // To order tab mi t invoice tab hin ti\n      const newOrderTab: InvoiceTab = {\n        id: 'DH' + Date.now().toString(),\n        name: 'n t hng ' + (this.orders.length + 1),\n        cartItems: [...currentInvoice.cartItems],\n        createdDate: currentInvoice.createdDate,\n        totalPrice: currentInvoice.totalPrice,\n        discountAmount: currentInvoice.discountAmount,\n        customer: currentInvoice.customer ? { ...currentInvoice.customer } : null,\n        totalQuantity: currentInvoice.totalQuantity,\n        debt: currentInvoice.debt,\n        note: currentInvoice.note,\n        customerPaid: 0, // Order lun c customerPaid = 0\n        totalCost: currentInvoice.totalCost\n      };\n      (newOrderTab as any).customerPaidManuallySet = false;\n\n      // Thm order tab vo danh sch orders\n      this.orders.push(newOrderTab);\n      this.activeOrderTabIndex = this.orders.length - 1;\n\n      // Khng xa invoice tab hin ti, ch chuyn sang order mode\n      // Gi nguyn invoice tab  c th chuyn v sau\n\n      // ng b cartItems vi order tab mi (khng gi setActiveOrderTab v n s reset cartItems)\n      this.cartItems = [...newOrderTab.cartItems];\n      this.discountAmount = newOrderTab.discountAmount;\n      this.selectedCustomer = newOrderTab.customer;\n      this.invoiceNote = newOrderTab.note || '';\n\n      // Cp nht order tab vi cartItems hin ti\n      this.orders[this.activeOrderTabIndex].cartItems = [...this.cartItems];\n      this.orders[this.activeOrderTabIndex].discountAmount = this.discountAmount;\n      this.orders[this.activeOrderTabIndex].customer = this.selectedCustomer;\n      this.orders[this.activeOrderTabIndex].note = this.invoiceNote;\n\n      console.log(' Chuyn sang Order Mode - Convert invoice tab thnh order tab');\n    } else {\n      // Tt Order Mode, tr v invoice\n      this.isOrderMode = false;\n\n      // ng b d liu t order tab v invoice tab hin ti\n      if (this.orders[this.activeOrderTabIndex]) {\n        const currentOrder = this.orders[this.activeOrderTabIndex];\n        this.invoices[this.activeTabIndex].cartItems = [...currentOrder.cartItems];\n        this.invoices[this.activeTabIndex].discountAmount = currentOrder.discountAmount;\n        this.invoices[this.activeTabIndex].customer = currentOrder.customer;\n        this.invoices[this.activeTabIndex].note = currentOrder.note;\n        this.invoices[this.activeTabIndex].totalPrice = currentOrder.totalPrice;\n        this.invoices[this.activeTabIndex].totalQuantity = currentOrder.totalQuantity;\n        this.invoices[this.activeTabIndex].totalCost = currentOrder.totalCost;\n      }\n\n      // ng b li cartItems, discount, note, customer vi invoice tab hin ti\n      this.cartItems = [...this.invoices[this.activeTabIndex].cartItems];\n      this.discountAmount = this.invoices[this.activeTabIndex].discountAmount || 0;\n      this.selectedCustomer = this.invoices[this.activeTabIndex].customer;\n      this.invoiceNote = this.invoices[this.activeTabIndex].note || '';\n      this.saveDataToLocalStorage();\n    }\n  }\n\n  // Order tab management\n  orders: InvoiceTab[] = [];\n  activeOrderTabIndex = 0;\n\n  async addOrderTab() {\n    const tabId = this.orders.length + 1;\n    const newId = Date.now().toString();\n    const newTab: InvoiceTab = {\n      id: 'DH' + newId,\n      name: 'n t hng ' + tabId,\n      cartItems: [],\n      createdDate: '',\n      totalPrice: 0,\n      discountAmount: 0,\n      customer: null,\n      totalQuantity: 0,\n      debt: 0,\n      note: '',\n      customerPaid: 0,\n      totalCost: 0\n    };\n    (newTab as any).customerPaidManuallySet = false;\n    this.orders.push(newTab);\n    this.setActiveOrderTab(this.orders.length - 1);\n\n    // Reset cc gi tr khi to tab mi t UI\n    this.cartItems = [];\n    this.discountAmount = 0;\n    this.selectedCustomer = null;\n    this.customerSearchTerm = '';\n\n    // m bo customerPaid lun = 0\n    this.orders[this.activeOrderTabIndex].customerPaid = 0;\n    this.saveDataToLocalStorage();\n  }\n\n  setActiveOrderTab(index: number) {\n    this.activeOrderTabIndex = index;\n    this.cartItems = [...this.orders[index].cartItems];\n    this.selectedCustomer = this.orders[index].customer;\n    if (this.selectedCustomer) {\n      this.customerSearchTerm = this.selectedCustomer.Name + ' - ' + (this.selectedCustomer.ContactNumber || '');\n    } else {\n      this.customerSearchTerm = '';\n    }\n    this.invoiceNote = this.orders[index].note || '';\n    this.discountAmount = this.orders[index].discountAmount || 0;\n    // m bo customerPaid lun = 0 khi chuyn tab\n    this.orders[this.activeOrderTabIndex].customerPaid = 0;\n    this.saveDataToLocalStorage();\n  }\n\n  // Khi add item vo order.cartItems, lun set customerPaid = 0\n  // private syncCartWithOrder() {\n  //   if (this.isOrderMode) {\n  //     if (this.orders[this.activeOrderTabIndex]) {\n  //       this.orders[this.activeOrderTabIndex].cartItems = [...this.cartItems];\n  //       this.orders[this.activeOrderTabIndex].discountAmount = this.discountAmount;\n  //       this.orders[this.activeOrderTabIndex].customer = this.selectedCustomer;\n  //       this.orders[this.activeOrderTabIndex].note = this.invoiceNote;\n  //       this.orders[this.activeOrderTabIndex].customerPaid = 0;\n  //     }\n  //   } else {\n  //     if (this.invoices[this.activeTabIndex]) {\n  //       this.invoices[this.activeTabIndex].cartItems = [...this.cartItems];\n  //       this.invoices[this.activeTabIndex].discountAmount = this.discountAmount;\n  //       this.invoices[this.activeTabIndex].customer = this.selectedCustomer;\n  //       this.invoices[this.activeTabIndex].note = this.invoiceNote;\n  //     }\n  //   }\n  //   this.updateInvoiceTotalPrice();\n  //   this.saveDataToLocalStorage();\n  // }\n\n  // ===================== UI TAB RENDER =====================\n  // (Phn ny s sa  HTML, nhng cn thm cc hm ny  gi t template)\n  getOrderTabs() {\n    return this.orders;\n  }\n  getActiveOrderTabIndex() {\n    return this.activeOrderTabIndex;\n  }\n  setStatus(): string {\n    // Khi order c to, mc nh l pending\n    return 'pending';\n  }\n\n  // Method to update order status when checkout is successful\n  async updateOrderStatusToChecked(orderId: string): Promise<void> {\n    try {\n      const updateData = { status: 'checked' };\n      await firstValueFrom(this.orderService.updateOrderToFirestore(orderId, updateData));\n\n      // Update in IndexedDB\n      const order = await this.orderService.getOrderFromDBById(orderId);\n      if (order) {\n        order.status = 'checked';\n        await this.orderService.updateOrderInDB(order);\n      }\n\n      // Notify via WebSocket\n      await this.orderService.notifyOrderUpdated({ id: orderId, status: 'checked' });\n\n      console.log(` Order ${orderId} status updated to 'checked'`);\n    } catch (error) {\n      console.error(` Error updating order status to 'checked':`, error);\n    }\n  }\n\n  // Checkout order (convert order to invoice)\n  async checkoutOrder(orderId: string): Promise<void> {\n    try {\n      // Get order from IndexedDB\n      const order = await this.orderService.getOrderFromDBById(orderId);\n      if (!order) {\n        console.error(` Order ${orderId} not found`);\n        return;\n      }\n\n      // Check if order is already checked or canceled\n      if (order.status === 'checked' || order.status === 'canceled') {\n        console.log(` Order ${orderId} is already ${order.status}`);\n        return;\n      }\n\n      // Update order status to 'checked'\n      await this.updateOrderStatusToChecked(orderId);\n\n      // Create invoice from order\n      const now = new Date();\n      const vnNow = this.timeZoneService.formatVietnamISOString(now);\n\n      const invoice: InvoiceTab = {\n        id: 'HD' + Date.now().toString(),\n        name: 'Ha n t n hng ' + order.id,\n        cartItems: order.cartItems,\n        createdDate: vnNow,\n        totalPrice: order.totalPrice,\n        discountAmount: order.discountAmount,\n        customer: order.customer,\n        totalQuantity: order.totalQuantity,\n        debt: 0, // Orders don't have debt\n        note: order.note,\n        customerPaid: order.totalPrice - order.discountAmount, // Full payment\n        totalCost: order.totalCost\n      };\n\n      // Add invoice to Firestore\n      this.invoiceService.addInvoiceToFirestore(invoice).subscribe({\n        next: async (res) => {\n          try {\n            await this.invoiceService.notifyInvoiceCreated(invoice);\n            console.info(` Order ${orderId} converted to invoice successfully: ${res}`);\n          } catch (error) {\n            console.error(' Error notifying invoice creation:', error);\n          }\n        },\n        error: async (err) => {\n          console.error(` Error converting order to invoice: ${err}`);\n          // Save to offline store if needed\n          try {\n            await this.invoiceService.saveInvoiceToOffline(invoice);\n            console.log(' Invoice saved to offline store');\n          } catch (offlineError) {\n            console.error(' Error saving to offline store:', offlineError);\n          }\n        }\n      });\n\n      // Add invoice to IndexedDB\n      await this.invoiceService.addInvoiceToDB(invoice);\n      console.log(` Invoice added to IndexedDB`);\n\n    } catch (error) {\n      console.error(` Error during order checkout:`, error);\n    }\n  }\n\n  // Handle processed order from order page\n  private handleProcessedOrder(invoice: InvoiceTab, orderId: string): void {\n    try {\n      console.log(` Processing order ${orderId} as invoice ${invoice.id} on main page`);\n      console.log(` Invoice data:`, {\n        customerPaid: invoice.customerPaid,\n        totalPrice: invoice.totalPrice,\n        discountAmount: invoice.discountAmount,\n        debt: invoice.debt,\n        isEditMode: (invoice as any).isEditMode\n      });\n\n      // Check if this is edit mode\n      const isEditMode = (invoice as any).isEditMode || false;\n\n      if (isEditMode) {\n        // Handle edit mode\n        this.isEditMode = true;\n        this.originalOrderId = (invoice as any).originalOrderId || orderId;\n        console.log(` Entering edit mode for order ${this.originalOrderId}`);\n      } else {\n        // Normal processing mode\n        this.isEditMode = false;\n        this.originalOrderId = null;\n      }\n\n      // Switch to invoice mode if currently in order mode\n      if (this.isOrderMode) {\n        this.isOrderMode = false;\n        // Sync current order data before switching\n        if (this.orders[this.activeOrderTabIndex]) {\n          this.orders[this.activeOrderTabIndex].cartItems = [...this.cartItems];\n          this.orders[this.activeOrderTabIndex].discountAmount = this.discountAmount;\n          this.orders[this.activeOrderTabIndex].customer = this.selectedCustomer;\n          this.orders[this.activeOrderTabIndex].note = this.invoiceNote;\n        }\n      }\n\n      // Add the processed order as a new invoice tab\n      const newInvoiceTab: InvoiceTab = {\n        id: invoice.id,\n        name: invoice.name || (isEditMode ? `Chnh sa n hng ${orderId}` : `Ha n t n hng ${orderId}`),\n        cartItems: [...invoice.cartItems],\n        createdDate: invoice.createdDate,\n        totalPrice: invoice.totalPrice,\n        discountAmount: invoice.discountAmount,\n        customer: invoice.customer ? { ...invoice.customer } : null,\n        totalQuantity: invoice.totalQuantity,\n        debt: invoice.debt || 0,\n        note: invoice.note,\n        customerPaid: invoice.customerPaid || 0,\n        totalCost: invoice.totalCost,\n        deliveryTime: invoice.deliveryTime\n      } as any;\n\n      // Mark as manually set to prevent auto-override\n      (newInvoiceTab as any).customerPaidManuallySet = true;\n      if (isEditMode) {\n        (newInvoiceTab as any).isEditMode = true;\n        (newInvoiceTab as any).originalOrderId = this.originalOrderId;\n      }\n\n      console.log(` New invoice tab data:`, {\n        customerPaid: newInvoiceTab.customerPaid,\n        totalPrice: newInvoiceTab.totalPrice,\n        discountAmount: newInvoiceTab.discountAmount,\n        debt: newInvoiceTab.debt,\n        isEditMode: (newInvoiceTab as any).isEditMode\n      });\n\n      // Add to invoices array\n      this.invoices.push(newInvoiceTab);\n\n      // Set as active tab\n      this.setActiveTab(this.invoices.length - 1);\n\n      // Force update the invoice data to ensure it's not overridden\n      const finalInvoiceIndex = this.invoices.length - 1;\n      this.invoices[finalInvoiceIndex].customerPaid = invoice.customerPaid || 0;\n      this.invoices[finalInvoiceIndex].debt = invoice.debt || 0;\n      (this.invoices[finalInvoiceIndex] as any).customerPaidManuallySet = true;\n      if (isEditMode) {\n        (this.invoices[finalInvoiceIndex] as any).isEditMode = true;\n        (this.invoices[finalInvoiceIndex] as any).originalOrderId = this.originalOrderId;\n      }\n\n      console.log(` Force updated invoice data:`, {\n        customerPaid: this.invoices[finalInvoiceIndex].customerPaid,\n        debt: this.invoices[finalInvoiceIndex].debt,\n        customerPaidManuallySet: (this.invoices[finalInvoiceIndex] as any).customerPaidManuallySet,\n        isEditMode: (this.invoices[finalInvoiceIndex] as any).isEditMode\n      });\n\n      // Update cart items, customer, and other data\n      this.cartItems = [...invoice.cartItems];\n      this.selectedCustomer = invoice.customer;\n      this.discountAmount = invoice.discountAmount;\n      this.invoiceNote = invoice.note || '';\n\n      // Update customer search term\n      if (this.selectedCustomer) {\n        this.customerSearchTerm = this.selectedCustomer.Name + ' - ' + (this.selectedCustomer.ContactNumber || '');\n      } else {\n        this.customerSearchTerm = '';\n      }\n\n      // Keep the original customerPaid from the invoice (which was set from order)\n      this.formattedCustomerPaid = (invoice.customerPaid || 0).toString();\n\n      // Save to localStorage\n      this.saveDataToLocalStorage();\n\n      // Force UI update\n      this.updateInvoiceTotalPrice();\n\n      console.log(`  x l n hng ${orderId} thnh cng! D liu  c thm vo tab ha n.`);\n      console.log(` Final invoice tab data:`, {\n        customerPaid: this.invoices[this.activeTabIndex].customerPaid,\n        totalPrice: this.invoices[this.activeTabIndex].totalPrice,\n        discountAmount: this.invoices[this.activeTabIndex].discountAmount,\n        debt: this.invoices[this.activeTabIndex].debt,\n        isEditMode: (this.invoices[this.activeTabIndex] as any).isEditMode\n      });\n\n    } catch (error) {\n      console.error(` Error handling processed order:`, error);\n    }\n  }\n  async order() {\n    if (!this.selectedCustomer) {\n      alert('Bn phi select customer cho order!');\n      return;\n    }\n    const notEnough = await this.checkOnHandFromIndexedDB();\n    if (notEnough) {\n      alert('Khng  s lng');\n      return;\n    }\n    if (this.cartItems.length === 0) {\n      alert('Gi hng trng!');\n      return;\n    }\n    // Ly index order hin ti\n    const currentOrderIndex = this.activeOrderTabIndex;\n    // Gn cc gi tr vo order tab trc khi to order object\n    const now = new Date();\n    const vnNow = this.timeZoneService.formatVietnamISOString(now);\n    this.orders[currentOrderIndex].debt = this.getChangeAmount();\n    this.orders[currentOrderIndex].note = this.invoiceNote;\n    this.orders[currentOrderIndex].createdDate = vnNow;\n    this.orders[currentOrderIndex].totalPrice = this.getTotalAmount() - this.discountAmount;\n    this.orders[currentOrderIndex].customer = this.selectedCustomer ? { ...this.selectedCustomer } : null;\n    this.orders[currentOrderIndex].discountAmount = this.discountAmount;\n    this.orders[currentOrderIndex].customerPaid = this.orders[currentOrderIndex].customerPaid || 0;\n    this.orders[currentOrderIndex].totalCost = this.getTotalCost();\n    this.orders[currentOrderIndex].totalQuantity = this.getTotalQuantity();\n    this.orders[currentOrderIndex].deliveryTime = this.deliveryTime;\n    // To order object t tab hin ti\n    const order = {\n      ...this.orders[currentOrderIndex],\n      cartItems: [...this.cartItems],\n      status: this.setStatus(),\n      customerPaidManuallySet: false\n    };\n    // Gi ln Firestore\n    try {\n      await firstValueFrom(this.orderService.addOrderToFirestore(order));\n      // Pht WebSocket real-time (nu mun)\n      await this.orderService.notifyOrderCreated(order);\n      // Lu vo IndexedDB ( ng b offline)\n      await this.orderService.addOrderToDB(order);\n      alert(' lu n t hng!');\n    } catch (err) {\n      // Nu li, ch lu local\n      await this.orderService.addOrderToDB(order);\n      alert(' lu n t hng (offline)!');\n    }\n    // Reset gi hng v trng thi\n    this.cartItems = [];\n    this.discountAmount = 0;\n    this.invoiceNote = '';\n    this.selectedCustomer = null;\n    this.customerSearchTerm = '';\n    this.saveDataToLocalStorage();\n  }\n\n  private async reloadCartItemsOnHand() {\n    for (const item of this.cartItems) {\n      if (item.product && item.product.Id) {\n        const latest = await this.productService.getProductByIdFromIndexedDB(item.product.Id);\n        if (latest) {\n          item.product.OnHand = latest.OnHand;\n        }\n      }\n    }\n  }\n\n  removeOrderTab(index: number) {\n    // Nu tab khng c item, xa trc tip khng cn dialog\n    if (!this.orders[index].cartItems || this.orders[index].cartItems.length === 0) {\n      this.handleRemoveOrderTab(index);\n      return;\n    }\n    // Nu tab c item, hin th dialog xc nhn\n    const dialogRef = this.dialog.open(ConfirmPopupComponent, {\n      width: '300px',\n      data: { message: 'Bn c chc chn mun ng n t hng?' }\n    });\n    dialogRef.afterClosed().subscribe(result => {\n      if (result === true) {\n        this.handleRemoveOrderTab(index);\n      }\n    });\n  }\n\n  private handleRemoveOrderTab(index: number) {\n    // Nu ch cn 1 tab cui cng, reset v \"n t hng 1\"\n    if (this.orders.length === 1) {\n      const lastTab = this.orders[0];\n      lastTab.name = 'n t hng 1';\n      lastTab.id = 'DH' + Date.now().toString();\n      lastTab.cartItems = [];\n      lastTab.customerPaid = 0;\n      this.setActiveOrderTab(0);\n      return;\n    }\n    // Xa tab\n    this.orders.splice(index, 1);\n    // m bo lun c t nht 1 tab\n    if (this.orders.length === 0) {\n      this.addOrderTab();\n    } else {\n      // Set active tab mi\n      const newIndex = Math.max(index - 1, 0);\n      this.setActiveOrderTab(newIndex);\n    }\n  }\n\n  async saveEditedOrder() {\n    if (!this.originalOrderId) {\n      console.error(' No original order ID found');\n      return;\n    }\n\n    const notEnough = await this.checkOnHandFromIndexedDB();\n    if (notEnough) {\n      alert('Khng  s lng');\n      return;\n    }\n\n    if (this.cartItems.length === 0) {\n      alert('Gi hng trng!');\n      return;\n    }\n\n    // Get current invoice tab (which is the edited order)\n    const currentInvoiceIndex = this.activeTabIndex;\n  // removed unused timestamp variables (vnNow)\n\n    // Update order with edited data\n    const updatedOrder = {\n      id: this.originalOrderId,\n      name: 'n t hng ' + this.originalOrderId,\n      cartItems: [...this.cartItems],\n      createdDate: this.invoices[currentInvoiceIndex].createdDate, // Keep original creation date\n      totalPrice: this.getTotalAmount() - this.discountAmount,\n      discountAmount: this.discountAmount,\n      customer: this.selectedCustomer ? { ...this.selectedCustomer } : null,\n      totalQuantity: this.getTotalQuantity(),\n      debt: this.getChangeAmount(),\n      note: this.invoiceNote,\n      customerPaid: this.invoices[currentInvoiceIndex].customerPaid || 0,\n      totalCost: this.getTotalCost(),\n      status: 'edited', // Set status to 'edited'\n      deliveryTime: this.invoices[currentInvoiceIndex].deliveryTime\n    };\n\n    try {\n      // Update in Firestore\n      await firstValueFrom(this.orderService.updateOrderToFirestore(this.originalOrderId, updatedOrder));\n      console.log(` Order ${this.originalOrderId} updated in Firestore`);\n\n      // Update in IndexedDB\n      await this.orderService.updateOrderInDB(updatedOrder);\n      console.log(` Order ${this.originalOrderId} updated in IndexedDB`);\n\n      // Notify via WebSocket\n      await this.orderService.notifyOrderUpdated(updatedOrder);\n      console.log(` Order ${this.originalOrderId} update notified via WebSocket`);\n\n      alert(` lu chnh sa n hng ${this.originalOrderId}!`);\n\n      // Clear local storage data for this tab and remove edit tab\n      this.localStorageService.clearTabData(currentInvoiceIndex);\n      this.invoices.splice(currentInvoiceIndex, 1);\n\n      // Reset edit flags\n      this.isEditMode = false;\n      this.originalOrderId = null;\n\n      // Restore tabs UI\n      if (this.invoices.length === 0) {\n        this.addInvoiceTab();\n      } else {\n        const newIndex = Math.min(currentInvoiceIndex, this.invoices.length - 1);\n        this.setActiveTab(newIndex);\n      }\n\n      // Reset UI values\n      this.discountAmount = 0;\n      this.change = 0;\n      this.formattedCustomerPaid = '0';\n      this.invoiceNote = '';\n\n      // Optionally notify realtime\n      if (typeof (this.invoiceService as any).notifyInvoiceUpdated === 'function') {\n        try {\n          await (this.invoiceService as any).notifyInvoiceUpdated(updatedOrder);\n        } catch (e) { /* ignore */ }\n      }\n    } catch (error) {\n      console.error(' Error saving edited order:', error);\n      alert('Li khi lu chnh sa n hng!');\n    }\n  }\n\n  // Edit mode tracking\n  isEditMode = false;\n  originalOrderId: string | null = null;\n  isEditModeInvoice = false;\n  originalInvoiceId: string | null = null;\n\n  // Add saveEditedInvoice implementation (place inside the MainPageComponent class)\n  async saveEditedInvoice() {\n    if (!this.originalInvoiceId) {\n      console.error(' No original invoice ID found');\n      return;\n    }\n\n    const notEnough = await this.checkOnHandFromIndexedDB();\n    if (notEnough) {\n      alert('Khng  s lng');\n      return;\n    }\n\n    if (this.cartItems.length === 0) {\n      alert('Gi hng trng!');\n      return;\n    }\n\n    const currentInvoiceIndex = this.activeTabIndex;\n    const updatedInvoice: InvoiceTab = {\n      id: this.originalInvoiceId,\n      name: this.invoices[currentInvoiceIndex]?.name || ('Ha n ' + this.originalInvoiceId),\n      cartItems: [...this.cartItems],\n      createdDate: this.invoices[currentInvoiceIndex]?.createdDate || new Date().toISOString(),\n      totalPrice: this.getTotalAmount() - (this.discountAmount || 0),\n      discountAmount: this.discountAmount || 0,\n      customer: this.selectedCustomer ? { ...this.selectedCustomer } : null,\n      totalQuantity: this.getTotalQuantity(),\n      debt: this.getChangeAmount(),\n      note: this.invoiceNote || '',\n      customerPaid: this.invoices[currentInvoiceIndex]?.customerPaid || 0,\n      totalCost: this.getTotalCost(),\n      deliveryTime: this.invoices[currentInvoiceIndex]?.deliveryTime || ''\n    };\n\n    try {\n      // Update remote (Firestore / API)\n      if (typeof (this.invoiceService as any).updateInvoiceToFirestore === 'function') {\n        await firstValueFrom((this.invoiceService as any).updateInvoiceToFirestore(updatedInvoice.id, updatedInvoice));\n      } else if ((this.invoiceService as any).http && (this.invoiceService as any).firebase?.put_update_invoice) {\n        const url = (this.invoiceService as any).firebase.put_update_invoice;\n        await firstValueFrom((this.invoiceService as any).http.put(url + updatedInvoice.id, updatedInvoice));\n      }\n\n      // Update local IndexedDB\n      if (typeof (this.invoiceService as any).updateInvoiceInDB === 'function') {\n        await (this.invoiceService as any).updateInvoiceInDB(updatedInvoice);\n      } else if (typeof (this.invoiceService as any).addInvoiceToDB === 'function') {\n        await (this.invoiceService as any).addInvoiceToDB(updatedInvoice);\n      }\n\n      alert(` lu chnh sa ha n ${updatedInvoice.id}!`);\n\n      // Clear local storage data for this tab and remove edit tab\n      this.localStorageService.clearTabData(currentInvoiceIndex);\n      this.invoices.splice(currentInvoiceIndex, 1);\n\n      // Reset edit flags\n      this.isEditMode = false;\n      this.isEditModeInvoice = false;\n      this.originalInvoiceId = null;\n\n      // Restore tabs UI\n      if (this.invoices.length === 0) {\n        this.addInvoiceTab();\n      } else {\n        const newIndex = Math.min(currentInvoiceIndex, this.invoices.length - 1);\n        this.setActiveTab(newIndex);\n      }\n\n      // Reset UI values\n      this.discountAmount = 0;\n      this.change = 0;\n      this.formattedCustomerPaid = '0';\n      this.invoiceNote = '';\n\n      // Optionally notify realtime\n      if (typeof (this.invoiceService as any).notifyInvoiceUpdated === 'function') {\n        try {\n          await (this.invoiceService as any).notifyInvoiceUpdated(updatedInvoice);\n        } catch (e) { /* ignore */ }\n      }\n    } catch (error) {\n      console.error(' Error saving edited invoice:', error);\n      alert('Li khi lu chnh sa ha n!');\n    }\n  }\n}","usedDeprecatedRules":[]}]