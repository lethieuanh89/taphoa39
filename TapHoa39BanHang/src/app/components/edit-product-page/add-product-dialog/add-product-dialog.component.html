<div class="add-product-dialog">
  <div class="dialog-header">
    <h2 class="dialog-title">
      <mat-icon class="title-icon">add_shopping_cart</mat-icon>
      Thêm hàng hóa
    </h2>
  </div>

  <div class="tabs">
    <button class="tab" [class.active]="selectedTab === 'info'" (click)="selectTab('info')">
      <mat-icon>info</mat-icon>
      <span>Thông tin</span>
    </button>
    <button class="tab" [class.active]="selectedTab === 'desc'" (click)="selectTab('desc')">
      <mat-icon>description</mat-icon>
      <span>Mô tả</span>
    </button>
  </div>

  <!-- Info tab -->
  <div *ngIf="selectedTab === 'info'" class="content">
    <div class="left">
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>inventory_2</mat-icon>
          Thông tin cơ bản
        </h3>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Mã hàng</mat-label>
          <input matInput [(ngModel)]="product.code" placeholder="Nhập mã hàng hóa" required />
          <mat-icon matPrefix>qr_code_2</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Tên hàng</mat-label>
          <input matInput [(ngModel)]="product.name" placeholder="Nhập tên hàng hóa" required />
          <mat-icon matPrefix>label</mat-icon>
        </mat-form-field>

        <div class="row">
          <mat-form-field appearance="outline" class="flex-1">
            <mat-label>Nhóm hàng</mat-label>
            <mat-select [(ngModel)]="product.group">
              <mat-option *ngFor="let g of groups" [value]="g.id">{{ g.name }}</mat-option>
            </mat-select>
            <mat-icon matPrefix>category</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="flex-1">
            <mat-label>Nhà cung cấp</mat-label>
            <mat-select [(ngModel)]="product.brand">
              <mat-option *ngFor="let b of brands" [value]="b.id">{{ b.name }}</mat-option>
            </mat-select>
            <mat-icon matPrefix>badge</mat-icon>
          </mat-form-field>
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>payments</mat-icon>
          Giá và tồn kho
        </h3>

        <div class="row">
          <mat-form-field appearance="outline" class="flex-1">
            <mat-label>Giá vốn VND</mat-label>
            <input matInput type="number" [(ngModel)]="product.cost" placeholder="0" />
            <mat-icon matPrefix>money</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="flex-1">
            <mat-label>Giá bán VND</mat-label>
            <input matInput type="number" [(ngModel)]="product.price" placeholder="0" />
            <mat-icon matPrefix>sell</mat-icon>
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Tồn kho</mat-label>
          <input matInput type="number" [(ngModel)]="product.stock" placeholder="0" />
          <mat-icon matPrefix>inventory</mat-icon>
        </mat-form-field>
      </div>

      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>straighten</mat-icon>
          Đơn vị tính
        </h3>

        <div class="units">
          <ng-container *ngIf="productUnits.length === 0">
            <div class="empty-state">
              <mat-icon>info</mat-icon>
              <p>Chưa có đơn vị tính nào</p>
              <button mat-raised-button color="primary" (click)="openAddBaseUnit()">
                <mat-icon>add</mat-icon>
                Thêm đơn vị cơ bản
              </button>
            </div>
          </ng-container>

          <ng-container *ngIf="productUnits.length > 0">
            <div class="unit-list">
              <div class="unit-pill" *ngFor="let u of productUnits; let i = index">
                <button type="button" class="unit-remove" aria-label="Xóa đơn vị" (click)="removeUnit(i)">
                  <mat-icon>close</mat-icon>
                </button>
                <div class="unit-content">
                  <div class="unit-header">
                    <mat-icon class="unit-icon">{{u.isBase ? 'star' : 'label'}}</mat-icon>
                    <ng-container *ngIf="u.isBase">
                      <strong class="unit-name">{{ u.name }}</strong>
                    </ng-container>
                    <ng-container *ngIf="!u.isBase">
                      <span class="unit-name">{{ u.name }}</span>
                    </ng-container>
                  </div>
                  <ng-container *ngIf="u.isBase">
                    <span class="unit-badge">Đơn vị cơ bản</span>
                  </ng-container>
                  <ng-container *ngIf="!u.isBase">
                    <span class="unit-conversion">= {{ u.conversion }} {{ productUnits[0].name }}</span>
                  </ng-container>
                  <div class="unit-price">
                    <mat-icon>sell</mat-icon>
                    {{ u.price | number:'1.0-0' }} ₫
                  </div>
                </div>
              </div>
            </div>
            <div class="unit-actions">
              <button mat-stroked-button color="primary" (click)="openAddUnit()">
                <mat-icon>add</mat-icon>
                Thêm đơn vị
              </button>
            </div>
          </ng-container>
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>settings</mat-icon>
          Thuộc tính
        </h3>

        <div class="attributes">
          <ng-container *ngIf="productAttributes.length === 0">
            <div class="empty-state">
              <mat-icon>info</mat-icon>
              <p>Chưa có thuộc tính nào</p>
              <button mat-raised-button color="primary" (click)="openAddAttribute()">
                <mat-icon>add</mat-icon>
                Thêm thuộc tính
              </button>
            </div>
          </ng-container>

          <ng-container *ngIf="productAttributes.length > 0">
            <div class="attribute-list">
              <div class="attribute-item" *ngFor="let attr of productAttributes; let i = index">
                <button type="button" class="attr-remove" aria-label="Xóa thuộc tính" (click)="removeAttribute(i)">
                  <mat-icon>close</mat-icon>
                </button>
                <div class="attr-header">
                  <mat-icon class="attr-icon">label</mat-icon>
                  <strong class="attr-name">{{ attr.name }}</strong>
                </div>
                <div class="attr-values">
                  <span class="attr-value-chip" *ngFor="let val of attr.values">{{ val }}</span>
                </div>
              </div>
            </div>
            <div class="attribute-actions">
              <button mat-stroked-button color="primary" (click)="openAddAttribute()">
                <mat-icon>add</mat-icon>
                Thêm thuộc tính
              </button>
            </div>
          </ng-container>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="form-section image-section">
        <h3 class="section-title">
          <mat-icon>image</mat-icon>
          Hình ảnh
        </h3>
        <div class="image-box" [class.has-image]="imageDataUrl">
          <div class="placeholder" *ngIf="!imageDataUrl">
            <mat-icon class="upload-icon">cloud_upload</mat-icon>
            <button mat-raised-button color="primary" (click)="fileInput.click()">
              <mat-icon>add_photo_alternate</mat-icon>
              Thêm ảnh
            </button>
            <p class="hint">Mỗi ảnh không quá 2 MB</p>
          </div>
          <div class="image-preview" *ngIf="imageDataUrl">
            <img [src]="imageDataUrl" alt="product image" />
            <button mat-mini-fab color="warn" class="change-image-btn" (click)="fileInput.click()" title="Đổi ảnh">
              <mat-icon>edit</mat-icon>
            </button>
          </div>
          <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" hidden />
        </div>
      </div>
    </div>
  </div>

  <!-- Description tab -->
  <div *ngIf="selectedTab === 'desc'" class="content desc-content">
    <div class="desc-left">
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>description</mat-icon>
          Mô tả sản phẩm
        </h3>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Mô tả chi tiết</mat-label>
          <textarea matInput rows="8" [(ngModel)]="product.description" placeholder="Nhập mô tả sản phẩm..."></textarea>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Mẫu ghi chú (hóa đơn, đặt hàng)</mat-label>
          <textarea matInput rows="5" [(ngModel)]="product.noteTemplate" placeholder="Nhập mẫu ghi chú..."></textarea>
        </mat-form-field>
      </div>
    </div>
  </div>

  <div class="actions">

    <span class="spacer"></span>
    <button mat-raised-button color="primary" (click)="save()">
      <mat-icon>save</mat-icon>
      Lưu
    </button>
  </div>
</div>