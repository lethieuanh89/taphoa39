<div class="search-header">
  <div>
    <button class="voice-icon" mat-icon-button matPrefix (click)="startVoiceInput()">üé§</button>
    <input type="text" class="search-bar " matInput [formControl]="searchControl"
      placeholder="T√¨m ki·∫øm: nh·∫≠p m√£ h√†ng ho·∫∑c t√™n h√†ng v√† g√µ Enter... " (keyup.enter)="onSearch($event)">


    <!-- <mat-autocomplete #auto="matAutocomplete">
      <mat-option *ngFor="let option of filteredOptions | async" [value]="option.FullName">
        <img [src]="option.Image" alt="option image" class="option-image">
        {{ option.FullName }}
      </mat-option>
    </mat-autocomplete> -->
  </div>


  <mat-toolbar>
    <button mat-button class="save-button" (click)="onSave()"
      [ngClass]="{'active-button': activeButton === ''}">L∆∞u</button>

    <button mat-button class="update-button" (click)="onUpdate()" [ngClass]="{'active-button': activeButton === ''}">C·∫≠p
      nh·∫≠t ƒë·∫øn
      KiotViet</button>
    <button mat-button class="ton-kho-button" (click)="checkRemains()">
      Ki·ªÉm tra h·∫øt h√†ng
      <span *ngIf="showLowStockWarning" class="warning-icon"></span>
    </button>
    <button mat-button class="clear-cache-button" (click)="clearCache()">X√≥a Cache</button>
    <button mat-button class="add-product-button" (click)="addProduct()">Th√™m h√†ng h√≥a</button>

  </mat-toolbar>

  <div *ngIf="showOfflineHint" class="sync-hint">
    <span class="sync-dot"></span>
    <span>{{ hintMessage }}</span>
  </div>
</div>

<div *ngIf="isLoading" class="loading-overlay">
  <div class="spinner"></div>
  <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
</div>

<div class="main-container">
  <!-- <div class="category-list">
    <ul>
      <li *ngFor="let category of categories" (click)="onCategoryClick(category.path)"
        [ngClass]="{'active-category': activeCategory === category.path}">
        {{ category.name }}
      </li>
    </ul>
  </div> -->

  <!-- B·∫£ng s·∫£n ph·∫©m -->
  <div class="product-table">
    <table mat-table [dataSource]="filteredProducts" class="mat-elevation-z8">

      <ng-container matColumnDef="Image">
        <th class="highlight" mat-header-cell *matHeaderCellDef>·∫¢nh</th>
        <td mat-cell *matCellDef="let element">
          <div class="img-tooltip-wrapper">
            <img class="thumbnail" [src]="element.Image" alt="product" />
            <div class="tooltip-img">
              <img [src]="element.Image" alt="preview" />
            </div>
          </div>
        </td>
      </ng-container>

      <!-- C·ªôt M√£ H√†ng -->
      <ng-container matColumnDef="Code">
        <th class="highlight" mat-header-cell *matHeaderCellDef>M√£ H√†ng</th>
        <td mat-cell *matCellDef="let element"
          [style.background-color]="getProductColor(element.ParentCode || element.Code)">
          <div class="cell-wrapper">
            <input class="input-field custom-input" matInput [(ngModel)]="element.Code" tabindex="1"
              (focus)="onInputFocus($event)">
          </div>
        </td>
      </ng-container>

      <!-- C·ªôt T√™n H√†ng -->
      <ng-container matColumnDef="FullName">
        <th class="highlight" mat-header-cell *matHeaderCellDef>T√™n H√†ng</th>
        <td mat-cell *matCellDef="let element"
          [style.background-color]="getProductColor(element.ParentCode || element.Code)">
          <input class="input-field custom-input" matInput [(ngModel)]="element.FullName"
            matTooltip="{{ element.FullName.length > 15 ? (element.FullName) : element.FullName }}" tabindex="1"
            (focus)="onInputFocus($event)">
        </td>
      </ng-container>

      <ng-container matColumnDef="AverageCheckPoint">
        <th class="highlight" mat-header-cell *matHeaderCellDef>T√≠nh <br>Trung b√¨nh?</th>
        <td mat-cell *matCellDef="let element"
          [style.background-color]="getProductColor(element.ParentCode || element.Code)">
          <input [disabled]="!element.Master" type="checkbox" style="width: 20px;height:20px;" tabindex="1"
            [(ngModel)]="element.AverageCheckPoint">
        </td>
      </ng-container>

      <ng-container matColumnDef="FinalBasePrice">
        <th class="highlight" mat-header-cell *matHeaderCellDef>Gi√° B√°n <br>mong mu·ªën</th>
        <td mat-cell *matCellDef="let element"
          [style.background-color]="getProductColor(element.ParentCode || element.Code)">
          <input class="input-field custom-input" matInput type="text" [value]="(userChangedFinalBasePrice[element.Code] ? formatNumber(element.FinalBasePrice) : formatNumber(element._constBasePrice !== undefined ? element._constBasePrice : element.BasePrice))"
            (input)="onInputFinalBasePrice($event, element);updateCost(element);formatNumber(element.FinalBasePrice)"
            (keydown)="validateNumber($event)" tabindex="1" (focus)="onInputFocus($event)" name="finalBasePrice">
        </td>
      </ng-container>
      <!-- C·ªôt Gi√° B√°n -->


      <ng-container matColumnDef="BasePrice">
        <th class="highlight" mat-header-cell *matHeaderCellDef>Gi√° B√°n <br> ƒë·ªÅ xu·∫•t</th>
        <td mat-cell *matCellDef="let element"
          [style.background-color]="getProductColor(element.ParentCode || element.Code)">
          <!-- <input class="input-field custom-input" matInput type="text" [value]="formatNumber(element.BasePrice)"
            (input)="onInputBasePrice($event, element)" (keydown)="validateNumber($event)" tabindex="1"
            (focus)="onInputFocus($event)"> -->
          {{element.BasePrice | number:'1.0-0'}}
        </td>
      </ng-container>

      <!-- C·ªôt Gi√° V·ªën -->
      <ng-container matColumnDef="Cost">
        <th class="highlight" mat-header-cell *matHeaderCellDef>Gi√° V·ªën <br> ƒê∆°n v·ªã </th>
        <td mat-cell *matCellDef="let element"
          [style.background-color]="getProductColor(element.ParentCode || element.Code)">
          {{element.Cost | number:'1.0-0'}}
        </td>
      </ng-container>

      <!-- C·ªôt T·ªìn Kho -->
      <ng-container matColumnDef="OnHand">
        <th class="highlight" mat-header-cell *matHeaderCellDef>T·ªìn Kho</th>
        <td mat-cell *matCellDef="let element"
          [style.background-color]="getProductColor(element.ParentCode || element.Code)">

          {{element.OnHand | number:'1.3-3'}}
        </td>
      </ng-container>



      <!-- C·ªôt Gi√° v·ªën l·ªëc
      <ng-container matColumnDef="PackCost">
        <th class="highlight" mat-header-cell *matHeaderCellDef>Gi√° v·ªën l·ªëc</th>
        <td mat-cell *matCellDef="let element">
          <input class="input-field custom-input" matInput type="number" [(ngModel)]="element.PackCost"
            readonly>
        </td>
      </ng-container> -->

      <!-- C·ªôt Gi√° g·ªëc th√πng
      <ng-container matColumnDef="OriginalBoxPrice">
        <th class="highlight" mat-header-cell *matHeaderCellDef>Gi√° v·ªën <br>th√πng</th>
        <td mat-cell *matCellDef="let element">
          <input class="input-field custom-input" matInput type="number" [(ngModel)]="element.OriginalBoxPrice"
             readonly>
        </td>
      </ng-container> -->

      <!-- C·ªôt M√¥ T·∫£ Chi Ti·∫øt -->
      <ng-container matColumnDef="Description">
        <th class="highlight" mat-header-cell *matHeaderCellDef>M√¥ T·∫£ <br>Chi Ti·∫øt</th>
        <td mat-cell *matCellDef="let element"
          [style.background-color]="getProductColor(element.ParentCode || element.Code)">
          <textarea class="input-field custom-input" matInput [(ngModel)]="element.Description"
            [disabled]="!element.Master"
            matTooltip="{{ element.Description.length > 15 ? (element.Description) : element.Description }}"
            tabindex="1" (focus)="onInputFocus($event)"></textarea>
        </td>
      </ng-container>

      <!-- C·ªôt Quy c√°ch ƒë√≥ng g√≥i
      <ng-container matColumnDef="PackingSpec">
        <th mat-header-cell *matHeaderCellDef>Quy c√°ch <br>l·ªëc</th>
        <td mat-cell *matCellDef="let element"
          [style.background-color]="getProductColor(element.ParentCode || element.Code)">
          <input class="input-field custom-input" matInput [(ngModel)]="element.PackingSpec"
            (input)="updateCost(element)"  (keydown)="validateNumber($event)"
            tabindex="1" (focus)="onInputFocus($event)">
        </td>
      </ng-container> -->
      <!-- C·ªôt L·∫ª -->
      <ng-container matColumnDef="Retail">
        <th mat-header-cell *matHeaderCellDef>L·∫ª <br>(ƒë∆°n v·ªã nh·ªè nh·∫•t)</th>
        <td mat-cell *matCellDef="let element"
          [style.background-color]="getProductColor(element.ParentCode || element.Code)">
          <input class="input-field custom-input" matInput [(ngModel)]="element.Retail" [disabled]="!element.Master"
            (input)="updateCost(element)" (keydown)="handleNumericKeyDown($event, element)" tabindex="1"
            (focus)="onInputFocus($event)">
        </td>
      </ng-container>

      <!-- C·ªôt Quy c√°ch ƒë∆°n v·ªã -->
      <ng-container matColumnDef="UnitSpec">
        <th mat-header-cell *matHeaderCellDef>Quy c√°ch <br>ƒë∆°n v·ªã</th>
        <td mat-cell *matCellDef="let element"
          [style.background-color]="getProductColor(element.ParentCode || element.Code)">
          {{element.ConversionValue}}
          <!-- <input class="input-field custom-input" matInput [(ngModel)]="element.UnitSpec" (input)="updateCost(element)"
             (keydown)="validateNumber($event)" tabindex="1"
            (focus)="onInputFocus($event)"> -->
        </td>
      </ng-container>



      <!-- C·ªôt Th√πng -->
      <ng-container matColumnDef="Box">
        <th mat-header-cell *matHeaderCellDef>Th√πng</th>
        <td mat-cell *matCellDef="let element"
          [style.background-color]="getProductColor(element.ParentCode || element.Code)">
          <input class="input-field custom-input" matInput [(ngModel)]="element.Box" [disabled]="!element.Master"
            (input)="updateCost(element)" (keydown)="handleNumericKeyDown($event, element)" tabindex="1"
            (focus)="onInputFocus($event)">

        </td>
      </ng-container>

      <!-- C·ªôt Chi·∫øt kh·∫•u -->
      <ng-container matColumnDef="Discount">
        <th mat-header-cell *matHeaderCellDef>Chi·∫øt kh·∫•u tr√™n<br> 1 s·∫£n ph·∫©m</th>
        <td mat-cell *matCellDef="let element"
          [style.background-color]="getProductColor(element.ParentCode || element.Code)">
          <input class="input-field custom-input" matInput type="text" [disabled]="!element.Master"
            [value]="element.Discount === 0 ? '': formatNumber(element.Discount)"
            (input)="onInputDiscount($event, element); updateCost(element)"
            (keydown)="handleNumericKeyDown($event, element)" tabindex="1" (focus)="onInputFocus($event)">
        </td>
      </ng-container>

      <ng-container matColumnDef="Discount2">
        <th mat-header-cell *matHeaderCellDef>Chi·∫øt kh·∫•u tr√™n <br>t·ªïng ti·ªÅn</th>
        <td mat-cell *matCellDef="let element"
          [style.background-color]="getProductColor(element.ParentCode || element.Code)">
          <input class="input-field custom-input" matInput type="text" [disabled]="!element.Master"
            [value]="element.Discount2 === 0 ? '': formatNumber(element.Discount2)"
            (input)="onInputDiscount2($event, element); updateCost(element)"
            (keydown)="handleNumericKeyDown($event, element)" tabindex="1" (focus)="onInputFocus($event)">
        </td>
      </ng-container>

      <!-- C·ªôt Th√†nh ti·ªÅn -->
      <ng-container matColumnDef="TotalPrice">
        <th mat-header-cell *matHeaderCellDef>Th√†nh ti·ªÅn</th>
        <td mat-cell *matCellDef="let element"
          [style.background-color]="getProductColor(element.ParentCode || element.Code)">
          <input class="input-field custom-input" matInput type="text" [disabled]="!element.Master"
            [value]="element.TotalPrice === 0 ? '' : formatNumber(element.TotalPrice)"
            (input)="onInputTotalPrice($event, element); updateCost(element)"
            (keydown)="handleNumericKeyDown($event, element)" tabindex="1" (focus)="onInputFocus($event)">
        </td>
      </ng-container>

      <!-- C·ªôt ƒê∆°n v·ªã -->
      <ng-container matColumnDef="Unit">
        <th mat-header-cell *matHeaderCellDef>ƒê∆°n v·ªã</th>
        <td mat-cell *matCellDef="let element"
          [style.background-color]="getProductColor(element.ParentCode || element.Code)">
          {{element.Unit}}
        </td>
      </ng-container>

      <!-- H√†ng ti√™u ƒë·ªÅ -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <!-- H√†ng d·ªØ li·ªáu -->
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" [ngClass]="{'master-row': row.Master}"></tr>
    </table>
  </div>
</div>